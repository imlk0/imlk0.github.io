<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>自制x86玩具操作系统 week6 | imlk's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>自制x86玩具操作系统 week6</span></h1><span><span class=date>📅 2019-05-01</span>
<span class=date>(更新于2021-10-10)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/osdev/>OSDev</a>
</span>/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>#操作系统</a>
<a href=https://blog.imlk.top/tags/diy/>#DIY</a></span></span><br></div><main class=post-content><h2 id=day-0x0f>DAY 0x0F</h2><h4 id=两种jmp指令>两种JMP指令</h4><p><code>near jmp</code>只修改IP寄存器的值，而<code>far jmp</code>同时修改<code>IP</code>寄存器和<code>CS</code>寄存器的值(用<code>:</code>隔开)
用于任务切换的JMP命令就属于far-JMP命令，用于任务切换的JMP命令在切换回这个任务后，会从这条JMP命令后继续执行。</p><h4 id=gdt中的tss段>GDT中的TSS段</h4><p>TSS(task status segment)，全称任务状态段
CPU在执行带有段地址的指令时，会去确认GDT中对应项的配置，可用此判断是JMP指令还是far-JMP，</p><h4 id=trtask-register寄存器>TR(task register)寄存器</h4><p><code>TR</code>寄存器记录当前正在运行的是哪一个任务，任务切换时，寄存器的值会自动变化，每次给<code>TR</code>寄存器赋值的时候，需要将其在GDT中的序号乘以8。</p><p>两个任务交替进行输出：
<img src=/images/blog/os/6.png alt=两个任务交替进行输出></p><h2 id=day-0x10>DAY 0x10</h2><p>作者原先只定义了两个任务，并且只是在超时之后将其强行进行切换，但是实际中的场景比这样的复杂得多，因而封装了切换任务的的逻辑，并且在这样的基础上实现任务增减、任务优先级设置，因此我这里模仿CanvasCtl的结构去实现task的管理</p><h4 id=多窗口>多窗口</h4><p>多任务建立起来以后，窗口（window）的数量也相应增加，为此实现了窗口和任务的绑定关系、窗口焦点的变化。</p><h4 id=优先级>优先级</h4><p>原先的task切换时，采用的是公平竞争的方式，每个任务被执行的几率相等，但是在实际的操作系统中，往往需要让某些进程拥有更高的优先级。要实现这样的功能，只要在task中加入priority字段，然后在切换任务时考虑这个字段即可。
<img src=/images/blog/os/7.png alt=task不同的优先级></p><h2 id=day-0x11>DAY 0x11</h2><h4 id=命令行窗口>命令行窗口</h4><p>这一天的内容基本上是对现有知识的应用，读取键盘输入、keytable的转换、按键的不同情况的响应等。
由于我之前写了log输出模块，可以像命令行那样一行一行显示日志文本，所以这个命令行窗口其实和我之前的那个日志模块有些类似，因此我直接将原先的代码进行修改，结合作者的实现，加入读取键盘输入的逻辑。
对各种按键锁的支持其实就是获取锁的状态，并进行记录，然后在触发按键响应过程中判断锁的状态，以此进行过滤。
<img src=/images/blog/os/8.png alt>
但是一些组合键的响应支持还不够完善，期待下一天的相关内容。</p></main><div id=comments><hr><script src=//geoip-js.com/js/apis/geoip2/v2.1/geoip2.js type=text/javascript></script><script>var onSuccess=function(e){var t=e.country.names["zh-CN"],n=e.country.iso_code;if(!n)return;t&&(document.getElementById("comments-blocked-country-code").innerHTML=t),n=="CN"&&(document.getElementById("comments-shown").style.display="none",document.getElementById("comments-blocked").style.display="")},onError=function(){};geoip2.country(onSuccess,onError)</script><div id=comments-blocked style=font-style:italic;color:#777;display:none>评论区已关闭。<span style=float:right>来自 <span id=comments-blocked-country-code>unknown</span> 的访客
<span>&nbsp; - powered by: geoip-js.com</span></span></div><div id=comments-shown><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>