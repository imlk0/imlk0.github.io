<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>理解MindSpore Lite计算图与自定义算子 | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>理解MindSpore Lite计算图与自定义算子</span></h1><span><span class=date>📅 2022-09-25</span>
<span class=date>(更新于2023-08-30)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/ai/>AI</a></span>
/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/mindspore/>#MindSpore</a>
<a href=https://blog.imlk.top/tags/ai/>#AI</a></span></span><br></div><main class=post-content><h1 id=mindspore-模型格式>MindSpore 模型格式</h1><ul><li><a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/converter_tool.html><code>converter_lite</code></a>工具<ul><li>支持的输入格式：MINDIR(MindSpore <code>.mindir</code>)、CAFFE、TFLITE、TF、ONNX</li><li>输出格式MINDIR_LITE(<code>.ms</code>)</li></ul></li><li>MINDIR(<code>.mindir</code>)<ul><li>MindSpore的模型文件，protobuff格式</li></ul></li><li>MINDIR_LITE(<code>.ms</code>)<ul><li><p>目前是<code>MSL2</code>版本，flatbuffer序列化文件，可推理，可训练。旧版为<code>MSL0</code>版本</p></li><li><p><a href=https://github.com/mindspore-ai/mindspore/blob/d351abb9f16a337610400ef5eba7af58bf291fb3/mindspore/lite/schema/model.fbs#L22>schema文件</a></p></li><li><p>MindIR</p><ul><li>IR的定义https://www.mindspore.cn/docs/zh-CN/r0.7/design/mindspore/ir.html</li><li>对应Lite算子https://www.mindspore.cn/lite/docs/zh-CN/r1.8/operator_list_lite.html</li></ul></li></ul></li></ul><h1 id=mindspore计算图结构>MindSpore计算图结构</h1><ul><li>SubGraph：模型是由相互嵌套的多个SubGraph组成的</li><li>Tensor：神经元，表示各层的输入输出，权重</li><li>Primitive：Mindspore定义的一种IR的算子</li><li>CNode：表示图上的一个算子行为，包含了：输入输出的tensor，由Primitive表示的具体的算子类型<ul><li>注意，mindspore的算子的输入输出可以有多个</li><li>注意，其中的device_type字段几乎可以忽略，目前仅两个用途。1. 仅在GPU的优先级高于CPU且该字段设置为GPU时，该节点才会选择使用GPU的Kernel。2. 仅在开启了<a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/runtime_cpp.html#%E9%85%8D%E7%BD%AE%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5>模型并行策略时才会影响</a>SetEnableParallel</li></ul></li><li>PartialFusion：一个特殊的算子，表示一个子图包含了一个SubGraph的索引号</li></ul><h1 id=mindspore模型初始化流程>MindSpore模型初始化流程</h1><ol><li><code>LiteModel::ConstructModel()</code> 从flatbuffers创建LiteModel对象。<ol><li><code>LiteModel::ConvertNodes()</code> 从flatbuffers初始化<code>mindspore::lite::LiteGraph::Node</code>对象</li><li><code>LiteModel::ConvertTensors()</code> 从flatbuffers初始化<code>mindspore::schema::Tensor</code>对象</li></ol></li><li><code>LiteSession::CompileGraph(Model *model)</code><ol><li><code>LiteSession::ConvertTensors()</code> 根据模型中定义的<code>mindspore::schema::Tensor</code>对象实例化成<code>mindspore::lite::Tensor</code>对象</li><li><code>Scheduler::Schedule(std::vector&lt;kernel::KernelExec *> *dst_kernels)</code> 实例化<code>mindspore::kernel::KernelExec</code>对象<ol><li><code>Scheduler::ScheduleGraphToKernels()</code> 将图转换成KernelExec对象</li><li>进行拓扑排序、将连续的Kernel按照arch类型合并成SubGraph</li></ol></li></ol></li></ol><h1 id=mindspore的扩展>MindSpore的扩展</h1><ol><li><p><a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/register_kernel.html#%E9%80%9A%E7%94%A8%E7%AE%97%E5%AD%90>自定义运行时算子——通用算子</a>：对Primitive列表中，已有算子（如Add）实现的重写</p></li><li><p><a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/register_kernel.html#custom%E7%AE%97%E5%AD%90>自定义运行时算子——Custom算子</a>：定义一种新的算子，使用Primitive列表中的Primitive::Custom算子接口，构建专属的实现。其中type和attr是可以自定义的属性</p><pre tabindex=0><code>table Custom {
     type: string;
     attr: [Attribute];
}
</code></pre></li><li><p><a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/delegate.html>模型Delegate</a> 提供将模型中的一部分子图卸载到别的框架执行的能力</p></li><li><p><a href=https://www.mindspore.cn/lite/docs/zh-CN/r1.8/use/converter_register.html#%E6%A8%A1%E5%9E%8B%E6%89%A9%E5%B1%95>模型转换中定义算子</a> converter工具提供了一种称为「图优化扩展」的能力（实际上是实现一个自定义的Pass），可以在获得MindSpore定义的图结构的基础上，对图进行修改，可将部分节点转换成Custom算子。</p></li></ol></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>