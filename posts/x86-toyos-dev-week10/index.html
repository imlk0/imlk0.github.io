<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>è‡ªåˆ¶x86ç©å…·æ“ä½œç³»ç»Ÿ week10 | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>è‡ªåˆ¶x86ç©å…·æ“ä½œç³»ç»Ÿ week10</span></h1><span><span class=date>ğŸ“… 2019-05-01</span>
<span class=date>(æ›´æ–°äº2021-10-10)</span>
/
<span class=cats>ğŸ“š
<a href=https://blog.imlk.top/categories/osdev/>OSDev</a></span>
/
<span class=tags>ğŸ·ï¸
<a href=https://blog.imlk.top/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>#æ“ä½œç³»ç»Ÿ</a>
<a href=https://blog.imlk.top/tags/diy/>#DIY</a></span></span><br></div><main class=post-content><h2 id=day-0x1b>DAY 0x1B</h2><p>å›é¡¾<code>TSS</code>ç»“æ„ä½“ï¼Œå…¶ä¸­æœ‰ä¸€<code>CR3</code>å­—æ®µï¼Œè¯¥å­—æ®µåœ¨taskåˆ‡æ¢çš„æ—¶å€™ä¼šè‡ªåŠ¨èµ‹å€¼ç»™<code>CR3</code>å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œç»™ç”¨æˆ·ç¨‹åºè®¾ç½®é¢å¤–çš„é¡µç›®å½•åœ°å€ï¼ˆç‰©ç†åœ°å€ï¼‰ï¼Œ</p><p>é¦–å…ˆéœ€è¦åˆ†é…ä¸€å¼ é¡µè¡¨</p><p>æŒ‰ç…§å†…å­˜ä¸­çš„ç»“æ„æ¥æ„é€ é¡µç›®å½•ç»“æ„ä½“å’Œé¡µè¡¨ç»“æ„ä½“</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>PAGE_DE</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> entrys[PAGE_DE_ENTRY_NUM];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PAGE_DE<span style=color:#f92672>*</span> <span style=color:#a6e22e>alloc_page_de</span>(MEMMAN<span style=color:#f92672>*</span> memman) {
</span></span><span style=display:flex><span>	PAGE_DE<span style=color:#f92672>*</span> p <span style=color:#f92672>=</span> (PAGE_DE<span style=color:#f92672>*</span>)memman_alloc_4k(memman, <span style=color:#66d9ef>sizeof</span>(PAGE_DE));
</span></span><span style=display:flex><span>	utils<span style=color:#f92672>::</span>memset(p, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(PAGE_DE));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> p;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è·å¾—é¡µè¡¨ä»¥åï¼Œå¯ä»¥åˆ†é…ä¸€å®šçš„å†…å­˜åŒºåŸŸæ¥å­˜æ”¾ç”¨æˆ·ç¨‹åºæ•°æ®ï¼Œä½œè€…åœ¨è¿è¡Œç”¨æˆ·ç¨‹åºæ—¶ï¼Œé‡‡ç”¨æ–°å¢ä¸€é¡¹æ®µè¡¨çš„æ–¹æ³•å°†é€»è¾‘åœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¾ç„¶ç»•è¿‡æ®µè¡¨ï¼Œç›´æ¥ç”¨é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†ä»<code>0x00000000</code>å¼€å§‹çš„çº¿æ€§åœ°å€åŒºåŸŸæ˜ å°„åˆ°æˆ‘ä»¬åˆšåˆšåˆ†é…çš„ç”¨æˆ·ç¨‹åºåŒºåŸŸçš„ç‰©ç†åœ°å€ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>map_page_addr2addr(sys<span style=color:#f92672>::</span>memman, pagede, <span style=color:#ae81ff>0</span>, segsiz, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)q <span style=color:#f92672>-</span> LADDR_K_BASE, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>); <span style=color:#75715e>// user access | write | present
</span></span></span></code></pre></div><p>æ³¨æ„flagè®¾ç½®ä¸ºâ€œç”¨æˆ·æ€å¯è®¿é—®ã€å¯å†™ã€è¯¥é¡µå­˜åœ¨â€</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ˜ å°„åœ°å€åˆ°é¡µç›®å½•ï¼Œè¦æ±‚start_laddrå’Œstart_paddrä½12ä½ç›¸åŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>map_page_addr2addr</span>(MEMMAN<span style=color:#f92672>*</span> memman, PAGE_DE<span style=color:#f92672>*</span> pagede, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> start_laddr, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> size,
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> start_paddr, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> demode, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> tamode) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> end_laddr <span style=color:#f92672>=</span> start_laddr <span style=color:#f92672>+</span> size;
</span></span><span style=display:flex><span>	end_laddr <span style=color:#f92672>=</span> (end_laddr <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1000</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>0x1000</span>  <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x1000</span>;<span style=color:#75715e>// 4kå‘ä¸Šå¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	start_laddr <span style=color:#f92672>=</span> start_laddr <span style=color:#f92672>/</span> <span style=color:#ae81ff>0x1000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x1000</span>;<span style=color:#75715e>// 4kå‘ä¸‹å¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	start_paddr <span style=color:#f92672>=</span> start_paddr <span style=color:#f92672>/</span> <span style=color:#ae81ff>0x1000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x1000</span>;<span style=color:#75715e>// 4kå‘ä¸‹å¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> start_entry <span style=color:#f92672>=</span> start_laddr <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>22</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> end_entry <span style=color:#f92672>=</span> ((end_laddr <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x400000</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>0x400000</span>  <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x400000</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>22</span>;<span style=color:#75715e>// 4MBå¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> sub_start_laddr <span style=color:#f92672>=</span> start_laddr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> sub_end_laddr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> sub_start_paddr <span style=color:#f92672>=</span> start_paddr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> sub_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> start_entry; i <span style=color:#f92672>&lt;</span> end_entry <span style=color:#f92672>&amp;&amp;</span> i <span style=color:#f92672>&lt;</span> PAGE_DE_ENTRY_NUM; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>		PAGE_TA<span style=color:#f92672>*</span> pta <span style=color:#f92672>=</span> (PAGE_TA<span style=color:#f92672>*</span>)((pagede<span style=color:#f92672>-&gt;</span>entrys[i]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFFFFF000</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (pta <span style=color:#f92672>==</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>			pta <span style=color:#f92672>=</span> alloc_page_ta(memman);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			pta <span style=color:#f92672>=</span> (PAGE_TA<span style=color:#f92672>*</span>)(((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)pta) <span style=color:#f92672>+</span> LADDR_K_BASE);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		sub_end_laddr <span style=color:#f92672>=</span> utils<span style=color:#f92672>::</span>min(end_laddr, (i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>22</span>);
</span></span><span style=display:flex><span>		sub_size <span style=color:#f92672>=</span> utils<span style=color:#f92672>::</span>max(<span style=color:#ae81ff>0</span>, sub_end_laddr <span style=color:#f92672>-</span> sub_start_laddr);
</span></span><span style=display:flex><span>		map_page_addr2addr(pta, sub_start_laddr, sub_size, sub_start_paddr, tamode);<span style=color:#75715e>// å¡«å……ptaæŒ‡å‘çš„é¡µè¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		sub_start_paddr <span style=color:#f92672>+=</span> sub_size;
</span></span><span style=display:flex><span>		sub_start_laddr <span style=color:#f92672>+=</span> sub_size;
</span></span><span style=display:flex><span>		set_page_ta2de(pagede, pta, i, demode);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ†é¡µç»“æ„è¦æ±‚é¡µè¡¨æ˜ å°„çš„å†…å­˜æ˜¯æŒ‰4kå¯¹é½çš„ï¼Œå³çº¿æ€§åœ°å€çš„ä¸€é¡µæ˜ å°„ç‰©ç†å†…å­˜ä¸€å¸§ã€‚è€Œä½œè€…ä¹‹å‰ç¼–å†™çš„<code>memman_alloc_4k</code>å‡½æ•°ä»…ä»…ä¿è¯äº†å†…å­˜åŒºåŸŸå¤§å°4kå¯¹é½ï¼Œå› æ­¤æˆ‘ä»¬è¦å¯¹è¯¥å‡½æ•°è¿›è¡Œä¿®æ”¹ï¼Œè®©å®ƒåˆ†é…çš„ç©ºé—´åœ¨åˆå§‹åœ°å€å’Œå†…å­˜å¤§å°éƒ½æŒ‰4kå¯¹é½ã€‚</p><p>é™¤äº†ç”¨æˆ·ç¨‹åºçš„é¡µè¡¨å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå†…æ ¸ç¨‹åºçš„é¡µè¡¨åŠ å…¥åˆ°ç”¨æˆ·æ€é¡µç›®å½•é‡Œé¢ï¼Œè¿™æ ·çš„è¯ï¼Œç”¨æˆ·æ€ç¨‹åºè°ƒç”¨å†…æ ¸ä¸­çš„apiæ‰§è¡Œå†…æ ¸ç¨‹åºæ—¶ï¼Œå°±ä¸ç”¨æ›´å˜CR3,ç›´æ¥ä»å½“å‰çš„taskï¼ˆå¸¦æœ‰æˆ‘ä»¬å‡†å¤‡çš„ç”¨æˆ·æ€é¡µç›®å½•ï¼‰é‡Œé¢æ˜ å°„åˆ°å†…æ ¸æ€çš„ä»£ç äº†</p><p>ç”¨æˆ·æ€taskçš„åˆ†é¡µï¼š</p><pre tabindex=0><code>cr3: 0x00000077e000
0x00000000-0x00000fff -&gt; 0x000020000000-0x000020000fff  /* ä½çº¿æ€§åœ°å€åŒºåŸŸç”¨æˆ·ç¨‹åº */
0xc0000000-0xdfffffff -&gt; 0x000000000000-0x00001fffffff  /* é«˜çº¿æ€§åœ°å€åŒºåŸŸå†…æ ¸ç¨‹åº */
0xe0000000-0xffffffff -&gt; 0x0000e0000000-0x0000ffffffff  /* é«˜çº¿æ€§åœ°å€åŒºåŸŸç¡¬ä»¶åŒºåŸŸ */
</code></pre><p>ç¼–å†™å‡½æ•°æ‰§è¡Œè¿™ä¸€æ‹·è´è¿‡ç¨‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>copy_page_de2de</span>(PAGE_DE<span style=color:#f92672>*</span> fromde, <span style=color:#66d9ef>int</span> fromstart, PAGE_DE<span style=color:#f92672>*</span> tode, <span style=color:#66d9ef>int</span> tostart, <span style=color:#66d9ef>int</span> count) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> count <span style=color:#f92672>&amp;&amp;</span> fromstart <span style=color:#f92672>+</span> i <span style=color:#f92672>&lt;</span> PAGE_DE_ENTRY_NUM <span style=color:#f92672>&amp;&amp;</span> tostart <span style=color:#f92672>+</span> i <span style=color:#f92672>&lt;</span> PAGE_DE_ENTRY_NUM; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>		tode<span style=color:#f92672>-&gt;</span>entrys[tostart <span style=color:#f92672>+</span> i] <span style=color:#f92672>=</span> fromde<span style=color:#f92672>-&gt;</span>entrys[fromstart <span style=color:#f92672>+</span> i];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¢åŠ ä¸¤é¡¹ç”¨æˆ·æ€çš„gdt</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>	set_segmdesc(gdt <span style=color:#f92672>+</span> ((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)__USER_CS <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>3</span>), <span style=color:#ae81ff>0xFFFFFFFF</span>, <span style=color:#ae81ff>0</span>, AR_CODE32_ER <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x60</span>);
</span></span><span style=display:flex><span>	set_segmdesc(gdt <span style=color:#f92672>+</span> ((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)__USER_DS <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>3</span>), <span style=color:#ae81ff>0xFFFFFFFF</span>, <span style=color:#ae81ff>0</span>, AR_DATA32_RW <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x60</span>);
</span></span></code></pre></div><p>ä»¥ç”¨æˆ·æ€è¿è¡Œæˆ‘ä»¬åŠ è½½çš„ç¨‹åº</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>	start_app(<span style=color:#ae81ff>0x1b</span>, __USER_CS, esp, __USER_DS, <span style=color:#f92672>&amp;</span>(task<span style=color:#f92672>-&gt;</span>tss.esp0));<span style=color:#75715e>// å…¥å£åœ°å€0x1b,é‚£é‡Œæ˜¯ä¸€ä¸ªjmpè·³æ¿
</span></span></span></code></pre></div><p>è¿è¡Œhello
<img src=/images/blog/os/21.png alt></p><p>å¯èƒ½ä¼šè´¨ç–‘å¦‚æœå°†å†…æ ¸çš„é¡µè¡¨æ”¾åˆ°ç”¨æˆ·æ€ç¨‹åºçš„é¡µç›®å½•é‡Œé¢ä¼šä¸ä¼šå¯¼è‡´ä»ç”¨æˆ·æ€ç›´æ¥è®¿é—®å†…æ ¸æ•°æ®ï¼Œæ¯•ç«Ÿæˆ‘ä»¬ç»•è¿‡äº†æ®µè¡¨ï¼Œæ®µè¡¨çš„limitå·²ç»ä¸èƒ½èµ·ä¿æŠ¤ä½œç”¨äº†ã€‚
å®é™…ä¸Šæ˜¯ä¸ç”¨æ‹…å¿ƒçš„ï¼Œå› ä¸ºå†…æ ¸é¡µè¡¨çš„flagä¸­è®¾å®šäº†Userä½ä¸º0ï¼Œåªå…è®¸å†…æ ¸æ€ä»£ç è®¿é—®ã€‚</p><p>ç¼–å†™ä»¥ä¸‹ç¨‹åº<code>touch_kernel.cpp</code>æ¥æµ‹è¯•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>HariMain</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span><span style=color:#f92672>*</span> kp <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0xC0000000</span>;
</span></span><span style=display:flex><span>	(<span style=color:#f92672>*</span>kp) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xFFFFFFFF</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/images/blog/os/22.png alt>
bochsæ£€æµ‹åˆ°äº†é¡µé”™è¯¯PE
<img src=/images/blog/os/23.png alt></p><p>è‡³æ­¤ï¼Œä¸è€ƒè™‘è™šæ‹Ÿå†…å­˜çš„ç”¨æˆ·æ€åˆ†é¡µå®ç°å®Œæˆ</p></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>Â© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡ - 2020042968å·</a></footer></body></html>