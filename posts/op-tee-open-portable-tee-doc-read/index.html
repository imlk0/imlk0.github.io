<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>OP-TEE: Open Portable TEE 概念梳理 | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>OP-TEE: Open Portable TEE 概念梳理</span></h1><span><span class=date>📅 2021-11-27</span>
<span class=date>(更新于2023-08-30)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/tee/>TEE</a></span>
/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/trustzone/>#TrustZone</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a>
<a href=https://blog.imlk.top/tags/reading/>#Reading</a></span></span><br></div><main class=post-content><h1 id=links>Links</h1><ul><li><a href=https://www.trustedfirmware.org/>https://www.trustedfirmware.org/</a> Linaro的介绍可信固件的网页</li><li><a href=https://www.op-tee.org/>https://www.op-tee.org/</a> OP-TEE官网</li><li><a href=https://github.com/OP-TEE/>https://github.com/OP-TEE/</a> OP-TEE仓库</li><li><a href=https://optee.readthedocs.io/en/latest/>https://optee.readthedocs.io/en/latest/</a> 文档</li><li><a href=https://www.kernel.org/doc/html/latest/staging/tee.html>https://www.kernel.org/doc/html/latest/staging/tee.html</a> Linux TEE subsystem</li></ul><h1 id=overview>Overview</h1><h2 id=architecture-in-armv8>Architecture (in ARMv8)</h2><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled.png alt=Untitled></p><ul><li><p>Definition</p><ul><li>CA：Client Application</li><li>TA：Trusted Applcation</li><li>TOS：Trusted OS（OP-TEE &mldr;）</li><li>REE：Rich Execute Environment</li><li>TEE：Trusted Execution Environment</li><li>ATF：ARM Trusted Firmware</li></ul></li><li><p>SMC(Secure Monitor Call) ，从Normal world EL1发起调用，进入EL3，然后跳转到Secure world</p></li><li><p>常见ARM启动流程</p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%201.png alt=Untitled></p></li></ul><h2 id=trustzone-hardware>Trustzone Hardware</h2><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%202.png alt=Untitled></p><ul><li>AXI(Advanced eXtensible Interface)：先进可扩展接口系统总线。TurstZone为其增加了一个额外的控制信号位称为<strong>非安全状态位（NS bit, Non-Secure bit）</strong><ul><li>AWPROT[1]：表示总线写事务是否安全（1表示不安全，0表示安全）</li><li>ARPROT[1]：表示总线读事务是否安全</li></ul></li><li>APB(Advanced Peripheral Bus，APB)：外设总线：APB通过AXI-to-APB桥连接到系统总线上。</li><li>TZASC(TrustZone Address Space Controller)TrustZone地址空间控制组件：一是AXI总线上的一个主设备，<strong>TZASC能够将从设备全部的地址空间分割成一系列的不同地址范围</strong>。</li><li>TZMA(TrustZone Memory Adapter)：TrustZone内存适配器组件。允许对片上静态内存（on-SoC Static Memory）或者片上ROM进行安全区域和非安全区域的划分。</li><li>TZPC(TrustZone Protection Controller)：TrustZone保护控制器组件。通过设定TZPCDECPORT信号和TZPCR0SIZE等相关控制信号，用来告知APB-to-AXI对应的外设是安全设备还是非安全设备</li><li>TZIC(TrustZone Interrupt Controller)：TrustZone中断控制器。TZIC的作用是让处理器处于非安全态时无法捕获到安全中断。</li></ul><h2 id=op-tee与liunx-tee-subsystem>OP-TEE与Liunx TEE subsystem</h2><ul><li><p>用户空间程序通过 <code>ioctl()</code>和Linux TEE子系统通信（CA和<code>/dev/tee*</code> , tee-supplicant和<code>/dev/teepriv*</code>），然后OP-TEE驱动使用SMC调用约定（SMC Calling Convention (SMCCC)，是一种使用 <code>smc</code> 汇编和安全世界通信的约定）和OP-TEE通信</p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%203.png alt=Untitled></p></li><li><p>目前Linux 的TEE子系统中包含对OP-TEE和AMD-TEE的支持，后者是AMD Platform Security Processor（PSP，AMD平台安全处理器，是一个arm处理器，被用于提供安全服务，与AMD SEV技术无关）</p></li></ul><h2 id=globalplatform-api><strong>GlobalPlatform API</strong></h2><ul><li><p><strong>每个TA由一个UUID标识</strong></p></li><li><p><strong>TEE Client AP</strong>I: CA使用与TEE交互的API一共5个，一般调用顺序如下：</p><p>OP-TEE似乎未给normal world加载TA的能力</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>TEEC_InitializeContext</span>(...)
</span></span><span style=display:flex><span><span style=color:#a6e22e>TEEC_OpenSession</span>(...)
</span></span><span style=display:flex><span><span style=color:#a6e22e>TEEC_InvokeCommand</span>(...)
</span></span><span style=display:flex><span><span style=color:#a6e22e>TEEC_CloseSession</span>(...)
</span></span><span style=display:flex><span><span style=color:#a6e22e>TEEC_FinalizeContext</span>(...)
</span></span></code></pre></div><ul><li><p>在<code>TEEC_InvokeCommand()</code>中使用 <code>commandID</code>参数来标识待执行的命令，最多支持4个参数，每个参数的类型允许动态指定，可以是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Parameter Type Constants */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_NONE             0
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_VALUE_INPUT      1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_VALUE_OUTPUT     2
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_VALUE_INOUT      3
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_MEMREF_INPUT     5
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_MEMREF_OUTPUT    6
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TEE_PARAM_TYPE_MEMREF_INOUT     7
</span></span></span></code></pre></div></li></ul></li><li><p>TEE Contexts：被用于创建CA和TEE之间的逻辑链接，需在TEE Session之前创建，当CA完成了在secure world运行的任务之后，它应该释放掉该context.</p></li><li><p>TEE Sessions：CA和某个特定的TA之间的逻辑链接，这意味着CA和某个特定的TA之间的通信已经创建</p></li><li><p>**TEE Internal Core API：**提供给TA使用，主要包括以下功能</p><pre tabindex=0><code>1. **Trusted Storage API for Data and Keys**
2. Cryptographic Operations API
3. Time API
4. Arithmetical API
</code></pre><ul><li>其中可信存储允许存储普通Data和Keys，<strong>每个存储的Object由一个Id标识</strong>。<ul><li>存储类型可以被指定为<ul><li>瞬态（Transient）：存储于内存中</li><li>持久化（Persistent）：可以被同一TA再次加载，要求可以通过恢复出厂设置被清除</li></ul></li><li>OP-TEE在实现过程中，持久化数据的存储有两种位置：<a href=https://optee.readthedocs.io/en/latest/architecture/secure_storage.html>参见</a><ul><li><code>TEE_STORAGE_PRIVATE_REE</code>存储到REE的文件系统中，由在REE用户态运行的 <code>tee-supplicant</code>来辅助完成</li><li><code>TEE_STORAGE_PRIVATE_RPMB</code>存储到eMMC设备的 <strong>Replay Protected Memory Block (RPMB，重放保护存储块)</strong> 。RPMB 可对写入操作进行鉴权，但是读取并不需要鉴权，<strong>任何人都可以进行读取</strong>的操作，因此存储到 RPMB 的数据通常会<strong>进行加密后再存储</strong>。<ul><li>对于RPMB存储，其secure key是只能写入一次的OTP，该key从HUK派生，在安全环境（如厂商）中写入</li><li>在实际使用中对RPMB的读写需要由不安全世界的tee-supplicant进行辅助，<a href=https://optee.readthedocs.io/en/latest/architecture/secure_storage.html#device-access>见</a></li><li>qemu暂不支持模拟RPMB硬件，但tee-supplicant中实现了对RPMB的模拟</li></ul></li><li>还有一个<code>TEE_STORAGE_PRIVATE</code>选项会自动从上面两种位置进行选择一种</li></ul></li></ul></li></ul></li></ul><h3 id=op-tee的密钥管理参考httpsopteereadthedocsioenlatestarchitecturesecure_storagehtmlkey-manager>OP-TEE的密钥管理（<a href=https://optee.readthedocs.io/en/latest/architecture/secure_storage.html#key-manager>参考</a>）</h3><ul><li><p><strong>Hardware Unique Key (HUK)硬件唯一密钥</strong>，<a href=https://optee.readthedocs.io/en/latest/architecture/porting_guidelines.html#hardware-unique-key>参考</a></p><p>是每个设备唯一的密钥，用于派生出其他密钥。OP-TEE中没有具体定义其获取方式（默认的值为全0数组），这意味着它可能是<strong>由另一个安全处理器提供</strong>。</p></li><li><p><strong>Secure Storage Key (SSK)安全存储密钥</strong></p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%204.png alt=Untitled></p><p>在OP-TEE启动后从HUK中派生，保存在安全内存（secure memory）中，永远不存储到disk中。这似乎意味着SSK在每次系统启动后都会是一样的值。</p><p>其中HUK和Chip ID的获取取决于平台实现。</p></li><li><p><strong>Trusted Application Storage Key (TSK)可信应用安全存储密钥</strong></p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%205.png alt=Untitled></p><p>每个TA一个，通过SSK和TA_UUID派生，这保证了TA加密的数据无法被别的TA解密。</p><p>由于SSK是不变的，这种派生似乎意味着TSK对于每个TA始终都是一样的。</p></li><li><p><strong>File Encryption Key (FEK) 文件加密密钥</strong></p><p>这个密钥通过伪随机数产生，用于加密/解密存储在文件块（file block）中的数据。同时FEK自身通过TSK加密后存储在元文件（meta file）中</p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%206.png alt=Untitled></p></li></ul><h2 id=rpmb-in-emmc>RPMB in eMMC</h2><ul><li>RPMB 「Replay Protected Memory Block(重放保护内存块)」是eMMC中的一个特别的分区，使用计数器来防止重放攻击（每写入一次计数器加一），允许通过共享密钥的写入保护，其中内容可以任意读取，因此需要先加密后再写入。</li><li>基本原理<ul><li><p>预共享密钥（authentication/security key）</p><ul><li>RPMB 加密用的security key是对称密钥，只能被写入一次（one-time programmable），通常在安全环境下（如出厂时）烧写到 eMMC 的 OTP 区域</li></ul></li><li><p>基于消息验证码MAC对请求/响应进行验证</p><ul><li><p>HMAC SHA-256</p></li><li><p>将[283:0]范围内的内容使用预共享的密钥进行加密</p></li><li><p>读操作的请求帧不需要MAC值（填0x0），但是读操作的响应帧会提供MAC值进行验证</p><p><img src=/images/OP-TEE%20Open%20Portable%20TEE%20a9aa1234bc2646449c45b2bbb557ed52/Untitled%207.png alt=RPMB请求/响应帧格式></p><p>RPMB请求/响应帧格式</p></li></ul></li><li><p>基于write counter的防止写重放</p><ul><li>write counter也参与到MAC值的校验过程中，检验完成后。会比较帧中的write counter和硬件中记录的counter是否一致。否则拒绝写入并失败</li><li>读请求的reply中write counter值为0</li><li>writer counter的值可以被读出</li></ul></li></ul></li><li>RPMB分区可以使用 <code>mmc</code>工具进行访问</li><li>参考<ul><li><a href=https://wowothink.com/8ca78fd8/>RPMB介绍与使用</a></li><li><a href=https://blog.csdn.net/shenjin_s/article/details/79868375>RPMB原理介绍</a></li><li><a href=https://www.jedec.org/sites/default/files/docs/JESD84-B51.pdf>JEDEC eMMC specification (JESD84-B51)</a>（登陆后可免费下载）</li></ul></li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>