<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>从QSDK源码编译RAX3000Q所需的软件包 | imlk's blog</title>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet>
</head>
<body>
<header class=header>
<a class=logo href=/> imlk's Blog </a>
<nav>
<ul class=menu>
<li><a href=/>Home</a></li>
<li><a href=/about/>About</a></li>
<li><a href=/archives/>Archives</a></li>
<li><a href=/friends/>Friends</a></li>
<li><a href=/index.xml>Subscribe</a></li>
</ul>
</nav>
</header>
<hr>
<div class=article-meta>
<h1><span class=title>从QSDK源码编译RAX3000Q所需的软件包</span></h1>
<span>
<span class=date>2022-02-10</span>
|
<span class=cats>
<a href=https://blog.imlk.top/categories/router/>Router</a>
</span>
|
<span class=tags>
<a href=https://blog.imlk.top/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/>#路由器</a>
<a href=https://blog.imlk.top/tags/openwrt/>#OpenWrt</a>
</span>
</span>
<br>
</div>
<main>
<p>前一篇文章中讲到了如何开启RAX3000Q的ssh，并且发现其固件正是QSDK，但是并没有妥善解决软件包的问题，这一次我们尝试基于QSDK源码编译我们想要的软件包的ipk文件。</p>
<p>实践过程也是参考了很多网上的关于QSDK的文章。</p>
<p>我是在docker容器中构建的，环境是Ubuntu 20.04 （dockerhub上的<code>ubuntu:latest</code>），对于其他发行版如ArchLinux，在编译时可能需要解决宿主机上openssl头文件版本的问题，且本文中提到的patch可能不再适用。</p>
<h1 id=获取源码>获取源码</h1>
<p>QSDK的源码管理类似于Android和ChromeOS，也基于<a href=https://gerrit.googlesource.com/git-repo/+/HEAD/README.md><code>repo</code>工具</a>，在开始之前需要先安装好<code>repo</code>。</p>
<p>QSDK的manifest文件存放在<a href=https://source.codeaurora.org/quic/cc-qrdk/releases/manifest/qstak/>这个仓库</a>中，只有一个名为<code>release</code>的branch。在之前的分析中知道该路由器Openwrt版本为15.05和kernel版本为4.4，结合<a href=https://wiki.codeaurora.org/xwiki/bin/viewrev/QSDK/WebHome>QSDK的wiki</a>，我选择了主版本号为11的QSDK的最新的manifest文件：<code>caf_AU_LINUX_QSDK_NHSS.QSDK.11.5.0.6_TARGET_ALL.11.5.0.6.055.xml</code>。</p>
<p>使用如下语句获取源码并初始化</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>repo init -u git://source.codeaurora.org/quic/cc-qrdk/releases/manifest/qstak -b release -m caf_AU_LINUX_QSDK_NHSS.QSDK.11.5.0.6_TARGET_ALL.11.5.0.6.055.xml
repo sync
</code></pre></div><blockquote>
<p>请勿选择<code>caf_AU_LINUX_QSDK_NHSS.QSDK.12.0.R9_TARGET_ALL.12.0.09.841.011.xml</code>，测试发现其中的linux版本为5.4，且musl-libc版本与当前固件中的不符。</p>
</blockquote>
<p>因为编译环境的问题，编译过程中（尤其是构建toolchain时）会导致很多error产生，在开始之前需要进行一些修改，这些修改多数是增加一些.patch文件，或者是对Makefile的一些改动。</p>
<p>其中大部分改动参考了<a href=https://www.litreily.top/2021/02/07/qsdk-compile>这篇文章</a></p>
<ul>
<li>
<p>qsdk/</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>diff --git a/toolchain/gcc/patches/5.2.0/999-fix-too-many-template-parameters.patch b/toolchain/gcc/patches/5.2.0/999-fix-too-many-template-parameters.patch
new file mode 100644
index 000000000000..cab030714d2b
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/toolchain/gcc/patches/5.2.0/999-fix-too-many-template-parameters.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,94 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+From 94801184df727b94bf7b8d64b1f98a22f51325d7 Mon Sep 17 00:00:00 2001
</span><span style=color:#a6e22e>+From: Elliot Saba &lt;staticfloat@gmail.com&gt;
</span><span style=color:#a6e22e>+Date: Mon, 22 Apr 2019 19:58:09 -0400
</span><span style=color:#a6e22e>+Subject: [PATCH] Remove double `tempate &lt;&gt;` declarations in `wide-int.h`
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+This fixes compilation of GCC 5.2.0 with very recent compilers such as
</span><span style=color:#a6e22e>+GCC 8.3.0, which would otherwise fail with errors such as `error: too
</span><span style=color:#a6e22e>+many template-parameter-lists`
</span><span style=color:#a6e22e>+---
</span><span style=color:#a6e22e>+ gcc/wide-int.h | 10 ----------
</span><span style=color:#a6e22e>+ 1 file changed, 10 deletions(-)
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+diff --git a/gcc/wide-int.h b/gcc/wide-int.h
</span><span style=color:#a6e22e>+index 46f45453c015..9a71c4fea61b 100644
</span><span style=color:#a6e22e>+--- a/gcc/wide-int.h
</span><span style=color:#a6e22e>++++ b/gcc/wide-int.h
</span><span style=color:#a6e22e>+@@ -365,21 +365,18 @@ namespace wi
</span><span style=color:#a6e22e>+      inputs.  Note that CONST_PRECISION and VAR_PRECISION cannot be
</span><span style=color:#a6e22e>+      mixed, in order to give stronger type checking.  When both inputs
</span><span style=color:#a6e22e>+      are CONST_PRECISION, they must have the same precision.  */
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, FLEXIBLE_PRECISION, FLEXIBLE_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+     typedef widest_int result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, FLEXIBLE_PRECISION, VAR_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+     typedef wide_int result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, FLEXIBLE_PRECISION, CONST_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+@@ -389,14 +386,12 @@ namespace wi
</span><span style=color:#a6e22e>+ 			       &lt;int_traits &lt;T2&gt;::precision&gt; &gt; result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, VAR_PRECISION, FLEXIBLE_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+     typedef wide_int result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, CONST_PRECISION, FLEXIBLE_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+@@ -406,7 +401,6 @@ namespace wi
</span><span style=color:#a6e22e>+ 			       &lt;int_traits &lt;T1&gt;::precision&gt; &gt; result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, CONST_PRECISION, CONST_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+@@ -417,7 +411,6 @@ namespace wi
</span><span style=color:#a6e22e>+ 			       &lt;int_traits &lt;T1&gt;::precision&gt; &gt; result_type;
</span><span style=color:#a6e22e>+   };
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename T1, typename T2&gt;
</span><span style=color:#a6e22e>+   struct binary_traits &lt;T1, T2, VAR_PRECISION, VAR_PRECISION&gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+@@ -881,7 +874,6 @@ generic_wide_int &lt;storage&gt;::dump () const
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ namespace wi
</span><span style=color:#a6e22e>+ {
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;typename storage&gt;
</span><span style=color:#a6e22e>+   struct int_traits &lt; generic_wide_int &lt;storage&gt; &gt;
</span><span style=color:#a6e22e>+     : public wi::int_traits &lt;storage&gt;
</span><span style=color:#a6e22e>+@@ -960,7 +952,6 @@ inline wide_int_ref_storage &lt;SE&gt;::wide_int_ref_storage (const T &amp;x,
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ namespace wi
</span><span style=color:#a6e22e>+ {
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;bool SE&gt;
</span><span style=color:#a6e22e>+   struct int_traits &lt;wide_int_ref_storage &lt;SE&gt; &gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+@@ -1147,7 +1138,6 @@ class GTY(()) fixed_wide_int_storage
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ namespace wi
</span><span style=color:#a6e22e>+ {
</span><span style=color:#a6e22e>+-  template &lt;&gt;
</span><span style=color:#a6e22e>+   template &lt;int N&gt;
</span><span style=color:#a6e22e>+   struct int_traits &lt; fixed_wide_int_storage &lt;N&gt; &gt;
</span><span style=color:#a6e22e>+   {
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e></span>diff --git a/tools/bison/patches/001-fix-port-gnulib.patch b/tools/bison/patches/001-fix-port-gnulib.patch
new file mode 100644
index 000000000000..499d73a2666d
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/bison/patches/001-fix-port-gnulib.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,11 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/lib/fseterr.c  2022-02-10 13:17:52.129083732 +0800
</span><span style=color:#a6e22e>++++ b/lib/fseterr.c  2022-02-10 13:23:49.408599169 +0800
</span><span style=color:#a6e22e>+@@ -29,7 +29,7 @@
</span><span style=color:#a6e22e>+   /* Most systems provide FILE as a struct and the necessary bitmask in
</span><span style=color:#a6e22e>+      &lt;stdio.h&gt;, because they need it for implementing getc() and putc() as
</span><span style=color:#a6e22e>+      fast macros.  */
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   fp-&gt;_flags |= _IO_ERR_SEEN;
</span><span style=color:#a6e22e>+ #elif defined __sferror || defined __DragonFly__ /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin */
</span><span style=color:#a6e22e>+   fp_-&gt;_flags |= __SERR;
</span><span style=color:#a6e22e></span>diff --git a/tools/e2fsprogs/patches/001-fix-undefined-reference-makedev.patch b/tools/e2fsprogs/patches/001-fix-undefined-reference-makedev.patch
new file mode 100644
index 000000000000..2c059b4ea072
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/e2fsprogs/patches/001-fix-undefined-reference-makedev.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,9 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/lib/blkid/devname.c 2021-02-07 16:04:24.190214251 +0800
</span><span style=color:#a6e22e>++++ b/lib/blkid/devname.c 2021-02-07 16:03:53.869128549 +0800
</span><span style=color:#a6e22e>+@@ -37,6 +37,7 @@
</span><span style=color:#a6e22e>+ #include &lt;sys/mkdev.h&gt;
</span><span style=color:#a6e22e>+ #endif
</span><span style=color:#a6e22e>+ #include &lt;time.h&gt;
</span><span style=color:#a6e22e>++#include &lt;sys/sysmacros.h&gt;
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ #include &#34;blkidP.h&#34;
</span><span style=color:#a6e22e></span>\ No newline at end of file
diff --git a/tools/findutils/patches/001-fix-port-gnulib.patch b/tools/findutils/patches/001-fix-port-gnulib.patch
new file mode 100644
index 000000000000..f164d776ba24
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/findutils/patches/001-fix-port-gnulib.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,33 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/gnulib/lib/freadahead.c    2008-04-17 01:55:14.000000000 +0200
</span><span style=color:#a6e22e>++++ b/gnulib/lib/freadahead.c    2008-04-17 01:54:36.000000000 +0200
</span><span style=color:#a6e22e>+@@ -22,7 +22,7 @@
</span><span style=color:#a6e22e>+ size_t
</span><span style=color:#a6e22e>+ freadahead (FILE *fp)
</span><span style=color:#a6e22e>+ {
</span><span style=color:#a6e22e>+-#if defined _IO_ferror_unlocked     /* GNU libc, BeOS */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || defined _IO_ferror_unlocked || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Linux libc5 */
</span><span style=color:#a6e22e>+   if (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)
</span><span style=color:#a6e22e>+     return 0;
</span><span style=color:#a6e22e>+   return (fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr)
</span><span style=color:#a6e22e>+--- a/gnulib/lib/freading.c      2008-04-17 01:55:14.000000000 +0200
</span><span style=color:#a6e22e>++++ b/gnulib/lib/freading.c      2008-04-17 01:54:36.000000000 +0200
</span><span style=color:#a6e22e>+@@ -29,7 +29,7 @@
</span><span style=color:#a6e22e>+   /* Most systems provide FILE as a struct and the necessary bitmask in
</span><span style=color:#a6e22e>+      &lt;stdio.h&gt;, because they need it for implementing getc() and putc() as
</span><span style=color:#a6e22e>+      fast macros.  */
</span><span style=color:#a6e22e>+-#if defined _IO_ferror_unlocked     /* GNU libc, BeOS */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || defined _IO_ferror_unlocked || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Linux libc5 */
</span><span style=color:#a6e22e>+   return ((fp-&gt;_flags &amp; _IO_NO_WRITES) != 0
</span><span style=color:#a6e22e>+          || ((fp-&gt;_flags &amp; (_IO_NO_READS | _IO_CURRENTLY_PUTTING)) == 0
</span><span style=color:#a6e22e>+              &amp;&amp; fp-&gt;_IO_read_base != NULL));
</span><span style=color:#a6e22e>+--- a/gnulib/lib/fseeko.c        2008-04-17 01:55:14.000000000 +0200
</span><span style=color:#a6e22e>++++ b/gnulib/lib/fseeko.c        2008-04-17 01:54:36.000000000 +0200
</span><span style=color:#a6e22e>+@@ -39,7 +39,7 @@
</span><span style=color:#a6e22e>+ #endif
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   /* These tests are based on fpurge.c.  */
</span><span style=color:#a6e22e>+-#if defined _IO_ferror_unlocked     /* GNU libc, BeOS */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || defined _IO_ferror_unlocked || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Linux libc5 */
</span><span style=color:#a6e22e>+   if (fp-&gt;_IO_read_end == fp-&gt;_IO_read_ptr
</span><span style=color:#a6e22e>+       &amp;&amp; fp-&gt;_IO_write_ptr == fp-&gt;_IO_write_base
</span><span style=color:#a6e22e>+       &amp;&amp; fp-&gt;_IO_save_base == NULL)
</span><span style=color:#a6e22e></span>diff --git a/tools/m4/patches/200-fix-port-gnulib-freadahead.patch b/tools/m4/patches/200-fix-port-gnulib-freadahead.patch
new file mode 100644
index 000000000000..9501b4fc7788
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/m4/patches/200-fix-port-gnulib-freadahead.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,109 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+diff --git a/lib/fflush.c b/lib/fflush.c
</span><span style=color:#a6e22e>+index 983ade0ffb..a6edfa105b 100644
</span><span style=color:#a6e22e>+--- a/lib/fflush.c
</span><span style=color:#a6e22e>++++ b/lib/fflush.c
</span><span style=color:#a6e22e>+@@ -33,7 +33,7 @@
</span><span style=color:#a6e22e>+ #undef fflush
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ /* Clear the stream&#39;s ungetc buffer, preserving the value of ftello (fp).  */
</span><span style=color:#a6e22e>+ static void
</span><span style=color:#a6e22e>+@@ -72,7 +72,7 @@ clear_ungetc_buffer (FILE *fp)
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ #endif
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-#if ! (defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */)
</span><span style=color:#a6e22e>++#if ! (defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */)
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ # if (defined __sferror || defined __DragonFly__ || defined __ANDROID__) &amp;&amp; defined __SNPT
</span><span style=color:#a6e22e>+ /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin, Minix 3, Android */
</span><span style=color:#a6e22e>+@@ -148,7 +148,7 @@ rpl_fflush (FILE *stream)
</span><span style=color:#a6e22e>+   if (stream == NULL || ! freading (stream))
</span><span style=color:#a6e22e>+     return fflush (stream);
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   clear_ungetc_buffer_preserving_position (stream);
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+diff --git a/lib/fpurge.c b/lib/fpurge.c
</span><span style=color:#a6e22e>+index b1d417c7a2..3aedcc3734 100644
</span><span style=color:#a6e22e>+--- a/lib/fpurge.c
</span><span style=color:#a6e22e>++++ b/lib/fpurge.c
</span><span style=color:#a6e22e>+@@ -62,7 +62,7 @@ fpurge (FILE *fp)
</span><span style=color:#a6e22e>+   /* Most systems provide FILE as a struct and the necessary bitmask in
</span><span style=color:#a6e22e>+      &lt;stdio.h&gt;, because they need it for implementing getc() and putc() as
</span><span style=color:#a6e22e>+      fast macros.  */
</span><span style=color:#a6e22e>+-# if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++# if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   fp-&gt;_IO_read_end = fp-&gt;_IO_read_ptr;
</span><span style=color:#a6e22e>+   fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_base;
</span><span style=color:#a6e22e>+   /* Avoid memory leak when there is an active ungetc buffer.  */
</span><span style=color:#a6e22e>+diff --git a/lib/freadahead.c b/lib/freadahead.c
</span><span style=color:#a6e22e>+index c2ecb5b28a..23ec76ee53 100644
</span><span style=color:#a6e22e>+--- a/lib/freadahead.c
</span><span style=color:#a6e22e>++++ b/lib/freadahead.c
</span><span style=color:#a6e22e>+@@ -30,7 +30,7 @@ extern size_t __sreadahead (FILE *);
</span><span style=color:#a6e22e>+ size_t
</span><span style=color:#a6e22e>+ freadahead (FILE *fp)
</span><span style=color:#a6e22e>+ {
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   if (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)
</span><span style=color:#a6e22e>+     return 0;
</span><span style=color:#a6e22e>+   return (fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr)
</span><span style=color:#a6e22e>+diff --git a/lib/freading.c b/lib/freading.c
</span><span style=color:#a6e22e>+index 73c28acddf..c24d0c88ab 100644
</span><span style=color:#a6e22e>+--- a/lib/freading.c
</span><span style=color:#a6e22e>++++ b/lib/freading.c
</span><span style=color:#a6e22e>+@@ -31,7 +31,7 @@ freading (FILE *fp)
</span><span style=color:#a6e22e>+   /* Most systems provide FILE as a struct and the necessary bitmask in
</span><span style=color:#a6e22e>+      &lt;stdio.h&gt;, because they need it for implementing getc() and putc() as
</span><span style=color:#a6e22e>+      fast macros.  */
</span><span style=color:#a6e22e>+-# if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++# if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   return ((fp-&gt;_flags &amp; _IO_NO_WRITES) != 0
</span><span style=color:#a6e22e>+           || ((fp-&gt;_flags &amp; (_IO_NO_READS | _IO_CURRENTLY_PUTTING)) == 0
</span><span style=color:#a6e22e>+               &amp;&amp; fp-&gt;_IO_read_base != NULL));
</span><span style=color:#a6e22e>+diff --git a/lib/fseeko.c b/lib/fseeko.c
</span><span style=color:#a6e22e>+index 0101ab55f7..193f4e8ce5 100644
</span><span style=color:#a6e22e>+--- a/lib/fseeko.c
</span><span style=color:#a6e22e>++++ b/lib/fseeko.c
</span><span style=color:#a6e22e>+@@ -47,7 +47,7 @@ fseeko (FILE *fp, off_t offset, int whence)
</span><span style=color:#a6e22e>+ #endif
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   /* These tests are based on fpurge.c.  */
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   if (fp-&gt;_IO_read_end == fp-&gt;_IO_read_ptr
</span><span style=color:#a6e22e>+       &amp;&amp; fp-&gt;_IO_write_ptr == fp-&gt;_IO_write_base
</span><span style=color:#a6e22e>+       &amp;&amp; fp-&gt;_IO_save_base == NULL)
</span><span style=color:#a6e22e>+@@ -123,7 +123,7 @@ fseeko (FILE *fp, off_t offset, int whence)
</span><span style=color:#a6e22e>+           return -1;
</span><span style=color:#a6e22e>+         }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+       fp-&gt;_flags &amp;= ~_IO_EOF_SEEN;
</span><span style=color:#a6e22e>+       fp-&gt;_offset = pos;
</span><span style=color:#a6e22e>+ #elif defined __sferror || defined __DragonFly__ || defined __ANDROID__
</span><span style=color:#a6e22e>+diff --git a/lib/stdio-impl.h b/lib/stdio-impl.h
</span><span style=color:#a6e22e>+index 78d896e9f5..05c5752a24 100644
</span><span style=color:#a6e22e>+--- a/lib/stdio-impl.h
</span><span style=color:#a6e22e>++++ b/lib/stdio-impl.h
</span><span style=color:#a6e22e>+@@ -18,6 +18,12 @@
</span><span style=color:#a6e22e>+    the same implementation of stdio extension API, except that some fields
</span><span style=color:#a6e22e>+    have different naming conventions, or their access requires some casts.  */
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>++/* Glibc 2.28 made _IO_IN_BACKUP private.  For now, work around this
</span><span style=color:#a6e22e>++   problem by defining it ourselves.  FIXME: Do not rely on glibc
</span><span style=color:#a6e22e>++   internals.  */
</span><span style=color:#a6e22e>++#if !defined _IO_IN_BACKUP &amp;&amp; defined _IO_EOF_SEEN
</span><span style=color:#a6e22e>++# define _IO_IN_BACKUP 0x100
</span><span style=color:#a6e22e>++#endif
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ /* BSD stdio derived implementations.  */
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e></span>diff --git a/tools/make-ext4fs/patches/001-fix-undefined-reference-major-minor.patch b/tools/make-ext4fs/patches/001-fix-undefined-reference-major-minor.patch
new file mode 100644
index 000000000000..8ee8929c1416
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/make-ext4fs/patches/001-fix-undefined-reference-major-minor.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,9 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/contents.c        2021-02-07 15:37:31.463251930 +0800
</span><span style=color:#a6e22e>++++ b/contents.c        2021-02-07 15:37:03.022743240 +0800
</span><span style=color:#a6e22e>+@@ -15,6 +15,7 @@
</span><span style=color:#a6e22e>+  */
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ #include &lt;sys/stat.h&gt;
</span><span style=color:#a6e22e>++#include &lt;sys/sysmacros.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;string.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;stdio.h&gt;
</span><span style=color:#a6e22e></span>\ No newline at end of file
diff --git a/tools/mtd-utils/patches/001-fix-missing-header-file-sys-sysmacros.patch b/tools/mtd-utils/patches/001-fix-missing-header-file-sys-sysmacros.patch
new file mode 100644
index 000000000000..d3e586803835
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/mtd-utils/patches/001-fix-missing-header-file-sys-sysmacros.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,10 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/include/common.h  2021-02-07 16:25:50.643801767 +0800
</span><span style=color:#a6e22e>++++ b/include/common.h  2021-02-07 16:25:41.139803836 +0800
</span><span style=color:#a6e22e>+@@ -19,6 +19,7 @@
</span><span style=color:#a6e22e>+ #ifndef __MTD_UTILS_COMMON_H__
</span><span style=color:#a6e22e>+ #define __MTD_UTILS_COMMON_H__
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>++#include &lt;sys/sysmacros.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;stdbool.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;stdio.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;stdlib.h&gt;
</span><span style=color:#a6e22e></span>\ No newline at end of file
diff --git a/tools/sed/patches/001-fix-port-gnulib.patch b/tools/sed/patches/001-fix-port-gnulib.patch
new file mode 100644
index 000000000000..a3fd8709482f
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/sed/patches/001-fix-port-gnulib.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,11 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/lib/fwriting.c     2012-09-13 14:58:19.000000000 +0800
</span><span style=color:#a6e22e>++++ b/lib/fwriting.c     2022-02-10 13:28:31.221698961 +0800
</span><span style=color:#a6e22e>+@@ -27,7 +27,7 @@
</span><span style=color:#a6e22e>+   /* Most systems provide FILE as a struct and the necessary bitmask in
</span><span style=color:#a6e22e>+      &lt;stdio.h&gt;, because they need it for implementing getc() and putc() as
</span><span style=color:#a6e22e>+      fast macros.  */
</span><span style=color:#a6e22e>+-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>++#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
</span><span style=color:#a6e22e>+   return (fp-&gt;_flags &amp; (_IO_NO_READS | _IO_CURRENTLY_PUTTING)) != 0;
</span><span style=color:#a6e22e>+ #elif defined __sferror || defined __DragonFly__ /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin */
</span><span style=color:#a6e22e>+   return (fp_-&gt;_flags &amp; __SWR) != 0;
</span><span style=color:#a6e22e></span>diff --git a/tools/squashfs4/Makefile b/tools/squashfs4/Makefile
index 50b70fbe1c90..fe292de0960b 100644
<span style=color:#f92672>--- a/tools/squashfs4/Makefile
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/squashfs4/Makefile
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -24,7 +24,7 @@ define Host/Compile
</span><span style=color:#75715e></span> 		XZ_SUPPORT=1 \
 		LZMA_XZ_SUPPORT=1 \
 		XATTR_SUPPORT= \
<span style=color:#f92672>-		LZMA_LIB=&#34;$(STAGING_DIR_HOST)/lib/liblzma.a&#34; \
</span><span style=color:#f92672></span><span style=color:#a6e22e>+		LZMA_LIB=&#34;$(STAGING_DIR_HOST)/lib/liblzma.a -lmd&#34; \
</span><span style=color:#a6e22e></span> 		EXTRA_CFLAGS=&#34;-I$(STAGING_DIR_HOST)/include&#34; \
 		mksquashfs unsquashfs
 endef
diff --git a/tools/squashfs4/patches/001-fix-undefined-reference-major.patch b/tools/squashfs4/patches/001-fix-undefined-reference-major.patch
new file mode 100644
index 000000000000..89b065d95bff
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/squashfs4/patches/001-fix-undefined-reference-major.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,20 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/squashfs-tools/mksquashfs.c       2021-02-08 10:08:42.135709202 +0800
</span><span style=color:#a6e22e>++++ b/squashfs-tools/mksquashfs.c       2021-02-08 10:09:03.263649419 +0800
</span><span style=color:#a6e22e>+@@ -52,6 +52,7 @@
</span><span style=color:#a6e22e>+ #include &lt;regex.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;fnmatch.h&gt;
</span><span style=color:#a6e22e>+ #include &lt;sys/wait.h&gt;
</span><span style=color:#a6e22e>++#include &lt;sys/sysmacros.h&gt;
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ #ifndef linux
</span><span style=color:#a6e22e>+ #ifndef __CYGWIN__
</span><span style=color:#a6e22e>+--- a/squashfs-tools/unsquashfs.c       2021-02-08 10:08:48.335691509 +0800
</span><span style=color:#a6e22e>++++ b/squashfs-tools/unsquashfs.c       2021-02-08 10:09:24.919589603 +0800
</span><span style=color:#a6e22e>+@@ -30,6 +30,7 @@
</span><span style=color:#a6e22e>+ #include &#34;xattr.h&#34;
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ #include &lt;sys/types.h&gt;
</span><span style=color:#a6e22e>++#include &lt;sys/sysmacros.h&gt;
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ struct cache *fragment_cache, *data_cache;
</span><span style=color:#a6e22e>+ struct queue *to_reader, *to_deflate, *to_writer, *from_writer;
</span><span style=color:#a6e22e></span>\ No newline at end of file

</code></pre></div></li>
<li>
<p>qsdk/qca/feeds/packages/</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>diff --git a/libs/libgpg-error/patches/020-gawk5-support.patch b/libs/libgpg-error/patches/020-gawk5-support.patch
new file mode 100644
index 0000000000..218d097498
<span style=color:#f92672>--- /dev/null
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/libs/libgpg-error/patches/020-gawk5-support.patch
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -0,0 +1,124 @@
</span><span style=color:#75715e></span><span style=color:#a6e22e>+--- a/lang/cl/mkerrcodes.awk
</span><span style=color:#a6e22e>++++ b/lang/cl/mkerrcodes.awk
</span><span style=color:#a6e22e>+@@ -122,7 +122,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+--- a/src/Makefile.am
</span><span style=color:#a6e22e>++++ b/src/Makefile.am
</span><span style=color:#a6e22e>+@@ -293,7 +293,7 @@ code-from-errno.h: mkerrcodes$(EXEEXT_FOR_BUILD) Makefile
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ errnos-sym.h: Makefile mkstrtable.awk errnos.in
</span><span style=color:#a6e22e>+ 	$(AWK) -f $(srcdir)/mkstrtable.awk -v textidx=2 -v nogettext=1 \
</span><span style=color:#a6e22e>+-		-v prefix=GPG_ERR_ -v namespace=errnos_ \
</span><span style=color:#a6e22e>++		-v prefix=GPG_ERR_ -v pkg_namespace=errnos_ \
</span><span style=color:#a6e22e>+ 		$(srcdir)/errnos.in &gt;$@
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+--- a/src/Makefile.in	2022-02-10 19:51:36.848145191 +0800
</span><span style=color:#a6e22e>++++ b/src/Makefile.in	2022-02-10 20:04:18.368259432 +0800
</span><span style=color:#a6e22e>+@@ -1018,7 +1018,7 @@
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ errnos-sym.h: Makefile mkstrtable.awk errnos.in
</span><span style=color:#a6e22e>+ 	$(AWK) -f $(srcdir)/mkstrtable.awk -v textidx=2 -v nogettext=1 \
</span><span style=color:#a6e22e>+-		-v prefix=GPG_ERR_ -v namespace=errnos_ \
</span><span style=color:#a6e22e>++		-v prefix=GPG_ERR_ -v pkg_namespace=errnos_ \
</span><span style=color:#a6e22e>+ 		$(srcdir)/errnos.in &gt;$@
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ # We depend on versioninfo.rc because that is build by config.status
</span><span style=color:#a6e22e>+--- a/src/mkerrcodes.awk
</span><span style=color:#a6e22e>++++ b/src/mkerrcodes.awk
</span><span style=color:#a6e22e>+@@ -85,7 +85,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+--- a/src/mkerrcodes1.awk
</span><span style=color:#a6e22e>++++ b/src/mkerrcodes1.awk
</span><span style=color:#a6e22e>+@@ -81,7 +81,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+--- a/src/mkerrcodes2.awk
</span><span style=color:#a6e22e>++++ b/src/mkerrcodes2.awk
</span><span style=color:#a6e22e>+@@ -91,7 +91,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+--- a/src/mkerrnos.awk
</span><span style=color:#a6e22e>++++ b/src/mkerrnos.awk
</span><span style=color:#a6e22e>+@@ -83,7 +83,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+--- a/src/mkstrtable.awk
</span><span style=color:#a6e22e>++++ b/src/mkstrtable.awk
</span><span style=color:#a6e22e>+@@ -77,7 +77,7 @@
</span><span style=color:#a6e22e>+ #
</span><span style=color:#a6e22e>+ # The variable prefix can be used to prepend a string to each message.
</span><span style=color:#a6e22e>+ #
</span><span style=color:#a6e22e>+-# The variable namespace can be used to prepend a string to each
</span><span style=color:#a6e22e>++# The variable pkg_namespace can be used to prepend a string to each
</span><span style=color:#a6e22e>+ # variable and macro name.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ BEGIN {
</span><span style=color:#a6e22e>+@@ -102,7 +102,7 @@ header {
</span><span style=color:#a6e22e>+       print &#34;/* The purpose of this complex string table is to produce&#34;;
</span><span style=color:#a6e22e>+       print &#34;   optimal code with a minimum of relocations.  */&#34;;
</span><span style=color:#a6e22e>+       print &#34;&#34;;
</span><span style=color:#a6e22e>+-      print &#34;static const char &#34; namespace &#34;msgstr[] = &#34;;
</span><span style=color:#a6e22e>++      print &#34;static const char &#34; pkg_namespace &#34;msgstr[] = &#34;;
</span><span style=color:#a6e22e>+       header = 0;
</span><span style=color:#a6e22e>+     }
</span><span style=color:#a6e22e>+   else
</span><span style=color:#a6e22e>+@@ -110,7 +110,7 @@ header {
</span><span style=color:#a6e22e>+ }
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+ !header {
</span><span style=color:#a6e22e>+-  sub (/\#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>++  sub (/#.+/, &#34;&#34;);
</span><span style=color:#a6e22e>+   sub (/[ 	]+$/, &#34;&#34;); # Strip trailing space and tab characters.
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e>+   if (/^$/)
</span><span style=color:#a6e22e>+@@ -150,7 +150,7 @@ END {
</span><span style=color:#a6e22e>+   else
</span><span style=color:#a6e22e>+     print &#34;  gettext_noop (\&#34;&#34; last_msgstr &#34;\&#34;);&#34;;
</span><span style=color:#a6e22e>+   print &#34;&#34;;
</span><span style=color:#a6e22e>+-  print &#34;static const int &#34; namespace &#34;msgidx[] =&#34;;
</span><span style=color:#a6e22e>++  print &#34;static const int &#34; pkg_namespace &#34;msgidx[] =&#34;;
</span><span style=color:#a6e22e>+   print &#34;  {&#34;;
</span><span style=color:#a6e22e>+   for (i = 0; i &lt; coded_msgs; i++)
</span><span style=color:#a6e22e>+     print &#34;    &#34; pos[i] &#34;,&#34;;
</span><span style=color:#a6e22e>+@@ -158,7 +158,7 @@ END {
</span><span style=color:#a6e22e>+   print &#34;  };&#34;;
</span><span style=color:#a6e22e>+   print &#34;&#34;;
</span><span style=color:#a6e22e>+   print &#34;static GPG_ERR_INLINE int&#34;;
</span><span style=color:#a6e22e>+-  print namespace &#34;msgidxof (int code)&#34;;
</span><span style=color:#a6e22e>++  print pkg_namespace &#34;msgidxof (int code)&#34;;
</span><span style=color:#a6e22e>+   print &#34;{&#34;;
</span><span style=color:#a6e22e>+   print &#34;  return (0 ? 0&#34;;
</span><span style=color:#a6e22e>+ 
</span><span style=color:#a6e22e></span>
</code></pre></div></li>
</ul>
<h1 id=编译>编译</h1>
<h2 id=编译前的准备>编译前的准备</h2>
<p>首先进入qsdk源码目录，其中的目录布局和openwrt非常接近</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cd qsdk
</code></pre></div><p>在配置之前将feeds中的软件包添加进来：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make package/symlinks
</code></pre></div><p>实际上是根据feeds.conf更新feeds，然后在<code>./packages/feeds/</code>目录里面创建到<code>./feeds/packages</code>中的feeds包的软链接，在这一步之后才能看见更多的软件包</p>
<h2 id=配置qsdk>配置QSDK</h2>
<p>使用默认的配置作为<code>.config</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cp qca/configs/qsdk/ipq_open.config .config
</code></pre></div><p>接着使用菜单配置：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make menuconfig 
</code></pre></div><p>RAX3000Q自带的固件是32bit的，因此我们这里<code>target</code>选<code>IPQ</code>，<code>subtarget</code>选<code>IPQ50xx(32bit)</code>，接着直接保存为<code>.config</code>。</p>
<p>在现有的<code>.config</code>中添加默认配置：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make defconfig
</code></pre></div><p>接着可以进行一些个性化配置，或者备份对.config文件所作的修改，我直接跳过了：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make kernel_menuconfig <span style=color:#75715e># 配置内核，可选</span>
make menuconfig <span style=color:#75715e># 再次配置，可选</span>
scripts/diffconfig.sh &gt; mydiffconfig <span style=color:#75715e># 备份修改到文件mydiffconfig，可选</span>
</code></pre></div><h2 id=编译-1>编译</h2>
<ul>
<li>
<p>预下载源码</p>
<p>为了提高编译效率，先下载所有依赖，并激活多线程编译（Openwrt官网这么说的，也不知道对多线程到底有没有影响）</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make download
</code></pre></div></li>
<li>
<p>构建toolchain</p>
<p>正式编译之前要先编译toolchain，这一步中会因为编译环境的问题导致很多error产生，因此我们需要先打一些patch的</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make toolchain/install -j V<span style=color:#f92672>=</span>s
</code></pre></div></li>
<li>
<p>只构建特定软件包</p>
<p>首先需要在make menuconfig中勾选该软件包，以<code>firewall</code>为例</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make package/network/config/firewall/compile V<span style=color:#f92672>=</span>s
</code></pre></div><p>产物在<code>./bin/ipq/packages/base/firewall_2015-07-27_ipq.ipk</code></p>
</li>
<li>
<p>全盘编译</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>make -j V<span style=color:#f92672>=</span>s
</code></pre></div><p>产生的完整img文件在<code>./bin/ipq/</code>下。</p>
<p>但是我<strong>没有尝试过将其刷入</strong>因此<strong>不保证不会刷坏！！！！！！</strong></p>
</li>
</ul>
<h1 id=编译失败的排错>编译失败的排错</h1>
<p><a href=https://www.litreily.top/2021/02/07/qsdk-compile>这篇文章</a>里已经涵盖了很多在ubuntu20.04环境中编译时可能遇到的问题，但我在编译这一版本的QSDK时还遇到了额外的问题。所有对QSDK所需的修改已经在文章开头的diff文件中涵盖了，这里只是列出信息有助于排错：</p>
<ul>
<li>
<p>u-boot的编译依赖于libssl1.0-dev：</p>
<p>系统的libssl-dev版本太新了，需要更换为libssl1.0-dev</p>
</li>
<li>
<p>编译squashfs4时遇到undefined reference to `SHA256Init'：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>/usr/bin/ld: /qsdk/qsdk/staging_dir/host/lib/liblzma.a(liblzma_la-check.o): in function `lzma_check_init&#39;:
check.c:(.text+0x75): undefined reference to `SHA256Init&#39;
/usr/bin/ld: /qsdk/qsdk/staging_dir/host/lib/liblzma.a(liblzma_la-check.o): in function `lzma_check_update&#39;:
check.c:(.text+0xbf): undefined reference to `SHA256Update&#39;
/usr/bin/ld: /qsdk/qsdk/staging_dir/host/lib/liblzma.a(liblzma_la-check.o): in function `lzma_check_finish&#39;:
check.c:(.text+0x115): undefined reference to `SHA256Final&#39;
collect2: error: ld returned 1 exit status
</code></pre></div><p>参考<a href=https://forums.freebsd.org/threads/binutils-gdb-linker-wont-find-_libmd_sha256_init-etc.79347/>这个链接</a>可以了解到，这是因为宿主环境中提供<code>SHA256Init</code>这个函数的库改为了<code>libmd.a</code>，需要修改<code>tools/squashfs4/Makefile</code>，加上链接器选项<code>-lmd</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=color:#f92672>--- a/tools/squashfs4/Makefile
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/squashfs4/Makefile
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -24,7 +24,7 @@ define Host/Compile
</span><span style=color:#75715e></span> 		XZ_SUPPORT=1 \
 		LZMA_XZ_SUPPORT=1 \
 		XATTR_SUPPORT= \
<span style=color:#f92672>-		LZMA_LIB=&#34;$(STAGING_DIR_HOST)/lib/liblzma.a&#34; \
</span><span style=color:#f92672></span><span style=color:#a6e22e>+		LZMA_LIB=&#34;$(STAGING_DIR_HOST)/lib/liblzma.a -lmd&#34; \
</span><span style=color:#a6e22e></span> 		EXTRA_CFLAGS=&#34;-I$(STAGING_DIR_HOST)/include&#34; \
 		mksquashfs unsquashfs
 endef
</code></pre></div></li>
<li>
<p>编译gcc-5.2.0时报<code>gcc-5.2.0/gcc/wide-int.h:370:10: error: too many template-parameter-lists</code></p>
<p>修复办法参考<a href=https://gist.github.com/thierer/534faf0772ee66c51fdfcf964ebb1655>这里</a></p>
</li>
<li>
<p>编译libgpg-error时出现gawk和<code>namespace</code>相关的错误信息</p>
<p>是因为宿主机器使用的gawk5.0版本过新，修复方法<a href=https://github.com/neheb/packages/blob/9afde0d39ae364c327063d36b188465058056a86/libs/libgpg-error/patches/020-gawk5-support.patch>参考这个patch</a></p>
</li>
</ul>
<h1 id=引用>引用</h1>
<ul>
<li>
<p><a href=https://www.litreily.top/2021/01/29/qsdk/%5B>下载安装基于 openwrt 的 QSDK - LITREILY</a></p>
</li>
<li>
<p><a href=https://www.litreily.top/2021/02/07/qsdk-compile>基于 IPQ807x 编译 QSDK - LITREILY</a></p>
</li>
<li>
<p><a href=https://nodemand.hatenablog.com/entry/2020/11/24/155129>为 SONY MANOMA NCP-HG100 构建 Dropbear（SSH 服务器）</a></p>
</li>
</ul>
</main>
<div id=comments>
<hr>
<script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label="💬 comments 💬" theme=github-light crossorigin=anonymous async></script>
</div>
<footer>
<hr>
© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备 - 2020042968号</a>
</footer>
</body>
</html>