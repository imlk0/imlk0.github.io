<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ä»ext4è¿ç§»åˆ°btrfs | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/archives/>Archives</a></li><li><a href=/friends/>Friends</a></li><li><a href=/index.xml>Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>ä»ext4è¿ç§»åˆ°btrfs</span></h1><span><span class=date>2022-01-12</span>
<span class=date>(æ›´æ–°äº2022-07-18)</span>
/
<span class=cats><a href=https://blog.imlk.top/categories/linux/>Linux</a></span>
/
<span class=tags><a href=https://blog.imlk.top/tags/btrfs/>#btrfs</a>
<a href=https://blog.imlk.top/tags/grub/>#grub</a></span></span><br></div><main><p>ä»Šå¤©å°è¯•äº†å°†æ ¹æ–‡ä»¶ç³»ç»Ÿè¿ç§»åˆ°btrfsï¼Œä¸»è¦æ˜¯çœ‹ä¸­äº†å®ƒçš„Copy-on-Writeä»¥åŠé€æ˜å‹ç¼©å’Œå¿«ç…§ç­‰ç‰¹æ€§ã€‚é‰´äºæ²¡æœ‰æ‰¾åˆ°ç°æˆçš„å®Œæ•´æ•™ç¨‹ï¼ŒåŠ ä¸Šå­å·çš„åˆ’åˆ†å…¶å®çœ‹ä¸ªäººåå¥½ï¼Œæ•…åšæ­¤æ–‡ï¼Œé¡ºä¾¿æŠŠåœ¨è¿™æœŸé—´é‡åˆ°çš„é—®é¢˜è®°å½•ä¸€ä¸‹ã€‚</p><p>æ•´ä¸ªè¿ç§»è¿‡ç¨‹æ˜¯åœ¨LiveCDä¸­æ“ä½œçš„ã€‚</p><h2 id=åˆ›å»ºbtrfs>åˆ›å»ºbtrfs</h2><p>å°†åŸå…ˆçš„rootfså¤‡ä»½åï¼Œæ ¼å¼åŒ–ä¸ºbtrfsï¼Œå·¥å…·ä»»æ„ï¼Œè¿™é‡Œæˆ‘ç”¨çš„gnomeè‡ªå¸¦çš„ç£ç›˜ç®¡ç†ç¨‹åºï¼ŒGPartdåº”è¯¥ä¹Ÿå¯ä»¥ã€‚</p><p><img src=/images/blog/btrfs_1.png alt></p><ul><li><p>æŒ‚è½½btrfsåˆ†åŒºåˆ°ä¸´æ—¶ç›®å½•<code>/mnt/btrfs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mount -t btrfs -o compress<span style=color:#f92672>=</span>zstd /dev/sdb4 /mnt/btrfs
</span></span></code></pre></div><p>æ³¨æ„é»˜è®¤ä¸ä¼šå¼€å¯å‹ç¼©åŠŸèƒ½ï¼Œå› æ­¤è¿™é‡Œæœ€å¥½å°±åŠ ä¸Š<code>-o compress=zstd</code>ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€ä¼šè¿˜å¾—å°†ä¹‹å‰å¤‡ä»½çš„æ–‡ä»¶æ‹·è´å›æ¥ã€‚</p><p>å¦‚æœæƒ³è¦äº†è§£å‹ç¼©ç®—æ³•çš„é€‰æ‹©ï¼Œå¯ä»¥å‚è€ƒ<a href=https://btrfs.wiki.kernel.org/index.php/Compression>https://btrfs.wiki.kernel.org/index.php/Compression</a></p></li></ul><h2 id=åˆ›å»ºå­å·>åˆ›å»ºå­å·</h2><h3 id=btrfså­å·å¸ƒå±€>btrfså­å·å¸ƒå±€</h3><p>æ¨èé˜…è¯»<a href=https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Layout>https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Layout</a></p><p>å¦‚æœå…³å¿ƒå¿«ç…§ï¼Œè¿˜å¯ä»¥é˜…è¯»ï¼š<a href=https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Snapshots>https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Snapshots</a></p><p>btrfsçš„å­å·å¸ƒå±€å¾ˆéšæ„ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§èŒƒå¼ï¼šFlatã€Nestedã€Mixedï¼Œä¸Šé¢Flatå’ŒNestedåŒºåˆ«åœ¨äºï¼šåè€…çš„subvolumeåº•ä¸‹è¿˜æœ‰subvolumeï¼ˆæ³¨æ„å¿«ç…§æ—¶ä¸ä¼šé€’å½’å¯¹é‡Œé¢çš„subvolumeåšå¿«ç…§ï¼‰ï¼Œè€ŒFlatåˆ™å€¾å‘äºå°†æ‰€æœ‰çš„subvolumeå¹³é“ºã€‚</p><p>åœ¨è€ƒè™‘ä¾¿æ·æ€§å’Œå¿«ç…§åï¼Œæˆ‘å‚è€ƒFlatå¸ƒå±€åˆ¶å®šäº†ä¸‹é¢è¿™æ ·çš„å¸ƒå±€</p><pre tabindex=0><code>/               &lt;rootå·ï¼Œä¸æŒ‚è½½&gt;
â”œâ”€â”€ snapshots   &lt;ç›®å½•ï¼Œç”¨äºä¹‹åå­˜æ”¾å¿«ç…§å·&gt;
â””â”€â”€ subvolumes  &lt;ç›®å½•ï¼Œæ–°å¢çš„å­å·ä¹Ÿéƒ½æ”¾åœ¨è¿™ä¸‹é¢&gt;
    â”œâ”€â”€ home    &lt;å­å·ï¼ŒæŒ‚è½½ä¸º/home&gt;
    â””â”€â”€ root    &lt;å­å·ï¼ŒæŒ‚è½½ä¸º/&gt;
</code></pre><h3 id=åˆ›å»ºå­å·-1>åˆ›å»ºå­å·</h3><ul><li><p>åˆ›å»ºä¸¤ä¸ªç›®å½•å­˜æ”¾å¸¸è§„çš„subvolumeså’Œå¿«ç…§ç”¨çš„snapshots</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir /mnt/btrfs/subvolumes
</span></span><span style=display:flex><span>sudo mkdir /mnt/btrfs/snapshots
</span></span></code></pre></div></li><li><p>åˆ›å»ºä¸¤ä¸ªsubvolume</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo btrfs subvolume create /mnt/btrfs/subvolumes/root
</span></span><span style=display:flex><span>sudo btrfs subvolume create /mnt/btrfs/subvolumes/home
</span></span></code></pre></div></li></ul><p>å¯ä»¥ä½¿ç”¨<code>sudo btrfs subvolume list -p /mnt/btrfs</code>æŸ¥çœ‹è¿™ä¸¤ä¸ªsubvolumeçš„id</p><p>ç°åœ¨ï¼Œå¯ä»¥ç›´æ¥è®¿é—®<code>/mnt/btrfs/subvolumes/root</code>å’Œ<code>/mnt/btrfs/subvolumes/home</code>ï¼Œå¹¶å°†ä¹‹å‰å¤‡ä»½çš„æ–‡ä»¶æ‹·è´å›æ¥ã€‚</p><h2 id=æ›´æ–°grub>æ›´æ–°grub</h2><p>è¿™ä¸€æ­¥éœ€è¦chrootåˆ°åŸæ¥çš„rootfsé‡Œé¢ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•<code>/mnt/btrfs-root</code>æ¥å‡†å¤‡rootfsã€‚</p><p>æŒ‚è½½ä¸¤ä¸ªsubvolumeï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mount -t btrfs -o noatime,compress<span style=color:#f92672>=</span>zstd,subvol<span style=color:#f92672>=</span>/subvolumes/root /dev/sdb4 /mnt/btrfs-root
</span></span><span style=display:flex><span>sudo mount -t btrfs -o noatime,compress<span style=color:#f92672>=</span>zstd,subvol<span style=color:#f92672>=</span>/subvolumes/home /dev/sdb4 /mnt/btrfs-root/home
</span></span></code></pre></div><p>mount bindå¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åchrootã€‚ï¼ˆå¦‚æœä½ çš„<code>/boot</code>ç›®å½•åœ¨åˆ«çš„åˆ†åŒºçš„ï¼Œé‚£ä¹ˆè¿˜éœ€è¦é¢å¤–æŒ‚è½½<code>/boot</code>ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /mnt/btrfs-root
</span></span><span style=display:flex><span>sudo mount -o bind /dev  dev
</span></span><span style=display:flex><span>sudo mount -o bind /sys sys
</span></span><span style=display:flex><span>sudo mount -o bind /proc proc
</span></span><span style=display:flex><span>sudo chroot .
</span></span></code></pre></div><p>æ›´æ–°grubé…ç½®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h2 id=æ›´æ–°etcfstab>æ›´æ–°/etc/fstab</h2><p>æ³¨æ„æŒ‡å®šå‚æ•°ä¸­çš„<code>compress</code>å’Œ<code>subvol</code>é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>UUID<span style=color:#f92672>=</span>7f208f70-fee3-4bbe-8f3f-c1e95dd25afe  /  btrfs  defaults,noatime,compress<span style=color:#f92672>=</span>zstd,subvol<span style=color:#f92672>=</span>/subvolumes/root <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>UUID<span style=color:#f92672>=</span>7f208f70-fee3-4bbe-8f3f-c1e95dd25afe  /home  btrfs  defaults,noatime,compress<span style=color:#f92672>=</span>zstd,subvol<span style=color:#f92672>=</span>/subvolumes/home <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=å…³äºå‹ç¼©>å…³äºå‹ç¼©</h2><p>å¦‚æœä½ åƒæˆ‘ä¸€æ ·åœ¨æ¢å¤æ–‡ä»¶ä¹‹å‰å¿˜äº†åŠ å‹ç¼©é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ†åˆ«å‹ç¼©æ¯ä¸ªå­å·é‡Œçš„ç°å­˜æ–‡ä»¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo btrfs filesystem defragment -r -v -czstd /mnt/btrfs/subvolumes/root
</span></span><span style=display:flex><span>sudo btrfs filesystem defragment -r -v -czstd /mnt/btrfs/subvolumes/home
</span></span></code></pre></div><p>å¯ä»¥ä½¿ç”¨<a href=https://github.com/kilobyte/compsize>compsize</a>è¿™ä¸ªå·¥å…·è®¡ç®—å‹ç¼©ç‡ã€‚æˆ‘è¿™é‡Œé¡ºä¾¿æµ‹è¯•äº†ä¸€ä¸‹å‹ç¼©æ•ˆæœï¼Œä¸<a href=https://wiki.gnome.org/Apps/Disks>gnome-disks</a>çš„ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚å…¶ä¸­gnome-disksæ˜¾ç¤ºçš„æ˜¯æ–‡ä»¶ç³»ç»Ÿå·²ç”¨ç©ºé—´ï¼Œcompsizeçš„ç»Ÿè®¡æ–¹å¼ä¼¼ä¹ä¸å¤ªä¸€æ ·ï¼š</p><table><thead><tr><th>å‹ç¼©èŒƒå›´\ç»Ÿè®¡æ–¹æ³•</th><th>gnome-disks</th><th>compsize</th></tr></thead><tbody><tr><td>å‹ç¼©å‰</td><td>140G</td><td>128Gï¼ˆ100%ï¼‰</td></tr><tr><td>å‹ç¼©/subvolumes/rootå­å·</td><td>100G</td><td>89Gï¼ˆ69%ï¼‰</td></tr><tr><td>å‹ç¼©/subvolumes/rootå’Œ/subvolumes/homeå­å·</td><td>66G</td><td>56Gï¼ˆ44%ï¼‰</td></tr></tbody></table><p><img src=/images/blog/btrfs_2.png alt=åŒæ—¶å‹ç¼©/å’Œ/homeå­å·çš„ç»“æœ></p><h2 id=å…³äºå‘>å…³äºå‘</h2><p>æ•´ä½“æ¥çœ‹å…¶å®æ˜¯æ²¡æœ‰ä»€ä¹ˆå‘çš„ï¼ˆå…¶å®é‡åˆ°çš„å‘ä¹Ÿæ˜¯è‡ªå·±æŒ–çš„</p><p>å°±å†™ä¸€ä¸‹è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜8ï¼š</p><ol><li>å¤‡ä»½ï¼šå› ä¸ºæ˜¯åœ¨LiveCDé‡Œæ“ä½œçš„ï¼Œæœ¬æ¥å¤‡ä»½æ–‡ä»¶çš„æ—¶å€™æ‰“ç®—ä½¿ç”¨TimeShiftçš„rsyncæ¨¡å¼ï¼Œä½†æ˜¯TimeShiftæ— æ³•åœ¨LiveCDé‡Œé¢ä½¿ç”¨ï¼Œä¸çŸ¥é“å¼€å‘è€…æ˜¯æ€ä¹ˆè€ƒè™‘çš„ã€‚æœ€åæ¢ç”¨äº†LuckyBackupï¼ˆè™½ç„¶éƒ½æ˜¯rsyncä½†æ˜¯å°±æ˜¯æ‡’å¾—è‡ªå·±å†™å‘½ä»¤hhhï¼‰</li><li>btrfs-convertï¼šè¿™å·¥å…·å¯ä»¥åŸåœ°æŠŠext4è½¬æ¢ä¸ºbtrfsï¼Œä½†æ˜¯ä¼¼ä¹å—åˆ°ç©ºé—²å—æ•°é‡çš„é™åˆ¶ï¼Œæˆ‘æµ‹è¯•äº†å‡ æ¬¡å‘ç°åœ¨ä¸åŒçš„åœ°æ–¹æŠ¥failedï¼Œå³ä½¿æ•´ä¸ªext4æ–‡ä»¶ç³»ç»Ÿåªä½¿ç”¨å¤§æ¦‚50%çš„ç©ºé—´ã€‚æœ€åç´¢æ€§ç›´æ¥æ ¼å¼åŒ–æˆbtrfså†æ‹·è´å›å»äº†ã€‚</li><li>grub unknown filesystemï¼šæ”¹å®Œä¹‹ågrubç›´æ¥è¿›åˆ°resuceæ•‘æ´æ¨¡å¼ï¼Œå‘ç°æ— æ³•è¯†åˆ«btrfsåˆ†åŒºã€‚è¿™ä¸ªå…¶å®æ˜¯æˆ‘ä¹‹å‰ä¹±æ”¹äº†EFIåˆ†åŒºé‡Œçš„å†…å®¹å¯¼è‡´çš„ï¼Œå…¶ä¸­çš„grub efiæ–‡ä»¶æ˜¯å¾ˆæ—§çš„ç‰ˆæœ¬ï¼Œä¸è®¤è¯†btrfsï¼Œä¹Ÿå°±æ²¡æ³•åŠ è½½<code>/boot/grub/x86_64-efi/</code>é‡Œçš„grubæ¨¡å—æ–‡ä»¶ï¼Œå¯¼è‡´æ•‘æ´æ¨¡å¼é‡ŒåŸºæœ¬ä¸Šå•¥ä¹Ÿä¸èƒ½å¹²ã€‚æœ€åæ˜¯æŠŠEFIåˆ†åŒºä¹ŸæŒ‚è½½ä¸Šï¼Œåœ¨chrooté‡Œä½¿ç”¨<code>grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB</code>ä¹‹ç±»çš„å‘½ä»¤é‡æ–°ç”Ÿæˆäº†ä¸€ä¸‹EFIåˆ†åŒºä¸­çš„<code>grubx64.efi</code></li></ol></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer><hr>Â© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡ - 2020042968å·</a></footer></body></html>