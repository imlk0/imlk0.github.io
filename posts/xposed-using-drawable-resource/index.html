<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Xposed模块开发——在hook之后使用module的drawable资源 | imlk's blog</title>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet>
</head>
<body>
<header class=header>
<a class=logo href=/> imlk's Blog </a>
<nav>
<ul class=menu>
<li><a href=/>Home</a></li>
<li><a href=/about/>About</a></li>
<li><a href=/archives/>Archives</a></li>
<li><a href=/friends/>Friends</a></li>
<li><a href=/index.xml>Subscribe</a></li>
</ul>
</nav>
</header>
<hr>
<div class=article-meta>
<h1><span class=title>Xposed模块开发——在hook之后使用module的drawable资源</span></h1>
<span>
<span class=date>2017-12-30</span>
|
<span class=cats>
<a href=https://blog.imlk.top/categories/xposed/>Xposed</a>
</span>
|
<span class=tags>
<a href=https://blog.imlk.top/tags/android/>#Android</a>
<a href=https://blog.imlk.top/tags/java/>#Java</a>
<a href=https://blog.imlk.top/tags/xposed/>#Xposed</a>
</span>
</span>
<br>
</div>
<main>
<p>在xposed开发过程中遇到了直接使用模块内置资源失效的问题，而且这个问题很诡异，有时候失效，有时候有效果，没效果的时候一般是显示一把叉叉</p>
<p>在上网搜索后发现，hook函数是在被hook应用内部执行的，环境不一样，所以直接用R.drawable.xxx的方式使用会出现问题。</p>
<h3 id=解决办法>解决办法：</h3>
<p><a href=https://forum.xda-developers.com/xposed/access-resources-module-t2805276>https://forum.xda-developers.com/xposed/access-resources-module-t2805276</a></p>
<p>参考了rovo89大神在xda上面的回复，改用</p>
<pre tabindex=0><code>private static String MODULE_PATH = null;
private int mFakeId = 0;

public void initZygote(StartupParam startupParam) throws Throwable {
	MODULE_PATH = startupParam.modulePath;//获取模块apk文件在储存中的位置
}

public void handleInitPackageResources(InitPackageResourcesParam resparam) throws Throwable {
	if (!resparam.packageName.equals(&quot;your.target.app&quot;))
	return;

	XModuleResources modRes = XModuleResources.createInstance(MODULE_PATH, resparam.res);
	mFakeId = resparam.res.addResource(modRes, R.drawable.ic_launcher);
}
</code></pre><p><a href=http://api.xposed.info/reference/android/content/res/XResources.html#addResource(android.content.res.Resources,>http://api.xposed.info/reference/android/content/res/XResources.html#addResource(android.content.res.Resources,</a> int)</p>
<p>获得<code>mFakeld</code>变量，它储存的是在被hook应用内植入的一个假id，这个id对应的是module里面的<code>R.drawable.ic_launcher</code>这个资源，通过这个假id就可以使用到我们的module内的drawable资源。</p>
<h3 id=再次遇到问题>再次遇到问题</h3>
<p>在实际使用中</p>
<pre tabindex=0><code>view.setBackgroundResource(mFakeId);
//导致异常
//No known package when getting value for resource number 0x7e73c7c7&lt;/pre&gt;
</code></pre><h3 id=再次解决>再次解决</h3>
<p>搜索到一段代码</p>
<p><a href=https://github.com/neverweep/xStatusbarLunarDate/blob/master/src/de/xiaoxia/xstatusbarlunardate/Main.java>https://github.com/neverweep/xStatusbarLunarDate/blob/master/src/de/xiaoxia/xstatusbarlunardate/Main.java</a></p>
<pre tabindex=0><code>@Override
public void handleInitPackageResources(InitPackageResourcesParam resparam){

	if (!resparam.packageName.equals(PACKAGE_NAME))

	return; //如果不是UI则跳过

	//这里将自带的图标资源插入到systemui中，并获取到一个资源id

	XModuleResources modRes = XModuleResources.createInstance(MODULE_PATH, resparam.res); //创建一个插入资源的实例

	ic_toast_bg_fest = resparam.res.addResource(modRes, R.drawable.ic_toast_bg_fest);

	ic_toast_bg = resparam.res.addResource(modRes, R.drawable.ic_toast_bg);

}
</code></pre><p>使用：</p>
<pre tabindex=0><code>if(_notify_icon){

	//为Toast加入背景
	
	toastView.setBackground((context.getResources().getDrawable(isFest ? ic_toast_bg_fest : ic_toast_bg)));
	
	toastView.setGravity(Gravity.CENTER);
	
	if(toastTextView != null){
	
	toastTextView.setTextColor(0xFF000000);
	
	toastTextView.setPadding(0, 15, 0, 0);
	
	toastTextView.setShadowLayer(0, 0, 0, 0X00FFFFFF);

}
</code></pre><p>这段代码里面使用的是配合<code>context</code>获得<code>drawable</code>，使用<code>setBackground()</code>方法</p>
<p>经过检验，这种写法正确。</p>
</main>
<div id=comments>
<hr>
<script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label="💬 comments 💬" theme=github-light crossorigin=anonymous async></script>
</div>
<footer>
<hr>
© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备 - 2020042968号</a>
</footer>
</body>
</html>