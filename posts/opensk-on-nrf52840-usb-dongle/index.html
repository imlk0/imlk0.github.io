<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ç”¨nRF52840 USB Dongleå’ŒOpenSKåˆ¶ä½œå¼€æºç¡¬ä»¶å¯†é’¥ | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>ç”¨nRF52840 USB Dongleå’ŒOpenSKåˆ¶ä½œå¼€æºç¡¬ä»¶å¯†é’¥</span></h1><span><span class=date>2020-10-10</span>
<span class=date>(æ›´æ–°äº2021-10-10)</span>
/
<span class=cats><a href=https://blog.imlk.top/categories/hardware/>Hardware</a></span>
/
<span class=tags><a href=https://blog.imlk.top/tags/opensk/>#OpenSK</a>
<a href=https://blog.imlk.top/tags/nrf52840/>#nRF52840</a>
<a href=https://blog.imlk.top/tags/hardware/>#Hardware</a>
<a href=https://blog.imlk.top/tags/%E7%9E%8E%E6%90%9E/>#çæ</a></span></span><br></div><main><p>åœ¨å¤§ä½¬çš„æ¨èä¸‹æ¥è§¦äº†OpenSKï¼Œä¸€ä¸ªå¼€æºçš„å®‰å…¨å¯†é’¥å®ç°ï¼Œæ”¯æŒFIDO U2Fæ ‡å‡†ï¼ˆåŒå› å­è®¤è¯ï¼‰å’ŒFIDO2è§„èŒƒã€‚ç›®å‰OpenSKæ”¯æŒçš„ç¡¬ä»¶ä¸»è¦æ˜¯åŸºäºnordicçš„nRF52840èŠ¯ç‰‡çš„ä¸‰æ¬¾äº§å“ï¼š</p><ul><li><a href=https://www.nordicsemi.com/Software-and-Tools/Development-Kits/nRF52840-DK>Nordic nRF52840-DK</a></li><li><a href=https://www.nordicsemi.com/Software-and-tools/Development-Kits/nRF52840-Dongle>Nordic nRF52840 Dongle</a></li><li><a href=https://wiki.makerdiary.com/nrf52840-mdk/>Makerdiary nRF52840-MDK USB dongle</a>.</li></ul><p>å‰ä¸¤è€…ç®—æ˜¯nordicè‡ªäº§è‡ªé”€çš„ï¼Œæœ€åä¸€æ¬¾åˆ™æ˜¯æ·±åœ³çš„ä¸€å®¶ä¼ä¸šMakerdiaryç”Ÿäº§çš„usbè®¾å¤‡ï¼Œä»·æ ¼ç›¸å¯¹å®æƒ ä¸€äº›ï¼ˆå…³é”®æ˜¯æœ‰OpenSKå®˜æ–¹æ”¯æŒä¸”æ·˜å®ä¹°å¾—åˆ°ï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯makerdiaryå®¶çš„nRF52840-MDK USB Dongleï¼Œæ·˜å®é“¾æ¥åœ¨æ–‡ç« æœ€åº•éƒ¨ã€‚</p><h2 id=å®‰è£…opensk>å®‰è£…OpenSK</h2><p>æ•´ä¸ªå®‰è£…è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼šåˆ·å…¥UF2 BootLoaderå’Œåˆ·å…¥OpenSK</p><h3 id=åˆ·å…¥uf2bootloader>åˆ·å…¥UF2BootLoader</h3><p>é¦–å…ˆæ£€æŸ¥æ¿å­æ˜¯å¦å·²ç»åˆ·å…¥äº†UF2BootLoaderï¼š</p><p>æŒ‰ä½æ¿å­çš„reseté”®æ’å…¥PCï¼Œå·¦ä¸Šæ–¹çš„ç»¿è‰²ç”µæºæŒ‡ç¤ºç¯äº®èµ·ï¼Œå¦‚æœåŒæ—¶è¿˜æœ‰å¦ä¸€é¢—ç»¿ç¯äº®èµ·ä¸”å‡ºç°åä¸º<code>MDK-Dongle</code>çš„Uç›˜ï¼Œåˆ™è¯´æ˜å·²ç»åˆ·å…¥äº†UF2BootLoaderï¼Œå¯ä»¥è·³è¿‡è¯¥æ­¥éª¤ï¼Œå¦åˆ™éœ€è¦åˆ·UF2BootLoaderã€‚</p><p>é¦–å…ˆå®‰è£…<code>nrfutil</code>ï¼š</p><pre tabindex=0><code>sudo pip install nrfutil
</code></pre><p>ä»åº—å®¶çš„githubä¸Šä¸‹è½½<a href=https://github.com/makerdiary/nrf52840-mdk-usb-dongle/raw/master/firmware/open_bootloader/uf2_bootloader-0.2.13-44-gb2b4284-nosd_signed.zip>é¢„ç¼–è¯‘å¥½çš„UF2BootLoader</a>ï¼š</p><pre tabindex=0><code>wget https://github.com/makerdiary/nrf52840-mdk-usb-dongle/raw/master/firmware/open_bootloader/uf2_bootloader-0.2.13-44-gb2b4284-nosd_signed.zip
</code></pre><p>ç”¨nrfutilåˆ·å…¥UF2BootLoaderï¼š</p><pre tabindex=0><code>nrfutil dfu usb-serial -pkg uf2_bootloader-0.2.13-44-gb2b4284-nosd_signed.zip -p &lt;your-serial-port-name&gt;
</code></pre><p>å…¶ä¸­<code>&lt;your-serial-port-name></code>å–å†³äºä½ çš„ç”µè„‘å’Œä½ çš„æ¿å­ï¼Œæ¯”å¦‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šæ˜¯ï¼š</p><p><code>/dev/serial/by-id/usb-MakerDiary_nRF52840_MDK_USB_Dongle_0E648D428B58FE7A-if00</code></p><p>åˆ·å®Œä¹‹åä¼šå‡ºç°ä¸€ä¸ªåä¸º<code>MDK-Dongle</code>çš„Uç›˜è®¾å¤‡<code>/dev/sdc</code>ï¼š</p><p><img src=/images/blog/65/image-20201009202108347.png alt=image-20201009202108347></p><p><img src=/images/blog/65/image-20201009190411324.png alt=image-20201009190411324></p><h3 id=åˆ·å…¥opensk>åˆ·å…¥OpenSK</h3><p>ä»githubä¸Š<a href=https://github.com/makerdiary/nrf52840-mdk-usb-dongle/raw/master/firmware/OpenSK/opensk_nrf52840_mdk_usb_dongle_gece14d7.uf2>ä¸‹è½½</a>é¢„ç¼–è¯‘å¥½çš„OpenSKå›ºä»¶ï¼š</p><pre tabindex=0><code>wget https://github.com/makerdiary/nrf52840-mdk-usb-dongle/raw/master/firmware/OpenSK/opensk_nrf52840_mdk_usb_dongle_gece14d7.uf2
</code></pre><p>é•¿æŒ‰reseté”®è®²æ¿å­æ’å…¥PCï¼ŒæŒ‚è½½å‡ºç°çš„åä¸º<code>MDK-Dongle</code>çš„Uç›˜è®¾å¤‡ï¼š</p><p>å°†æˆ‘ä»¬çš„å›ºä»¶æ‹·è´è¿›å»</p><pre tabindex=0><code>cp ./opensk_nrf52840_mdk_usb_dongle_gece14d7.uf2 /run/media/imlk/MDK-DONGLE/
</code></pre><p><img src=/images/blog/65/image-20201009192646793.png alt=image-20201009192646793></p><p>æ‹·è´è¿‡ç¨‹çº¦20sï¼ŒæœŸé—´æŒ‡ç¤ºç¯ä¼šå˜æˆé—ªçƒçš„çº¢è‰²ï¼š</p><p><img src=/images/blog/65/IMG_20201009_200214.jpg alt=IMG_20201009_200214></p><p>å‘½ä»¤ç»“æŸä¹‹åçº¢ç¯å˜ç»¿å¹¶ç†„ç­ï¼Œç”¨<code>lsusb</code>å¯ä»¥çœ‹åˆ°è¯¥è®¾å¤‡ï¼š</p><p><img src=/images/blog/65/image-20201009202912460.png alt=image-20201009202912460></p><p>ç°åœ¨æˆ‘ä»¬çš„å›ºä»¶å·²ç»å†™å¥½äº†ï¼Œå¯ä»¥åœ¨https://webauthn.io/ä¸Šæˆ–è€…Windows10ç™»å½•é€‰é¡¹ä¸­è¿›è¡Œæµ‹è¯•äº†ã€‚</p><h2 id=ç¼–è¯‘openskå›ºä»¶>ç¼–è¯‘OpenSKå›ºä»¶</h2><p>åº—é“ºçš„GitHubä»“åº“ï¼ˆhttps://github.com/makerdiary/OpenSKï¼‰æ˜¯åŸºäºè€ç‰ˆæœ¬çš„OpenSKåšçš„é€‚é…ï¼Œåº—å®¶è¯´æ–°ç‰ˆæœ¬ä¿®å¤äº†ä¸å°‘bugï¼Œè€ŒOpenSKå®˜æ–¹ä»“åº“ï¼ˆhttps://github.com/google/OpenSKï¼‰å¯¹äºmakerdiaryå®¶çš„è¿™æ¬¾nRF52840-MDK USB Dongleå·²ç»åšäº†é€‚é…äº†ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ç”¨googleçš„ä»“åº“ç¼–è¯‘ï¼š</p><p>å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼šhttps://github.com/google/OpenSK/blob/master/docs/install.md</p><pre tabindex=0><code>git clone git@github.com:google/OpenSK.git
</code></pre><p><strong>å®˜æ–¹çš„OpenSKåœ¨åˆ·å…¥åä¼šæ¸…ç©ºUICRï¼ˆuser information configuration registersï¼‰ï¼Œè¿™ä¼šå¯¼è‡´BootLoaderçš„å…¥å£åœ°å€è¢«æ¸…é™¤æ‰ï¼Œå› æ­¤ç”¨UF2BootLoaderåˆ·å…¥OpenSKåä¼šå¯¼è‡´è¿›ä¸å»UF2BootLoader</strong></p><p>å¦‚æœå·²ç»å› ä¸ºè¯¥åŸå› è€Œè¿›ä¸å»UF2BootLoaderï¼Œå¯ä»¥å‚è€ƒä¸‹ä¸€èŠ‚<a href=#%E7%94%A8J-Link%E7%BB%99nRF52840%E5%88%B7BootLoader>ç”¨J-Linkç»™nRF52840åˆ·BootLoader</a>æ¸…ç©ºæ•°æ®å†é‡æ–°åˆ·å…¥BootLoaderã€‚</p><p>ä¸ºäº†é¿å…è¯¥é—®é¢˜æˆ‘ä»¬éœ€è¦å¯¹æºç è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œé˜²æ­¢æ¸…ç©ºUICRï¼š</p><p>é¦–å…ˆç¡®ä¿ä½ çš„å½“å‰å·¥ä½œç›®å½•æ˜¯OpenSKæºç æ ¹ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªåä¸º<code>./patches/tock/99-avoid-erasing-uicr.patch</code>çš„patch</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>cat &lt;&lt; EOF &gt; ./patches/tock/99-avoid-erasing-uicr.patch
</span></span><span style=display:flex><span>diff --git a/boards/nordic/nrf52_components/src/startup.rs b/boards/nordic/nrf52_components/src/startup.rs
</span></span><span style=display:flex><span>index 9ddb414fd..5e85da513 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/boards/nordic/nrf52_components/src/startup.rs
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/boards/nordic/nrf52_components/src/startup.rs
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -29,68 +29,68 @@ impl Component for NrfStartupComponent {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     type StaticInput = ();
</span></span><span style=display:flex><span>     type Output = ();
</span></span><span style=display:flex><span>     unsafe fn finalize(self, _s: Self::StaticInput) -&gt; Self::Output {
</span></span><span style=display:flex><span><span style=color:#f92672>-        // Make non-volatile memory writable and activate the reset button
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        let uicr = nrf52::uicr::Uicr::new();
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Check if we need to erase UICR memory to re-program it
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // This only needs to be done when a bit needs to be flipped from 0 to 1.
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        let psel0_reset: u32 = uicr.get_psel0_reset_pin().map_or(0, |pin| pin as u32);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        let psel1_reset: u32 = uicr.get_psel1_reset_pin().map_or(0, |pin| pin as u32);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        let mut erase_uicr = ((!psel0_reset &amp; (self.button_rst_pin as u32))
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            | (!psel1_reset &amp; (self.button_rst_pin as u32))
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            | (!(uicr.get_vout() as u32) &amp; (self.reg_vout as u32)))
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            != 0;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Only enabling the NFC pin protection requires an erase.
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if self.nfc_as_gpios {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            erase_uicr |= !uicr.is_nfc_pins_protection_enabled();
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if erase_uicr {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            nrf52::nvmc::NVMC.erase_uicr();
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        nrf52::nvmc::NVMC.configure_writeable();
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        let mut needs_soft_reset: bool = false;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Configure reset pins
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if uicr
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            .get_psel0_reset_pin()
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            .map_or(true, |pin| pin != self.button_rst_pin)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            uicr.set_psel0_reset_pin(self.button_rst_pin);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if uicr
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            .get_psel1_reset_pin()
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            .map_or(true, |pin| pin != self.button_rst_pin)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            uicr.set_psel1_reset_pin(self.button_rst_pin);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Configure voltage regulator output
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if uicr.get_vout() != self.reg_vout {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            uicr.set_vout(self.reg_vout);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Check if we need to free the NFC pins for GPIO
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if self.nfc_as_gpios {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            uicr.set_nfc_pins_protection(true);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672>-
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        // Any modification of UICR needs a soft reset for the changes to be taken into account.
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        if needs_soft_reset {
</span></span></span><span style=display:flex><span><span style=color:#f92672>-            cortexm4::scb::reset();
</span></span></span><span style=display:flex><span><span style=color:#f92672>-        }
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+        // // Make non-volatile memory writable and activate the reset button
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // let uicr = nrf52::uicr::Uicr::new();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Check if we need to erase UICR memory to re-program it
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // This only needs to be done when a bit needs to be flipped from 0 to 1.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // let psel0_reset: u32 = uicr.get_psel0_reset_pin().map_or(0, |pin| pin as u32);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // let psel1_reset: u32 = uicr.get_psel1_reset_pin().map_or(0, |pin| pin as u32);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // let mut erase_uicr = ((!psel0_reset &amp; (self.button_rst_pin as u32))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     | (!psel1_reset &amp; (self.button_rst_pin as u32))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     | (!(uicr.get_vout() as u32) &amp; (self.reg_vout as u32)))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     != 0;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Only enabling the NFC pin protection requires an erase.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if self.nfc_as_gpios {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     erase_uicr |= !uicr.is_nfc_pins_protection_enabled();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if erase_uicr {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     nrf52::nvmc::NVMC.erase_uicr();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // nrf52::nvmc::NVMC.configure_writeable();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // let mut needs_soft_reset: bool = false;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Configure reset pins
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if uicr
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     .get_psel0_reset_pin()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     .map_or(true, |pin| pin != self.button_rst_pin)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     uicr.set_psel0_reset_pin(self.button_rst_pin);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if uicr
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     .get_psel1_reset_pin()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     .map_or(true, |pin| pin != self.button_rst_pin)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     uicr.set_psel1_reset_pin(self.button_rst_pin);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Configure voltage regulator output
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if uicr.get_vout() != self.reg_vout {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     uicr.set_vout(self.reg_vout);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Check if we need to free the NFC pins for GPIO
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if self.nfc_as_gpios {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     uicr.set_nfc_pins_protection(true);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     while !nrf52::nvmc::NVMC.is_ready() {}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     needs_soft_reset = true;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // // Any modification of UICR needs a soft reset for the changes to be taken into account.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // if needs_soft_reset {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        //     cortexm4::scb::reset();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        // }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><p>åœ¨è¿›è¡Œä¸Šè¿°ä¿®æ”¹åï¼Œæˆ‘ä»¬å†å¼€å§‹åˆå§‹åŒ–ï¼š</p><pre tabindex=0><code>./setup.sh
</code></pre><p>é€šè¿‡nrfutiléƒ¨ç½²åˆ°æˆ‘ä»¬çš„æ¿å­ä¸Šï¼Œæ³¨æ„æ”¹æˆ<code>nrf52840_mdk_dfu</code>ï¼š</p><pre tabindex=0><code>./deploy.py --board=nrf52840_mdk_dfu --opensk --programmer=nordicdfu
</code></pre><p><strong>è¿™ä¸€æ­¥ä¼šæŠ¥é”™<code>fatal: Couldn't find any DFU device on your system.</code>ï¼Œçœ‹æºç ä¼¼ä¹åœ¨å¯»æ‰¾ä¸€ä¸ª<code>vendor_id == "1915"</code>å¹¶ä¸”<code>product_id == "521F"</code>çš„è®¾å¤‡ï¼ŒçŒœæµ‹æ˜¯å› ä¸ºåˆ·äº†UF2BootLoaderçš„åŸå› æ‰å¯¼è‡´æ‰¾ä¸åˆ°è®¾å¤‡ã€‚</strong></p><p>é‚£æˆ‘ä»¬å°±é‡‡ç”¨åˆ«çš„æ–¹æ³•ï¼Œç¼–è¯‘æˆ<code>.uf2</code>æ–‡ä»¶ï¼Œé€šè¿‡UF2BootLoaderçƒ§å†™ã€‚</p><pre tabindex=0><code>./deploy.py --board=nrf52840_mdk_dfu --opensk --programmer=none
</code></pre><p>æ‰§è¡Œå®Œæ¯•åä¼šåœ¨ç”Ÿæˆä¸€ä¸ªåˆå¹¶åçš„<code>.hex</code>æ–‡ä»¶<code>target/nrf52840_mdk_dfu_merged.hex</code></p><p>æ¥ä¸‹æ¥ä»åº—å®¶çš„githubä¸‹è½½<code>uf2conv.py</code>è¿™ä¸ªå·¥å…·</p><pre tabindex=0><code>wget https://github.com/makerdiary/nrf52840-mdk-usb-dongle/raw/master/tools/uf2conv.py
</code></pre><p>æŠŠ<code>.hex</code>è½¬åŒ–æˆ<code>.uf2</code></p><pre tabindex=0><code>python uf2conv.py -c -f 0xada52840 -o ./target/nrf52840_mdk_dfu_merged.uf2 ./target/nrf52840_mdk_dfu_merged.hex
</code></pre><p>æŒ‰ä½resetæŒ‰é’®ï¼Œå°†æ¿å­æ’å…¥PCï¼Œæ‹·è´uf2åˆ°æ¿å­ä¸­</p><pre tabindex=0><code>cp ./target/nrf52840_mdk_dfu_merged.uf2 /run/media/imlk/MDK-DONGLE/
</code></pre><p>ç­‰ä¸Šé¢çš„ç¨‹åºç»“æŸåï¼Œçº¢ç¯å˜ç»¿å¹¶ç†„ç­ï¼Œ<code>lsusb</code>æŸ¥çœ‹åˆ°æ–°çš„è®¾å¤‡</p><p><img src=/images/blog/65/image-20201010130247171.png alt=image-20201010130247171></p><p>è‡³æ­¤åˆ·å†™å®Œæˆ</p><h2 id=ç”¨j-linkç»™nrf52840åˆ·bootloader>ç”¨J-Linkç»™nRF52840åˆ·BootLoader</h2><p>åœ¨åˆ·å›ºä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå› ä¸ºå¡«é”™åŸºåœ°å€è€Œæ— æ„ä¸­è¦†ç›–æ‰flashä¸­é‡è¦çš„éƒ¨åˆ†ï¼Œæ­¤æ—¶å¯ä»¥è¿›å…¥dfuæ¨¡å¼ä½¿ç”¨<code>nRF Connect</code>ä¸­çš„Programmerå·¥å…·åˆ·å†™å›ºä»¶ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬æŠŠBootLoaderåˆ·æ‰äº†ï¼Œè€Œæ¿å­ä¸Šçš„Appåˆè¦†ç›–äº†restæŒ‰é’®çš„é€»è¾‘ï¼Œæˆ–è€…å…¶ä»–åŸå› å¯¼è‡´æˆ‘ä»¬è¿›ä¸å»dfuæ¨¡å¼ï¼Œæˆ‘ä»¬è¿˜æ˜¯æœ‰åŠæ³•æ•‘å›æ¥çš„ã€‚nRF52840è¿™é¢—SoCåŒ…å«<code>SWD</code>æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªJ-Linkç¼–ç¨‹å™¨è¿æ¥æ¿å­å’Œpcï¼Œç„¶åä½¿ç”¨<code>nRF Connect</code>å¯¹å…¶è¿›è¡Œç¼–ç¨‹ã€‚</p><p>è¿æ¥æ–¹å¼å¦‚å›¾æ‰€ç¤ºï¼Œå³ä¾§æ˜¯ä¸€ä¸ªJ-Linkç¼–ç¨‹å™¨ï¼Œæˆ‘ä»¬å°†å®ƒçš„å¤–å£³æ‹†ä¸‹ï¼Œæ‰¾åˆ°é‡Œé¢çš„ä¸€ç»„swdæ¥å£ï¼ˆ3.3VCCï¼‰ã€DIOã€CLKã€GNDï¼‰ï¼Œå¯¹åº”å°†å…¶è¿æ¥åˆ°å·¦è¾¹çš„æ¿å­ä¸Šçš„ï¼ˆVINã€SWDIOã€SWDCLKã€GNDï¼‰ï¼š</p><p><img src=/images/blog/65/image-20201011000341491.png alt=image-20201011000341491></p><p>æ¿å­çš„å¼•è„šå›¾ï¼ˆæºè‡ªhttps://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/#software-resourceï¼‰</p><p><img src=/images/blog/65/nrf52840-mdk-usb-dongle-pinout.png alt=img></p><p>å°†J-Linkè¿æ¥åˆ°PCï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿æ¥åˆ°äº†J-Linkè®¾å¤‡ã€‚</p><pre tabindex=0><code>[imlk@imlk-pc ~]$ lsusb
...
Bus 001 Device 087: ID 1366:0101 SEGGER J-Link PLUS
...
</code></pre><p>æ­¤æ—¶æ‰“å¼€<code>nRF Connect</code>ä¸­çš„Programmerå·¥å…·ï¼Œå·¦ä¸Šè§’åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬çš„è®¾å¤‡äº†ï¼š</p><p>åœ¨å½“å‰é¡µé¢ä¸­ï¼Œä½ å¯ä»¥è¯»å–ã€æ“¦é™¤è®¾å¤‡ä¸­çš„æ•°æ®ï¼Œå…·ä½“çš„å†…å­˜å¸ƒå±€å¯ä»¥ä»NORDICçš„å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾åˆ°ï¼šhttps://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v15.3.0%2Flib_bootloader.html&cp=5_0_3_5_0_7&anchor=lib_bootloader_memoryã€‚</p><p>é€šè¿‡å¯¼å…¥BootLoaderçš„hexæ–‡ä»¶ï¼Œç„¶åç‚¹å‡»Erase & Writeï¼Œå¯ä»¥æ“¦é™¤å…¨éƒ¨æ•°æ®å¹¶å†™å…¥BootLoaderã€‚</p><p><img src=/images/blog/65/image-20201011001219508.png alt=image-20201011001219508></p><p>å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½makerdiaryé¢„ç¼–è¯‘çš„UF2BootLoaderçš„hexæ–‡ä»¶ï¼šhttps://github.com/makerdiary/nrf52840-mdk-usb-dongle/tree/master/firmware/uf2_bootloader</p><h2 id=ç”¨openskå®ç°linuxç™»å½•å¤±è´¥>ç”¨OpenSKå®ç°Linuxç™»å½•ï¼ˆå¤±è´¥ï¼‰</h2><p>é‡åˆ°çš„é—®é¢˜æ˜¯æ‰§è¡Œ<code>pamu2fcfg</code>å‘½ä»¤åï¼ŒæŒ‰ä¸‹æ¿å­ä¸Šçš„æŒ‰é’®ä¼šå‡ºç°<code>error: fido_cred_verify (-7) FIDO_ERR_INVALID_ARGUMENT</code>çš„é”™è¯¯ï¼Œæ²¡æ‰¾åˆ°è§£å†³åŠæ³•</p><p>æš‚æ—¶æŠŠæ‰¾åˆ°çš„èµ„æ–™å †åœ¨è¿™é‡Œï¼Œç­‰æˆåŠŸäº†å†æ›´æ–°ï¼š</p><p><a href=https://sites.google.com/site/mtrons/howtos/bake-your-own-security-key>https://sites.google.com/site/mtrons/howtos/bake-your-own-security-key</a></p><p><a href=https://schulz.dk/2019/08/23/using-solokey-for-linux-login/>https://schulz.dk/2019/08/23/using-solokey-for-linux-login/</a></p><p><a href=https://schulz.dk/2019/08/24/password-less-linux-login-with-solokeys/>https://schulz.dk/2019/08/24/password-less-linux-login-with-solokeys/</a></p><h2 id=ç›¸å…³é“¾æ¥>ç›¸å…³é“¾æ¥</h2><ul><li><p>åˆ›å®¢æ—¥è®°-Google OpenSK å¿«é€Ÿå…¥é—¨æŒ‡å—
<a href=https://zhuanlan.zhihu.com/p/109631580>https://zhuanlan.zhihu.com/p/109631580</a></p></li><li><p>makerdiaryçš„OpenSKä»“åº“
<a href=https://github.com/makerdiary/OpenSK>https://github.com/makerdiary/OpenSK</a></p></li><li><p>makerdiaryçš„åšå®¢
<a href=https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/opensk/getting-started/>https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/opensk/getting-started/</a></p></li><li><p>nRF52840-MDK USB Dongleæ·˜å®é“¾æ¥ï¼š
<a href="https://item.taobao.com/item.htm?spm=2013.1.w4004-18605444720.4.54af5ff1ndQwhn&id=578378054977">https://item.taobao.com/item.htm?spm=2013.1.w4004-18605444720.4.54af5ff1ndQwhn&id=578378054977</a></p></li><li><p>Erase UICR and merge Bootloader problem
<a href=https://devzone.nordicsemi.com/f/nordic-q-a/50948/erase-uicr-and-merge-bootloader-problem>https://devzone.nordicsemi.com/f/nordic-q-a/50948/erase-uicr-and-merge-bootloader-problem</a></p></li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer><hr>Â© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡ - 2020042968å·</a></footer></body></html>