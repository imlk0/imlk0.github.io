<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>è¯»Androidç³»ç»Ÿç¯‡ä¹‹----å…rootå®ç°Hookç³»ç»ŸæœåŠ¡æ‹¦æˆªæ–¹æ³• | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/archives/>Archives</a></li><li><a href=/friends/>Friends</a></li><li><a href=/index.xml>Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>è¯»Androidç³»ç»Ÿç¯‡ä¹‹&mdash;-å…rootå®ç°Hookç³»ç»ŸæœåŠ¡æ‹¦æˆªæ–¹æ³•</span></h1><span><span class=date>2018-04-13</span>
|
<span class=cats><a href=https://blog.imlk.top/categories/android/>Android</a></span>
|
<span class=tags><a href=https://blog.imlk.top/tags/android/>#Android</a>
<a href=https://blog.imlk.top/tags/binder/>#Binder</a>
<a href=https://blog.imlk.top/tags/ipc/>#IPC</a>
<a href=https://blog.imlk.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>#è¯»ä¹¦ç¬”è®°</a></span></span><br></div><main><p>ç¬¬äºŒç¯‡è¯»ä¹¦ç¬”è®°</p><p>æ‹œè¯»å§œç»´å¤§ç¥çš„<a href=https://blog.csdn.net/jiangwei0910410003/article/details/52523679>Androidç³»ç»Ÿç¯‡ä¹‹&mdash;-å…rootå®ç°Hookç³»ç»ŸæœåŠ¡æ‹¦æˆªæ–¹æ³•</a></p><p>æ¢³ç†äº†ä¸‹æ€è·¯ï¼Œè§£å†³äº†ç–‘æƒ‘</p><p>æˆ‘ä»¬ä½¿ç”¨å‰ªåˆ‡æ¿æœåŠ¡çš„æ—¶å€™æ˜¯è°ƒç”¨äº†<code>ContextImpl</code>çš„<code>getSystemService</code>æ–¹æ³•</p><h4 id=contextimplçš„getsystemserviceæ–¹æ³•><code>ContextImpl</code>çš„<code>getSystemService</code>æ–¹æ³•</h4><pre tabindex=0><code>    @Override
    public Object getSystemService(String name) {
        return SystemServiceRegistry.getSystemService(this, name);
    }
</code></pre><p>è¯¥æ–¹æ³•å°†è¿”å›<code>Object</code>ç±»å‹å¯¹è±¡ï¼Œæˆ‘ä»¬å°†å®ƒå¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ª<code>ClipboardManager</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒè¿”å›äº†ä¸€ä¸ª<code>ClipboardManager</code>ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚è€Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆå°†æ„é€ ä¸€ä¸ª<code>ClipboardManager</code>ï¼Œåœ¨<code>ClipboardManager</code>æ„é€ çš„è¿‡ç¨‹ä¸­ï¼Œå°†è·å–è¿œç«¯<code>Binder</code>å¹¶è°ƒç”¨<code>IClipboard.Stub</code>çš„<code>asInterface</code>æ–¹æ³•è½¬åŒ–ä¸º<strong>æœ¬åœ°ä»£ç†å¯¹è±¡</strong>ä¿å­˜åœ¨å…¶ä¸­ï¼Œ</p><h4 id=clipboardmanagerçš„ä¸€ä¸ªæ„é€ å‡½æ•°><code>ClipboardManager</code>çš„ä¸€ä¸ªæ„é€ å‡½æ•°</h4><pre tabindex=0><code>    /** {@hide} */
    public ClipboardManager(Context context, Handler handler) throws ServiceNotFoundException {
        mContext = context;
        mService = IClipboard.Stub.asInterface(
                ServiceManager.getServiceOrThrow(Context.CLIPBOARD_SERVICE));
    }
</code></pre><p>è·å–è¿œç«¯<code>Binder</code>çš„æ“ä½œå…¶å®æ˜¯è°ƒç”¨äº†<code>ServiceManager</code>ä¸­çš„<code>getService</code>æ–¹æ³•ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªè¿œç«¯<code>Binder</code>ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>BinderProxy</code>ï¼ˆå½“ç„¶<code>ServiceManager</code>ä¼šæŠŠè¿™ä¸ªè¿œç«¯å¯¹è±¡ç¼“å­˜åˆ°<code>sCache</code>ä¸­ä»¥åº”å¯¹é¢‘ç¹è°ƒç”¨ï¼‰ï¼Œå§œç»´çš„æ–‡ç« é‡Œå°±æ˜¯ä»è¿™é‡Œåˆ‡å…¥ï¼Œç¬¬ä¸€æ­¥å…ˆåŠ¨æ€ä»£ç†äº†è¿™ä¸ª<code>BinderProxy</code>ã€‚</p><blockquote><p>è¿™é‡Œéœ€è¦é“­è®°ä¸€ç‚¹ï¼Œè¿œç«¯<code>Binder</code>éœ€è¦è°ƒç”¨<code>Stub</code>çš„<code>asInterface</code>æ–¹æ³•è½¬åŒ–ä¸º<strong>æœ¬åœ°ä»£ç†å¯¹è±¡</strong>æ‰èƒ½ä½¿ç”¨(ä¸Šé¢è¯´åˆ°åœ¨<code>ClipboardManager</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œè¿™ä¸€æ­¥éª¤<code>ClipboardManager</code>å¸®æˆ‘ä»¬å°è£…äº†è¿™ä¸€æ“ä½œ)</p></blockquote><h4 id=servicemanagerä¸­çš„getserviceæ–¹æ³•><code>ServiceManager</code>ä¸­çš„<code>getService</code>æ–¹æ³•</h4><pre tabindex=0><code>    /**
     * Returns a reference to a service with the given name.
     * 
     * @param name the name of the service to get
     * @return a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn&#39;t exist
     */
    public static IBinder getService(String name) {
        try {
            IBinder service = sCache.get(name);
            if (service != null) {
                return service;
            } else {
                return Binder.allowBlocking(getIServiceManager().getService(name));
            }
        } catch (RemoteException e) {
            Log.e(TAG, &#34;error in getService&#34;, e);
        }
        return null;
    }
</code></pre><p>ä¸‹é¢ç»§ç»­è§£æå§œç»´çš„æ–‡ç« ä¸­hookçš„æµç¨‹ï¼Œåœ¨ä¸Šä¸€æ­¥çš„åŠ¨æ€ä»£ç†ä¹‹åï¼Œæ‹¦æˆªäº†è¢«ä»£ç†å¯¹è±¡ï¼ˆ<code>BinderProxy</code>å¯¹è±¡ï¼‰çš„<code>queryLocalInterface</code>æ–¹æ³•ï¼Œä¸‹é¢æ˜¯</p><h4 id=binderproxyä¸­querylocalinterfaceçš„å®ç°><code>BinderProxy</code>ä¸­<code>queryLocalInterface</code>çš„å®ç°</h4><pre tabindex=0><code>    public IInterface queryLocalInterface(String descriptor) {
        return null;
    }
</code></pre><p>å¯ä»¥çœ‹è§å®ƒç›´æ¥è¿”å›äº†<code>null</code>ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å“ªé‡Œè¢«è°ƒç”¨çš„å‘¢ï¼Œåç¼–è¯‘<code>framework.jar</code>å‘ç°ï¼Œæ˜¯åœ¨<code>IClipboard.Stub</code>ä¸­ï¼Œè¿™é‡Œ<code>IClipboard</code>å°±æ˜¯ç”¨<code>aidl</code>ç”Ÿæˆçš„ï¼Œå’Œæˆ‘ä»¬è‡ªå·±ç”Ÿæˆçš„å·®ä¸å¤š
çœ‹çœ‹</p><h4 id=iclipboardstubçš„asinterfaceæ–¹æ³•><code>IClipboard.Stub</code>çš„<code>asInterface</code>æ–¹æ³•</h4><pre tabindex=0><code>    public static IClipboard asInterface(IBinder obj) {
        if (obj == null) {
            return null;
        }
        IInterface iin = obj.queryLocalInterface(DESCRIPTOR);
        if (iin == null || !(iin instanceof IClipboard)) {
            return new Proxy(obj);
        }
        return (IClipboard) iin;
    }
</code></pre><p>å›åˆ°æ­£é¢˜ï¼Œå§œç»´çš„æ–‡ç« é‡Œæ‹¦æˆªäº†<code>queryLocalInterface</code>ä»¥åï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºå®ƒåˆåŠ¨æ€ä»£ç†äº†ä¸€ä¸ªå«åš<code>base</code>çš„å¯¹è±¡ï¼Œå› ä¸ºè¿™é‡Œnewäº†ä¸€ä¸ª<code>HookBinderInvocationHandler</code>ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯<code>base</code>çªç„¶æœ‰ç‚¹è’™è¿™ä¸ª<code>base</code>æ˜¯å“ªé‡Œå†’å‡ºæ¥çš„ï¼Œçœ‹çœ‹ä¸Šä¸‹æ–‡ï¼Œå‘ç°æ˜¯åœ¨ç¬¬ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„Handlerçš„æ„é€ å‡½æ•°é‡Œï¼Œä¼ å…¥äº†ä¸€ä¸ª<code>rawBinder</code>ï¼Œèµ‹å€¼ç»™äº†æˆå‘˜å˜é‡<code>base</code>äº†ï¼Œè€Œè¿™ä¸ª<code>rawBinder</code>ï¼Œå°±æ˜¯ç¬¬ä¸€æ¬¡ä»£ç†ä¸­ï¼Œè¢«ä»£ç†çš„é‚£ä¸ªè¿œç«¯<code>Binder</code>ï¼Œæˆ‘å°±æœ‰ç‚¹çº³é—·äº†ï¼Œä»£ç†ä¸¤æ¬¡å¹²å•¥ï¼Ÿï¼Œä»”ç»†æƒ³ï¼Œè¿™åªæ˜¯ä¸ªæ„é€ å‡½æ•°å•Šï¼Œæˆ‘æƒ³ä¼ è¿›å»ä»€ä¹ˆå’Œæˆ‘è¦åŠ¨æ€ä»£ç†ä»€ä¹ˆå¯¹è±¡æ²¡æœ‰å…³ç³»å‘€ã€‚
äºæ˜¯ç¿»å›å»çœ‹ï¼ŒåŠ¨æ€ä»£ç†çš„æ¥å£æ˜¯<code>this.iinterface</code>ï¼Œçœ‹äº†ä¸‹ç¬¬ä¸€æ¬¡åŠ¨æ€ä»£ç†çš„Handlerçš„æ„é€ å‡½æ•°ï¼Œçœ‹åˆ°</p><pre tabindex=0><code>this.iinterface = Class.forName(&#34;android.content.IClipboard&#34;)
</code></pre><p>ä»”ç»†æƒ³æƒ³ï¼Œè¿™æ˜¯è¦æå‡ºæ¥ä¸€ä¸ª<code>IClipboard</code>å•Šï¼Œå…¶å®è¿™ä¸ª<code>IClipboard</code>æˆ‘ä»¬å‰æ–‡æ¥è§¦è¿‡äº†ï¼Œè¿™é‡Œè´´ä¸Š<code>IClipboard</code>éƒ¨åˆ†æºç ï¼ˆä¸»è¦çœ‹ç»“æ„ï¼‰</p><pre tabindex=0><code>package android.content;
Â·Â·Â·Â·Â·Â·
public interface IClipboard extends IInterface {

    public static abstract class Stub extends Binder implements IClipboard {
Â·Â·Â·Â·Â·Â·
        private static class Proxy implements IClipboard {
Â·Â·Â·Â·Â·Â·
</code></pre><p>æ¢³ç†ä¸€éï¼Œ
ç¬¬ä¸€æ¬¡åŠ¨æ€ä»£ç†äº†è¿œç«¯<code>Binder</code>ï¼ŒHandleræ˜¯<code>IClipboardHookBinderHandler</code>ï¼Œ
åœ¨ç¬¬ä¸€æ¬¡ä»£ç†çš„Handleré‡Œé¢ï¼Œæ‹¦æˆªäº†<code>queryLocalInterface</code>æ–¹æ³•ï¼Œ
è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨<code>asInterface</code>é‡Œé¢è°ƒç”¨çš„ï¼Œ
æ‹¦æˆªä»¥åï¼Œå¼€å§‹ç¬¬äºŒæ¬¡åŠ¨æ€ä»£ç†ï¼Œ
ç”¨<code>IClipboard</code>è¿™ä¸ªæ¥å£åˆæˆäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ŒHandleræ˜¯<code>HookBinderInvocationHandler</code>ï¼Œ
æŠŠè¿™ä¸ªåˆæˆçš„ä»£ç†å¯¹è±¡<code>return</code>äº†ï¼ï¼ï¼</p><p>æ²¡é”™ï¼Œè¿™é‡Œæ˜¯å…³é”®ï¼Œå®ƒç›´æ¥æŠŠå®ƒä½œä¸º<code>queryLocalInterface</code>æ–¹æ³•çš„è¿”å›å€¼<code>return</code>äº†</p><p>çœ‹ä¸€ä¸‹åŸæ¥çš„<a href=#BinderProxy%E4%B8%ADqueryLocalInterface%E7%9A%84%E5%AE%9E%E7%8E%B0>BinderProxyä¸­queryLocalInterfaceçš„å®ç°</a></p><p>å†çœ‹ä¸€ä¸‹<a href=#IClipboard.Stub%E7%9A%84asInterface%E6%96%B9%E6%B3%95>IClipboard.Stubçš„asInterfaceæ–¹æ³•</a></p><p>åœ¨<code>asInterface</code>æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬åˆæˆçš„ä»£ç†å¯¹è±¡ï¼Œèµ‹å€¼ç»™äº†iinï¼Œæ¥ä¸‹æ¥</p><pre tabindex=0><code>        IInterface iin = obj.queryLocalInterface(DESCRIPTOR);
        if (iin == null || !(iin instanceof IClipboard)) { //å…³é”®ï¼ï¼ï¼ï¼ï¼
            return new Proxy(obj); //æ²¡èµ°è¿™ï¼ï¼ï¼
        }
        return (IClipboard) iin; //èµ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬åˆæˆçš„ä»£ç†å¯¹è±¡è¢«å¼ºåˆ¶è½¬æ¢ä»¥åç›´æ¥è¿”å›äº†ï¼Œè¢«ç”¨æ¥ä¹‹åè¿›è¡Œå‰ªåˆ‡æ¿çš„ä¸€äº›æ“ä½œ
</code></pre><p>å“‡ï¼Œå‡ ä¹å“­å‡ºæ¥ï¼Œçœ‹äº†é‚£ä¹ˆä¹…ç»ˆäºæ‡‚äº†å…³é”®éƒ¨åˆ†ï¼Œä¸ºä»€ä¹ˆä½œè€…ä¸æ ‡è®°ä¸€ä¸‹å‘¢
/(ã„’oã„’)/~~</p><p>æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ï¼š</p><p>hookå‰ï¼š</p><pre tabindex=0><code>[è°ƒç”¨ getSystemService ]
 --&gt; [ ClipboardManager çš„æ„é€ å‡½æ•°]
 --&gt; [é—´æ¥è°ƒç”¨äº† ServiceManager ä¸­çš„ getService ]
 --&gt; [è·å¾—è¿œç«¯ Binder å¯¹è±¡]
 --&gt; [è°ƒç”¨ IClipboard.Stub çš„ asInterface å¹¶æŠŠè¿œç«¯å¯¹è±¡ä¼ å…¥]
 --&gt; [è·å¾— IClipboard.Stub.Proxy å¯¹è±¡]
 --&gt; [åç»­ä½¿ç”¨]
</code></pre><p>hookåï¼š</p><pre tabindex=0><code>[Hookå¼€å§‹]
 --&gt; [ä¸»åŠ¨åå°„è°ƒç”¨ ServiceManager ä¸­çš„ getService å¹¶åŠ¨æ€ä»£ç†è¿œç«¯å¯¹è±¡]
 --&gt; [æ­£å¸¸è°ƒç”¨å¼€å§‹]
 --&gt; [è°ƒç”¨ getSystemService ]
 --&gt; [ ClipboardManager çš„æ„é€ å‡½æ•°]
 --&gt; [é—´æ¥è°ƒç”¨äº† ServiceManager ä¸­çš„ getService ]
 --&gt; [è·å¾—ç¬¬ä¸€æ¬¡åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å¯¹è±¡]
 --&gt; [è°ƒç”¨ IClipboard.Stub çš„ asInterface å¹¶æŠŠè¿œç«¯å¯¹è±¡ä¼ å…¥]
 --&gt; [æ‹¦æˆª queryLocalInterface å¹¶åˆæˆ IClipboard æ¥å£çš„ä»£ç†å¯¹è±¡]
 --&gt; [è¿”å›åˆæˆçš„ä»£ç†å¯¹è±¡]
 --&gt; [åç»­ä½¿ç”¨]
</code></pre><p>å°±è¿™æ ·ï¼Œä¸¤æ¬¡åŠ¨æ€ä»£ç†ï¼Œç¬¬ä¸€æ¬¡ä»£ç†è¿œç«¯å¯¹è±¡ï¼Œæ‹¦æˆª<code>queryLocalInterface</code>æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡åŠ¨æ€ä»£ç†åˆæˆäº†ä¸€ä¸ªå®ç°äº†<code>IClipboard</code>æ¥å£çš„å¯¹è±¡ï¼Œéª—è¿‡äº†<code>ClipboardManager</code>ã€‚</p></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer><hr>Â© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡ - 2020042968å·</a></footer></body></html>