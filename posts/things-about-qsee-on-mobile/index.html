<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>浅析一加6手机上的QSEE | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>浅析一加6手机上的QSEE</span></h1><span><span class=date>📅 2021-10-12</span>
<span class=date>(更新于2023-08-30)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/tee/>TEE</a></span>
/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/trustzone/>#TrustZone</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a>
<a href=https://blog.imlk.top/tags/qsee/>#QSEE</a></span></span><br></div><main class=post-content><h1 id=refer>Refer</h1><ul><li><a href=https://blog.csdn.net/wnw_jackie/article/details/113373657>com.qualcomm.qti.qdma 简单介绍</a></li><li><a href=https://research.checkpoint.com/2019/the-road-to-qualcomm-trustzone-apps-fuzzing/>The Road to Qualcomm TrustZone Apps Fuzzing</a> <a href=https://cfp.recon.cx/media/tz_apps_fuzz.pdf>[PDF]</a> [RECON Montreal 2019]</li><li>Qualcomm-<a href=https://www.qualcomm.com/documents/secure-boot-and-image-authentication-technical-overview-v20>Secure Boot and Image Authentication Technical Overview (v2.0)</a> also <a href=https://www.qualcomm.com/media/documents/files/secure-boot-and-image-authentication-technical-overview-v1-0.pdf>v1.0 version</a></li><li><a href=https://www.usenix.org/system/files/sec20-harrison.pdf>PartEmu: Enabling Dynamic Analysis of Real-World TrustZone SoftwareUsing Emulation</a> [USENIX 20]</li><li><a href=https://gtoad.github.io/2019/11/26/TEE-CVE-2015-6639/>https://gtoad.github.io/2019/11/26/TEE-CVE-2015-6639/</a></li></ul><h1 id=keypoints>Keypoints</h1><h2 id=缩写>缩写</h2><p>部分参考自<a href=#refer>Refer[1]</a></p><ul><li><strong>QSEE</strong>: Qualcomm Secure Execution Environment (TZ versions 4.x, 3.x, and 2.x)</li><li><strong>QTEE</strong>: Qualcomm Trusted Execution Environment (TZ version 5.x)</li><li><strong>TA</strong>: Trusted Application 也称为<strong>trustlets</strong></li><li><strong>HLOS</strong>: High Level OS，即Non-secure世界的OS</li><li><strong>QTI</strong>: Qualcomm Technologies Inc.</li><li><strong>QSEECOM</strong>: Qualcomm Secure Execution Environment Communicator</li><li><strong>QSEECOMD</strong>: QTI Secure Execution Environment Communicator Daemon.</li></ul><h2 id=关键文件>关键文件</h2><ul><li><p>/vendor/lib64/libQSEEComAPI.so：用户态程序API。并无源码，但在AOSP中找到一份<a href=https://cs.android.com/android/platform/superproject/+/master:hardware/qcom/keymaster/QSEEComAPI.h>QSEEComAPI.h</a>头文件</p></li><li><p>/vendor/bin/qseecomd：用户态守护进程</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled.png alt=Untitled></p></li><li><p>/dev/qseecom 、/dev/qsee_ipc_irq_spss: 内核驱动暴露给用户态程序的字符设备接口。</p><p>仅在高通设备内核源码中存在，<a href=https://android.googlesource.com/kernel/msm.git/+/refs/tags/android-12.0.0_r0.7/drivers/misc/qseecom.c>驱动源码</a></p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%201.png alt=Untitled></p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%202.png alt=Untitled></p></li><li><p>常见的存放二进制TA程序的目录：<a href=https://research.checkpoint.com/2019/the-road-to-qualcomm-trustzone-apps-fuzzing/>来源</a></p><pre tabindex=0><code>/firmware/image/
/vendor/firmware/
/vendor/firmware/image/
</code></pre></li><li><p>调试信息：</p><ul><li><p>源码位置：drivers/firmware/qcom/tz_log.c</p></li><li><p>/proc/tzdbg/：一加Android N以上设备上存在，包含<code>qsee_log</code>和<code>tz_log</code>两个子文件</p></li><li><p>/sys/kernel/debug/tzdbg/：若设备挂载了debugfs，<code>tzdbg</code>目录下存在和trustzone相关实时日志信息。</p><ul><li>其中<code>qsee_log</code>是安全世界一侧的日志</li></ul><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%203.png alt=Untitled></p></li><li><p>此外dmesg中也有一部分内核驱动日志（日志tag是QSEECOM）</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%204.png alt=Untitled></p></li></ul></li></ul><h2 id=设备分区以oneplus-6为例>设备分区（以oneplus 6为例）</h2><ul><li><p>/vendor挂载了一个单独的分区，存放厂商特定的数据。这里面/vendor/firmware里存放了一部分trustlets</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%205.png alt=Untitled></p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%206.png alt=Untitled></p></li><li><p>/vendor/firmware_mnt里面存放了设备上一部分trustlets的可执行文件，单独在另一个分区里</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%207.png alt=Untitled></p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%208.png alt=Untitled></p></li></ul><h2 id=设备上的trustlets文件以oneplus-6为例>设备上的<strong>trustlets文件（以oneplus 6为例）</strong></h2><p>该设备上的存放trustlets文件的路径已知有两个，<code>/vendor/firmware/</code>和<code>/vendor/firmware_mnt/image/</code></p><p>（单个trustlet程序被拆分成好几个文件，这里为了显示设备上有哪些trustlet，只列出了主要部分的<code>.mdt</code>文件）</p><ul><li><p><code>/vendor/firmware/</code>：</p><pre tabindex=0><code>-rw-r--r-- 1 root root 6684 2009-01-01 08:00 /vendor/firmware/a630_zap.mdt
-rw-r--r-- 1 root root 7208 2009-01-01 08:00 /vendor/firmware/cppf.mdt
-rw-r--r-- 1 root root 6812 2009-01-01 08:00 /vendor/firmware/ipa_fws.mdt
-rw-r--r-- 1 root root 7208 2009-01-01 08:00 /vendor/firmware/widevine.mdt
</code></pre></li><li><p><code>/vendor/firmware_mnt/image/</code>，其中值得注意的有一个<code>alipay.mdt</code>，还有一个<code>soter64.mdt</code></p><pre tabindex=0><code>-r--r----- 1 system system 7452 2021-05-26 22:51 /vendor/firmware_mnt/image/adsp.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/alipay.mdt
-r--r----- 1 system system 7260 2021-05-26 22:51 /vendor/firmware_mnt/image/cdsp.mdt
-r--r----- 1 system system 6876 2021-05-26 22:51 /vendor/firmware_mnt/image/cmnlib.mdt
-r--r----- 1 system system 7032 2021-05-26 22:51 /vendor/firmware_mnt/image/cmnlib64.mdt
-r--r----- 1 system system  724 2021-05-26 22:25 /vendor/firmware_mnt/image/cpe_9340.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/cppf.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/dhsecapp.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/dxhdcp2.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/esesvc.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/faceapp.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/fpc1228.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/gfp5288.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/gfp9508.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/gpqese.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/gptest.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/haventkn.mdt
-r--r----- 1 system system 8412 2021-05-26 22:51 /vendor/firmware_mnt/image/modem.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/securemm.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/sl7000.mdt
-r--r----- 1 system system 7964 2021-05-26 22:51 /vendor/firmware_mnt/image/slpi.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/soter64.mdt
-r--r----- 1 system system 6812 2021-05-26 22:51 /vendor/firmware_mnt/image/venus.mdt
-r--r----- 1 system system 7004 2021-05-26 22:51 /vendor/firmware_mnt/image/voicepri.mdt
-r--r----- 1 system system 7208 2021-05-26 22:51 /vendor/firmware_mnt/image/widevine.mdt
</code></pre></li></ul><h3 id=trustlet文件格式>trustlet文件格式</h3><p>并未找到关于这些文件组织形式的官方说明文档，但从一些网络来源可以得出一些结论：</p><ul><li><p>trustlet可执行文件被拆分成了好几个部分，包括<code>*.mdt</code>、<code>*.bXX</code>。</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%209.png alt=图源Refer[2]></p><p>图源<a href="https://www.notion.so/Things-About-QSEE-On-Mobile-d705c73739c241e48aab6765102a11b3?pvs=21">Refer[2]</a></p></li><li><p>完整的trustlet是一个标准的ELF格式文件，其中有一个名为Hash Table的Segment（这个段的定义可在<a href="https://www.notion.so/Things-About-QSEE-On-Mobile-d705c73739c241e48aab6765102a11b3?pvs=21">Refer[3]</a>找到）。</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%2010.png alt=Untitled></p><ul><li>前半部分是元数据和各ELF文件中各segments的哈希值。</li><li>签名和证书链：文件中包含证书（Signature）和证书链（Cert Chain）。<ul><li>双重签名：在OEM签名的基础上，还允许由QTI进行签名（可选），将产生两套证书和证书链。两套签名都校验正确才通过。</li><li>根证书是针对一个HASH值进行校验的，HASH值要么存在QFPROM eFuses中，要么保存在硬件ROM代码中。（见<a href="https://www.notion.so/Things-About-QSEE-On-Mobile-d705c73739c241e48aab6765102a11b3?pvs=21">Refer[3]</a>）</li></ul></li></ul></li><li><p>高通的SDK中有一个名为sectools的工具来做签名和文件分解，在网上找到<a href=https://gitlab.mingwork.com/hanguoliang/test/tree/8e3a790f3a19335c80e72fab48245550233323db/adsp_proc/sectools>一份</a>。</p></li><li><p>使用<a href=https://github.com/pandasauce/unify_trustlet>https://github.com/pandasauce/unify_trustlet</a> 这个工具可以将这些零散的文件合并：</p><ul><li>工具原理是：读取ProgramHeaders，然后按照Segment的序号，依次读取.bXX文件拼接到文件内正确的位置。</li></ul></li></ul><h3 id=libqseecomapiso分析>libQSEEComAPI.so分析</h3><ul><li>闭源，但是AOSP中有一份头文件<a href=https://cs.android.com/android/platform/superproject/+/master:hardware/qcom/keymaster/QSEEComAPI.h>QSEEComAPI.h</a></li><li>通过/dev/qseecom字符设备与内核通信，内核侧源码：<ul><li><a href=https://android.googlesource.com/kernel/msm.git/+/refs/tags/android-12.0.0_r0.7/drivers/misc/qseecom.c>/drivers/misc/qseecom.c</a></li><li><a href=https://android.googlesource.com/kernel/msm.git/+/refs/tags/android-12.0.0_r0.7/include/uapi/linux/qseecom.h>/include/uapi/linux/qseecom.h</a></li></ul></li><li>IDA分析<ul><li>QSEECom_start_app(): 存在v1和v2两个版本<ul><li><code>QSEECom_start_app()</code>: 传入trustlet文件路径，读取<code>*.md</code>t、<code>*.bXX</code>，将所有文件直接拼接在一起，然后写入到啊内存中传递给内核中的qseecom驱动 。加载完成后释放ION内存</li><li><code>QSEECom_start_app_V2()</code>: 传入普通内存中加载好的trustlet文件buffer，拷贝到ION内存中，传递给内核中的qseecom驱动。加载完成后释放ION内存</li></ul></li><li>其余函数未分析。。</li></ul></li></ul><h2 id=trustlet文件分析以soter64为例>trustlet文件分析（以soter64）为例</h2><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%2011.png alt=Untitled></p><h3 id=证书链>证书链</h3><ul><li>三级证书模式：<ul><li>叶子证书是为每个trustlet单独生成的，比如alipay的和soter64的叶子证书不同。</li><li>叶子证书中OU字段包含了trustlet的一些元数据如HW_ID、OEM_ID、APP_ID之类的，但文档说新的做法是将这些元数据移到ELF文件中而不是叶子证书上。</li></ul></li></ul><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%2012.png alt=某个trustlet特定的证书></p><p>某个trustlet特定的证书</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%2013.png alt=中间证书></p><p>中间证书</p><p><img src=/images/Things%20About%20QSEE%20On%20Mobile%20d705c73739c241e48aab6765102a11b3/Untitled%2014.png alt=根证书></p><p>根证书</p><h3 id=总结>总结</h3><p>下一步计划借助ida分析，但是存在一些难点</p><ul><li>缺少函数定义头文件</li><li>似乎与GlobalPlatform组织的API标准不同</li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>