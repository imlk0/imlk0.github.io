<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>探究AMD SEV/SEV-ES远程证明过程——在EPYC 7302洋垃圾服务器上 | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>探究AMD SEV/SEV-ES远程证明过程——在EPYC 7302洋垃圾服务器上</span></h1><span><span class=date>📅 2023-04-14</span>
<span class=date>(更新于2023-08-30)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/tee/>TEE</a></span>
/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/sev/>#SEV</a>
<a href=https://blog.imlk.top/tags/kvm/>#KVM</a>
<a href=https://blog.imlk.top/tags/homelab/>#Homelab</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a></span></span><br></div><main class=post-content><p>去年把Homelab升级到了EPYC 7302，是二代的EPYC产品，代号"rome"，这块CPU支持SEV和SEV-ES特性也就是所谓机密虚拟机。Intel的CPU中与之对应的则是TDX，只可惜支持TDX特性的CPU价格昂贵，是难以触碰到的。与之相比，AMD SEV系列则比较容易买到，花费千元不到的价格，就能买到二代EPYC。目前支持SEV-SNP的三代EPYC的二手价格最低是3500左右，还是略高。</p><p>在本文中，我将通过实验如何创建一个SEV/SEV-ES虚拟机、对虚拟机进行度量和secret注入，来学习和理解其远程证明过程。</p><blockquote><p>本文仅限于对SEV/SEV-ES特性的简单尝试，和对pre-attestation远程证明的理解。这篇文章中的许多部分，尤其是Guest VM中OVMF、GRUB、Kernel、Kernel cmdline的配置和度量并不完备，<strong>请勿直接将文中的命令直接用于构建生产环境</strong>，而是使用现有的成熟方案，例如<a href=https://github.com/confidential-containers/kata-containers-CCv0>confidential-containers/kata-containers-CCv0</a>。</p></blockquote><h2 id=host环境配置>Host环境配置</h2><p>Host环境比较好配，libvirt有一篇<a href=https://libvirt.org/kbase/launch_security_sev.html#id2>文章</a>介绍了配置过程。</p><ol><li>开启SME：kernel cmdline 加<code>mem_encrypt=on</code></li><li>开启SEV：kernel cmdline 加<code>kvm_amd.sev=1</code>，给kvm_amd内核模块的sev参数。如果你想用SEV-ES，请加上<code>kvm_amd.sev_es=1</code></li><li>BIOS配置：如果想要SEV-ES支持，需要在BIOS里，将<code>SEV-ES ASID Space Limit</code>从默认值1改成大一些的值。小于这个Limit值的ASID都将分配给SEV-ES，其余的分配给SEV。
<img src=/images/iKVM_capture_1.jpg alt>
<img src=/images/iKVM_capture_2.jpg alt></li></ol><p>最后，检查<code>/proc/cpuinfo</code>里有<code>sme</code>和<code>sev</code>，并且<code>/sys/module/kvm_amd/parameters/sev</code>的值为<code>Y</code>或者<code>1</code>就行了。如果是SEV-ES，还要检查<code>/proc/cpuinfo</code>里有<code>sev_es</code>，并且<code>/sys/module/kvm_amd/parameters/sev_es</code>的值为<code>Y</code>或者<code>1</code></p><blockquote><p>如果没有，记得检查一下你的CPU是否支持sev，并且BIOS里面是否开了SME支持（据说超微早期的一些BIOS没有这个选项）</p></blockquote><p>dmesg里也会显示一些信息：
<img src=/images/2023-04-18-11-33-03.png alt></p><h2 id=创建和启动guest-vm>创建和启动Guest VM</h2><p>上面那篇文章也介绍了虚拟机的创建过程，包括建议使用Q35和OVMF等等。不过因为PVE和libvirt是冲突的，上面的配置方法不适用于我的环境：</p><ul><li><p>对于<code>VM Configuration</code>章节的内容，我们可以按这些指引在PVE的WEB面板上找到对应的配置来创建虚拟机。（为了实验简单，我这里并未完全遵守其中的过程，而是clone了一台已有的Linux虚机来运行）</p></li><li><p>而对于<code>Checking SEV support in the virt stack</code>章节，鉴于PVE的Guest VM并没有提供SEV相关的配置，我们只能在qemu命令行参数上做手脚。</p></li></ul><p>首先，在pve host上，使用<code>qm showcmd</code>查看创建的Guest VM的qemu启动命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>qm showcmd &lt;vmid&gt; --pretty 
</span></span></code></pre></div><p>把<code>&lt;vmid></code>替换成你的vm id</p><blockquote><p>在pve上，<code>/usr/bin/kvm</code>是<code>qemu-system-x86_64</code>的一个符号链接</p></blockquote><p>增加两个命令行选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -object &#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5&#39; \
</span></span><span style=display:flex><span>  -machine &#39;memory-encryption=sev0&#39;
</span></span></code></pre></div><blockquote><p>根据PVE的<a href=https://pve.proxmox.com/wiki/Manual:_qm.conf>文档</a>，也可以通过PVE的虚拟机配置文件中的<code>args</code>参数来追加qemu命令行选项。</p></blockquote><p>如果是SEV，需要设置<code>policy=0x1</code>，如果是SEV-ES，设置<code>policy=0x5</code>。具体的含义可以从 <a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a> 的<code>Table 2. Guest Policy Structure</code>里找到如下描述：</p><p><img src=/images/2023-04-17-15-34-39.png alt></p><p>随后执行完整的qemu命令开启Guest VM。</p><blockquote><p>如果你遇到<code>kvm: sev_kvm_init: failed to initialize ret=-25 fw_error=0 ''</code>，说明你的环境有问题，请参照<code>Host环境配置</code>章节进行检查。</p></blockquote><p>在Guest VM中使用以下命令验证sev已经开启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dmesg | grep -i sev
</span></span></code></pre></div><p><img src=/images/2023-04-18-14-17-08.png alt></p><p>如果设置<code>policy=0x1</code>那就是：</p><p><img src=/images/2023-04-14-14-50-57.png alt></p><h2 id=sev--sev-es的远程证明过程>SEV & SEV-ES的远程证明过程</h2><p>SEV和SEV-ES只支持<code>pre-attestation</code>形式的验证，即在VM启动时进行度量和secret植入，而从epyc 7003系列开始增加的SEV-SNP特性支持<code>runtime-attestation</code>。由于作者只有epyc 7302的机器（买不起新的），本文只介绍<code>pre-attestation</code>。具体的流程可以参考<a href=https://github.com/AMDESE/sev-tool#proposed-provisioning-steps>sev-tool</a>的文档，以及<a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a>的「Appendix A Usage Flows」章节里的流程图，两者都算很清晰的。</p><p>本文将用virtee社区构建的<a href=https://github.com/virtee/sevctl>sevctl</a>工具实际操作一遍这个过程，有助于对<code>pre-attestation</code>的理解。</p><blockquote><p>至于为什么用sevctl不用AMD自己的sev-tool，因为我是rustacean :)</p></blockquote><h3 id=概念介绍>概念介绍</h3><p>SEV的威胁模型想必不用多解释，这里介绍一下在这个实验中的三方：</p><ul><li>SEV Host (😈️): 或称平台Platform，指SEV的主机环境，包括Hypervisor，归属于平台所有者（服务器的提供者），并可以由其控制。在我们的实验中就是我的pve主机。</li><li>SEV Guest VM (🤔): 受保护的机密容器，也就是托管在服务器上的的一个虚拟机，其安全性对于Guest Owner来说是未知的，需要通过remote attestation来证明。在实验中这是我在pve上的一个虚拟机。</li><li>Relying Party (😇): 天然可以被Guest Owner所相信的一些环境。在实验中这个是我的个人电脑。</li></ul><h3 id=构建带sev支持的ovmf>构建带SEV支持的OVMF</h3><p>会发现pve自带的OVMF firmware是不支持AMDSEV的，使用该firmware我们将无法完成SEV的LAUNCH_SECRET环节。</p><p>参考了以下文档之后：</p><ul><li><a href=https://github.com/confidential-containers/documentation/blob/9faf24a7f26053820bd0c8a809134b2e8ed52d2d/demos/sev-demo/README.md#ovmf>CCv0 with AMD SEV - confidential-containers社区</a></li><li><a href=https://github.com/tianocore/tianocore.github.io/wiki/Getting-Started-with-EDK-II>Getting Started with EDK II</a></li></ul><p>我决定自己构建OVMF firmware：</p><ol><li><p>通过包管理器安装<code>nasm</code>、<code>iasl</code>命令</p></li><li><p>获取EDK2源码并编译OVMF</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/tianocore/edk2.git
</span></span><span style=display:flex><span>cd edk2 
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make -C BaseTools/
</span></span><span style=display:flex><span>source edksetup.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch OvmfPkg/AmdSev/Grub/grub.efi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>build -t GCC5 -a X64 -p OvmfPkg/AmdSev/AmdSevX64.dsc
</span></span></code></pre></div></li></ol><p>产物路径为<code>Build/AmdSev/DEBUG_GCC5/FV/OVMF.fd</code></p><h3 id=构建sevctl>构建sevctl</h3><p>非常简单，clone下来然后cargo build就行啦</p><p>需要注意的是，对于<code>pre-attestation</code>，只需要在SEV Host，和Relying Party环境中编译和使用这个工具。不需要在SEV VM里编译它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/virtee/sevctl
</span></span><span style=display:flex><span>cd sevctl
</span></span><span style=display:flex><span>cargo install --path .
</span></span></code></pre></div><h3 id=平台导出证书链>（平台）导出证书链</h3><p>首先，需要在SEV Host上导出该平台PDH公钥及其证书链，并将其发给Guest Owner进行验证。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl export /tmp/sev.pdh
</span></span></code></pre></div><p>使用scp将/tmp/sev.pdh拷贝到Relying Party侧</p><h3 id=relying-party验证证书链完整性>（Relying Party）验证证书链完整性</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl verify --sev /tmp/sev.pdh
</span></span></code></pre></div><p>输出如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>PDH EP384 D256 6a8d620717a742dd522b914d5e730eb84eda5bcb47a57f46ce2b7e10f1901b13
</span></span><span style=display:flex><span> ⬑ PEK EP384 E256 ded12636fe3fdfe5774944ea91e475c1ddf1a1d9f1955469d784782d5989ae9b
</span></span><span style=display:flex><span>   •⬑ OCA EP384 E256 63b5d98d309ce7c7b8c8a0f2ec93516560e0c4a5ef4535da0cbddd0f1e34e130
</span></span><span style=display:flex><span>    ⬑ CEK EP384 E256 1345efa44c7a85979b07053ae5c5e16a0b103fc5bf3d0281b2f1ff8802ad71e6
</span></span><span style=display:flex><span>       ⬑ ASK R4096 R384 d8cd9d1798c311c96e009a91552f17b4ddc4886a064ec933697734965b9ab29db803c79604e2725658f0861bfaf09ad4
</span></span><span style=display:flex><span>         •⬑ ARK R4096 R384 3d2c1157c29ef7bd4207fc0c8b08db080e579ceba267f8c93bec8dce73f5a5e2e60d959ac37ea82176c1a0c61ae203ed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> • = self signed, ⬑ = signs, •̷ = invalid self sign, ⬑̸ = invalid signs
</span></span></code></pre></div><p>sevctl这个工具做的还是很精心的，证书链的可视化也很好，可以看到整个链上没有invalid的部分，这说明证书链是完好的。</p><p>这里简单解释一下每个密钥的用途：</p><p>平台部分：</p><ul><li>CEK(Chip Endorsement Key)：每个SEV平台，具体来说是一块CPU的唯一的密钥，它从烧录在CPU的OTP fuses里的一段secret派生而来，并不直接使用，用于给其它密钥签名。</li><li>PEK(Platform Endorsement Key)：随机产生的ECDSA签名密钥，当该平台的所有者变更时重新生成。</li><li>PDH(Platform Diffie-Hellman Key)：随机产生的ECDH密钥，是整个证书链的最末端。其生命期和PEK一样，<strong>并非特定于某个Guest VM</strong>的。它的用途后面会讲到</li></ul><p>AMD部分：</p><ul><li>ASK(AMD Signing Key)：AMD持有，在出厂前对CEK进行签名</li><li>ARK(AMD Root Key)：AMD持有，用于签署ASK</li></ul><p>通过这条链，AMD向你证明这个平台是AMD认可的。</p><blockquote><p>每一代EPYC产品的ASK/ARK证书可以从<a href=https://www.amd.com/en/developer/sev.html>AMD的网页</a>上获得。</p><p>每一块CPU对应的CEK也可以从<a href=https://kdsintf.amd.com/cek/>这个网页</a>获得，参数cpu的标识id可以通过<code>sevctl show identifier</code>命令获得。注意每次访问时获得的CEK证书都是不同的（签名字段会变化）。</p></blockquote><blockquote><p>值得一提的是，由于CEK是从fuse派生的，AMD其实也是持有CEK的私钥部分的，这意味着在这条链上，你需要完全相信AMD。</p></blockquote><p>以上是与AMD关联的一条链，细心的读者应该发现了从OCA开始的另一条链，<code>OCA->PEK->PDH</code>。</p><ul><li>OCA(Owner Certificate Authority Signing Key)：所有者持有的签名密钥。
可以看到，在证书链的位置上，OCA是与CEK并列的。通过这条链，还额外证明了这个平台是被某个平台所有者所拥有的。</li></ul><p>具体来说这里还可以细分到两种模式：</p><ol><li>self-owned：SEV firmware同时持有OCA公钥和私钥部分，它在内部生成这对密钥。这意味着任何一个外部实体都无法访问私钥。</li><li>platform-owned: SEV firmware只持有OCA公钥，而私钥由平台的所有者持有。</li></ol><p>关于ARK和OCA两个证书链，这里有一个很好的说明：https://github.com/inclavare-containers/attestation-evidence-broker/blob/master/docs/design/design.md#sev-es-attestation-evidence</p><h3 id=relying-party协商密钥并创建会话>（Relying Party）协商密钥并创建会话</h3><p>每次启动一个Guest VM被称为一次会话（session），Guest Owner需要为这一个session生成GODH密钥，然后和平台发来的证书链（包含PDH）一起生成master secret。从master secret派生出KEK、KIK，以及一组随机生成的TEK、TIK和密钥。把这些密钥一起生成session parameters。Hypervisor在启动VM时，会将GODH和session parameters其作为LAUNCH_START的参数传递给PSP。</p><blockquote><p>在生产环境中，请不要重复使用之前的GODH，以防平台拥有者对你发起重放攻击。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl session -n <span style=color:#e6db74>&#39;sev&#39;</span> /tmp/sev.pdh <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>其中<code>'sev'</code>是我指定的密钥名字，<code>/tmp/sev.pdh</code>是从平台拿到的证书链 <code>5</code>是启动Guest VM时的policy值（Guest Owner应该控制这个值以避免由配置导致的安全问题）。</p><p>这将在当前目录下产生若个文件</p><ul><li>sev_godh.b64：GODH(Guest Owner Diffie-Hellman key)，它和PDH都是<a href=https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman>ECDH</a>密钥，在交换公钥之后双方可以生成一致的master secret。</li><li>sev_session.b64：session parameters，包含了由KEK和KIK共同保护的TEK和TIK，以及一个和session有关的NONCE值
<img src=/images/2023-04-17-21-35-24.png alt></li><li>sev_tek.bin：TEK(Transport Encryption Key)，一个AES-128密钥。用于加密Guest Owner和Firmware之间传输的数据</li><li>sev_tik.bin：TIK(Transport Integrity Key)，一个HMAC密钥。用于对Guest Owner和Firmware之间传输的数据实施完整性保护。</li></ul><p>使用scp将sev_godh.b64和sev_session.b64发送到平台侧用于启动VM，其余的两个文件由Relying Party保留。</p><h3 id=平台启动guest-vm并进行度量>（平台）启动Guest VM并进行度量</h3><p>与libvirt不同，pve并未提供在启动时度量Guest VM状态的命令，我们需要对pve启动qemu时的参数进行一些修改。</p><p>同样，在pve host上，使用<code>qm showcmd</code>查看qemu启动命令</p><p>我们要做以下修改</p><ol><li><p>使用我们自己编译的OVMF.fd而不是pve提供的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -drive &#39;if=pflash,unit=0,format=raw,readonly=on,file=/usr/share/pve-edk2-firmware//OVMF_CODE_4M.secboot.fd&#39; \
</span></span></code></pre></div><p>改成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -drive &#39;if=pflash,unit=0,format=raw,readonly=on,file=./OVMF.fd&#39; \
</span></span></code></pre></div></li><li><p>增加sev相关的选项，尤其是sev-guest选项要增加参数<code>dh-cert-file=&lt;file1>,session-file=&lt;file2></code></p><blockquote><p>qemu <a href=https://www.qemu.org/docs/master/system/qemu-manpage.html>man-page</a>:</p><p>The dh-cert-file and session-file provides the guest owner’s Public Diffie-Hillman key defined in SEV spec. The PDH and session parameters are used for establishing a cryptographic session with the guest owner to negotiate keys used for attestation. The file must be encoded in base64.</p></blockquote><p>例如在我的实验中中，使用以下选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -object &#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5,dh-cert-file=/tmp/sev_godh.b64,session-file=/tmp/sev_session.b64&#39; \
</span></span><span style=display:flex><span>  -machine &#39;memory-encryption=sev0&#39;
</span></span></code></pre></div></li><li><p>在其中插入一个<code>-S</code>选项，这样可以<a href=https://www.qemu.org/docs/master/system/managed-startup.html>在启动后暂停VM</a>，我们有机会进行度量。</p></li></ol><p>改完之后的命令如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/usr/bin/kvm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -id <span style=color:#ae81ff>114</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -name <span style=color:#e6db74>&#39;pve-sev,debug-threads=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -no-shutdown <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,id=qmp,path=/var/run/qemu-server/114.qmp,server=on,wait=off&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -mon <span style=color:#e6db74>&#39;chardev=qmp,mode=control&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,id=qmp-event,path=/var/run/qmeventd.sock,reconnect=5&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -mon <span style=color:#e6db74>&#39;chardev=qmp-event,mode=control&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -pidfile /var/run/qemu-server/114.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -daemonize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -smbios <span style=color:#e6db74>&#39;type=1,uuid=1fe437a6-eac4-48c3-9640-298b4a370cf6&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;if=pflash,unit=0,format=raw,readonly=on,file=./OVMF.fd&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;if=pflash,unit=1,id=drive-efidisk0,format=qcow2,file=/mnt/sandisk2t-data/pve-storage//images/114/vm-114-disk-0.qcow2&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -smp <span style=color:#e6db74>&#39;8,sockets=1,cores=8,maxcpus=8&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -nodefaults <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -boot <span style=color:#e6db74>&#39;menu=on,strict=on,reboot-timeout=1000,splash=/usr/share/qemu-server/bootsplash.jpg&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -vnc <span style=color:#e6db74>&#39;unix:/var/run/qemu-server/114.vnc,password=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -cpu <span style=color:#e6db74>&#39;EPYC-Rome,enforce,+kvm_pv_eoi,+kvm_pv_unhalt,vendor=AuthenticAMD&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -m <span style=color:#ae81ff>4096</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -object <span style=color:#e6db74>&#39;iothread,id=iothread-virtioscsi0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -readconfig /usr/share/qemu-server/pve-q35-4.0.cfg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;vmgenid,guid=f277a770-a44d-4ee0-a169-6db7a64677f5&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;qxl-vga,id=vga,max_outputs=4,bus=pcie.0,addr=0x1&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,path=/var/run/qemu-server/114.qga,server=on,wait=off,id=qga0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-serial,id=qga0,bus=pci.0,addr=0x8&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtserialport,chardev=qga0,name=org.qemu.guest_agent.0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-serial,id=spice,bus=pci.0,addr=0x9&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;spicevmc,id=vdagent,name=vdagent&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtserialport,chardev=vdagent,name=com.redhat.spice.0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -spice <span style=color:#e6db74>&#39;tls-port=61000,addr=127.0.0.1,tls-ciphers=HIGH,seamless-migration=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x3,free-page-reporting=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -iscsi <span style=color:#e6db74>&#39;initiator-name=iqn.1993-08.org.debian:01:fc5232458f32&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;file=/mnt/seagate4t/pve-backup/template/iso/archlinux-2023.03.01-x86_64.iso,if=none,id=drive-ide2,media=cdrom,aio=io_uring&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;ide-cd,bus=ide.1,unit=0,drive=drive-ide2,id=ide2,bootindex=101&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-scsi-pci,id=virtioscsi0,bus=pci.3,addr=0x1,iothread=iothread-virtioscsi0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;file=/mnt/sandisk2t-data/pve-storage//images/114/vm-114-disk-1.qcow2,if=none,id=drive-scsi0,discard=on,format=qcow2,cache=none,aio=io_uring,detect-zeroes=unmap&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;scsi-hd,bus=virtioscsi0.0,channel=0,scsi-id=0,lun=0,drive=drive-scsi0,id=scsi0,rotation_rate=1,bootindex=100&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -netdev <span style=color:#e6db74>&#39;type=tap,id=net0,ifname=tap114i0,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown,vhost=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-net-pci,mac=96:27:59:37:8F:1C,netdev=net0,bus=pci.0,addr=0x12,id=net0,rx_queue_size=1024,tx_queue_size=1024&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -netdev <span style=color:#e6db74>&#39;type=tap,id=net1,ifname=tap114i1,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown,vhost=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-net-pci,mac=16:C8:90:53:5B:A9,netdev=net1,bus=pci.0,addr=0x13,id=net1,rx_queue_size=1024,tx_queue_size=1024&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -machine <span style=color:#e6db74>&#39;type=q35+pve0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -object <span style=color:#e6db74>&#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5,dh-cert-file=/tmp/sev_godh.b64,session-file=/tmp/sev_session.b64&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -S <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -machine <span style=color:#e6db74>&#39;memory-encryption=sev0&#39;</span>
</span></span></code></pre></div><p>用改后的参数启动qemu，此时PVE Web面板会显示该VM处于<code>running (prelaunch)</code>状态。</p><p>上面的命令同时开启了unix domain socket，路径为<code>/var/run/qemu-server/114.qmp</code>。这是一个<a href=https://wiki.qemu.org/Documentation/QMP>QMP接口（QEMU Machine Protocol）</a>，通过它我们可以向qemu虚拟机发送一些控制指令。</p><p>可以使用nc或者socat连接到它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>socat - UNIX-CONNECT:/var/run/qemu-server/114.qmp
</span></span></code></pre></div><p>连接上后立刻收到了如下信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;QMP&#34;</span>: {<span style=color:#f92672>&#34;version&#34;</span>: {<span style=color:#f92672>&#34;qemu&#34;</span>: {<span style=color:#f92672>&#34;micro&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;minor&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#f92672>&#34;major&#34;</span>: <span style=color:#ae81ff>7</span>}, <span style=color:#f92672>&#34;package&#34;</span>: <span style=color:#e6db74>&#34;pve-qemu-kvm_7.2.0-8&#34;</span>}, <span style=color:#f92672>&#34;capabilities&#34;</span>: []}}
</span></span></code></pre></div><p>这时我们处于<code>capabilities negotiation</code>模式，我们通过发送以下内容来进入<code>command mode</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;qmp_capabilities&#34;</span> }
</span></span></code></pre></div><p>得到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {}}
</span></span></code></pre></div><p>紧接着，可以通过一下请求查询qmp所支持的所有命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-commands&#34;</span> }
</span></span></code></pre></div><p>输出过长此处省略</p><p>QMP支持的命令的描述及examples，可以在<a href=https://www.qemu.org/docs/master/interop/qemu-qmp-ref.html>这里</a>找到。这里我只介绍一些我们用到的：</p><p>查询平台的sev信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-sev&#34;</span> }
</span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;api-minor&#34;</span>: <span style=color:#ae81ff>24</span>, <span style=color:#f92672>&#34;handle&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;launch-secret&#34;</span>, <span style=color:#f92672>&#34;api-major&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;build-id&#34;</span>: <span style=color:#ae81ff>15</span>, <span style=color:#f92672>&#34;policy&#34;</span>: <span style=color:#ae81ff>5</span>}}
</span></span></code></pre></div><p>查询度量值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-sev-launch-measure&#34;</span> }
</span></span></code></pre></div><p>输出:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD&#34;</span>}}
</span></span></code></pre></div><p>其中data字段的base64值就是度量结果，这是一个48bytes的数据。根据<a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>文档</a>中的<code>Table 52: LAUNCH_MEASURE Measurement Buffer</code>章节，它的结构是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>MEASURE(32bytes) || MNONCE(16bytes)
</span></span></code></pre></div><ol><li><code>MEASURE</code>
在<code>6.5 LAUNCH_MEASURE</code>章节，描述了<code>MEASURE</code>其实是一个HMAC值</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>HMAC(0x04 || API_MAJOR || API_MINOR || BUILD || GCTX.POLICY || GCTX.LD || MNONCE; GCTX.TIK)
</span></span></code></pre></div><p>具体的细节也可以参考<a href=https://www.qemu.org/docs/master/system/i386/amd-memory-encryption.html#calculating-expected-guest-launch-measurement>QEMU文档</a>中的描述。
2. <code>MNONCE</code>
MNONCE是由firmware生成的nonce值，目的是防止敌手发起重放攻击。</p><p>平台需要要把这两个数据一并发给Relaying Party。</p><blockquote><p>所谓度量是一个计算内存hash的过程，PSP内部维护了guest vm的一个状态机。当Hypervisor运行<code>LAUNCH_START</code>命令之后，vm处于<code>GSTATE.LUPDATE</code>状态，此时Hypervisor可以通过对多个内存区域执行<code>LAUNCH_UPDATE_DATA</code>，然后PSP会使用该区域的值来更新当前VM的hash值，并将对应区域的数据使用这个VM对应的VEK密钥进行加密。如果是SEV-ES，Hypervisor还可以通过<code>LAUNCH_UPDATE_VMSA</code>命令来对VM的VMCB save area做上述hash值更新和内存加密操作。最后Hypervisor通过<code>LAUNCH_MEASURE</code>命令生成一个度量结果，并将状态转换为<code>GSTATE.LSECRET</code>，此时无法再使用<code>LAUNCH_UPDATE_DATA</code>和<code>LAUNCH_UPDATE_VMSA</code>命令。</p></blockquote><h3 id=relaying-party验证度量值>（Relaying Party）验证度量值</h3><p>现在转到Relaying Party侧。Guest VM已经度量好，正等着我们验证呢。</p><ol><li><p>构建VMSA binary
如果你是SEV-ES，那么在此之前，还有一项内容，就是构建VMSA binary。这也是SEV-ES相比于SEV多出来的一部分，它额外度量了每个Guest vCPU的VMSA区域，并在运行时提供加密保护。</p><p>因此我们的Guest Owner在验证度量值时，也需要计算出VMSA区域的初始值（也就是VMSA binary），并把它纳入度量过程中。</p><p>首先需要知道Guest vCPU的一些信息。可以使用qmp中的<code>"query-cpu-model-expansion"</code>命令，其中参数<code>"name"</code>需要根据你的qemu命令行中指定的<code>-cpu</code>选项进行调整。</p><p>比如我的命令是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-cpu-model-expansion&#34;</span>, <span style=color:#f92672>&#34;arguments&#34;</span>: { <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;static&#34;</span>, <span style=color:#f92672>&#34;model&#34;</span>: { <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;EPYC-Rome&#34;</span> } } }
</span></span></code></pre></div><p>输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;model&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;base&#34;</span>, <span style=color:#f92672>&#34;props&#34;</span>: {<span style=color:#f92672>&#34;vmx-entry-load-rtit-ctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svme-addr-chk&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cmov&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ia64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ssb-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;aes&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-apicv-xapic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mmx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdpid&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;arat&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-page-walk-4&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-page-walk-5&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;gfni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibrs-all&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-desc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pause-filter&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;bus-lock-detect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsavec&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;intel-pt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-tsc-scaling&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr8-store-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdseed-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-eptp-switching&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-asyncpf&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;perfctr-core&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mpx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pbe&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512cd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;decodeassists&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-clear-bndcfgs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse4.1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;family&#34;</span>: <span style=color:#ae81ff>23</span>, <span style=color:#f92672>&#34;intel-pt-lip&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vmwrite-vmexit-fields&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-asyncpf-int&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vnmi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-true-ctls&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept-execonly&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-save-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-all-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;wbnoinvd&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512f&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;msr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mce&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mca&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xcrypt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-intr-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;min-level&#34;</span>: <span style=color:#ae81ff>13</span>, <span style=color:#f92672>&#34;vmx-flexpriority&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xgetbv1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;cid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-exinfo&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ds&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fxsr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-fp16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-bf16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr8-load-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsaveopt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;arch-lbr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-vid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-save-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xtpr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsx-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ple&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-vpopcntdq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;phe&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;extapic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;3dnowprefetch&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-vmfunc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-shutdown&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx1&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vbmi2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cr8legacy&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-encls-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;stibp&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-msr-bitmap&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xcrypt-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-mwait-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-pml&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-nmi-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-tile&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-single-context-noglobals&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pn&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rsba&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;dca&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vendor&#34;</span>: <span style=color:#e6db74>&#34;AuthenticAMD&#34;</span>, <span style=color:#f92672>&#34;vmx-unrestricted-guest&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr3-store-noexit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pku&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pks&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;smx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cmp-legacy&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-4fmaps&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmcb-clean&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;hle&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx-vnni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;3dnowext&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amd-no-ssb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;npt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgxlc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rdctl-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invvpid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clwb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;lbrv&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;adx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ss&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pni&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tsx-ldtrk&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svm-lock&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;smep&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;smap&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pfthreshold&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invpcid-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-int8&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;x2apic&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512vbmi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vnni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-x2apic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-pv-sched-yield&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invlpg-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invvpid-all-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-hlt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;flushbyasid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;f16c&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-ack-intr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ace2-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pae&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pat&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;phe-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-tsc-offset&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-nopiodelay&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvmclock-stable-bit&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-rdtsc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;hypervisor&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-rdtscp-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mds-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pcommit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vpid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;syscall&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512dq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;invtsc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-monitor-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-wbinvd-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;est&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-poll-control&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512ifma&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tm2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-pv-eoi&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-ipi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cx8&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-invvpid-single-addr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;waitpkg&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cldemote&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-tokenkey&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xfd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-mmu&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse4.2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pge&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512bitalg&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pdcm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-bndcfgs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-clear-rtit-ctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#ae81ff>49</span>, <span style=color:#f92672>&#34;movbe&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;nrip-save&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ssse3&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sse4a&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-msi-ext-dest-id&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-pause-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;invpcid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-debug&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pdpe1gb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sgx-mode64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc-deadline&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;skip-l1dfl-vmentry&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-perf-global-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fma&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;cx16&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;de&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;stepping&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;xsave&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;clflush&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;skinit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tce&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fpu&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ds-cpl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fma4&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-nosave-debugctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-kss&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;la57&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;osvw&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;apic&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pmm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-noload-debugctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-eptad&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;spec-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-posted-intr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-register&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc-adjust&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-steal-time&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-vp2intersect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvmclock&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-zero-len-inject&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pschange-mc-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;v-vmsave-vmload&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdrand-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-provisionkey&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lwp&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amd-ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xop&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibpb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ibrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;core-capability&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-single-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;movdiri&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;acpi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512bw&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ace2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fsgsbase&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-ept-2mb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept-1gb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ht&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-io-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;nx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pclmulqdq&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mmxext&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;popcnt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vaes&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;serialize&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;movdir64b&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsaves&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-shadow-vmcs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-save-preemption-timer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fsrm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-perf-global-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-io-bitmap&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;umip&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-store-lma&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-movdr-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sep&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;virt-ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr3-load-noexit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;nodeid-msr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;md-clear&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;misalignsse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;split-lock-detect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;min-xlevel&#34;</span>: <span style=color:#ae81ff>2147483679</span>, <span style=color:#f92672>&#34;bmi1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;bmi2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-unhalt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tsc-scale&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;topoext&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;amd-stibp&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-preemption-timer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clflushopt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-entry-load-pkrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vnmi-pending&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;monitor&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vintr-pending&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512er&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;full-width-write&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pmm-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pcid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;taa-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;arch-capabilities&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vgif&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-secondary-ctls&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-xsaves&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clzero&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;3dnow&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;erms&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-ia32e-mode&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lahf-lm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vpclmulqdq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ins-outs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fxsr-opt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xstore&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rtm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-hint-dedicated&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-bf16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lmce&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;perfctr-nb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rdrand&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdseed&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-4vnniw&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vme&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;dtes64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mtrr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdtscp&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xsaveerptr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pse36&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-tlb-flush&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-wait-sipi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tbm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;wdt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdpmc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-mtf&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;model-id&#34;</span>: <span style=color:#e6db74>&#34;AMD EPYC-Rome Processor&#34;</span>, <span style=color:#f92672>&#34;sha-ni&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-load-pkrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;abm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-ept-advanced-exitinfo&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512pf&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-hlt-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xstore-en&#34;</span>: <span style=color:#66d9ef>false</span>}}}}
</span></span></code></pre></div><p>主要用到的是上面的<code>model</code>、<code>family</code>、<code>stepping</code>信息，这几个值将决定VMSA中的<code>rdx</code>寄存器的值。</p><p>构建vCPU0的VMSA binary：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl vmsa build NEW-VMSA0.bin --userspace qemu --family <span style=color:#ae81ff>23</span> --stepping <span style=color:#ae81ff>0</span> --model <span style=color:#ae81ff>49</span> --firmware ./OVMF.fd --cpu <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>如果是多个核心，还需要生成其余核心的VMSA binary。不过由于其余的VMSA binary都是一样的，只需要为vCPU1生成一次就行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl vmsa build NEW-VMSA1.bin --userspace qemu --family <span style=color:#ae81ff>23</span> --stepping <span style=color:#ae81ff>0</span> --model <span style=color:#ae81ff>49</span> --firmware ./OVMF.fd --cpu <span style=color:#ae81ff>1</span>
</span></span></code></pre></div></li><li><p>计算度量值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl measurement build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --api-major <span style=color:#ae81ff>0</span> --api-minor <span style=color:#ae81ff>24</span> --build-id <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy 0x05 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tik sev_tik.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --launch-measure-blob ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --firmware ./OVMF.fd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --num-cpus <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --vmsa-cpu0 ./NEW-VMSA0.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --vmsa-cpu1 ./NEW-VMSA1.bin
</span></span></code></pre></div><p>其中：</p><ul><li><code>--api-major</code>、<code>--api-minor</code>、<code>--build-id</code>、<code>--policy</code>可以通过qmp里的<code>{ "execute": "query-sev" }</code>命令查询到</li><li><code>--policy</code> 和启动Guest VM时指定的policy一致</li><li><code>--firmware</code>是我们使用的OVMF.fd的路径<blockquote><p>除了firmware，还支持加入其它的度量值如<code>--kernel</code>, <code>--initrd</code>, <code>--cmdline</code>。不过由于我们给qemu只指定了firmware的路径，所以qemu只度量了firmware。所以我们在验证的时候也只度量firmware。</p></blockquote></li><li>传入<code>--launch-measure-blob</code>的目的是获取末尾的MNONCE值。</li><li>如果是SEV-SNP，则需提供<ul><li><code>--num-cpus</code>：Guest VM的cpu数量</li><li><code>--vmsa-cpu0</code>、<code>--vmsa-cpu1</code>：每个CPU的vmsa区域初始值。如果是多于一个vCPU，则需要指定<code>--vmsa-cpu1</code></li></ul></li></ul><p>输出如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD
</span></span></code></pre></div><p>可见和我们从平台处拿到的度量结果是一致的。</p></li></ol><p>至此我们证明了这么一件事：有一个经过AMD验证的平台，这个平台向我们证明了它上面运行了我们预期的Guest VM。但是我们还差一步，那就是向这个Guest VM注入我们的机密数据，这样我们可以进一步与它上面的应用建立可信信道。</p><h3 id=relaying-party生成secret>（Relaying Party）生成secret</h3><p>所谓的secret是若干个<code>&lt;GUID, Value></code>组成的键值对，借助<code>sevctl</code>，可以将其打包成一个binary，然后经过TEK加密以及TIK进行的HMAC保护。随后该binary被发送给AMD PSP。在执行SEV的<code>LAUNCH_SECRET</code>命令时，由PSP使用TEK解密payload，然后用VEK加密并放入到Guest VM里指定的内存区域。</p><blockquote><p>在实际应用中，这个secret通常存储一个密钥。比如grub里面有一个cryptodisk模块，会使用一个secret来解密经过luks加密的磁盘，它的guid是<code>736869e5-84f0-4973-92ec-06879ce3da0b</code>。</p></blockquote><p>在这个实验中，我们定义了一个GUID为<code>43ced044-42ec-487a-88b7-261bda359f24</code>的secret，值为<code>"TOP_SECRET_MESSAGE"</code>这个字符串。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;TOP_SECRET_MESSAGE&#34;</span> &gt; ./secret.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sevctl secret build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tik sev_tik.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tek sev_tek.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --launch-measure-blob ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --secret 43ced044-42ec-487a-88b7-261bda359f24:./secret.txt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./secret_header.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./secret_payload.bin
</span></span></code></pre></div><p>输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Wrote header to: ./secret_header.bin
</span></span><span style=display:flex><span>Wrote payload to: ./secret_payload.bin
</span></span></code></pre></div><p>我们将输出的两个文件用scp发到平台</p><h3 id=平台将secret植入guest-vm>（平台）将secret植入Guest VM</h3><p>首先用base64命令将secret_header.bin和secret_payload.bin转为base64编码</p><p>得到：</p><ul><li><code>base64 -w 0 &lt; secret_header.bin</code>：<code>AAAAAKzd9a3vLYPW4fcwzlsAq+YY6Vhlqcj65QvIzqy3Mc+XPiyzEsCsmKKIpk8SfnAF7w==</code></li><li><code>base64 -w 0 &lt; secret_payload.bin</code>：<code>s1Ua7oK6RH54g97oWgV1XWqQw4vpZLpfAL2oCVG9uLhjB+dzHxeKnQbxaiQ8ibSUedTfZx28QIz7tKaRh12mIg==</code></li></ul><p>在QMP中，使用<code>sev-inject-launch-secret</code>命令，并用上面两个参数作为值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;sev-inject-launch-secret&#34;</span>, <span style=color:#f92672>&#34;arguments&#34;</span>: { <span style=color:#f92672>&#34;packet-header&#34;</span>: <span style=color:#e6db74>&#34;AAAAAKzd9a3vLYPW4fcwzlsAq+YY6Vhlqcj65QvIzqy3Mc+XPiyzEsCsmKKIpk8SfnAF7w==&#34;</span>, <span style=color:#f92672>&#34;secret&#34;</span>: <span style=color:#e6db74>&#34;s1Ua7oK6RH54g97oWgV1XWqQw4vpZLpfAL2oCVG9uLhjB+dzHxeKnQbxaiQ8ibSUedTfZx28QIz7tKaRh12mIg==&#34;</span> } }
</span></span></code></pre></div><p>返回</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {}}
</span></span></code></pre></div><p>使用<code>cont</code>命令继续运行VM</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;cont&#34;</span> }
</span></span></code></pre></div><h3 id=guest-vmos启动并获取植入的secret>（Guest VM）OS启动并获取植入的secret</h3><p>前面说到，所有的secret被写入到内存的特定区域。这个区域的地址是由UEFI（在虚拟机中就是OVMF firmware）暴露给qemu的，随后UEFI会在EFI configuration table中创建一个GUID为<code>adf956ad-e98c-484c-ae11-b51c7d336447</code>的条目，并对该内存区域做一个<code>EFI_RESERVED_TYPE</code>标记告诉bootloader和kernel不要覆盖了这块内存。</p><p>Linux内核增加了对识别SEV植入的secret值的支持，这是通过一个叫<code>efi_secret</code>的内核模块实现的，它会根据GUID识别EFI configuration table里的条目，并从该条目指示的内存地址中解析我们的secret，并暴露在一个虚拟的文件系统中。</p><p>感兴趣的读者可以阅读<a href=https://docs.kernel.org/5.19/security/secrets/coco.html>这篇短文章</a></p><ol><li><p>确保Guest VM检测到了SEV支持</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dmesg | grep -i sev
</span></span></code></pre></div><p>应该显示<code>Memory Encryption Features active: AMD SEV</code></p></li><li><p>载入<code>efi_secret</code>内核模块</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>modprobe efi_secret
</span></span></code></pre></div></li><li><p>挂载<code>securityfs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mount -t securityfs securityfs /sys/kernel/security
</span></span></code></pre></div></li><li><p>检查secret值</p><p>所有的secret值在/sys/kernel/security/secrets/coco目录下，以secret的GUID作为文件名，读取该文件就能得到secret的内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ls -la /sys/kernel/security/secrets/coco/
</span></span></code></pre></div></li></ol><p>下图是我们的实验结果，其中运行的Guest VM是一个archiso镜像
<img src=/images/2023-04-17-13-35-51.png alt></p><p>可以看到我们成功读出了我们注入的secret的值<code>TOP_SECRET_MESSAGE</code>。</p><h2 id=总结>总结</h2><p>这一趟配置过程花了不少时间，不过也是圆了我最初组这一套设备时的一个想法吧，总的来说还是比较有趣的。相比于繁杂的SGX，SEV和SEV-ES就显得清晰了很多（当然一些方面比如CEK能够标识一个CPU，这样隐私性就弱了些了，然后也没有证书撤销列表这种东西），在这个过程中可以看出AMD在设计这个方案中的一些安全考虑，比如<code>pre-attestation</code>过程中的session nonce和measure nonce值的使用。</p><p>但是也可以看出这个方案中的一些缺陷，比如secret的植入过程会要求Guest Owner在Guest VM启动前就参与进来。如果可以再进一步，比如PSP在开启Guest VM后，就自动为该VM生成一对非对称密钥。用平台上的PEK为这个Guest VM签一个证书，里面包含公钥和VM的度量值等信息，然后把私钥以secret的信息放到VM里面，就可以节省掉很多环节。在新版本的PSP中，增加了一个名为<code>ATTESTATION</code>的命令，它允许在VM的处于运行状态时，生成一个attestation report，包含了度量值信息并由PEK签名。但是遗憾的是它只是提供了一种方式获取之前度量的结果，没有解决在LAUNCH_START和LAUNCH_MEASURE阶段需要Guest Owner参与的问题。</p><p>另外是关于pve平台的问题，在这个实验中也算是理解了pve没有内置sev支持的原因：最大的问题在于远程证明。如果不做远程证明，那为Guest VM开SEV只是代表了内存加密，但是并不能保证固件、Kernel等的安全性，用户无法相信上面的软件是安全的。而如果要做远程证明，就变得麻烦了起来，需要平台和用户配合起来完成，这对于PVE来说显然是太复杂了。还是特定场景比如kata容器这样的更适合。</p><h2 id=参考>参考：</h2><ul><li><a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a></li><li><a href=https://docs.kernel.org/5.19/security/secrets/coco.html>Confidential Computing secrets - Linux Kernel Doc</a></li><li>EDKII中与secret相关的几个pr：<ul><li><a href=https://github.com/tianocore/edk2/pull/1175>https://github.com/tianocore/edk2/pull/1175</a></li><li><a href=https://github.com/tianocore/edk2/pull/1235>https://github.com/tianocore/edk2/pull/1235</a></li></ul></li><li>James Bottomley（上述PR的主要作者）的文章<ul><li><a href=https://blog.hansenpartnership.com/deploying-encrypted-images-for-confidential-computing/>Deploying Encrypted Images for Confidential Computing</a></li></ul></li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>