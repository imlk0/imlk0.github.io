<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>æ¢ç©¶AMD SEV/SEV-ESè¿œç¨‹è¯æ˜è¿‡ç¨‹â€”â€”åœ¨EPYC 7302æ´‹åƒåœ¾æœåŠ¡å™¨ä¸Š | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>æ¢ç©¶AMD SEV/SEV-ESè¿œç¨‹è¯æ˜è¿‡ç¨‹â€”â€”åœ¨EPYC 7302æ´‹åƒåœ¾æœåŠ¡å™¨ä¸Š</span></h1><span><span class=date>ğŸ“… 2023-04-14</span>
<span class=date>(æ›´æ–°äº2023-08-30)</span>
/
<span class=cats>ğŸ“š
<a href=https://blog.imlk.top/categories/tee/>TEE</a></span>
/
<span class=tags>ğŸ·ï¸
<a href=https://blog.imlk.top/tags/sev/>#SEV</a>
<a href=https://blog.imlk.top/tags/kvm/>#KVM</a>
<a href=https://blog.imlk.top/tags/homelab/>#Homelab</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a></span></span><br></div><main class=post-content><p>å»å¹´æŠŠHomelabå‡çº§åˆ°äº†EPYC 7302ï¼Œæ˜¯äºŒä»£çš„EPYCäº§å“ï¼Œä»£å·"rome"ï¼Œè¿™å—CPUæ”¯æŒSEVå’ŒSEV-ESç‰¹æ€§ä¹Ÿå°±æ˜¯æ‰€è°“æœºå¯†è™šæ‹Ÿæœºã€‚Intelçš„CPUä¸­ä¸ä¹‹å¯¹åº”çš„åˆ™æ˜¯TDXï¼Œåªå¯æƒœæ”¯æŒTDXç‰¹æ€§çš„CPUä»·æ ¼æ˜‚è´µï¼Œæ˜¯éš¾ä»¥è§¦ç¢°åˆ°çš„ã€‚ä¸ä¹‹ç›¸æ¯”ï¼ŒAMD SEVç³»åˆ—åˆ™æ¯”è¾ƒå®¹æ˜“ä¹°åˆ°ï¼ŒèŠ±è´¹åƒå…ƒä¸åˆ°çš„ä»·æ ¼ï¼Œå°±èƒ½ä¹°åˆ°äºŒä»£EPYCã€‚ç›®å‰æ”¯æŒSEV-SNPçš„ä¸‰ä»£EPYCçš„äºŒæ‰‹ä»·æ ¼æœ€ä½æ˜¯3500å·¦å³ï¼Œè¿˜æ˜¯ç•¥é«˜ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†é€šè¿‡å®éªŒå¦‚ä½•åˆ›å»ºä¸€ä¸ªSEV/SEV-ESè™šæ‹Ÿæœºã€å¯¹è™šæ‹Ÿæœºè¿›è¡Œåº¦é‡å’Œsecretæ³¨å…¥ï¼Œæ¥å­¦ä¹ å’Œç†è§£å…¶è¿œç¨‹è¯æ˜è¿‡ç¨‹ã€‚</p><blockquote><p>æœ¬æ–‡ä»…é™äºå¯¹SEV/SEV-ESç‰¹æ€§çš„ç®€å•å°è¯•ï¼Œå’Œå¯¹pre-attestationè¿œç¨‹è¯æ˜çš„ç†è§£ã€‚è¿™ç¯‡æ–‡ç« ä¸­çš„è®¸å¤šéƒ¨åˆ†ï¼Œå°¤å…¶æ˜¯Guest VMä¸­OVMFã€GRUBã€Kernelã€Kernel cmdlineçš„é…ç½®å’Œåº¦é‡å¹¶ä¸å®Œå¤‡ï¼Œ<strong>è¯·å‹¿ç›´æ¥å°†æ–‡ä¸­çš„å‘½ä»¤ç›´æ¥ç”¨äºæ„å»ºç”Ÿäº§ç¯å¢ƒ</strong>ï¼Œè€Œæ˜¯ä½¿ç”¨ç°æœ‰çš„æˆç†Ÿæ–¹æ¡ˆï¼Œä¾‹å¦‚<a href=https://github.com/confidential-containers/kata-containers-CCv0>confidential-containers/kata-containers-CCv0</a>ã€‚</p></blockquote><h2 id=hostç¯å¢ƒé…ç½®>Hostç¯å¢ƒé…ç½®</h2><p>Hostç¯å¢ƒæ¯”è¾ƒå¥½é…ï¼Œlibvirtæœ‰ä¸€ç¯‡<a href=https://libvirt.org/kbase/launch_security_sev.html#id2>æ–‡ç« </a>ä»‹ç»äº†é…ç½®è¿‡ç¨‹ã€‚</p><ol><li>å¼€å¯SMEï¼škernel cmdline åŠ <code>mem_encrypt=on</code></li><li>å¼€å¯SEVï¼škernel cmdline åŠ <code>kvm_amd.sev=1</code>ï¼Œç»™kvm_amdå†…æ ¸æ¨¡å—çš„sevå‚æ•°ã€‚å¦‚æœä½ æƒ³ç”¨SEV-ESï¼Œè¯·åŠ ä¸Š<code>kvm_amd.sev_es=1</code></li><li>BIOSé…ç½®ï¼šå¦‚æœæƒ³è¦SEV-ESæ”¯æŒï¼Œéœ€è¦åœ¨BIOSé‡Œï¼Œå°†<code>SEV-ES ASID Space Limit</code>ä»é»˜è®¤å€¼1æ”¹æˆå¤§ä¸€äº›çš„å€¼ã€‚å°äºè¿™ä¸ªLimitå€¼çš„ASIDéƒ½å°†åˆ†é…ç»™SEV-ESï¼Œå…¶ä½™çš„åˆ†é…ç»™SEVã€‚
<img src=/images/iKVM_capture_1.jpg alt>
<img src=/images/iKVM_capture_2.jpg alt></li></ol><p>æœ€åï¼Œæ£€æŸ¥<code>/proc/cpuinfo</code>é‡Œæœ‰<code>sme</code>å’Œ<code>sev</code>ï¼Œå¹¶ä¸”<code>/sys/module/kvm_amd/parameters/sev</code>çš„å€¼ä¸º<code>Y</code>æˆ–è€…<code>1</code>å°±è¡Œäº†ã€‚å¦‚æœæ˜¯SEV-ESï¼Œè¿˜è¦æ£€æŸ¥<code>/proc/cpuinfo</code>é‡Œæœ‰<code>sev_es</code>ï¼Œå¹¶ä¸”<code>/sys/module/kvm_amd/parameters/sev_es</code>çš„å€¼ä¸º<code>Y</code>æˆ–è€…<code>1</code></p><blockquote><p>å¦‚æœæ²¡æœ‰ï¼Œè®°å¾—æ£€æŸ¥ä¸€ä¸‹ä½ çš„CPUæ˜¯å¦æ”¯æŒsevï¼Œå¹¶ä¸”BIOSé‡Œé¢æ˜¯å¦å¼€äº†SMEæ”¯æŒï¼ˆæ®è¯´è¶…å¾®æ—©æœŸçš„ä¸€äº›BIOSæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼‰</p></blockquote><p>dmesgé‡Œä¹Ÿä¼šæ˜¾ç¤ºä¸€äº›ä¿¡æ¯ï¼š
<img src=/images/2023-04-18-11-33-03.png alt></p><h2 id=åˆ›å»ºå’Œå¯åŠ¨guest-vm>åˆ›å»ºå’Œå¯åŠ¨Guest VM</h2><p>ä¸Šé¢é‚£ç¯‡æ–‡ç« ä¹Ÿä»‹ç»äº†è™šæ‹Ÿæœºçš„åˆ›å»ºè¿‡ç¨‹ï¼ŒåŒ…æ‹¬å»ºè®®ä½¿ç”¨Q35å’ŒOVMFç­‰ç­‰ã€‚ä¸è¿‡å› ä¸ºPVEå’Œlibvirtæ˜¯å†²çªçš„ï¼Œä¸Šé¢çš„é…ç½®æ–¹æ³•ä¸é€‚ç”¨äºæˆ‘çš„ç¯å¢ƒï¼š</p><ul><li><p>å¯¹äº<code>VM Configuration</code>ç« èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰è¿™äº›æŒ‡å¼•åœ¨PVEçš„WEBé¢æ¿ä¸Šæ‰¾åˆ°å¯¹åº”çš„é…ç½®æ¥åˆ›å»ºè™šæ‹Ÿæœºã€‚ï¼ˆä¸ºäº†å®éªŒç®€å•ï¼Œæˆ‘è¿™é‡Œå¹¶æœªå®Œå…¨éµå®ˆå…¶ä¸­çš„è¿‡ç¨‹ï¼Œè€Œæ˜¯cloneäº†ä¸€å°å·²æœ‰çš„Linuxè™šæœºæ¥è¿è¡Œï¼‰</p></li><li><p>è€Œå¯¹äº<code>Checking SEV support in the virt stack</code>ç« èŠ‚ï¼Œé‰´äºPVEçš„Guest VMå¹¶æ²¡æœ‰æä¾›SEVç›¸å…³çš„é…ç½®ï¼Œæˆ‘ä»¬åªèƒ½åœ¨qemuå‘½ä»¤è¡Œå‚æ•°ä¸Šåšæ‰‹è„šã€‚</p></li></ul><p>é¦–å…ˆï¼Œåœ¨pve hostä¸Šï¼Œä½¿ç”¨<code>qm showcmd</code>æŸ¥çœ‹åˆ›å»ºçš„Guest VMçš„qemuå¯åŠ¨å‘½ä»¤</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>qm showcmd &lt;vmid&gt; --pretty 
</span></span></code></pre></div><p>æŠŠ<code>&lt;vmid></code>æ›¿æ¢æˆä½ çš„vm id</p><blockquote><p>åœ¨pveä¸Šï¼Œ<code>/usr/bin/kvm</code>æ˜¯<code>qemu-system-x86_64</code>çš„ä¸€ä¸ªç¬¦å·é“¾æ¥</p></blockquote><p>å¢åŠ ä¸¤ä¸ªå‘½ä»¤è¡Œé€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -object &#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5&#39; \
</span></span><span style=display:flex><span>  -machine &#39;memory-encryption=sev0&#39;
</span></span></code></pre></div><blockquote><p>æ ¹æ®PVEçš„<a href=https://pve.proxmox.com/wiki/Manual:_qm.conf>æ–‡æ¡£</a>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡PVEçš„è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ä¸­çš„<code>args</code>å‚æ•°æ¥è¿½åŠ qemuå‘½ä»¤è¡Œé€‰é¡¹ã€‚</p></blockquote><p>å¦‚æœæ˜¯SEVï¼Œéœ€è¦è®¾ç½®<code>policy=0x1</code>ï¼Œå¦‚æœæ˜¯SEV-ESï¼Œè®¾ç½®<code>policy=0x5</code>ã€‚å…·ä½“çš„å«ä¹‰å¯ä»¥ä» <a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a> çš„<code>Table 2. Guest Policy Structure</code>é‡Œæ‰¾åˆ°å¦‚ä¸‹æè¿°ï¼š</p><p><img src=/images/2023-04-17-15-34-39.png alt></p><p>éšåæ‰§è¡Œå®Œæ•´çš„qemuå‘½ä»¤å¼€å¯Guest VMã€‚</p><blockquote><p>å¦‚æœä½ é‡åˆ°<code>kvm: sev_kvm_init: failed to initialize ret=-25 fw_error=0 ''</code>ï¼Œè¯´æ˜ä½ çš„ç¯å¢ƒæœ‰é—®é¢˜ï¼Œè¯·å‚ç…§<code>Hostç¯å¢ƒé…ç½®</code>ç« èŠ‚è¿›è¡Œæ£€æŸ¥ã€‚</p></blockquote><p>åœ¨Guest VMä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯sevå·²ç»å¼€å¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dmesg | grep -i sev
</span></span></code></pre></div><p><img src=/images/2023-04-18-14-17-08.png alt></p><p>å¦‚æœè®¾ç½®<code>policy=0x1</code>é‚£å°±æ˜¯ï¼š</p><p><img src=/images/2023-04-14-14-50-57.png alt></p><h2 id=sev--sev-esçš„è¿œç¨‹è¯æ˜è¿‡ç¨‹>SEV & SEV-ESçš„è¿œç¨‹è¯æ˜è¿‡ç¨‹</h2><p>SEVå’ŒSEV-ESåªæ”¯æŒ<code>pre-attestation</code>å½¢å¼çš„éªŒè¯ï¼Œå³åœ¨VMå¯åŠ¨æ—¶è¿›è¡Œåº¦é‡å’Œsecretæ¤å…¥ï¼Œè€Œä»epyc 7003ç³»åˆ—å¼€å§‹å¢åŠ çš„SEV-SNPç‰¹æ€§æ”¯æŒ<code>runtime-attestation</code>ã€‚ç”±äºä½œè€…åªæœ‰epyc 7302çš„æœºå™¨ï¼ˆä¹°ä¸èµ·æ–°çš„ï¼‰ï¼Œæœ¬æ–‡åªä»‹ç»<code>pre-attestation</code>ã€‚å…·ä½“çš„æµç¨‹å¯ä»¥å‚è€ƒ<a href=https://github.com/AMDESE/sev-tool#proposed-provisioning-steps>sev-tool</a>çš„æ–‡æ¡£ï¼Œä»¥åŠ<a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a>çš„ã€ŒAppendix A Usage Flowsã€ç« èŠ‚é‡Œçš„æµç¨‹å›¾ï¼Œä¸¤è€…éƒ½ç®—å¾ˆæ¸…æ™°çš„ã€‚</p><p>æœ¬æ–‡å°†ç”¨virteeç¤¾åŒºæ„å»ºçš„<a href=https://github.com/virtee/sevctl>sevctl</a>å·¥å…·å®é™…æ“ä½œä¸€éè¿™ä¸ªè¿‡ç¨‹ï¼Œæœ‰åŠ©äºå¯¹<code>pre-attestation</code>çš„ç†è§£ã€‚</p><blockquote><p>è‡³äºä¸ºä»€ä¹ˆç”¨sevctlä¸ç”¨AMDè‡ªå·±çš„sev-toolï¼Œå› ä¸ºæˆ‘æ˜¯rustacean :)</p></blockquote><h3 id=æ¦‚å¿µä»‹ç»>æ¦‚å¿µä»‹ç»</h3><p>SEVçš„å¨èƒæ¨¡å‹æƒ³å¿…ä¸ç”¨å¤šè§£é‡Šï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹åœ¨è¿™ä¸ªå®éªŒä¸­çš„ä¸‰æ–¹ï¼š</p><ul><li>SEV Host (ğŸ˜ˆï¸): æˆ–ç§°å¹³å°Platformï¼ŒæŒ‡SEVçš„ä¸»æœºç¯å¢ƒï¼ŒåŒ…æ‹¬Hypervisorï¼Œå½’å±äºå¹³å°æ‰€æœ‰è€…ï¼ˆæœåŠ¡å™¨çš„æä¾›è€…ï¼‰ï¼Œå¹¶å¯ä»¥ç”±å…¶æ§åˆ¶ã€‚åœ¨æˆ‘ä»¬çš„å®éªŒä¸­å°±æ˜¯æˆ‘çš„pveä¸»æœºã€‚</li><li>SEV Guest VM (ğŸ¤”): å—ä¿æŠ¤çš„æœºå¯†å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æ‰˜ç®¡åœ¨æœåŠ¡å™¨ä¸Šçš„çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå…¶å®‰å…¨æ€§å¯¹äºGuest Owneræ¥è¯´æ˜¯æœªçŸ¥çš„ï¼Œéœ€è¦é€šè¿‡remote attestationæ¥è¯æ˜ã€‚åœ¨å®éªŒä¸­è¿™æ˜¯æˆ‘åœ¨pveä¸Šçš„ä¸€ä¸ªè™šæ‹Ÿæœºã€‚</li><li>Relying Party (ğŸ˜‡): å¤©ç„¶å¯ä»¥è¢«Guest Owneræ‰€ç›¸ä¿¡çš„ä¸€äº›ç¯å¢ƒã€‚åœ¨å®éªŒä¸­è¿™ä¸ªæ˜¯æˆ‘çš„ä¸ªäººç”µè„‘ã€‚</li></ul><h3 id=æ„å»ºå¸¦sevæ”¯æŒçš„ovmf>æ„å»ºå¸¦SEVæ”¯æŒçš„OVMF</h3><p>ä¼šå‘ç°pveè‡ªå¸¦çš„OVMF firmwareæ˜¯ä¸æ”¯æŒAMDSEVçš„ï¼Œä½¿ç”¨è¯¥firmwareæˆ‘ä»¬å°†æ— æ³•å®ŒæˆSEVçš„LAUNCH_SECRETç¯èŠ‚ã€‚</p><p>å‚è€ƒäº†ä»¥ä¸‹æ–‡æ¡£ä¹‹åï¼š</p><ul><li><a href=https://github.com/confidential-containers/documentation/blob/9faf24a7f26053820bd0c8a809134b2e8ed52d2d/demos/sev-demo/README.md#ovmf>CCv0 with AMD SEV - confidential-containersç¤¾åŒº</a></li><li><a href=https://github.com/tianocore/tianocore.github.io/wiki/Getting-Started-with-EDK-II>Getting Started with EDK II</a></li></ul><p>æˆ‘å†³å®šè‡ªå·±æ„å»ºOVMF firmwareï¼š</p><ol><li><p>é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…<code>nasm</code>ã€<code>iasl</code>å‘½ä»¤</p></li><li><p>è·å–EDK2æºç å¹¶ç¼–è¯‘OVMF</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/tianocore/edk2.git
</span></span><span style=display:flex><span>cd edk2 
</span></span><span style=display:flex><span>git submodule init
</span></span><span style=display:flex><span>git submodule update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make -C BaseTools/
</span></span><span style=display:flex><span>source edksetup.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch OvmfPkg/AmdSev/Grub/grub.efi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>build -t GCC5 -a X64 -p OvmfPkg/AmdSev/AmdSevX64.dsc
</span></span></code></pre></div></li></ol><p>äº§ç‰©è·¯å¾„ä¸º<code>Build/AmdSev/DEBUG_GCC5/FV/OVMF.fd</code></p><h3 id=æ„å»ºsevctl>æ„å»ºsevctl</h3><p>éå¸¸ç®€å•ï¼Œcloneä¸‹æ¥ç„¶åcargo buildå°±è¡Œå•¦</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº<code>pre-attestation</code>ï¼Œåªéœ€è¦åœ¨SEV Hostï¼Œå’ŒRelying Partyç¯å¢ƒä¸­ç¼–è¯‘å’Œä½¿ç”¨è¿™ä¸ªå·¥å…·ã€‚ä¸éœ€è¦åœ¨SEV VMé‡Œç¼–è¯‘å®ƒã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/virtee/sevctl
</span></span><span style=display:flex><span>cd sevctl
</span></span><span style=display:flex><span>cargo install --path .
</span></span></code></pre></div><h3 id=å¹³å°å¯¼å‡ºè¯ä¹¦é“¾>ï¼ˆå¹³å°ï¼‰å¯¼å‡ºè¯ä¹¦é“¾</h3><p>é¦–å…ˆï¼Œéœ€è¦åœ¨SEV Hostä¸Šå¯¼å‡ºè¯¥å¹³å°PDHå…¬é’¥åŠå…¶è¯ä¹¦é“¾ï¼Œå¹¶å°†å…¶å‘ç»™Guest Ownerè¿›è¡ŒéªŒè¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl export /tmp/sev.pdh
</span></span></code></pre></div><p>ä½¿ç”¨scpå°†/tmp/sev.pdhæ‹·è´åˆ°Relying Partyä¾§</p><h3 id=relying-partyéªŒè¯è¯ä¹¦é“¾å®Œæ•´æ€§>ï¼ˆRelying Partyï¼‰éªŒè¯è¯ä¹¦é“¾å®Œæ•´æ€§</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl verify --sev /tmp/sev.pdh
</span></span></code></pre></div><p>è¾“å‡ºå¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>PDH EP384 D256 6a8d620717a742dd522b914d5e730eb84eda5bcb47a57f46ce2b7e10f1901b13
</span></span><span style=display:flex><span> â¬‘ PEK EP384 E256 ded12636fe3fdfe5774944ea91e475c1ddf1a1d9f1955469d784782d5989ae9b
</span></span><span style=display:flex><span>   â€¢â¬‘ OCA EP384 E256 63b5d98d309ce7c7b8c8a0f2ec93516560e0c4a5ef4535da0cbddd0f1e34e130
</span></span><span style=display:flex><span>    â¬‘ CEK EP384 E256 1345efa44c7a85979b07053ae5c5e16a0b103fc5bf3d0281b2f1ff8802ad71e6
</span></span><span style=display:flex><span>       â¬‘ ASK R4096 R384 d8cd9d1798c311c96e009a91552f17b4ddc4886a064ec933697734965b9ab29db803c79604e2725658f0861bfaf09ad4
</span></span><span style=display:flex><span>         â€¢â¬‘ ARK R4096 R384 3d2c1157c29ef7bd4207fc0c8b08db080e579ceba267f8c93bec8dce73f5a5e2e60d959ac37ea82176c1a0c61ae203ed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> â€¢ = self signed, â¬‘ = signs, â€¢Ì· = invalid self sign, â¬‘Ì¸ = invalid signs
</span></span></code></pre></div><p>sevctlè¿™ä¸ªå·¥å…·åšçš„è¿˜æ˜¯å¾ˆç²¾å¿ƒçš„ï¼Œè¯ä¹¦é“¾çš„å¯è§†åŒ–ä¹Ÿå¾ˆå¥½ï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªé“¾ä¸Šæ²¡æœ‰invalidçš„éƒ¨åˆ†ï¼Œè¿™è¯´æ˜è¯ä¹¦é“¾æ˜¯å®Œå¥½çš„ã€‚</p><p>è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹æ¯ä¸ªå¯†é’¥çš„ç”¨é€”ï¼š</p><p>å¹³å°éƒ¨åˆ†ï¼š</p><ul><li>CEK(Chip Endorsement Key)ï¼šæ¯ä¸ªSEVå¹³å°ï¼Œå…·ä½“æ¥è¯´æ˜¯ä¸€å—CPUçš„å”¯ä¸€çš„å¯†é’¥ï¼Œå®ƒä»çƒ§å½•åœ¨CPUçš„OTP fusesé‡Œçš„ä¸€æ®µsecretæ´¾ç”Ÿè€Œæ¥ï¼Œå¹¶ä¸ç›´æ¥ä½¿ç”¨ï¼Œç”¨äºç»™å…¶å®ƒå¯†é’¥ç­¾åã€‚</li><li>PEK(Platform Endorsement Key)ï¼šéšæœºäº§ç”Ÿçš„ECDSAç­¾åå¯†é’¥ï¼Œå½“è¯¥å¹³å°çš„æ‰€æœ‰è€…å˜æ›´æ—¶é‡æ–°ç”Ÿæˆã€‚</li><li>PDH(Platform Diffie-Hellman Key)ï¼šéšæœºäº§ç”Ÿçš„ECDHå¯†é’¥ï¼Œæ˜¯æ•´ä¸ªè¯ä¹¦é“¾çš„æœ€æœ«ç«¯ã€‚å…¶ç”Ÿå‘½æœŸå’ŒPEKä¸€æ ·ï¼Œ<strong>å¹¶éç‰¹å®šäºæŸä¸ªGuest VM</strong>çš„ã€‚å®ƒçš„ç”¨é€”åé¢ä¼šè®²åˆ°</li></ul><p>AMDéƒ¨åˆ†ï¼š</p><ul><li>ASK(AMD Signing Key)ï¼šAMDæŒæœ‰ï¼Œåœ¨å‡ºå‚å‰å¯¹CEKè¿›è¡Œç­¾å</li><li>ARK(AMD Root Key)ï¼šAMDæŒæœ‰ï¼Œç”¨äºç­¾ç½²ASK</li></ul><p>é€šè¿‡è¿™æ¡é“¾ï¼ŒAMDå‘ä½ è¯æ˜è¿™ä¸ªå¹³å°æ˜¯AMDè®¤å¯çš„ã€‚</p><blockquote><p>æ¯ä¸€ä»£EPYCäº§å“çš„ASK/ARKè¯ä¹¦å¯ä»¥ä»<a href=https://www.amd.com/en/developer/sev.html>AMDçš„ç½‘é¡µ</a>ä¸Šè·å¾—ã€‚</p><p>æ¯ä¸€å—CPUå¯¹åº”çš„CEKä¹Ÿå¯ä»¥ä»<a href=https://kdsintf.amd.com/cek/>è¿™ä¸ªç½‘é¡µ</a>è·å¾—ï¼Œå‚æ•°cpuçš„æ ‡è¯†idå¯ä»¥é€šè¿‡<code>sevctl show identifier</code>å‘½ä»¤è·å¾—ã€‚æ³¨æ„æ¯æ¬¡è®¿é—®æ—¶è·å¾—çš„CEKè¯ä¹¦éƒ½æ˜¯ä¸åŒçš„ï¼ˆç­¾åå­—æ®µä¼šå˜åŒ–ï¼‰ã€‚</p></blockquote><blockquote><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±äºCEKæ˜¯ä»fuseæ´¾ç”Ÿçš„ï¼ŒAMDå…¶å®ä¹Ÿæ˜¯æŒæœ‰CEKçš„ç§é’¥éƒ¨åˆ†çš„ï¼Œè¿™æ„å‘³ç€åœ¨è¿™æ¡é“¾ä¸Šï¼Œä½ éœ€è¦å®Œå…¨ç›¸ä¿¡AMDã€‚</p></blockquote><p>ä»¥ä¸Šæ˜¯ä¸AMDå…³è”çš„ä¸€æ¡é“¾ï¼Œç»†å¿ƒçš„è¯»è€…åº”è¯¥å‘ç°äº†ä»OCAå¼€å§‹çš„å¦ä¸€æ¡é“¾ï¼Œ<code>OCA->PEK->PDH</code>ã€‚</p><ul><li>OCA(Owner Certificate Authority Signing Key)ï¼šæ‰€æœ‰è€…æŒæœ‰çš„ç­¾åå¯†é’¥ã€‚
å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯ä¹¦é“¾çš„ä½ç½®ä¸Šï¼ŒOCAæ˜¯ä¸CEKå¹¶åˆ—çš„ã€‚é€šè¿‡è¿™æ¡é“¾ï¼Œè¿˜é¢å¤–è¯æ˜äº†è¿™ä¸ªå¹³å°æ˜¯è¢«æŸä¸ªå¹³å°æ‰€æœ‰è€…æ‰€æ‹¥æœ‰çš„ã€‚</li></ul><p>å…·ä½“æ¥è¯´è¿™é‡Œè¿˜å¯ä»¥ç»†åˆ†åˆ°ä¸¤ç§æ¨¡å¼ï¼š</p><ol><li>self-ownedï¼šSEV firmwareåŒæ—¶æŒæœ‰OCAå…¬é’¥å’Œç§é’¥éƒ¨åˆ†ï¼Œå®ƒåœ¨å†…éƒ¨ç”Ÿæˆè¿™å¯¹å¯†é’¥ã€‚è¿™æ„å‘³ç€ä»»ä½•ä¸€ä¸ªå¤–éƒ¨å®ä½“éƒ½æ— æ³•è®¿é—®ç§é’¥ã€‚</li><li>platform-owned: SEV firmwareåªæŒæœ‰OCAå…¬é’¥ï¼Œè€Œç§é’¥ç”±å¹³å°çš„æ‰€æœ‰è€…æŒæœ‰ã€‚</li></ol><p>å…³äºARKå’ŒOCAä¸¤ä¸ªè¯ä¹¦é“¾ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„è¯´æ˜ï¼šhttps://github.com/inclavare-containers/attestation-evidence-broker/blob/master/docs/design/design.md#sev-es-attestation-evidence</p><h3 id=relying-partyåå•†å¯†é’¥å¹¶åˆ›å»ºä¼šè¯>ï¼ˆRelying Partyï¼‰åå•†å¯†é’¥å¹¶åˆ›å»ºä¼šè¯</h3><p>æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªGuest VMè¢«ç§°ä¸ºä¸€æ¬¡ä¼šè¯ï¼ˆsessionï¼‰ï¼ŒGuest Owneréœ€è¦ä¸ºè¿™ä¸€ä¸ªsessionç”ŸæˆGODHå¯†é’¥ï¼Œç„¶åå’Œå¹³å°å‘æ¥çš„è¯ä¹¦é“¾ï¼ˆåŒ…å«PDHï¼‰ä¸€èµ·ç”Ÿæˆmaster secretã€‚ä»master secretæ´¾ç”Ÿå‡ºKEKã€KIKï¼Œä»¥åŠä¸€ç»„éšæœºç”Ÿæˆçš„TEKã€TIKå’Œå¯†é’¥ã€‚æŠŠè¿™äº›å¯†é’¥ä¸€èµ·ç”Ÿæˆsession parametersã€‚Hypervisoråœ¨å¯åŠ¨VMæ—¶ï¼Œä¼šå°†GODHå’Œsession parameterså…¶ä½œä¸ºLAUNCH_STARTçš„å‚æ•°ä¼ é€’ç»™PSPã€‚</p><blockquote><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¯·ä¸è¦é‡å¤ä½¿ç”¨ä¹‹å‰çš„GODHï¼Œä»¥é˜²å¹³å°æ‹¥æœ‰è€…å¯¹ä½ å‘èµ·é‡æ”¾æ”»å‡»ã€‚</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl session -n <span style=color:#e6db74>&#39;sev&#39;</span> /tmp/sev.pdh <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>å…¶ä¸­<code>'sev'</code>æ˜¯æˆ‘æŒ‡å®šçš„å¯†é’¥åå­—ï¼Œ<code>/tmp/sev.pdh</code>æ˜¯ä»å¹³å°æ‹¿åˆ°çš„è¯ä¹¦é“¾ <code>5</code>æ˜¯å¯åŠ¨Guest VMæ—¶çš„policyå€¼ï¼ˆGuest Owneråº”è¯¥æ§åˆ¶è¿™ä¸ªå€¼ä»¥é¿å…ç”±é…ç½®å¯¼è‡´çš„å®‰å…¨é—®é¢˜ï¼‰ã€‚</p><p>è¿™å°†åœ¨å½“å‰ç›®å½•ä¸‹äº§ç”Ÿè‹¥ä¸ªæ–‡ä»¶</p><ul><li>sev_godh.b64ï¼šGODH(Guest Owner Diffie-Hellman key)ï¼Œå®ƒå’ŒPDHéƒ½æ˜¯<a href=https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman>ECDH</a>å¯†é’¥ï¼Œåœ¨äº¤æ¢å…¬é’¥ä¹‹ååŒæ–¹å¯ä»¥ç”Ÿæˆä¸€è‡´çš„master secretã€‚</li><li>sev_session.b64ï¼šsession parametersï¼ŒåŒ…å«äº†ç”±KEKå’ŒKIKå…±åŒä¿æŠ¤çš„TEKå’ŒTIKï¼Œä»¥åŠä¸€ä¸ªå’Œsessionæœ‰å…³çš„NONCEå€¼
<img src=/images/2023-04-17-21-35-24.png alt></li><li>sev_tek.binï¼šTEK(Transport Encryption Key)ï¼Œä¸€ä¸ªAES-128å¯†é’¥ã€‚ç”¨äºåŠ å¯†Guest Ownerå’ŒFirmwareä¹‹é—´ä¼ è¾“çš„æ•°æ®</li><li>sev_tik.binï¼šTIK(Transport Integrity Key)ï¼Œä¸€ä¸ªHMACå¯†é’¥ã€‚ç”¨äºå¯¹Guest Ownerå’ŒFirmwareä¹‹é—´ä¼ è¾“çš„æ•°æ®å®æ–½å®Œæ•´æ€§ä¿æŠ¤ã€‚</li></ul><p>ä½¿ç”¨scpå°†sev_godh.b64å’Œsev_session.b64å‘é€åˆ°å¹³å°ä¾§ç”¨äºå¯åŠ¨VMï¼Œå…¶ä½™çš„ä¸¤ä¸ªæ–‡ä»¶ç”±Relying Partyä¿ç•™ã€‚</p><h3 id=å¹³å°å¯åŠ¨guest-vmå¹¶è¿›è¡Œåº¦é‡>ï¼ˆå¹³å°ï¼‰å¯åŠ¨Guest VMå¹¶è¿›è¡Œåº¦é‡</h3><p>ä¸libvirtä¸åŒï¼Œpveå¹¶æœªæä¾›åœ¨å¯åŠ¨æ—¶åº¦é‡Guest VMçŠ¶æ€çš„å‘½ä»¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹pveå¯åŠ¨qemuæ—¶çš„å‚æ•°è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚</p><p>åŒæ ·ï¼Œåœ¨pve hostä¸Šï¼Œä½¿ç”¨<code>qm showcmd</code>æŸ¥çœ‹qemuå¯åŠ¨å‘½ä»¤</p><p>æˆ‘ä»¬è¦åšä»¥ä¸‹ä¿®æ”¹</p><ol><li><p>ä½¿ç”¨æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„OVMF.fdè€Œä¸æ˜¯pveæä¾›çš„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -drive &#39;if=pflash,unit=0,format=raw,readonly=on,file=/usr/share/pve-edk2-firmware//OVMF_CODE_4M.secboot.fd&#39; \
</span></span></code></pre></div><p>æ”¹æˆ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -drive &#39;if=pflash,unit=0,format=raw,readonly=on,file=./OVMF.fd&#39; \
</span></span></code></pre></div></li><li><p>å¢åŠ sevç›¸å…³çš„é€‰é¡¹ï¼Œå°¤å…¶æ˜¯sev-guesté€‰é¡¹è¦å¢åŠ å‚æ•°<code>dh-cert-file=&lt;file1>,session-file=&lt;file2></code></p><blockquote><p>qemu <a href=https://www.qemu.org/docs/master/system/qemu-manpage.html>man-page</a>:</p><p>The dh-cert-file and session-file provides the guest ownerâ€™s Public Diffie-Hillman key defined in SEV spec. The PDH and session parameters are used for establishing a cryptographic session with the guest owner to negotiate keys used for attestation. The file must be encoded in base64.</p></blockquote><p>ä¾‹å¦‚åœ¨æˆ‘çš„å®éªŒä¸­ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>  -object &#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5,dh-cert-file=/tmp/sev_godh.b64,session-file=/tmp/sev_session.b64&#39; \
</span></span><span style=display:flex><span>  -machine &#39;memory-encryption=sev0&#39;
</span></span></code></pre></div></li><li><p>åœ¨å…¶ä¸­æ’å…¥ä¸€ä¸ª<code>-S</code>é€‰é¡¹ï¼Œè¿™æ ·å¯ä»¥<a href=https://www.qemu.org/docs/master/system/managed-startup.html>åœ¨å¯åŠ¨åæš‚åœVM</a>ï¼Œæˆ‘ä»¬æœ‰æœºä¼šè¿›è¡Œåº¦é‡ã€‚</p></li></ol><p>æ”¹å®Œä¹‹åçš„å‘½ä»¤å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/usr/bin/kvm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -id <span style=color:#ae81ff>114</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -name <span style=color:#e6db74>&#39;pve-sev,debug-threads=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -no-shutdown <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,id=qmp,path=/var/run/qemu-server/114.qmp,server=on,wait=off&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -mon <span style=color:#e6db74>&#39;chardev=qmp,mode=control&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,id=qmp-event,path=/var/run/qmeventd.sock,reconnect=5&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -mon <span style=color:#e6db74>&#39;chardev=qmp-event,mode=control&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -pidfile /var/run/qemu-server/114.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -daemonize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -smbios <span style=color:#e6db74>&#39;type=1,uuid=1fe437a6-eac4-48c3-9640-298b4a370cf6&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;if=pflash,unit=0,format=raw,readonly=on,file=./OVMF.fd&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;if=pflash,unit=1,id=drive-efidisk0,format=qcow2,file=/mnt/sandisk2t-data/pve-storage//images/114/vm-114-disk-0.qcow2&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -smp <span style=color:#e6db74>&#39;8,sockets=1,cores=8,maxcpus=8&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -nodefaults <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -boot <span style=color:#e6db74>&#39;menu=on,strict=on,reboot-timeout=1000,splash=/usr/share/qemu-server/bootsplash.jpg&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -vnc <span style=color:#e6db74>&#39;unix:/var/run/qemu-server/114.vnc,password=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -cpu <span style=color:#e6db74>&#39;EPYC-Rome,enforce,+kvm_pv_eoi,+kvm_pv_unhalt,vendor=AuthenticAMD&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -m <span style=color:#ae81ff>4096</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -object <span style=color:#e6db74>&#39;iothread,id=iothread-virtioscsi0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -readconfig /usr/share/qemu-server/pve-q35-4.0.cfg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;vmgenid,guid=f277a770-a44d-4ee0-a169-6db7a64677f5&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;qxl-vga,id=vga,max_outputs=4,bus=pcie.0,addr=0x1&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;socket,path=/var/run/qemu-server/114.qga,server=on,wait=off,id=qga0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-serial,id=qga0,bus=pci.0,addr=0x8&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtserialport,chardev=qga0,name=org.qemu.guest_agent.0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-serial,id=spice,bus=pci.0,addr=0x9&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -chardev <span style=color:#e6db74>&#39;spicevmc,id=vdagent,name=vdagent&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtserialport,chardev=vdagent,name=com.redhat.spice.0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -spice <span style=color:#e6db74>&#39;tls-port=61000,addr=127.0.0.1,tls-ciphers=HIGH,seamless-migration=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x3,free-page-reporting=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -iscsi <span style=color:#e6db74>&#39;initiator-name=iqn.1993-08.org.debian:01:fc5232458f32&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;file=/mnt/seagate4t/pve-backup/template/iso/archlinux-2023.03.01-x86_64.iso,if=none,id=drive-ide2,media=cdrom,aio=io_uring&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;ide-cd,bus=ide.1,unit=0,drive=drive-ide2,id=ide2,bootindex=101&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-scsi-pci,id=virtioscsi0,bus=pci.3,addr=0x1,iothread=iothread-virtioscsi0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -drive <span style=color:#e6db74>&#39;file=/mnt/sandisk2t-data/pve-storage//images/114/vm-114-disk-1.qcow2,if=none,id=drive-scsi0,discard=on,format=qcow2,cache=none,aio=io_uring,detect-zeroes=unmap&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;scsi-hd,bus=virtioscsi0.0,channel=0,scsi-id=0,lun=0,drive=drive-scsi0,id=scsi0,rotation_rate=1,bootindex=100&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -netdev <span style=color:#e6db74>&#39;type=tap,id=net0,ifname=tap114i0,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown,vhost=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-net-pci,mac=96:27:59:37:8F:1C,netdev=net0,bus=pci.0,addr=0x12,id=net0,rx_queue_size=1024,tx_queue_size=1024&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -netdev <span style=color:#e6db74>&#39;type=tap,id=net1,ifname=tap114i1,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown,vhost=on&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -device <span style=color:#e6db74>&#39;virtio-net-pci,mac=16:C8:90:53:5B:A9,netdev=net1,bus=pci.0,addr=0x13,id=net1,rx_queue_size=1024,tx_queue_size=1024&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -machine <span style=color:#e6db74>&#39;type=q35+pve0&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -object <span style=color:#e6db74>&#39;sev-guest,id=sev0,cbitpos=47,reduced-phys-bits=1,policy=0x5,dh-cert-file=/tmp/sev_godh.b64,session-file=/tmp/sev_session.b64&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -S <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -machine <span style=color:#e6db74>&#39;memory-encryption=sev0&#39;</span>
</span></span></code></pre></div><p>ç”¨æ”¹åçš„å‚æ•°å¯åŠ¨qemuï¼Œæ­¤æ—¶PVE Webé¢æ¿ä¼šæ˜¾ç¤ºè¯¥VMå¤„äº<code>running (prelaunch)</code>çŠ¶æ€ã€‚</p><p>ä¸Šé¢çš„å‘½ä»¤åŒæ—¶å¼€å¯äº†unix domain socketï¼Œè·¯å¾„ä¸º<code>/var/run/qemu-server/114.qmp</code>ã€‚è¿™æ˜¯ä¸€ä¸ª<a href=https://wiki.qemu.org/Documentation/QMP>QMPæ¥å£ï¼ˆQEMU Machine Protocolï¼‰</a>ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥å‘qemuè™šæ‹Ÿæœºå‘é€ä¸€äº›æ§åˆ¶æŒ‡ä»¤ã€‚</p><p>å¯ä»¥ä½¿ç”¨ncæˆ–è€…socatè¿æ¥åˆ°å®ƒï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>socat - UNIX-CONNECT:/var/run/qemu-server/114.qmp
</span></span></code></pre></div><p>è¿æ¥ä¸Šåç«‹åˆ»æ”¶åˆ°äº†å¦‚ä¸‹ä¿¡æ¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;QMP&#34;</span>: {<span style=color:#f92672>&#34;version&#34;</span>: {<span style=color:#f92672>&#34;qemu&#34;</span>: {<span style=color:#f92672>&#34;micro&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;minor&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#f92672>&#34;major&#34;</span>: <span style=color:#ae81ff>7</span>}, <span style=color:#f92672>&#34;package&#34;</span>: <span style=color:#e6db74>&#34;pve-qemu-kvm_7.2.0-8&#34;</span>}, <span style=color:#f92672>&#34;capabilities&#34;</span>: []}}
</span></span></code></pre></div><p>è¿™æ—¶æˆ‘ä»¬å¤„äº<code>capabilities negotiation</code>æ¨¡å¼ï¼Œæˆ‘ä»¬é€šè¿‡å‘é€ä»¥ä¸‹å†…å®¹æ¥è¿›å…¥<code>command mode</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;qmp_capabilities&#34;</span> }
</span></span></code></pre></div><p>å¾—åˆ°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {}}
</span></span></code></pre></div><p>ç´§æ¥ç€ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹è¯·æ±‚æŸ¥è¯¢qmpæ‰€æ”¯æŒçš„æ‰€æœ‰å‘½ä»¤</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-commands&#34;</span> }
</span></span></code></pre></div><p>è¾“å‡ºè¿‡é•¿æ­¤å¤„çœç•¥</p><p>QMPæ”¯æŒçš„å‘½ä»¤çš„æè¿°åŠexamplesï¼Œå¯ä»¥åœ¨<a href=https://www.qemu.org/docs/master/interop/qemu-qmp-ref.html>è¿™é‡Œ</a>æ‰¾åˆ°ã€‚è¿™é‡Œæˆ‘åªä»‹ç»ä¸€äº›æˆ‘ä»¬ç”¨åˆ°çš„ï¼š</p><p>æŸ¥è¯¢å¹³å°çš„sevä¿¡æ¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-sev&#34;</span> }
</span></span></code></pre></div><p>è¾“å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;api-minor&#34;</span>: <span style=color:#ae81ff>24</span>, <span style=color:#f92672>&#34;handle&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;launch-secret&#34;</span>, <span style=color:#f92672>&#34;api-major&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;build-id&#34;</span>: <span style=color:#ae81ff>15</span>, <span style=color:#f92672>&#34;policy&#34;</span>: <span style=color:#ae81ff>5</span>}}
</span></span></code></pre></div><p>æŸ¥è¯¢åº¦é‡å€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-sev-launch-measure&#34;</span> }
</span></span></code></pre></div><p>è¾“å‡º:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD&#34;</span>}}
</span></span></code></pre></div><p>å…¶ä¸­dataå­—æ®µçš„base64å€¼å°±æ˜¯åº¦é‡ç»“æœï¼Œè¿™æ˜¯ä¸€ä¸ª48bytesçš„æ•°æ®ã€‚æ ¹æ®<a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>æ–‡æ¡£</a>ä¸­çš„<code>Table 52: LAUNCH_MEASURE Measurement Buffer</code>ç« èŠ‚ï¼Œå®ƒçš„ç»“æ„æ˜¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>MEASURE(32bytes) || MNONCE(16bytes)
</span></span></code></pre></div><ol><li><code>MEASURE</code>
åœ¨<code>6.5 LAUNCH_MEASURE</code>ç« èŠ‚ï¼Œæè¿°äº†<code>MEASURE</code>å…¶å®æ˜¯ä¸€ä¸ªHMACå€¼</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>HMAC(0x04 || API_MAJOR || API_MINOR || BUILD || GCTX.POLICY || GCTX.LD || MNONCE; GCTX.TIK)
</span></span></code></pre></div><p>å…·ä½“çš„ç»†èŠ‚ä¹Ÿå¯ä»¥å‚è€ƒ<a href=https://www.qemu.org/docs/master/system/i386/amd-memory-encryption.html#calculating-expected-guest-launch-measurement>QEMUæ–‡æ¡£</a>ä¸­çš„æè¿°ã€‚
2. <code>MNONCE</code>
MNONCEæ˜¯ç”±firmwareç”Ÿæˆçš„nonceå€¼ï¼Œç›®çš„æ˜¯é˜²æ­¢æ•Œæ‰‹å‘èµ·é‡æ”¾æ”»å‡»ã€‚</p><p>å¹³å°éœ€è¦è¦æŠŠè¿™ä¸¤ä¸ªæ•°æ®ä¸€å¹¶å‘ç»™Relaying Partyã€‚</p><blockquote><p>æ‰€è°“åº¦é‡æ˜¯ä¸€ä¸ªè®¡ç®—å†…å­˜hashçš„è¿‡ç¨‹ï¼ŒPSPå†…éƒ¨ç»´æŠ¤äº†guest vmçš„ä¸€ä¸ªçŠ¶æ€æœºã€‚å½“Hypervisorè¿è¡Œ<code>LAUNCH_START</code>å‘½ä»¤ä¹‹åï¼Œvmå¤„äº<code>GSTATE.LUPDATE</code>çŠ¶æ€ï¼Œæ­¤æ—¶Hypervisorå¯ä»¥é€šè¿‡å¯¹å¤šä¸ªå†…å­˜åŒºåŸŸæ‰§è¡Œ<code>LAUNCH_UPDATE_DATA</code>ï¼Œç„¶åPSPä¼šä½¿ç”¨è¯¥åŒºåŸŸçš„å€¼æ¥æ›´æ–°å½“å‰VMçš„hashå€¼ï¼Œå¹¶å°†å¯¹åº”åŒºåŸŸçš„æ•°æ®ä½¿ç”¨è¿™ä¸ªVMå¯¹åº”çš„VEKå¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚å¦‚æœæ˜¯SEV-ESï¼ŒHypervisorè¿˜å¯ä»¥é€šè¿‡<code>LAUNCH_UPDATE_VMSA</code>å‘½ä»¤æ¥å¯¹VMçš„VMCB save areaåšä¸Šè¿°hashå€¼æ›´æ–°å’Œå†…å­˜åŠ å¯†æ“ä½œã€‚æœ€åHypervisoré€šè¿‡<code>LAUNCH_MEASURE</code>å‘½ä»¤ç”Ÿæˆä¸€ä¸ªåº¦é‡ç»“æœï¼Œå¹¶å°†çŠ¶æ€è½¬æ¢ä¸º<code>GSTATE.LSECRET</code>ï¼Œæ­¤æ—¶æ— æ³•å†ä½¿ç”¨<code>LAUNCH_UPDATE_DATA</code>å’Œ<code>LAUNCH_UPDATE_VMSA</code>å‘½ä»¤ã€‚</p></blockquote><h3 id=relaying-partyéªŒè¯åº¦é‡å€¼>ï¼ˆRelaying Partyï¼‰éªŒè¯åº¦é‡å€¼</h3><p>ç°åœ¨è½¬åˆ°Relaying Partyä¾§ã€‚Guest VMå·²ç»åº¦é‡å¥½ï¼Œæ­£ç­‰ç€æˆ‘ä»¬éªŒè¯å‘¢ã€‚</p><ol><li><p>æ„å»ºVMSA binary
å¦‚æœä½ æ˜¯SEV-ESï¼Œé‚£ä¹ˆåœ¨æ­¤ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€é¡¹å†…å®¹ï¼Œå°±æ˜¯æ„å»ºVMSA binaryã€‚è¿™ä¹Ÿæ˜¯SEV-ESç›¸æ¯”äºSEVå¤šå‡ºæ¥çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé¢å¤–åº¦é‡äº†æ¯ä¸ªGuest vCPUçš„VMSAåŒºåŸŸï¼Œå¹¶åœ¨è¿è¡Œæ—¶æä¾›åŠ å¯†ä¿æŠ¤ã€‚</p><p>å› æ­¤æˆ‘ä»¬çš„Guest Owneråœ¨éªŒè¯åº¦é‡å€¼æ—¶ï¼Œä¹Ÿéœ€è¦è®¡ç®—å‡ºVMSAåŒºåŸŸçš„åˆå§‹å€¼ï¼ˆä¹Ÿå°±æ˜¯VMSA binaryï¼‰ï¼Œå¹¶æŠŠå®ƒçº³å…¥åº¦é‡è¿‡ç¨‹ä¸­ã€‚</p><p>é¦–å…ˆéœ€è¦çŸ¥é“Guest vCPUçš„ä¸€äº›ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨qmpä¸­çš„<code>"query-cpu-model-expansion"</code>å‘½ä»¤ï¼Œå…¶ä¸­å‚æ•°<code>"name"</code>éœ€è¦æ ¹æ®ä½ çš„qemuå‘½ä»¤è¡Œä¸­æŒ‡å®šçš„<code>-cpu</code>é€‰é¡¹è¿›è¡Œè°ƒæ•´ã€‚</p><p>æ¯”å¦‚æˆ‘çš„å‘½ä»¤æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;query-cpu-model-expansion&#34;</span>, <span style=color:#f92672>&#34;arguments&#34;</span>: { <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;static&#34;</span>, <span style=color:#f92672>&#34;model&#34;</span>: { <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;EPYC-Rome&#34;</span> } } }
</span></span></code></pre></div><p>è¾“å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {<span style=color:#f92672>&#34;model&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;base&#34;</span>, <span style=color:#f92672>&#34;props&#34;</span>: {<span style=color:#f92672>&#34;vmx-entry-load-rtit-ctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svme-addr-chk&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cmov&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ia64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ssb-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;aes&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-apicv-xapic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mmx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdpid&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;arat&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-page-walk-4&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-page-walk-5&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;gfni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibrs-all&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-desc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pause-filter&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;bus-lock-detect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsavec&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;intel-pt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-tsc-scaling&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr8-store-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdseed-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-eptp-switching&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-asyncpf&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;perfctr-core&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mpx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pbe&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512cd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;decodeassists&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-clear-bndcfgs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse4.1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;family&#34;</span>: <span style=color:#ae81ff>23</span>, <span style=color:#f92672>&#34;intel-pt-lip&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vmwrite-vmexit-fields&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-asyncpf-int&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vnmi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-true-ctls&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept-execonly&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-save-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-all-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;wbnoinvd&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512f&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;msr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mce&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mca&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xcrypt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-intr-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;min-level&#34;</span>: <span style=color:#ae81ff>13</span>, <span style=color:#f92672>&#34;vmx-flexpriority&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xgetbv1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;cid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-exinfo&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ds&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fxsr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-fp16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-bf16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr8-load-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsaveopt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;arch-lbr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-vid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-save-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xtpr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsx-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ple&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-vpopcntdq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;phe&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;extapic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;3dnowprefetch&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-vmfunc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-shutdown&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx1&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vbmi2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cr8legacy&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-encls-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;stibp&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-msr-bitmap&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xcrypt-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-mwait-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-pml&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-nmi-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-tile&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-single-context-noglobals&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pn&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rsba&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;dca&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vendor&#34;</span>: <span style=color:#e6db74>&#34;AuthenticAMD&#34;</span>, <span style=color:#f92672>&#34;vmx-unrestricted-guest&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr3-store-noexit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pku&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pks&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;smx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cmp-legacy&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512-4fmaps&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmcb-clean&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;hle&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx-vnni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;3dnowext&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amd-no-ssb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;npt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgxlc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rdctl-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invvpid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clwb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;lbrv&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;adx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ss&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pni&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tsx-ldtrk&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svm-lock&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;smep&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;smap&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pfthreshold&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invpcid-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-int8&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;x2apic&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512vbmi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512vnni&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-x2apic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-pv-sched-yield&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invlpg-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invvpid-all-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-hlt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;flushbyasid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;f16c&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-ack-intr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ace2-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pae&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pat&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;phe-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-tsc-offset&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-nopiodelay&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvmclock-stable-bit&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-rdtsc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;hypervisor&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-rdtscp-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mds-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pcommit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vpid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;syscall&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512dq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;svm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;invtsc&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-monitor-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-wbinvd-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;est&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-poll-control&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512ifma&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tm2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-pv-eoi&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-ipi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cx8&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-invvpid-single-addr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;waitpkg&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;cldemote&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-tokenkey&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xfd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-mmu&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sse4.2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pge&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512bitalg&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pdcm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-bndcfgs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-clear-rtit-ctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#ae81ff>49</span>, <span style=color:#f92672>&#34;movbe&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;nrip-save&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ssse3&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sse4a&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-msi-ext-dest-id&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-pause-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;invpcid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-debug&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pdpe1gb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;sgx-mode64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc-deadline&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;skip-l1dfl-vmentry&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-load-perf-global-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fma&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;cx16&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;de&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;stepping&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&#34;xsave&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;clflush&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;skinit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tce&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fpu&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ds-cpl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fma4&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-exit-nosave-debugctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-kss&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;la57&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;osvw&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;apic&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pmm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-noload-debugctl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-eptad&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;spec-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-posted-intr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-apicv-register&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tsc-adjust&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-steal-time&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-vp2intersect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvmclock&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-zero-len-inject&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pschange-mc-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;v-vmsave-vmload&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdrand-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sgx-provisionkey&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lwp&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amd-ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xop&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ibpb&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;ibrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;core-capability&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-invept-single-context&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;movdiri&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;acpi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512bw&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ace2&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fsgsbase&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-ept-2mb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ept-1gb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;ht&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-io-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;nx&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pclmulqdq&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;mmxext&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;popcnt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vaes&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;serialize&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;movdir64b&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xsaves&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-shadow-vmcs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-save-preemption-timer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-pat&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fsrm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-perf-global-ctrl&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-io-bitmap&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;umip&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-store-lma&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-movdr-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avic&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;sep&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;virt-ssbd&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-cr3-load-noexit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;nodeid-msr&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;md-clear&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;misalignsse&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;split-lock-detect&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;min-xlevel&#34;</span>: <span style=color:#ae81ff>2147483679</span>, <span style=color:#f92672>&#34;bmi1&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;bmi2&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-unhalt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;tsc-scale&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;topoext&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;amd-stibp&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-preemption-timer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clflushopt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-entry-load-pkrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vnmi-pending&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;monitor&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-vintr-pending&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512er&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;full-width-write&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pmm-en&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;pcid&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;taa-no&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;arch-capabilities&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vgif&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-secondary-ctls&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-xsaves&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;clzero&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;3dnow&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;erms&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-ia32e-mode&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lahf-lm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vpclmulqdq&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-ins-outs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;fxsr-opt&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xstore&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rtm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;kvm-hint-dedicated&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;amx-bf16&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;lmce&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;perfctr-nb&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;rdrand&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdseed&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;avx512-4vnniw&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vme&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;dtes64&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;mtrr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;rdtscp&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;xsaveerptr&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;pse36&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;kvm-pv-tlb-flush&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-activity-wait-sipi&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;tbm&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;wdt&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-rdpmc-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-mtf&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-entry-load-efer&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;model-id&#34;</span>: <span style=color:#e6db74>&#34;AMD EPYC-Rome Processor&#34;</span>, <span style=color:#f92672>&#34;sha-ni&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-exit-load-pkrs&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;abm&#34;</span>: <span style=color:#66d9ef>true</span>, <span style=color:#f92672>&#34;vmx-ept-advanced-exitinfo&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;avx512pf&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;vmx-hlt-exit&#34;</span>: <span style=color:#66d9ef>false</span>, <span style=color:#f92672>&#34;xstore-en&#34;</span>: <span style=color:#66d9ef>false</span>}}}}
</span></span></code></pre></div><p>ä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸Šé¢çš„<code>model</code>ã€<code>family</code>ã€<code>stepping</code>ä¿¡æ¯ï¼Œè¿™å‡ ä¸ªå€¼å°†å†³å®šVMSAä¸­çš„<code>rdx</code>å¯„å­˜å™¨çš„å€¼ã€‚</p><p>æ„å»ºvCPU0çš„VMSA binaryï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl vmsa build NEW-VMSA0.bin --userspace qemu --family <span style=color:#ae81ff>23</span> --stepping <span style=color:#ae81ff>0</span> --model <span style=color:#ae81ff>49</span> --firmware ./OVMF.fd --cpu <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>å¦‚æœæ˜¯å¤šä¸ªæ ¸å¿ƒï¼Œè¿˜éœ€è¦ç”Ÿæˆå…¶ä½™æ ¸å¿ƒçš„VMSA binaryã€‚ä¸è¿‡ç”±äºå…¶ä½™çš„VMSA binaryéƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªéœ€è¦ä¸ºvCPU1ç”Ÿæˆä¸€æ¬¡å°±è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl vmsa build NEW-VMSA1.bin --userspace qemu --family <span style=color:#ae81ff>23</span> --stepping <span style=color:#ae81ff>0</span> --model <span style=color:#ae81ff>49</span> --firmware ./OVMF.fd --cpu <span style=color:#ae81ff>1</span>
</span></span></code></pre></div></li><li><p>è®¡ç®—åº¦é‡å€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sevctl measurement build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --api-major <span style=color:#ae81ff>0</span> --api-minor <span style=color:#ae81ff>24</span> --build-id <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy 0x05 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tik sev_tik.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --launch-measure-blob ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --firmware ./OVMF.fd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --num-cpus <span style=color:#ae81ff>8</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --vmsa-cpu0 ./NEW-VMSA0.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --vmsa-cpu1 ./NEW-VMSA1.bin
</span></span></code></pre></div><p>å…¶ä¸­ï¼š</p><ul><li><code>--api-major</code>ã€<code>--api-minor</code>ã€<code>--build-id</code>ã€<code>--policy</code>å¯ä»¥é€šè¿‡qmpé‡Œçš„<code>{ "execute": "query-sev" }</code>å‘½ä»¤æŸ¥è¯¢åˆ°</li><li><code>--policy</code> å’Œå¯åŠ¨Guest VMæ—¶æŒ‡å®šçš„policyä¸€è‡´</li><li><code>--firmware</code>æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„OVMF.fdçš„è·¯å¾„<blockquote><p>é™¤äº†firmwareï¼Œè¿˜æ”¯æŒåŠ å…¥å…¶å®ƒçš„åº¦é‡å€¼å¦‚<code>--kernel</code>, <code>--initrd</code>, <code>--cmdline</code>ã€‚ä¸è¿‡ç”±äºæˆ‘ä»¬ç»™qemuåªæŒ‡å®šäº†firmwareçš„è·¯å¾„ï¼Œæ‰€ä»¥qemuåªåº¦é‡äº†firmwareã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨éªŒè¯çš„æ—¶å€™ä¹Ÿåªåº¦é‡firmwareã€‚</p></blockquote></li><li>ä¼ å…¥<code>--launch-measure-blob</code>çš„ç›®çš„æ˜¯è·å–æœ«å°¾çš„MNONCEå€¼ã€‚</li><li>å¦‚æœæ˜¯SEV-SNPï¼Œåˆ™éœ€æä¾›<ul><li><code>--num-cpus</code>ï¼šGuest VMçš„cpuæ•°é‡</li><li><code>--vmsa-cpu0</code>ã€<code>--vmsa-cpu1</code>ï¼šæ¯ä¸ªCPUçš„vmsaåŒºåŸŸåˆå§‹å€¼ã€‚å¦‚æœæ˜¯å¤šäºä¸€ä¸ªvCPUï¼Œåˆ™éœ€è¦æŒ‡å®š<code>--vmsa-cpu1</code></li></ul></li></ul><p>è¾“å‡ºå¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD
</span></span></code></pre></div><p>å¯è§å’Œæˆ‘ä»¬ä»å¹³å°å¤„æ‹¿åˆ°çš„åº¦é‡ç»“æœæ˜¯ä¸€è‡´çš„ã€‚</p></li></ol><p>è‡³æ­¤æˆ‘ä»¬è¯æ˜äº†è¿™ä¹ˆä¸€ä»¶äº‹ï¼šæœ‰ä¸€ä¸ªç»è¿‡AMDéªŒè¯çš„å¹³å°ï¼Œè¿™ä¸ªå¹³å°å‘æˆ‘ä»¬è¯æ˜äº†å®ƒä¸Šé¢è¿è¡Œäº†æˆ‘ä»¬é¢„æœŸçš„Guest VMã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å·®ä¸€æ­¥ï¼Œé‚£å°±æ˜¯å‘è¿™ä¸ªGuest VMæ³¨å…¥æˆ‘ä»¬çš„æœºå¯†æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä¸å®ƒä¸Šé¢çš„åº”ç”¨å»ºç«‹å¯ä¿¡ä¿¡é“ã€‚</p><h3 id=relaying-partyç”Ÿæˆsecret>ï¼ˆRelaying Partyï¼‰ç”Ÿæˆsecret</h3><p>æ‰€è°“çš„secretæ˜¯è‹¥å¹²ä¸ª<code>&lt;GUID, Value></code>ç»„æˆçš„é”®å€¼å¯¹ï¼Œå€ŸåŠ©<code>sevctl</code>ï¼Œå¯ä»¥å°†å…¶æ‰“åŒ…æˆä¸€ä¸ªbinaryï¼Œç„¶åç»è¿‡TEKåŠ å¯†ä»¥åŠTIKè¿›è¡Œçš„HMACä¿æŠ¤ã€‚éšåè¯¥binaryè¢«å‘é€ç»™AMD PSPã€‚åœ¨æ‰§è¡ŒSEVçš„<code>LAUNCH_SECRET</code>å‘½ä»¤æ—¶ï¼Œç”±PSPä½¿ç”¨TEKè§£å¯†payloadï¼Œç„¶åç”¨VEKåŠ å¯†å¹¶æ”¾å…¥åˆ°Guest VMé‡ŒæŒ‡å®šçš„å†…å­˜åŒºåŸŸã€‚</p><blockquote><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªsecreté€šå¸¸å­˜å‚¨ä¸€ä¸ªå¯†é’¥ã€‚æ¯”å¦‚grubé‡Œé¢æœ‰ä¸€ä¸ªcryptodiskæ¨¡å—ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªsecretæ¥è§£å¯†ç»è¿‡luksåŠ å¯†çš„ç£ç›˜ï¼Œå®ƒçš„guidæ˜¯<code>736869e5-84f0-4973-92ec-06879ce3da0b</code>ã€‚</p></blockquote><p>åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªGUIDä¸º<code>43ced044-42ec-487a-88b7-261bda359f24</code>çš„secretï¼Œå€¼ä¸º<code>"TOP_SECRET_MESSAGE"</code>è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;TOP_SECRET_MESSAGE&#34;</span> &gt; ./secret.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sevctl secret build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tik sev_tik.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tek sev_tek.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --launch-measure-blob ychmE35DRiv54GcbbM+igqxwfoshDLDVH0C7G8Ig0psQrgLNRNeZPPMzelvBwnZD <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --secret 43ced044-42ec-487a-88b7-261bda359f24:./secret.txt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./secret_header.bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./secret_payload.bin
</span></span></code></pre></div><p>è¾“å‡º</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Wrote header to: ./secret_header.bin
</span></span><span style=display:flex><span>Wrote payload to: ./secret_payload.bin
</span></span></code></pre></div><p>æˆ‘ä»¬å°†è¾“å‡ºçš„ä¸¤ä¸ªæ–‡ä»¶ç”¨scpå‘åˆ°å¹³å°</p><h3 id=å¹³å°å°†secretæ¤å…¥guest-vm>ï¼ˆå¹³å°ï¼‰å°†secretæ¤å…¥Guest VM</h3><p>é¦–å…ˆç”¨base64å‘½ä»¤å°†secret_header.binå’Œsecret_payload.binè½¬ä¸ºbase64ç¼–ç </p><p>å¾—åˆ°ï¼š</p><ul><li><code>base64 -w 0 &lt; secret_header.bin</code>ï¼š<code>AAAAAKzd9a3vLYPW4fcwzlsAq+YY6Vhlqcj65QvIzqy3Mc+XPiyzEsCsmKKIpk8SfnAF7w==</code></li><li><code>base64 -w 0 &lt; secret_payload.bin</code>ï¼š<code>s1Ua7oK6RH54g97oWgV1XWqQw4vpZLpfAL2oCVG9uLhjB+dzHxeKnQbxaiQ8ibSUedTfZx28QIz7tKaRh12mIg==</code></li></ul><p>åœ¨QMPä¸­ï¼Œä½¿ç”¨<code>sev-inject-launch-secret</code>å‘½ä»¤ï¼Œå¹¶ç”¨ä¸Šé¢ä¸¤ä¸ªå‚æ•°ä½œä¸ºå€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;sev-inject-launch-secret&#34;</span>, <span style=color:#f92672>&#34;arguments&#34;</span>: { <span style=color:#f92672>&#34;packet-header&#34;</span>: <span style=color:#e6db74>&#34;AAAAAKzd9a3vLYPW4fcwzlsAq+YY6Vhlqcj65QvIzqy3Mc+XPiyzEsCsmKKIpk8SfnAF7w==&#34;</span>, <span style=color:#f92672>&#34;secret&#34;</span>: <span style=color:#e6db74>&#34;s1Ua7oK6RH54g97oWgV1XWqQw4vpZLpfAL2oCVG9uLhjB+dzHxeKnQbxaiQ8ibSUedTfZx28QIz7tKaRh12mIg==&#34;</span> } }
</span></span></code></pre></div><p>è¿”å›</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;return&#34;</span>: {}}
</span></span></code></pre></div><p>ä½¿ç”¨<code>cont</code>å‘½ä»¤ç»§ç»­è¿è¡ŒVM</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;execute&#34;</span>: <span style=color:#e6db74>&#34;cont&#34;</span> }
</span></span></code></pre></div><h3 id=guest-vmoså¯åŠ¨å¹¶è·å–æ¤å…¥çš„secret>ï¼ˆGuest VMï¼‰OSå¯åŠ¨å¹¶è·å–æ¤å…¥çš„secret</h3><p>å‰é¢è¯´åˆ°ï¼Œæ‰€æœ‰çš„secretè¢«å†™å…¥åˆ°å†…å­˜çš„ç‰¹å®šåŒºåŸŸã€‚è¿™ä¸ªåŒºåŸŸçš„åœ°å€æ˜¯ç”±UEFIï¼ˆåœ¨è™šæ‹Ÿæœºä¸­å°±æ˜¯OVMF firmwareï¼‰æš´éœ²ç»™qemuçš„ï¼ŒéšåUEFIä¼šåœ¨EFI configuration tableä¸­åˆ›å»ºä¸€ä¸ªGUIDä¸º<code>adf956ad-e98c-484c-ae11-b51c7d336447</code>çš„æ¡ç›®ï¼Œå¹¶å¯¹è¯¥å†…å­˜åŒºåŸŸåšä¸€ä¸ª<code>EFI_RESERVED_TYPE</code>æ ‡è®°å‘Šè¯‰bootloaderå’Œkernelä¸è¦è¦†ç›–äº†è¿™å—å†…å­˜ã€‚</p><p>Linuxå†…æ ¸å¢åŠ äº†å¯¹è¯†åˆ«SEVæ¤å…¥çš„secretå€¼çš„æ”¯æŒï¼Œè¿™æ˜¯é€šè¿‡ä¸€ä¸ªå«<code>efi_secret</code>çš„å†…æ ¸æ¨¡å—å®ç°çš„ï¼Œå®ƒä¼šæ ¹æ®GUIDè¯†åˆ«EFI configuration tableé‡Œçš„æ¡ç›®ï¼Œå¹¶ä»è¯¥æ¡ç›®æŒ‡ç¤ºçš„å†…å­˜åœ°å€ä¸­è§£ææˆ‘ä»¬çš„secretï¼Œå¹¶æš´éœ²åœ¨ä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p><p>æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»<a href=https://docs.kernel.org/5.19/security/secrets/coco.html>è¿™ç¯‡çŸ­æ–‡ç« </a></p><ol><li><p>ç¡®ä¿Guest VMæ£€æµ‹åˆ°äº†SEVæ”¯æŒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dmesg | grep -i sev
</span></span></code></pre></div><p>åº”è¯¥æ˜¾ç¤º<code>Memory Encryption Features active: AMD SEV</code></p></li><li><p>è½½å…¥<code>efi_secret</code>å†…æ ¸æ¨¡å—</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>modprobe efi_secret
</span></span></code></pre></div></li><li><p>æŒ‚è½½<code>securityfs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mount -t securityfs securityfs /sys/kernel/security
</span></span></code></pre></div></li><li><p>æ£€æŸ¥secretå€¼</p><p>æ‰€æœ‰çš„secretå€¼åœ¨/sys/kernel/security/secrets/cocoç›®å½•ä¸‹ï¼Œä»¥secretçš„GUIDä½œä¸ºæ–‡ä»¶åï¼Œè¯»å–è¯¥æ–‡ä»¶å°±èƒ½å¾—åˆ°secretçš„å†…å®¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ls -la /sys/kernel/security/secrets/coco/
</span></span></code></pre></div></li></ol><p>ä¸‹å›¾æ˜¯æˆ‘ä»¬çš„å®éªŒç»“æœï¼Œå…¶ä¸­è¿è¡Œçš„Guest VMæ˜¯ä¸€ä¸ªarchisoé•œåƒ
<img src=/images/2023-04-17-13-35-51.png alt></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸè¯»å‡ºäº†æˆ‘ä»¬æ³¨å…¥çš„secretçš„å€¼<code>TOP_SECRET_MESSAGE</code>ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>è¿™ä¸€è¶Ÿé…ç½®è¿‡ç¨‹èŠ±äº†ä¸å°‘æ—¶é—´ï¼Œä¸è¿‡ä¹Ÿæ˜¯åœ†äº†æˆ‘æœ€åˆç»„è¿™ä¸€å¥—è®¾å¤‡æ—¶çš„ä¸€ä¸ªæƒ³æ³•å§ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ã€‚ç›¸æ¯”äºç¹æ‚çš„SGXï¼ŒSEVå’ŒSEV-ESå°±æ˜¾å¾—æ¸…æ™°äº†å¾ˆå¤šï¼ˆå½“ç„¶ä¸€äº›æ–¹é¢æ¯”å¦‚CEKèƒ½å¤Ÿæ ‡è¯†ä¸€ä¸ªCPUï¼Œè¿™æ ·éšç§æ€§å°±å¼±äº†äº›äº†ï¼Œç„¶åä¹Ÿæ²¡æœ‰è¯ä¹¦æ’¤é”€åˆ—è¡¨è¿™ç§ä¸œè¥¿ï¼‰ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºAMDåœ¨è®¾è®¡è¿™ä¸ªæ–¹æ¡ˆä¸­çš„ä¸€äº›å®‰å…¨è€ƒè™‘ï¼Œæ¯”å¦‚<code>pre-attestation</code>è¿‡ç¨‹ä¸­çš„session nonceå’Œmeasure nonceå€¼çš„ä½¿ç”¨ã€‚</p><p>ä½†æ˜¯ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ–¹æ¡ˆä¸­çš„ä¸€äº›ç¼ºé™·ï¼Œæ¯”å¦‚secretçš„æ¤å…¥è¿‡ç¨‹ä¼šè¦æ±‚Guest Owneråœ¨Guest VMå¯åŠ¨å‰å°±å‚ä¸è¿›æ¥ã€‚å¦‚æœå¯ä»¥å†è¿›ä¸€æ­¥ï¼Œæ¯”å¦‚PSPåœ¨å¼€å¯Guest VMåï¼Œå°±è‡ªåŠ¨ä¸ºè¯¥VMç”Ÿæˆä¸€å¯¹éå¯¹ç§°å¯†é’¥ã€‚ç”¨å¹³å°ä¸Šçš„PEKä¸ºè¿™ä¸ªGuest VMç­¾ä¸€ä¸ªè¯ä¹¦ï¼Œé‡Œé¢åŒ…å«å…¬é’¥å’ŒVMçš„åº¦é‡å€¼ç­‰ä¿¡æ¯ï¼Œç„¶åæŠŠç§é’¥ä»¥secretçš„ä¿¡æ¯æ”¾åˆ°VMé‡Œé¢ï¼Œå°±å¯ä»¥èŠ‚çœæ‰å¾ˆå¤šç¯èŠ‚ã€‚åœ¨æ–°ç‰ˆæœ¬çš„PSPä¸­ï¼Œå¢åŠ äº†ä¸€ä¸ªåä¸º<code>ATTESTATION</code>çš„å‘½ä»¤ï¼Œå®ƒå…è®¸åœ¨VMçš„å¤„äºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œç”Ÿæˆä¸€ä¸ªattestation reportï¼ŒåŒ…å«äº†åº¦é‡å€¼ä¿¡æ¯å¹¶ç”±PEKç­¾åã€‚ä½†æ˜¯é—æ†¾çš„æ˜¯å®ƒåªæ˜¯æä¾›äº†ä¸€ç§æ–¹å¼è·å–ä¹‹å‰åº¦é‡çš„ç»“æœï¼Œæ²¡æœ‰è§£å†³åœ¨LAUNCH_STARTå’ŒLAUNCH_MEASUREé˜¶æ®µéœ€è¦Guest Ownerå‚ä¸çš„é—®é¢˜ã€‚</p><p>å¦å¤–æ˜¯å…³äºpveå¹³å°çš„é—®é¢˜ï¼Œåœ¨è¿™ä¸ªå®éªŒä¸­ä¹Ÿç®—æ˜¯ç†è§£äº†pveæ²¡æœ‰å†…ç½®sevæ”¯æŒçš„åŸå› ï¼šæœ€å¤§çš„é—®é¢˜åœ¨äºè¿œç¨‹è¯æ˜ã€‚å¦‚æœä¸åšè¿œç¨‹è¯æ˜ï¼Œé‚£ä¸ºGuest VMå¼€SEVåªæ˜¯ä»£è¡¨äº†å†…å­˜åŠ å¯†ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯å›ºä»¶ã€Kernelç­‰çš„å®‰å…¨æ€§ï¼Œç”¨æˆ·æ— æ³•ç›¸ä¿¡ä¸Šé¢çš„è½¯ä»¶æ˜¯å®‰å…¨çš„ã€‚è€Œå¦‚æœè¦åšè¿œç¨‹è¯æ˜ï¼Œå°±å˜å¾—éº»çƒ¦äº†èµ·æ¥ï¼Œéœ€è¦å¹³å°å’Œç”¨æˆ·é…åˆèµ·æ¥å®Œæˆï¼Œè¿™å¯¹äºPVEæ¥è¯´æ˜¾ç„¶æ˜¯å¤ªå¤æ‚äº†ã€‚è¿˜æ˜¯ç‰¹å®šåœºæ™¯æ¯”å¦‚kataå®¹å™¨è¿™æ ·çš„æ›´é€‚åˆã€‚</p><h2 id=å‚è€ƒ>å‚è€ƒï¼š</h2><ul><li><a href=https://www.amd.com/system/files/TechDocs/55766_SEV-KM_API_Specification.pdf>AMD Secure Encrypted Virtualization API</a></li><li><a href=https://docs.kernel.org/5.19/security/secrets/coco.html>Confidential Computing secrets - Linux Kernel Doc</a></li><li>EDKIIä¸­ä¸secretç›¸å…³çš„å‡ ä¸ªprï¼š<ul><li><a href=https://github.com/tianocore/edk2/pull/1175>https://github.com/tianocore/edk2/pull/1175</a></li><li><a href=https://github.com/tianocore/edk2/pull/1235>https://github.com/tianocore/edk2/pull/1235</a></li></ul></li><li>James Bottomleyï¼ˆä¸Šè¿°PRçš„ä¸»è¦ä½œè€…ï¼‰çš„æ–‡ç« <ul><li><a href=https://blog.hansenpartnership.com/deploying-encrypted-images-for-confidential-computing/>Deploying Encrypted Images for Confidential Computing</a></li></ul></li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>Â© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡2020042968å·-1</a></footer></body></html>