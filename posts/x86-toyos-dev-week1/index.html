<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>自制x86玩具操作系统 week1 | imlk&#39;s blog</title>
  <link rel="stylesheet" href='/css/style.css' />
  <link rel="stylesheet" href='/css/fonts.css' />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="header">
    <a class="logo" href='/'> imlk's Blog </a>
    <nav>
      <ul class="menu">
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/archives/">Archives</a></li>
        
        <li><a href="/friends/">Friends</a></li>
        
        <li><a href="/index.xml">Subscribe</a></li>
        
      </ul>
    </nav>
  </header>
  <hr />



<div class="article-meta">
    <h1><span class="title">自制x86玩具操作系统 week1</span></h1>
    
    <span>
        <span class="date">2019-05-01</span> |
        
        <span class="cats">
            
            
            <a href='https://blog.imlk.top/categories/osdev/'>OSDev</a>
            
        </span>
        <span class="tags">
            
             | 
            <a href='https://blog.imlk.top/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/'>#操作系统</a>
            
            
            <a href='https://blog.imlk.top/tags/diy/'>#DIY</a>
            
        </span>
    </span>
    <br>
    <br>
    
</div>


<main>
    <h2 id="day-0x00">DAY 0x00</h2>
<p>先装个翻译插件，装了半天找了个勉强能用的
然后考虑用git来做版本控制，方便和原版进行比较找出自己的修改，然后发现文字编码问题，于是乎捣鼓了个工具来批量转换文件编码（一大堆时间栽进去了）。</p>
<p>第0天用16进制编辑器编辑出一个image文件</p>
<h2 id="day-0x01">DAY 0x01</h2>
<p>这张软盘共有1440KB大小，最高地址为0x168000-1</p>
<h4 id="文件描述">文件描述</h4>
<ul>
<li>tolset\z_tools\qemu目录中的MakeFile启动qemu-win.bat，本质上是设置环境并带参数启动qemu.exe</li>
<li>tolset\z_tools\qemu\vgabios.bin : <em>BIOS (ia32) ROM Ext.</em> (19*512)</li>
<li>hellos0\helloos.img：<em>DOS/MBR boot sector</em>, code offset 0x4e+2, OEM-ID &ldquo;HELLOIPL&rdquo;, root entries 224, sectors 2880 (volumes &lt;=32 MB), sectors/FAT 9, sectors/track 18, sectors 2880 (volumes &gt; 32 MB), serial number 0xffffffff, label: &ldquo;HELLO-OS   &ldquo;, FAT (12 bit), followed by FAT</li>
</ul>
<h4 id="汇编">汇编</h4>
<ul>
<li>编译<code>.nas</code>文件用工具<code>nask</code>，<code>nask helloos.nas helloos.img</code></li>
<li><code>DB</code>(define byte)用来以十六进制定义数据，一次一个Byte，多个之间逗号分割<br>
DB后还可以直接接字符串，字符串用<code>&quot;包围&quot;</code>起来，<strong>编译器不在字符串后面自动加\0</strong></li>
<li><code>RESB</code>(reserve byte)用来定义空的字节个数，后面接数字，等价于<code>DB</code>后面加一堆<code>0x00</code></li>
<li>数字字面量的表示形式和c语言里面一样0x开头为16进制</li>
<li><code>;</code>用于注释</li>
<li><code>DW</code>(define word),定义两个字节的数据</li>
<li><code>DD</code>(define double-word),定义4个字节的数据</li>
<li>数据部分支持先执行<code>加减乘除</code>运算再将结果写入</li>
<li><code>$</code>变量表示在<code>这个位置之前</code>已经写入的字节<strong>个数</strong></li>
</ul>
<h4 id="镜像文件格式">镜像文件格式</h4>
<ul>
<li>该软盘扇区大小为512字节，启动区在第一个扇区内，<strong>计算机首先从最初的一个扇区内开始读盘</strong>，启动区的末尾必须为<code>0x55AA</code>（无特别意义，仅仅作为启动区的标记）</li>
<li>软盘的一次读写以一个扇区为单位</li>
<li>IPL是initial program loader的意思，启动程序加载器</li>
<li>操作系统和操作系统的加载程序在同一个地方的启动机制叫做bootstrap方式</li>
</ul>
<h2 id="day-0x02">DAY 0x02</h2>
<h4 id="汇编-1">汇编</h4>
<ul>
<li><code>ORG</code>指令指定程序装载到内存中的指定地址(这里一开始没看懂)</li>
<li><code>JMP</code>指令跳转到标签处</li>
<li>作者的nask汇编中指令遵循Intel汇编，第一个是目标操作数，第二个是源操作数</li>
</ul>
<table>
<thead>
<tr>
<th>寄存器名</th>
<th>全称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>AX</td>
<td>accumulator</td>
<td>累加寄存器</td>
</tr>
<tr>
<td>CX</td>
<td>counter</td>
<td>计数寄存器</td>
</tr>
<tr>
<td>DX</td>
<td>data</td>
<td>数据寄存器</td>
</tr>
<tr>
<td>BX</td>
<td>base</td>
<td>基址寄存器（例如用于指向数组起始位置）</td>
</tr>
<tr>
<td>SP</td>
<td>stack pointer</td>
<td>栈指针寄存器</td>
</tr>
<tr>
<td>BP</td>
<td>base pointer</td>
<td>基址指针寄存器（栈帧的基地址）</td>
</tr>
<tr>
<td>SI</td>
<td>source index</td>
<td>源变址寄存器</td>
</tr>
<tr>
<td>DI</td>
<td>destination index</td>
<td>目的变址寄存器</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>寄存器名</th>
<th>全称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ES</td>
<td>extra segment</td>
<td>附加段寄存器</td>
</tr>
<tr>
<td>CS</td>
<td>code segment</td>
<td>代码段寄存器</td>
</tr>
<tr>
<td>SS</td>
<td>stack segment</td>
<td>（栈指针寄存器的）段寄存器</td>
</tr>
<tr>
<td>DS</td>
<td>data segment</td>
<td>数据段寄存器</td>
</tr>
<tr>
<td>FS</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>GS</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<ul>
<li><code>AH/AL</code>,<code>AX</code>,<code>EAX</code>,<code>RAX</code>分别为8，16，32，64位寄存器</li>
<li>标签<code>label</code>等价于地址，每个标签的地址是按照ORG指令加上偏移量计算得出的</li>
<li><code>[]</code>表示多一层寻址</li>
<li><code>BYTE</code>、<code>WORD</code>、<code>DWORD</code>这些汇编保留字和<code>[地址]</code>的组合，表示以给出的地址为低地址的一块数据</li>
<li><code>CMP</code>比较指令</li>
<li><code>JE</code>结果相等时的条件跳转</li>
<li><code>INT</code>是软件中断指令，可以调用BIOS里预设的函数，后面接一个数字表示调用不同的函数。<br>
调用前先将数据存到指定的寄存器</li>
<li><code>HLT</code>，(halt)让CPU停止动作，进入待机状态</li>
</ul>
<p>##未完待续</p>
<p>先睡觉了，天气冷，折腾一天了。</p>
<ul>
<li>Linux 汇编器：对比 GAS 和 NASM：
<a href="https://www.ibm.com/developerworks/cn/linux/l-gas-nasm.html">https://www.ibm.com/developerworks/cn/linux/l-gas-nasm.html</a></li>
<li>各种编译器的区别 ASM: MASM, NASM, FASM?
<a href="https://stackoverflow.com/questions/10179933/asm-masm-nasm-fasm/10180015">https://stackoverflow.com/questions/10179933/asm-masm-nasm-fasm/10180015</a></li>
</ul>
<h2 id="day-0x02-续">DAY 0x02 续</h2>
<p>上网搜了一下，发现原来的info地址已经变成了<a href="http://oswiki.osask.jp/">http://oswiki.osask.jp/</a>但是依然不能用，最后在google快照里面找到了踪迹<code>http://webcache.googleusercontent.com/search?q=cache:</code>后面接网页url即可</p>
<pre tabindex="0"><code>http://webcache.googleusercontent.com/search?q=cache:http://oswiki.osask.jp/?(AT)memorymap
</code></pre><p>helloos4中只取了helloos.nas的前半部分作为<code>ipl.nas</code></p>
<h4 id="汇编-2">汇编</h4>
<ul>
<li>nask编译时第三个参数为编译输出的列表文件，描述每个指令如何翻译成机器语言</li>
<li><code>ORG</code>指令编译不产生字节</li>
</ul>
<h4 id="makefile">Makefile</h4>
<ul>
<li><code>#</code>注释，<code>\</code>续行符号</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile"><span style="color:#a6e22e">目标</span><span style="color:#f92672">:</span> 依赖文件
	命令... <span style="color:#ae81ff">\
</span></code></pre></div><ul>
<li>
<p>第一个目标是默认目标</p>
</li>
<li>
<p>目标可以是一个文件，也可以是一个标签，称为伪目标</p>
</li>
<li>
<p><code>eding</code>能编辑img文件，将其它img文件放到指定的位置</p>
</li>
<li>
<p><code>ipl.bin</code>就是<code>helloos.img</code>的前0x00200个字节</p>
</li>
</ul>
<p>启动时，首先执行BIOS，然后BIOS加载软盘的启动区，并在一些列操作之后跳转到启动区起始处的第一条<code>JMP</code>指令。
<strong>启动区内容的装载地址为 0x00007c00-0x00007dff</strong>，这不是操作系统规定的，也不是img镜像文件中指定的，镜像文件得遵循这一规定，这一过程由BIOS进行
day1和day2的最终镜像文件没有区别，在helloos2中作者故意将程序区不以汇编代码形式展示，是因为其中要用到标签的地址，而这个地址要结合<code>ORG</code>指令计算得出，到helloos3时才加入<code>ORG</code>指令
参考FAT12启动区的定义，软盘的信息描述在0x62处截止，作者填充了18个字节的内容，然后在偏移量为0x50处写入代码</p>
<h3 id="参考">参考</h3>
<ul>
<li>FAT12文件系统之引导扇区结构：<br>
<a href="http://xitongbangshou.com/?p=41">http://xitongbangshou.com/?p=41</a></li>
</ul>

</main>



<div id="comments">
    <hr>
    <script src="https://utteranc.es/client.js" repo='KB5201314/KB5201314.github.io' issue-term="pathname" label='💬 comments 💬'
        theme='github-light' crossorigin="anonymous" async>
        </script>
</div>


  <footer>
  
  <hr/>
  © <a href="https://blog.imlk.top">imlk</a> 2017 &ndash; 2021 | imlk's blog | <a href="https://github.com/KB5201314/">Github</a> | <a href="mailto:me@imlk.top">Email</a> | <a href="http://www.miitbeian.gov.cn/">京ICP备 - 2020042968号</a>
  
  </footer>
  </body>
</html>
