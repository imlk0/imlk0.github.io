<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>åœ¨WireGuardåœºæ™¯ä¸­ä½¿ç”¨ç­–ç•¥è·¯ç”±å®šä¹‰å¤æ‚è·¯ç”±è§„åˆ™ | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>åœ¨WireGuardåœºæ™¯ä¸­ä½¿ç”¨ç­–ç•¥è·¯ç”±å®šä¹‰å¤æ‚è·¯ç”±è§„åˆ™</span></h1><span><span class=date>ğŸ“… 2022-11-29</span>
/
<span class=cats>ğŸ“š
<a href=https://blog.imlk.top/categories/network/>Network</a></span>
/
<span class=tags>ğŸ·ï¸
<a href=https://blog.imlk.top/tags/wireguard/>#wireguard</a>
<a href=https://blog.imlk.top/tags/ip-rule/>#ip-rule</a></span></span><br></div><main><p>ä»Šæ—¥åœ¨é…ç½®ç½‘ç»œæ—¶ï¼Œé‡åˆ°ä¸€ä¸ªéœ€æ±‚ï¼š</p><p>ä¸»æœºä¸Šæœ‰ä¸€ä¸ªæ— çº¿ç½‘å¡<code>wlp44s0</code>è¿æ¥åˆ°è·¯ç”±å™¨ï¼Œä½œä¸ºé»˜è®¤è·¯ç”±ï¼Œè¿˜æœ‰dockerå’Œtailscaleåˆ›å»ºçš„ä¸€äº›æ‚ä¸ƒæ‚å…«çš„æ¥å£ã€‚ç°åœ¨çš„æƒ³æ³•æ˜¯ï¼Œè¦æ–°å¢ä¸€ä¸ªwireguardéš§é“<code>wg0</code>è¿åˆ°å†…ç½‘çš„å¦ä¸€å°æœºå™¨ä¸Šï¼Œè®©æ‰€æœ‰çš„é€šå‘å¤–ç½‘çš„TCPæµé‡ç»è¿‡<code>wg0</code>è½¬å‘ï¼Œå…¶å®ƒä¸å—å½±å“ã€‚</p><p>WGçš„éƒ¨åˆ†å·²ç»é…å¥½ï¼Œä¸”ä½¿ç”¨<code>Table = off</code>å±æ€§å…³é—­äº†wireguardè‡ªåŠ¨ç”Ÿæˆçš„è·¯ç”±è§„åˆ™ã€‚æ¥ä¸‹æ¥éœ€è¦è§£å†³æˆ‘ä»¬è‡ªå®šä¹‰è·¯ç”±è§„åˆ™çš„éœ€æ±‚ã€‚</p><h1 id=iptables-fwmark--snat--ip-rule--ip-route>iptables fwmark + SNAT + ip rule + ip-route</h1><p>ç”±äºæ¶‰åŠåˆ°å¯¹TCPè¿æ¥çš„åˆ¤æ–­ï¼Œä¸€å¼€å§‹çš„æƒ³æ³•ï¼Œè‡ªç„¶æ˜¯å¾€iptablesä¸Šé ã€‚è€Œå¤–ç½‘çš„è¯ï¼Œå°½ç®¡æœ‰äº›è¹©è„šï¼Œä¹Ÿå‹‰å¼ºå®šä¹‰ä¸ºä»<code>0.0.0.0/0</code>ä¸­å»é™¤æ‰<code>192.168.0.0/16</code>,<code>172.16.0.0/12</code>,<code>10.0.0.0/8</code>,<code>127.0.0.1/32</code>,<code>255.255.255.255/32</code>è¿™äº›å­ç½‘è¿™æ ·çš„èŒƒç•´ï¼Œäºæ˜¯æœ‰äº†ä¸‹é¢è¿™æ ·çš„æ–¹æ¡ˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Mask packets need to be send via wg0</span>
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -d 255.255.255.255/32 -j RETURN
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -d 127.0.0.1/32 -j RETURN
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -d 192.168.0.0/16 -j RETURN
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -d 172.16.0.0/12 -j RETURN
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -d 10.0.0.0/8 -j RETURN
</span></span><span style=display:flex><span>sudo iptables -t mangle -A wg_wg0 -p tcp -j MARK --set-mark <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo iptables -t mangle -A OUTPUT -j wg_wg0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Re-write source ip</span>
</span></span><span style=display:flex><span>sudo iptables -A POSTROUTING -t nat -m mark --mark <span style=color:#ae81ff>10086</span> -j SNAT --to-source 10.253.0.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set route for those packets</span>
</span></span><span style=display:flex><span>sudo ip route add default dev wg0 src 10.253.0.2 table <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo ip rule add fwmark <span style=color:#ae81ff>10086</span> table <span style=color:#ae81ff>10086</span>
</span></span></code></pre></div><blockquote><p>å‚è€ƒäº†StackExchangeä¸Šçš„<a href=https://unix.stackexchange.com/questions/21093/output-traffic-on-different-interfaces-based-on-destination-port>è¿™ä¸ª</a>è®¨è®º</p></blockquote><p>å¯ä»¥ç†è§£ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>ä½¿ç”¨iptablesåœ¨mangleè¡¨çš„OUTPUTé“¾ä¸Šï¼Œå°†tcpé“¾æ¥é™„ä¸Šæ ‡è®°ä¸º<code>10086</code></li><li>ä½¿ç”¨ç­–ç•¥è·¯ç”±ip ruleæ–¹å¼åŒ¹é…è¿™äº›æµé‡ï¼Œä½¿å…¶ç”¨ä¸€å¼ æ–°çš„è·¯ç”±è¡¨ï¼ˆtable 10086ï¼‰æ¥è·¯ç”±å†³ç­–ï¼Œä½¿å…¶å‘é€åˆ°wg0è®¾å¤‡</li><li>ä½¿ç”¨SNATæ¥æ”¹å˜æ•°æ®åŒ…æºåœ°å€</li></ul><p>å¯èƒ½æ˜¯å—åˆ°äº†tailscaledçš„å½±å“ï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸Šä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œåªèƒ½ç”¨ä¸€ä¼šï¼Œä¹‹åæ‰€æœ‰çš„è¿æ¥éƒ½ä¼šå‡ºé—®é¢˜ï¼Œåˆæˆ–è€…æ˜¯httpä»¥åŠsshè¿æ¥æ­£å¸¸è€Œhttpsé“¾æ¥ä¸æ­£å¸¸ï¼Œæ¯”è¾ƒè¯¡å¼‚ã€‚ä»tcpdumpä¸­çœ‹ï¼Œæºipä¹Ÿç¬¦åˆ<code>wg0</code>æ¥å£çš„ipã€‚é‰´äºæ²¡æœ‰è°ƒè¯•å‡ºåŸå› ï¼Œä¸”å…¶SNATçš„æ–¹å¼ä¸å¤ªä¼˜é›…ï¼Œè¿™ç§æ–¹æ¡ˆåªèƒ½æ”¾å¼ƒã€‚</p><h1 id=ip-rule--ip-route>ip rule + ip-route</h1><p>æœ€ç»ˆåœ¨æµè§ˆip ruleå’Œip routeæ‰‹å†Œæ—¶ï¼Œå‘ç°äº†ä¸€ç§ä¸éœ€è¦iptablesçš„ï¼Œæ¯”è¾ƒä¼˜é›…çš„æ–¹æ¡ˆã€‚
è®©æˆ‘ä»¬çœ‹çœ‹ip ruleçš„å‚æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Usage: ip rule { add | del } SELECTOR ACTION
</span></span><span style=display:flex><span>       ip rule { flush | save | restore }
</span></span><span style=display:flex><span>       ip rule [ list [ SELECTOR ]]
</span></span><span style=display:flex><span>SELECTOR := [ not ] [ from PREFIX ] [ to PREFIX ] [ tos TOS ]
</span></span><span style=display:flex><span>            [ fwmark FWMARK[/MASK] ]
</span></span><span style=display:flex><span>            [ iif STRING ] [ oif STRING ] [ pref NUMBER ] [ l3mdev ]
</span></span><span style=display:flex><span>            [ uidrange NUMBER-NUMBER ]
</span></span><span style=display:flex><span>            [ ipproto PROTOCOL ]
</span></span><span style=display:flex><span>            [ sport [ NUMBER | NUMBER-NUMBER ]
</span></span><span style=display:flex><span>            [ dport [ NUMBER | NUMBER-NUMBER ] ]
</span></span><span style=display:flex><span>ACTION := [ table TABLE_ID ]
</span></span><span style=display:flex><span>          [ protocol PROTO ]
</span></span><span style=display:flex><span>          [ nat ADDRESS ]
</span></span><span style=display:flex><span>          [ realms [SRCREALM/]DSTREALM ]
</span></span><span style=display:flex><span>          [ goto NUMBER ]
</span></span><span style=display:flex><span>          SUPPRESSOR
</span></span><span style=display:flex><span>SUPPRESSOR := [ suppress_prefixlength NUMBER ]
</span></span><span style=display:flex><span>              [ suppress_ifgroup DEVGROUP ]
</span></span><span style=display:flex><span>TABLE_ID := [ local | main | default | NUMBER ]
</span></span></code></pre></div><p>é¦–å…ˆï¼Œip ruleæœ¬èº«çš„åŒ¹é…è§„åˆ™ä¸­ï¼Œæ”¯æŒåŸºäº<code>ipproto</code>æ¥åŒ¹é…ï¼Œè¿™æ ·æˆ‘å¯ä»¥ç”¨<code>ipproto tcp</code>æ¥åŒ¹é…tcpåŒ…ã€‚</p><p>æ¥ä¸‹æ¥è¦è§£å†³åŒ¹é…ç›®æ ‡ipèŒƒå›´çš„åŒ¹é…é—®é¢˜ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹è¿™äº›å€™é€‰é¡¹ï¼š</p><ul><li><p><code>oif STRING</code>ï¼šè¿™é‡Œé¢æœ‰ä¸€ä¸ª<code>oif</code>é€‰é¡¹ä¼¼ä¹å¯ä»¥æ ¹æ®æ•°æ®åŒ…çš„å‡ºç«™interfaceæ¥åŒ¹é…ï¼Œä¹ä¸€çœ¼çœ‹ï¼Œæˆ‘åªéœ€è¦ç”¨<code>oif wlp44s0</code>åŒ¹é…æˆ‘çš„æ— çº¿ç½‘å¡ï¼Œç”šè‡³ä¸éœ€è¦å»ä»¥è¹©è„šçš„æ–¹å¼å»åŒ¹é…ç›®æ ‡ipèŒƒå›´ã€‚ä½†æ–‡æ¡£é‡Œè¯´<code>oif</code>åªæœ‰åœ¨ç¨‹åºåˆ›å»ºsocketæ—¶ç»‘å®šåˆ°äº†æŸä¸ªè®¾å¤‡ä¸Šæ—¶æ‰èƒ½èµ·ä½œç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹ä¸ç®¡ç”¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>            oif NAME
</span></span><span style=display:flex><span>                  select the outgoing device to match. The outgoing
</span></span><span style=display:flex><span>                  interface is only available for packets originating
</span></span><span style=display:flex><span>                  from local sockets that are bound to a device.
</span></span></code></pre></div></li><li><p><code>to PREFIX</code>ï¼šæ–¹å¼ä¹Ÿä¸å¤ªä¼˜é›…ï¼Œip ruleçš„<code>not</code>è¡¨è¾¾å¼åªèƒ½åœ¨å¯¹æ•´æ¡è§„åˆ™èµ·ä½œç”¨ã€‚æˆ‘ä»¬æ— æ³•åšåˆ° <code>ipproto tcp not to 192.168.0.0/16 not to 172.16.0.0/12 not to 10.0.0.0/8</code>è¿™æ ·çš„åŒ¹é…ã€‚</p></li><li><p><code>table main</code>ï¼šä½¿ç”¨<code>not tcp table main</code>ç›´æ¥è·³åˆ°<code>main</code>è¡¨ä¹Ÿæ˜¯ä¸€ç§é€‰æ‹©ã€‚ä½†è¿™ç§æ–¹å¼ä¸é€‚åˆæˆ‘çš„æƒ…å†µï¼Œå› ä¸ºtailscaleä¹Ÿåˆ›å»ºäº†ä¸€äº›ruleï¼Œè¿™ä¹ˆåšè¦ä¹ˆä¼šæŠŠtailscaleçš„è§„åˆ™å¿½ç•¥ï¼Œè¦ä¹ˆä¼šä¸tailscaleäº§ç”Ÿå…³è”ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>0:      from all lookup local
</span></span><span style=display:flex><span>5210:   from all fwmark 0x80000/0xff0000 lookup main
</span></span><span style=display:flex><span>5230:   from all fwmark 0x80000/0xff0000 lookup default
</span></span><span style=display:flex><span>5250:   from all fwmark 0x80000/0xff0000 unreachable
</span></span><span style=display:flex><span>5270:   from all lookup 52
</span></span><span style=display:flex><span>32766:  from all lookup main
</span></span><span style=display:flex><span>32767:  from all lookup default
</span></span></code></pre></div></li></ul><p>æœ€åé€‰æ‹©äº†ip routeçš„<code>throw</code>è·¯ç”±æ–¹æ¡ˆï¼Œå®ƒæœ‰ç‚¹åƒiptablesé‡Œçš„<code>RETURN</code>åŠ¨ä½œã€‚å¦‚æœè¢«è·¯ç”±è¡¨é‡Œçš„<code>throw</code>ç±»å‹çš„è·¯ç”±åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆå°†é€€å‡ºè¯¥è·¯ç”±è¡¨çš„æœç´¢å¹¶å‡è£…å‘ç”Ÿäº†è·¯ç”±ç¼ºå¤±ï¼Œä»è€Œfallbackåˆ°ip ruleé‡Œçš„å…¶ä»–ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥å°±éå¸¸é€‚åˆæˆ‘çš„åœºæ™¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>              throw - a special control route used together with policy
</span></span><span style=display:flex><span>              rules. If such a route is selected, lookup in this table
</span></span><span style=display:flex><span>              is terminated pretending that no route was found. Without
</span></span><span style=display:flex><span>              policy routing it is equivalent to the absence of the
</span></span><span style=display:flex><span>              route in the routing table. The packets are dropped and
</span></span><span style=display:flex><span>              the ICMP message net unreachable is generated. The local
</span></span><span style=display:flex><span>              senders get an ENETUNREACH error.
</span></span></code></pre></div><p>æ‰€ä»¥æœ€ç»ˆçš„è„šæœ¬å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ip route add default dev wg0 src 10.253.0.2 table <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo ip route add throw 192.168.0.0/16 table <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo ip route add throw 172.16.0.0/12 table <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo ip route add throw 10.0.0.0/8 table <span style=color:#ae81ff>10086</span>
</span></span><span style=display:flex><span>sudo ip rule add ipproto tcp table <span style=color:#ae81ff>10086</span>
</span></span></code></pre></div><h1 id=æ€»ç»“>æ€»ç»“</h1><p>ä¹‹å‰é…ç½‘çš„æ—¶å€™æ¥è§¦<code>ip rule</code>æ€»æœ‰è¿™ç§æ„Ÿè§‰ï¼Œ<code>ip rule</code>æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä½†æ˜¯å®ƒçš„è§„åˆ™åŒ¹é…ä¼¼ä¹å¾ˆå¼±ï¼Œæ€»ä¼šæƒ³ç”¨iptables set-maskçš„æ–¹å¼æ¥å®ç°å¤æ‚çš„è§„åˆ™ï¼Œä½†æ˜¯iptableså†™èµ·æ¥å°±æ€»æ˜¯å¾ˆéº»çƒ¦ã€‚ç°åœ¨çœ‹æ¥ï¼Œ<code>ip rule</code>å’Œ<code>ip route</code>ç»„åˆèµ·æ¥è¿˜æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œèƒ½å¤Ÿå®ç°å¾ˆå¤šçš„éœ€æ±‚ã€‚</p></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer><hr>Â© imlk 2017 &ndash; 2021 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡ - 2020042968å·</a></footer></body></html>