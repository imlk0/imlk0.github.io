<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用SPF来保护你的域名邮箱 | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>使用SPF来保护你的域名邮箱</span></h1><span><span class=date>📅 2022-01-18</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/security/>Security</a></span>
/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/spf/>#SPF</a>
<a href=https://blog.imlk.top/tags/dns/>#DNS</a>
<a href=https://blog.imlk.top/tags/mail/>#Mail</a></span></span><br></div><main class=post-content><p>今天翻看邮箱，偶然看到之前课程助教让我们做作业时使用S/MIME签名和加密的邮件，然后想起邮件系统的设计似乎可以轻松伪造Sender这一问题，结果就看到一个叫SPF的东西，遂把它配置到自己的域名邮箱上，记录一下。</p><h2 id=何为spf>何为SPF</h2><blockquote><p>发件人策略框架（英语：Sender Policy Framework；简称SPF； RFC 4408）是一套电子邮件认证机制，可以确认电子邮件确实是由网域授权的邮件服务器寄出，防止有人伪冒身份网络钓鱼或寄出垃圾电邮。SPF允许管理员设定一个DNS TXT记录或SPF记录设定发送邮件服务器的IP范围，如有任何邮件并非从上述指明授权的IP地址寄出，则很可能该邮件并非确实由真正的寄件者寄出（邮件上声称的“寄件者”为假冒）</p><p><em>From：<a href=https://zh.wikipedia.org/wiki/%E5%8F%91%E4%BB%B6%E4%BA%BA%E7%AD%96%E7%95%A5%E6%A1%86%E6%9E%B6>Wikipedia-发件人策略框架</a></em></p></blockquote><p>简单来说，就是发送方可以在自己域名的TXT字段上配置一些允许的ip地址范围，只有在这些ip地址发出的邮件才被认为是真实的。如果其它ip的主机以这个域名下的邮箱身份发出邮件，接收者可以认为邮件是假冒的。</p><p>（算是又一个基于DNS来保证安全的例子了）</p><p>拿我们常用的gmail为例，查询<code>google.com</code>的TXT记录，其中一个结果就是SPF配置：</p><pre tabindex=0><code>google.com.             19      IN      TXT     &#34;v=spf1 include:_spf.google.com ~all&#34;
</code></pre><p>qq邮箱和163邮箱也是类似：</p><pre tabindex=0><code>qq.com.                 97      IN      TXT     &#34;v=spf1 include:spf.mail.qq.com -all&#34;
</code></pre><pre tabindex=0><code>163.com.                10295   IN      TXT     &#34;v=spf1 include:spf.163.com -all&#34;
</code></pre><p>这三个邮箱都没有直接列出允许的ip范围，而是使用了<code>include:&lt;domain></code>的形式来表示引入<code>&lt;domain></code>这个域名下的SPF记录（用法有点像CNAME那样）。</p><p>关于spf的更多语法，建议阅读<a href=https://www.renfei.org/blog/introduction-to-spf.html>这篇文章</a>。</p><h2 id=如何配置>如何配置</h2><p>本人的域名邮箱接的是腾讯企业邮，<a href="https://service.exmail.qq.com/cgi-bin/help?subtype=1&amp;id=20012&amp;no=1000580">其网站</a>上其实有介绍该怎么配置。</p><p>具体来说，只要为你邮箱中的域名加上下面这样一条TXT记录就行了：</p><pre tabindex=0><code>v=spf1 include:spf.mail.qq.com ~all
</code></pre><p>最后效果是：</p><pre tabindex=0><code>imlk.top.               300     IN      TXT     &#34;v=spf1 include:spf.mail.qq.com ~all&#34;
</code></pre><p>对于自建邮箱服务器的情况，按规则自己写一条包含ip的spf就行了。</p><h2 id=补充>补充</h2><h3 id=dkim>DKIM</h3><p>DKIM是一种防止邮件内容被恶意篡改的方法，发件服务器使用私钥为邮件进行签名，而接收方通过dns查询到发件方域名对应的公钥信息，验证签名的完整性。</p><p>可惜的是<strong>腾讯企业邮箱似乎无法开启DKIM</strong>，默认发出去的邮件中也未找到<code>DKIM-Signature</code>字段。</p><p><img src=/images/image-20220118152416029.png alt=image-20220118152416029></p><h3 id=dmarc>DMARC</h3><p>如果说SPF和DKIM定义了如何防止被别人假冒身份发送邮件，那么DMARC则定义了接收者收到假冒邮件后应该怎么处理。</p><p>给域名下的<code>_dmarc</code>子域加一条TXT记录<code>v=DMARC1; p=none; rua=mailto:mailauth-reports@qq.com</code>，具体细节可以直接<a href="https://service.exmail.qq.com/cgi-bin/help?subtype=1&amp;no=1001520&amp;id=16">参考</a>腾讯企业邮箱。</p><h2 id=测试spf>测试SPF</h2><p><a href=https://www.appmaildev.com/cn/spf>这个网站</a>可以直接测试SPF：</p><p>具体来说，它会随机生成一个邮箱，然后让你用配置好spf的邮箱给它发邮件，然后会出一份报告。</p><p><img src=/images/image-20220118133534557.png alt=image-20220118133534557></p><p>看起来配置没有问题。</p><p>接着我们使用<a href=https://www.jetmore.org/john/code/swaks/>swaks</a>从本机直接发送一封伪装身份的邮件：</p><pre tabindex=0><code>swaks --to test-e16ba1a8@appmaildev.com --from me@imlk.top --body &#39;This is a spoof email&#39; --header &#39;Subject: Spoof Email&#39; --ehlo imlk.top --header-X-Mailer imlk.top
</code></pre><p>结果SPF检测报告SoftFail</p><p><img src=/images/image-20220118153014062.png alt=image-20220118153014062></p><p>并且DMARC也报告了fail</p><p><img src=/images/image-20220118153031854.png alt=image-20220118153031854></p><p>如果向Gmail发送伪装身份的文件，则会报告错误：</p><p><img src=/images/image-20220118153207011.png alt=image-20220118153207011></p><h2 id=参考>参考</h2><ul><li><p><a href=https://www.appmaildev.com/cn/spf>SPF 测试工具</a></p></li><li><p><a href=https://saucer-man.com/information_security/452.html>邮件伪造原理和实践 - SAUCERMAN</a></p></li><li><p><a href="https://service.exmail.qq.com/cgi-bin/help?subtype=1&&amp;no=1001520&&amp;id=16">腾讯企业邮箱 - 帮助中心 - 设置企业邮箱的DMARC</a></p></li><li><p><a href="https://service.exmail.qq.com/cgi-bin/help?subtype=1&&amp;no=1000580&&amp;id=20012">腾讯企业邮箱 - 帮助中心 - 设置企业邮箱的SPF</a></p></li></ul></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备 - 2020042968号</a></footer></body></html>