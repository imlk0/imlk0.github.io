<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>[RECON Montreal 2019] The Road to Qualcomm TrustZone Apps Fuzzing æ–‡ç« é˜…è¯» | imlk's blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>[RECON Montreal 2019] The Road to Qualcomm TrustZone Apps Fuzzing æ–‡ç« é˜…è¯»</span></h1><span><span class=date>ğŸ“… 2021-10-29</span>
<span class=date>(æ›´æ–°äº2023-08-30)</span>
/
<span class=cats>ğŸ“š
<a href=https://blog.imlk.top/categories/tee/>TEE</a></span>
/
<span class=tags>ğŸ·ï¸
<a href=https://blog.imlk.top/tags/trustzone/>#TrustZone</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a>
<a href=https://blog.imlk.top/tags/fuzzing/>#Fuzzing</a>
<a href=https://blog.imlk.top/tags/reading/>#Reading</a></span></span><br></div><main class=post-content><ul><li><p><a href=https://research.checkpoint.com/2019/the-road-to-qualcomm-trustzone-apps-fuzzing/>https://research.checkpoint.com/2019/the-road-to-qualcomm-trustzone-apps-fuzzing/</a></p></li><li><p><a href=https://cfp.recon.cx/media/tz_apps_fuzz.pdf>https://cfp.recon.cx/media/tz_apps_fuzz.pdf</a></p><p><a href=%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/tz_apps_fuzz.pdf>tz_apps_fuzz.pdf</a></p></li></ul><h1 id=abstract>Abstract</h1><p>ä½œè€…çš„ç›®æ ‡æ˜¯å¯¹trustletçš„command handlerå‡½æ•°è¿›è¡ŒAFLæµ‹è¯•ã€‚</p><p>ä½œè€…è®¾è®¡äº†ä¸€ä¸ªloaderç¨‹åºï¼Œå¯ä»¥åœ¨Androidè®¾å¤‡çš„normal worldåŠ è½½å¹¶è¿è¡Œtrustletã€‚ä¸ºäº†è§£å†³syscallçš„å¤„ç†é—®é¢˜ï¼Œä½œè€…å‘QSEOSä¸­åŠ è½½ä¿®è¡¥è¿‡çš„trustletå‰¯æœ¬ä½œä¸ºproxy trustletã€‚ä¸ºäº†èƒ½å¤ŸåŠ è½½è¢«ä¿®è¡¥è¿‡çš„ä»£ç ï¼Œä½œè€…åˆ©ç”¨äº†ä¸¤ä¸ª1dayæ¼æ´æ¥ç»•è¿‡QSEOSå¯¹trustletçš„çš„æ ¡éªŒæµç¨‹ã€‚æœ€ç»ˆä½¿ç”¨AFLæµ‹è¯•å·¥å…·å®Œæˆäº†æµ‹è¯•ã€‚</p><h1 id=backguard>Backguard</h1><ul><li><p>secapp rangeï¼šcmblibåº“å’Œæ‰€æœ‰çš„trustletéƒ½è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­çš„ä¸€ä¸ªåä¸ºsecure app regionçš„åŒºåŸŸå†…ã€‚è¯¥åŒºåŸŸçš„åœ°å€å¯ä»¥ä»Android dmesgæ—¥å¿—ä¸­æ‰¾åˆ°</p><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled.png alt=Untitled></p></li><li><p>trustletçš„å†…å­˜ç©ºé—´æ— æ³•è¢«åˆ«çš„trustletè®¿é—®</p></li><li><p>trustletçš„å†…å­˜åˆ†é…è¯·æ±‚å°†è¢«åœ¨è¿™ä¸ªtrustletè‡ªèº«çš„æ•°æ®æ®µä¸­è¿›è¡Œ</p></li><li><p>trustletçš„æ ˆåŒºåŸŸæ˜¯trustletçš„æ•°æ®æ®µåŒºåŸŸ(data segment region)çš„ä¸€éƒ¨åˆ†</p></li><li><p><code>R9</code>å¯„å­˜å™¨å§‹ç»ˆæŒ‡å‘è¯¥trustletçš„æ•°æ®æ®µçš„åˆå§‹åœ°å€</p></li><li><p>trustletçš„command handlerå‡½æ•°ç­¾åï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>cmd_handler</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> <span style=color:#f92672>*</span>in, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> in_size, 
</span></span><span style=display:flex><span>														<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> <span style=color:#f92672>*</span>out, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> out_size)
</span></span></code></pre></div><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled%201.png alt="ä¸€ä¸ªcommand handlerå‡½æ•°çš„ä¾‹å­"></p><p>ä¸€ä¸ªcommand handlerå‡½æ•°çš„ä¾‹å­</p></li></ul><h1 id=åœ¨æ™®é€šä¸–ç•Œä¸­è¿è¡Œta>åœ¨æ™®é€šä¸–ç•Œä¸­è¿è¡ŒTA</h1><h2 id=åŸºæœ¬æ€è·¯>åŸºæœ¬æ€è·¯</h2><p>åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨normal worldç”¨æˆ·æ€çš„ç¨‹åºï¼ˆ<strong>trustlet loader</strong>ï¼‰ï¼Œå®ƒï¼š</p><ul><li>åˆ†é…ä¸€æ®µrwxæƒé™çš„å†…å­˜åŒºåŸŸå­˜å‚¨trustletçš„ä»£ç æ®µå’Œæ•°æ®æ®µã€‚è¿™äº›å†…å­˜å—çš„è™šæ‹Ÿåœ°å€å¿…é¡»ä¸ä¹‹å‰è§‚å¯Ÿåˆ°çš„secappåŒºåŸŸçš„æ®µåœ°å€ç›¸åŒ</li><li>å°†dumpå‡ºæ¥çš„æ®µçš„å†…å®¹åŠ è½½åˆ°åˆ†é…å‡ºçš„å†…å­˜ä¸­ã€‚</li><li>å‡†å¤‡å¥½ç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨trustletçš„command handlerçš„è¾“å…¥å’Œè¾“å‡º</li><li>å°†R9å¯„å­˜å™¨æŒ‡å‘æ•°æ®æ®µçš„åœ°å€ï¼Œå¹¶è°ƒç”¨trustletçš„command handlerå‡½æ•°</li></ul><h2 id=å¤±è´¥åŸå› >å¤±è´¥åŸå› ï¼š</h2><ul><li><strong>ä¾èµ–äºcmnlib</strong>ï¼šcommand handleråœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†æ¥è‡ªcmnlibçš„åº“å‡½æ•°ã€‚</li><li><strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼šcommand handlerä½¿ç”¨<code>SVC</code>æŒ‡ä»¤è°ƒç”¨äº†QSEOSç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯Linux Kernelå¹¶ä¸èƒ½å¤„ç†è¿™ç§ç³»ç»Ÿè°ƒç”¨</li></ul><h2 id=å¾…è§£å†³é—®é¢˜>å¾…è§£å†³é—®é¢˜ï¼š</h2><ol><li>å¦‚ä½•è·å–å®‰å…¨ä¸–ç•Œä¸­ï¼Œtrustletå’Œcmnlibçš„åŸºåœ°å€</li><li>å¦‚ä½•dump trustletå’Œcmnlibçš„æ•°æ®æ®µ</li><li>å¦‚ä½•èƒ½åœ¨normal worldæ‰§è¡Œtrustletä¸­çš„syscall</li></ol><h2 id=è§£å†³æ–¹æ¡ˆ>è§£å†³æ–¹æ¡ˆ</h2><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled%202.png alt=Untitled></p><h3 id=ä¿®è¡¥åŠ è½½åˆ°å®‰å…¨ä¸–ç•Œä¸­çš„trustlet>ä¿®è¡¥åŠ è½½åˆ°å®‰å…¨ä¸–ç•Œä¸­çš„trustlet</h3><p>é€šè¿‡å­—èŠ‚ç ä¿®è¡¥åˆ›å»ºä¸€ä¸ªproxy trustletã€‚æ‰©å±•ç°æœ‰trustletçš„command handlerå‡½æ•°ï¼Œå¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„command IDï¼Œä¾‹å¦‚0x99ï¼Œè¿™ä¸ªcommand IDæ‰€æä¾›çš„æœåŠ¡æ˜¯ï¼š</p><ol><li>è¿”å›trustletçš„åŸºåœ°å€</li><li>ä»secappåŒºåŸŸä¸­è¯»å–å†…å­˜</li><li>å‘secappåŒºåŸŸä¸­å†™å…¥å†…å­˜</li><li>æ‰§è¡Œä¸€ä¸ªè¯·æ±‚æŒ‡å®šçš„çš„syscall</li></ol><p>å‰ä¸‰ä¸ªè‡ªå®šä¹‰åŠŸèƒ½ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è·å¾—cmnlibçš„æ•°æ®æ®µåœ°å€ï¼ˆä¾‹å¦‚å¯¹äºprovè¿™ä¸ªtrustletï¼Œcmnlibçš„æ•°æ®æ®µåœ°å€è¢«å­˜å‚¨åœ¨0x83D4åç§»å¤„ï¼Œè¿™ç§æ–¹æ³•æ˜¯é€šç”¨çš„ã€æ¯ä¸ªtrustletéƒ½å¯ä»¥è®¿é—®cmblibçš„å†…å­˜ï¼‰ã€‚</p><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled%203.png alt="æ–°çš„command IDçš„å¤„ç†ä»£ç ï¼Œæä¾›äº†ä¸Šé¢æåˆ°çš„é‚£äº›åŠŸèƒ½"></p><p>æ–°çš„command IDçš„å¤„ç†ä»£ç ï¼Œæä¾›äº†ä¸Šé¢æåˆ°çš„é‚£äº›åŠŸèƒ½</p><h3 id=é‡å®šå‘syscall>é‡å®šå‘syscall</h3><p>ä¿®æ”¹qemuï¼Œä½¿å…¶èƒ½å¤Ÿç‰¹æ®Šå¤„ç†<code>SVC 0x1400</code>å’Œ<code>SVC 0x14F9</code>ï¼Œå°†normal worldå‘æ¥çš„syscallè½¬å‘åˆ°proxy trustleté‡Œã€‚</p><h3 id=æ ˆåœ°å€ä¸ä¸€è‡´é—®é¢˜>æ ˆåœ°å€ä¸ä¸€è‡´é—®é¢˜</h3><p>åœ¨è®¾è®¡ä¹‹åˆï¼Œnormal worldçš„trustletå’Œsecure worldçš„proxy trustletå…·æœ‰ä¸åŒçš„æ ˆåœ°å€ï¼Œæœ¬è´¨æ˜¯loaderå¹¶æ²¡æœ‰ä¸ºè°ƒç”¨cmd_handler()è®¾ç½®ç‹¬ç«‹çš„æ ˆåœ°å€ã€‚è¿™å¯¹äºç¨‹åºçš„è¿è¡Œæ²¡æœ‰å½±å“ï¼Œä½†æ˜¯ç”±äºsyscallçš„å‚æ•°å¯èƒ½åŒ…å«æŒ‡å‘ç”¨æˆ·ç©ºé—´æ ˆä¸Šå†…å®¹çš„æŒ‡é’ˆã€‚ä¸ºäº†ç¡®ä¿QSEOSåœ¨å¤„ç†syscallæ—¶èƒ½å¤Ÿè®¿é—®åˆ°æ­£ç¡®çš„æ•°æ®ï¼Œå¿…é¡»åœ¨secappåœ°å€èŒƒå›´å†…ä¸ºcmd_handler()åˆå§‹åŒ–ä¸€ä¸ªæ ˆï¼Œå®ƒä»¬éƒ½èƒ½è®¿é—®åˆ°çš„åœ°å€èŒƒå›´ã€‚è§£å†³åŠæ³•æ˜¯ç”±loaderæ‰©å±•trustletçš„æ•°æ®æ®µï¼ˆdata segmentï¼‰ï¼Œåœ¨è·³è½¬åˆ°command handlerä¹‹å‰ï¼Œå…ˆå°†loaderçš„SPå¯„å­˜å™¨æŒ‡å‘æ•°æ®æ®µçš„æœ«å°¾ã€‚</p><h3 id=å¯¹provè¿™ä¸ªtrustletå…·ä½“çš„ä¿®è¡¥>å¯¹<em>provè¿™ä¸ªtrustlet</em>å…·ä½“çš„ä¿®è¡¥</h3><ul><li><p>å¢åŠ ä»£ç </p><ol><li><p>å°†ä»£ç æ®µçš„é•¿åº¦ä»0x6ED0æ‰©å±•åˆ°0x7000</p></li><li><p>å°†0x99è¿™ä¸ªcommand IDçš„å¤„ç†ä»£ç æœºå™¨æŒ‡ä»¤å†™å…¥åˆ°0x6ED0</p></li><li><p>å°†0x2060å¤„çš„4ä¸ªå­—èŠ‚æ›¿æ¢æˆ<code>BL 0x6ED0</code>ï¼Œå³è·³åˆ°æ–°åŠ å…¥çš„command IDçš„å¤„ç†ä»£ç å¤„</p><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled%204.png alt="è·³è½¬åˆ°command handlerçš„ä»£ç "></p><p>è·³è½¬åˆ°command handlerçš„ä»£ç </p></li></ol></li><li><p>ä¸ºæ ˆè…¾å‡ºç©ºé—´</p><ol><li>å°†æ•°æ®æ®µçš„é•¿åº¦ä»0x103F0æ‰©å±•åˆ°0x11000ï¼ˆå¤šå‡ºçš„éƒ¨åˆ†ä½œä¸ºæ ˆï¼‰</li></ol></li></ul><h2 id=å¦‚ä½•åŠ è½½è¿è¡Œä¿®è¡¥åçš„proxy-trustlet>å¦‚ä½•åŠ è½½è¿è¡Œä¿®è¡¥åçš„proxy trustletï¼Ÿ</h2><h3 id=ä»å¯åŠ¨æµç¨‹æ¥çœ‹>ä»å¯åŠ¨æµç¨‹æ¥çœ‹</h3><p><code>Primary Bootloader(PBL, in ROM)</code> â†’<code>Secondary BootLoader(SBL)</code>â†’<code>Little Kernel applications bootloader && QSEOS</code>-><code>trustlets</code></p><p>å³ä½¿unlock bootloaderæˆ–è€…å–å¾—rootæƒé™ä¹Ÿæ— æ³•æ‰“ç ´è¯¥æµç¨‹ã€‚</p><h3 id=ä½¿ç”¨æ¼æ´>ä½¿ç”¨æ¼æ´</h3><p>ä½¿ç”¨ä¸¤ä¸ª1-dayæ¼æ´CVE-2015-6639ã€CVE-2016-2431ï¼Œä»è€Œä½œè€…å¾—ä»¥ä¿®æ”¹Nexus 6è®¾å¤‡ä¸Šçš„QSEOSçš„æ•°æ®æ®µã€‚ä½œè€…æ”»å‡»äº†QSEOSçš„éªŒè¯æœºåˆ¶ã€‚å…·ä½“æ¥è¯´ï¼š</p><ul><li>QSEOSå…ˆéªŒè¯TAæ–‡ä»¶ä¸­çš„ç­¾åæ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†è®¡ç®—å„ä¸ªæ®µçš„hashå€¼ä¸è®°å½•å€¼è¿›è¡Œæ¯”è¾ƒã€‚</li><li>ä½œè€…åˆ©ç”¨ä»£ç æ³¨å…¥çš„æ–¹å¼åœ¨ç­¾åéªŒè¯é€šè¿‡åï¼ŒéªŒè¯hashå€¼å‰ï¼Œæ”¹å†™è®°å½•çš„hashå€¼ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥ã€‚</li></ul><p><img src=/images/%5BRECON%20Montreal%202019%5D%20The%20Road%20to%20Qualcomm%20TrustZo%20ace3d28bcbd94d658c3afa71e63193f5/Untitled%205.png alt=Untitled></p><h1 id=fuzzing-of-trusted-app>Fuzzing of trusted app</h1><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä½œè€…åœ¨Androidä¸Šç»“åˆqemué€šè¿‡æ¨¡æ‹Ÿçš„æ–¹å¼è¿è¡Œäº†ä¸€ä¸ªtrustletçš„command handlerã€‚å¦å¤–å°†ä¸€ä¸ªè¢«ä¿®è¡¥è¿‡çš„trustletå‰¯æœ¬ä½œä¸ºproxy trustletåŠ è½½åˆ°çœŸå®çš„QSEOSä¸­ã€‚</p><p>ä½¿ç”¨AFLå·¥å…·æµ‹è¯•TAçš„command handlerï¼Œå¹¶åœ¨å®‰è£…æœ€æ–°romçš„Nexus 6è®¾å¤‡ä¸Šå‘ç°äº†provè¿™ä¸ªteustletçš„ä¸€ä¸ªæ¼æ´ã€‚</p><h1 id=æµ‹è¯•åˆ«çš„è®¾å¤‡ä¸Šçš„trustlet>æµ‹è¯•åˆ«çš„è®¾å¤‡ä¸Šçš„trustlet</h1><p>åœ¨Nexus6ä¸Šè¿è¡Œæ–°çš„è®¾å¤‡ä¸Šçš„trustletï¼Œæ‰€è¦ä»˜å‡ºçš„åŠªåŠ›ï¼Œæ¯”åœ¨æ–°è®¾å¤‡ä¸­åˆ©ç”¨ç±»ä¼¼çš„QSEOSæ¼æ´æ¥åˆ›å»ºè¿™æ ·çš„æµ‹è¯•ç¯å¢ƒè¦ç®€å•çš„å¤šã€‚</p><p>ä½œè€…æå‡ºäº†ä¸¤ç§æµ‹è¯•æ–¹æ³•ï¼š</p><ol><li>é‡ç”¨ä¹‹å‰çš„ç”±provè¿™ä¸ªtrustletä¿®è¡¥æˆçš„proxy trustletï¼Œä½œä¸ºæ–°çš„trustletåœ¨QSEOSä¸­çš„ä»£ç†</li><li>ä»¥æ¯ä¸ªæ–°çš„trustletä½œä¸ºåŸºç¡€è¿›è¡Œä¿®è¡¥äº§ç”Ÿproxy trustletï¼ŒåŠ è½½åˆ°QSEOSä¸­ä½œä¸ºä»£ç†</li></ol><p>ä½œè€…ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œé€šè¿‡æ”¹ç¼–LGå’Œä¸‰æ˜Ÿè®¾å¤‡ä¸­çš„trustletï¼Œç„¶åå°†å…¶åœ¨Nexus6ä¸Šéƒ¨ç½²ï¼Œæµ‹è¯•å‘ç°äº†é¢å¤–çš„å‡ ä¸ªæ¼æ´ï¼š</p><blockquote><p><em>dxhdcp2</em>Â (LVE-SMP-190005),Â <em>sec_store</em>Â (SVE-2019-13952),Â <em>authnr</em>Â (SVE-2019-13949) andÂ <em>esecomm</em>Â (SVE-2019-13950),Â <em>kmota</em>Â (CVE-2019-10574),Â <em>tzpr25</em>Â (acknowledged by Samsung),Â <em>prov</em>Â (Motorola is working on a fix).</p></blockquote></main><div id=comments><hr><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div><footer class=footer><hr>Â© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡2020042968å·-1</a></footer></body></html>