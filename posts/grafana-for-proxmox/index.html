<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Proxmox服务器的Grafana看板简易配置 | imlk's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>Proxmox服务器的Grafana看板简易配置</span></h1><span><span class=date>📅 2022-09-04</span>
<span class=date>(更新于2022-09-05)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/misc/>Misc</a>
</span>/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/proxmox/>#Proxmox</a>
<a href=https://blog.imlk.top/tags/grafana/>#Grafana</a>
<a href=https://blog.imlk.top/tags/influxdb/>#InfluxDB</a></span></span><br></div><main class=post-content><p>ITX拿来做PVE服务器已经用了好几个月的时间了，体验还是相当不错的，但是缺乏一个直观的性能看板。早听说PVE的Metric Server特性可以用来监视性能，恰逢最近有看到有人推Grafana，因此准备来体验一下。</p><h1 id=前奏>前奏</h1><p>首先参考一下PVE的官方<a href=https://pve.proxmox.com/wiki/External_Metric_Server#metric_server_influxdb>文档</a>关于Metric Server的描述。</p><p>别看这文档虽然短小，但也潜藏着不少坑。由于我们的实验是以InfluxDB V2版本进行。首先文档中的配置文件内容是针对InfluxDB V1的，在InfluxDB V2中不再适用。且文档建议使用UDP连接InfluxDB，但是InfluxDB V2中默认已经是http了。幸运的是这文档里对V2的配置提了一嘴。</p><h1 id=配置influxdb>配置InfluxDB</h1><p>那么我们创建一个lxc容器部署我们的InfluxDB服务和Grafana服务。</p><p>在lxc容器里装好influxdb和influx-cli并启动influxdb</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl enable --now influxdb
</span></span></code></pre></div><p>启动后默认监听http端口是<code>8086</code>，WebUI和API接口都在这个端口上访问</p><p>首次启动需要进行Setup，可以从WebUI上Setup，也可以在CLI工具上Setup。可以参考influxdb的<a href="https://docs.influxdata.com/influxdb/v2.4/install/?t=Linux#set-up-influxdb">文档</a></p><p>这里我们用CLI工具进行setup。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>influx setup
</span></span></code></pre></div><p>这是一个交互式的过程，我们设置一个名为<code>proxmox</code>的organization和一个名为<code>proxmox</code>的bucket/database。</p><h1 id=配置pve侧metric-server>配置PVE侧Metric Server</h1><p>在proxmox上配置(Datacenter -> Metric Server -> Add -> InfluxDB)：</p><p>要获得token，运行：</p><pre tabindex=0><code>influx config list --json
</code></pre><p><img src=/images/proxmox-influxdb-01.png alt></p><h1 id=配置grafana>配置Grafana</h1><p>安装并启动Grafana</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl enable --now grafana
</span></span></code></pre></div><p>访问WebUI，默认端口是3000</p><h2 id=添加influxdb作为数据源>添加InfluxDB作为数据源</h2><p>接下来连接InfluxDB，在WebUI上选择<code>Add data source</code>。</p><p>Query Language选择<code>Flux</code>，填写InfluxDB的URL。</p><p><img src=/images/proxmox-grafana-01.png alt></p><p>关掉Basic auth，剩余的Organization和Default Bucket填<code>proxmox</code>，Token填你的token</p><p><img src=/images/proxmox-grafana-02.png alt></p><h2 id=设置proxmox-dashboard>设置Proxmox Dashboard</h2><p>接着Import <a href=https://grafana.com/grafana/dashboards/15356-proxmox-flux/>这个</a>ID为<code>15356</code>的dashboard就可以了</p><p>记得顶上的Bucket选<code>proxmox</code>不然是No Data。</p><p><img src=/images/proxmox-grafana-03.png alt></p></main><div id=comments><hr><script src=//geoip-js.com/js/apis/geoip2/v2.1/geoip2.js type=text/javascript></script><script>var onSuccess=function(e){var t=e.country.names["zh-CN"],n=e.country.iso_code;if(!n)return;t&&(document.getElementById("comments-blocked-country-code").innerHTML=t),n=="CN"&&(document.getElementById("comments-shown").style.display="none",document.getElementById("comments-blocked").style.display="")},onError=function(){};geoip2.country(onSuccess,onError)</script><div id=comments-blocked style=font-style:italic;color:#777;display:none>评论区已关闭。<span style=float:right>来自 <span id=comments-blocked-country-code>unknown</span> 的访客
<span>&nbsp; - powered by: geoip-js.com</span></span></div><div id=comments-shown><script src=https://utteranc.es/client.js repo=imlk0/imlk0.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/imlk0/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>