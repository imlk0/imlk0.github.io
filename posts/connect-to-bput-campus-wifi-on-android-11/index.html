<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Android11的QPR1安全更新后无法连接北邮校园WiFi的解决方法 | imlk's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>Android11的QPR1安全更新后无法连接北邮校园WiFi的解决方法</span></h1><span><span class=date>📅 2021-03-17</span>
<span class=date>(更新于2021-10-10)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/wlan/>WLAN</a>
</span>/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/bupt/>#BUPT</a>
<a href=https://blog.imlk.top/tags/wpa2-enterprise/>#wpa2-enterprise</a>
<a href=https://blog.imlk.top/tags/%E7%9E%8E%E6%90%9E/>#瞎搞</a></span></span><br></div><main class=post-content><p>Android11在2020年12月发布的安全更新中进行了一个修复：<a href=https://www.xda-developers.com/android-11-break-enterprise-wifi-connection/>PSA: Android 11 will no longer let you insecurely connect to enterprise WiFi networks</a></p><p>这项变更直接导致的是连接安全性为<code>wpa2-enterprise</code>的WiFi时，去掉了<code>不验证(Do Not Validate) CA证书</code>的选项：<img src=/images/blog/70/image-20210317140152847-1615965848255.png alt=image-20210317140152847></p><h2 id=8021x>802.1X</h2><p>根据<a href=https://zh.wikipedia.org/wiki/IEEE_802.1X>维基百科</a>，802.1X是一种关于用户接入网络的认证标准，它工作在二层，通过EAP协议（Extensible Authentication Protocol）进行认证，为<code>wpa-enterprise/wpa2-enterprise</code>提供了接入控制。BUPT的校园WiFi <code>BUPT-mobile</code>使用的就是这样的接入方式：</p><p><img src=/images/blog/70/image-20210317141740866-1615965914316.png alt=image-20210317141740866></p><p><a href=https://zh.wikipedia.org/wiki/%E6%89%A9%E5%B1%95%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE>EAP</a>是一种可扩展的认证机制，通常使用的认证方法有EAP-TLS、EAP-TTLS、PEAP。前者是在服务端和客户端都会校验对方的证书。后两者则只需要服务器提供证书。</p><p><code>BUPT-mobile</code>可以选择<code>TTLS</code>或者<code>PEAP</code>方法，再结合学生的上网账号密码连接。这种认证方式使用PKI机制来确保验证过程的安全性(服务器发来一个证书，客户端用证书中包含的公钥与服务器建立通信)，非常类似于浏览网页时建立TLS连接时的那样。</p><p>但是如何确保服务器发来的证书的真实性？这里有两个选择，一是向CA购买证书，另一种则是自建PKI系统，自己当CA，自己给自己发证书。</p><p>（像百邮这样"top secret"的，当然是选择后者啦23333）</p><p>因此，在ios设备上首次连接<code>BUPT-mobile</code>后，会弹出一个这样的：</p><p><img src=/images/blog/70/image-20210317145134096.png alt=image-20210317145134096></p><p>由于是采用自建的PKI系统，所以签发这个证书的CA证书是没有被预装在我们设备里面的，因此这里提示的是这个证书<strong>不可信</strong>。</p><p>Android上没有这样的提示，因此一直以来，我们在连接的时候都必须要选择 <strong>不验证</strong> 服务器发来的证书：</p><p><img src=/images/blog/70/image-20210317142829088.png alt=image-20210317142829088></p><h2 id=ca证书>CA证书</h2><p>在Android11之后，虽然没有了这个<code>不验证</code>的选项，我们还是有办法连接校园WiFi的。</p><p>思路也很简单，既然不信任学校的CA签发的证书，那我们把CA的证书安装到手机里，信任了CA证书，那么它签发的证书也就能够被信任了。</p><h3 id=用wireshark抓取证书>用wireshark抓取证书</h3><p>前面提到EAP是二层协议，我们在建立WiFi连接的时候进行抓取：</p><p><img src=/images/blog/70/image-20210317150539106.png alt=image-20210317150539106></p><p>可以看到上面编号为7的包里面有AP发来的证书：</p><p><img src=/images/blog/70/image-20210317150815374.png alt=image-20210317150815374></p><p>解开发现包含了两个证书，我们右键将其保存下来（后缀名为.cer）：<img src=/images/blog/70/image-20210317150918046.png alt=image-20210317150918046></p><p>这两个证书一个身份是<code>BUPT Local Server Certificate</code>一个是<code>BUPT Local Certificate Authority</code>。前者由后者所颁发，而后者是一个自签名的证书。从名字来看，相信后者应该就是BUPT自制的CA证书了。</p><h3 id=安装证书>安装证书</h3><p>将CA证书（后者）传到手机上，在文件管理器中点击打开，会弹出一个证书安装程序：</p><p><img src=/images/blog/70/image-20210317151645163.png alt=image-20210317151645163></p><p>选择凭据用途为WLAN，然后给它起个名点击确认安装。</p><p>在WiFi连接时：EAP方法选择<code>TTLS</code>或者<code>PEAP</code>，CA证书选择刚刚我们安装的那个证书，域名留空（<strong>如果必须要填域名的话，域名那里填<code>BUPT Local Server Certificate</code></strong>，即颁发的证书里的CN字段的值），身份和密码分别填写上网账号密码便可连接上了：</p><p><img src=/images/blog/70/image-20210317151810275.png alt=image-20210317151810275></p><p><img src=/images/blog/70/image-20210317152000936.png alt=image-20210317152000936></p><p>最后将证书文件放在这里：</p><ul><li><p>证书: <a href=/objects/cer1.cer>cer1.cer</a></p></li><li><p>CA证书: <a href=/objects/cer2.cer>cer2.cer</a></p></li></ul><p>文件的md5sum:</p><pre tabindex=0><code>3784d3f46879644a0d1343208f381005  cer1.cer
4b60d9eaa8eaf05f784391d9e83a1f34  cer2.cer
</code></pre><blockquote><p>最后，由于在设备上随意安装未知来源的CA证书是一件很危险的事情，使用上面的证书文件的同时，也意味着您已经了解并明白潜在的风险，本人不承担由此导致的任何责任。</p></blockquote><h2 id=refer>refer</h2><ul><li><p><a href=https://documentation.meraki.com/MR/Encryption_and_Authentication/Wireless_Encryption_and_Authentication_Overview>Wireless Encryption and Authentication Overview</a></p></li><li><p><a href=https://wooyun.js.org/drops/%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%97%A0%E7%BA%BF%E6%B8%97%E9%80%8F%E4%B9%8BPEAP.html>企业级无线渗透之PEAP</a></p></li></ul></main><div id=comments><hr><script src=//geoip-js.com/js/apis/geoip2/v2.1/geoip2.js type=text/javascript></script><script>var onSuccess=function(e){var t=e.country.names["zh-CN"],n=e.country.iso_code;if(!n)return;t&&(document.getElementById("comments-blocked-country-code").innerHTML=t),n=="CN"&&(document.getElementById("comments-shown").style.display="none",document.getElementById("comments-blocked").style.display="")},onError=function(){};geoip2.country(onSuccess,onError)</script><div id=comments-blocked style=font-style:italic;color:#777;display:none>评论区已关闭。<span style=float:right>来自 <span id=comments-blocked-country-code>unknown</span> 的访客
<span>&nbsp; - powered by: geoip-js.com</span></span></div><div id=comments-shown><script src=https://utteranc.es/client.js repo=imlk0/imlk0.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/imlk0/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>