<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ä½¿ç”¨Yubikey PIVå’ŒPKCS#11æ¥éªŒè¯SSH Client | imlk's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>ğŸ Home</a></li><li><a href=/about/>ğŸ‘‹About</a></li><li><a href=/archives/>ğŸ“œArchives</a></li><li><a href=/friends/>ğŸ”—Friends</a></li><li><a href=/dn42/>ğŸ•¸ï¸DN42</a></li><li><a href=/index.xml>ğŸ“¢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>ä½¿ç”¨Yubikey PIVå’ŒPKCS#11æ¥éªŒè¯SSH Client</span></h1><span><span class=date>ğŸ“… 2023-03-16</span>
<span class=date>(æ›´æ–°äº2023-03-25)</span>
/
<span class=cats>ğŸ“š
<a href=https://blog.imlk.top/categories/security/>Security</a>
</span>/
<span class=tags>ğŸ·ï¸
<a href=https://blog.imlk.top/tags/yubikey/>#Yubikey</a>
<a href=https://blog.imlk.top/tags/pkcs11/>#PKCS11</a></span></span><br></div><main class=post-content><blockquote><p>æ›´æ–°äº<a href=https://github.blog/2023-03-23-we-updated-our-rsa-ssh-host-key/>Github æ›´æ¢äº†å®ƒRSA ssh host key</a>ä¹‹æ—¶ï¼Œå¯¹sshæ”»å‡»çš„å‡è®¾éƒ¨åˆ†çš„è®¨è®ºåšäº†ä¿®æ”¹ã€‚</p></blockquote><p>å‰æ®µæ—¶é—´æŠ½ç©ºç»™è‡ªå·±çš„â€œHomelabâ€æœåŠ¡å™¨åŠ äº†å†…å­˜ï¼Œèƒ½å¼€æ›´å¤šçš„VM & Conteineräº†ã€‚è™½ç„¶ç”¨Tailscaleå’Œè‡ªå»ºHeadscale/DerperæœåŠ¡çš„æ–¹å¼ç»„äº†å†…ç½‘ï¼Œè®¿é—®æœåŠ¡å™¨ä¸Šçš„æœåŠ¡çš„æ—¶å€™ä¹Ÿéƒ½æ˜¯èµ°çš„å†…ç½‘ï¼Œä¸€å®šç¨‹åº¦ä¸Šé€šä¿¡é“¾è·¯ä¸Šæ˜¯å®‰å…¨äº†ã€‚ä½†æ˜¯ç›®å‰è¿˜æ˜¯ä¸€ä¸ªssh keyåˆ°å¤„ç”¨ï¼Œå¦‚æœç¬”è®°æœ¬å¤±çªƒ/å¯†é’¥è¢«è¯»èµ°äº†ï¼Œè¿˜æ˜¯å¾ˆå±é™©çš„ï¼Œ(è¯´èµ·æ¥ä¹‹å‰ç”¨Termiuså°±æ˜¯è‡ªåŠ¨æŠŠ<code>~/.ssh/</code>é‡Œçš„æ‰€æœ‰keyéƒ½ä¸Šäº‘äº†)ã€‚æ‰€ä»¥è¿™æ¬¡å€Ÿç€å‡çº§é…ç½®çš„è¿™ä¸ªæœºä¼šï¼ŒæŠŠæ‰‹é‡Œçš„Yubikeyçš„PIVåŠŸèƒ½ç»™ç”¨ä¸Šï¼Œè®©ssh serverèƒ½å¤Ÿç”¨Yubikeyé‡Œå­˜çš„ç§é’¥æ¥éªŒè¯ssh clientã€‚</p><h1 id=è¯ä¹¦ç”Ÿæˆä¸å¯¼å‡º>è¯ä¹¦ç”Ÿæˆä¸å¯¼å‡º</h1><p>åŸºæœ¬ä¸Šæ˜¯å‚è€ƒäº†Yubikey Handbooké‡Œçš„<a href=https://ruimarinho.gitbooks.io/yubikey-handbook/content/ssh/authenticating-ssh-with-piv-and-pkcs11-client/>Authenticating SSH with PIV and PKCS#11 (client)</a>è¿™ç¯‡æ–‡ç« ï¼Œä¸‹é¢çš„å†…å®¹ä¹Ÿæ˜¯åŸºäºè¿™ç¯‡æ–‡ç« æ¥è¯´æ˜ã€‚</p><ol><li><p>é¦–å…ˆåœ¨yubikeyä¸­ç”Ÿæˆä¸€å¯¹RSA 2048å¯†é’¥ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦ï¼Œè¿™ä¸ªå¯ä»¥é€‰æ‹©ç”¨<code>yubico-piv-tool</code>å‘½ä»¤è¡Œå·¥å…·ï¼Œä¹Ÿå¯ä»¥ç”¨<code>Yubikey Manager</code>è¿™ä¸ªGUIå·¥å…·ï¼Œæˆ‘é€‰æ‹©äº†åè€…ã€‚</p><p>è¿™é‡Œé™¤äº†èƒ½å¤Ÿç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼Œè¿˜å¯ä»¥é€‰æ‹©ç”ŸæˆCSR(certificate signing request)ï¼Œæˆ‘æƒ³åº”è¯¥æ˜¯ä¸ºäº†æ–¹ä¾¿è®©CAç­¾è¯ä¹¦çš„åœºæ™¯ã€‚ä¹‹å‰ä¹Ÿè€ƒè™‘è¿‡è‡ªå»ºCAçš„äº‹ï¼Œä¸è¿‡æ„Ÿè§‰éº»çƒ¦å°±æç½®äº†ã€‚</p></li><li><p>ä»è¯ä¹¦ä¸­å¯¼å‡ºå…¬é’¥ï¼Œä¿å­˜åˆ°<code>~/.ssh/ybk_piv.pub</code>é‡Œ(æ–‡ä»¶åä»»æ„)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh-keygen -D /usr/lib/opensc-pkcs11.so -e &gt; ~/.ssh/ybk_piv.pub
</span></span></code></pre></div></li></ol><h1 id=æœåŠ¡ç«¯é…ç½®>æœåŠ¡ç«¯é…ç½®</h1><p>å°†è¯¥å…¬é’¥å®‰è£…åˆ°ç›®æ ‡sshdæœåŠ¡å™¨çš„<code>~/.ssh/authorized_keys</code>é‡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh-copy-id -f -i ~/.ssh/ybk_piv.pub &lt;user&gt;@&lt;server-ip&gt;
</span></span></code></pre></div><p>åˆ°æ­¤ï¼ŒæœåŠ¡ç«¯çš„é…ç½®å°±å®Œæˆäº†</p><h1 id=é…ç½®å®¢æˆ·ç«¯ç¯å¢ƒ>é…ç½®å®¢æˆ·ç«¯ç¯å¢ƒ</h1><p>PKCS#11æ˜¯ä¸€å¥—ä¸ºåº”ç”¨ç¨‹åºä½¿ç”¨HSMæ‰§è¡Œå¯†ç å‡½æ•°è€Œå®šä¹‰çš„APIæ ‡å‡†ï¼Œä¹Ÿç§°ä¸ºCryptoki(Cryptographic token interface)ã€‚</p><p><a href=https://en.wikipedia.org/wiki/OpenSC>OpenSC</a>æ˜¯PKCS#11çš„ä¸€ä¸ªå®ç°ï¼Œè€Œå®ƒå¯ä»¥ä½¿ç”¨<a href=https://en.wikipedia.org/wiki/PC/SC>PC/SC</a>ä½œä¸ºåç«¯ã€‚åè€…æ˜¯ä¸€ç§å°†æ™ºèƒ½å¡é›†æˆåˆ°è®¡ç®—ç¯å¢ƒä¸­çš„è§„èŒƒï¼Œåœ¨Linuxä¸Šçš„å®ç°è€…ä¸º<a href=https://github.com/LudovicRousseau/PCSC>pcsclite</a>ã€‚<a href=https://en.wikipedia.org/wiki/CCID_(protocol)>CCID</a>æ˜¯ä¸€ç§USBåè®®ï¼ŒYubikeyè®¾å¤‡æ”¯æŒè¿™ç§åè®®ã€‚</p><p>åœ¨ä¸€ä¸ªæ–°çš„Linuxä¸»æœºä¸Šï¼Œè¦è®©ssh clientä½¿ç”¨PKCS#11æ¥éªŒè¯ï¼Œè‡³å°‘éœ€è¦å‡†å¤‡ä»¥ä¸‹è½¯ä»¶ç»„ä»¶ï¼Œä»¥ArchLinuxç¯å¢ƒä¸ºä¾‹</p><ol><li>å®‰è£…<code>pcsclite</code>å¹¶ç¡®ä¿<code>pcscd.service</code>æ­£åœ¨è¿è¡Œ</li><li>å®‰è£…<code>opensc</code>ï¼Œè¿™æ—¶ä½ å°†æ‹¥æœ‰<code>/usr/lib/opensc-pkcs11.so</code>å’Œ<code>pkcs11-tool</code></li><li>å®‰è£…<code>ccid</code></li></ol><p>è¿™æ—¶è¿è¡Œ<code>pkcs11-tool -L</code>ä½ åº”è¯¥èƒ½çœ‹åˆ°ä½ çš„Yubikeyå¹¶ä¸”å…¶ä¸­æœ‰ä¸€ä¸ªsoltã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>âœ  ~ pkcs11-tool -L   
</span></span><span style=display:flex><span>Available slots:
</span></span><span style=display:flex><span>Slot 0 (0x0): Yubico YubiKey OTP+FIDO+CCID 00 00
</span></span><span style=display:flex><span>  token label        : ssh
</span></span><span style=display:flex><span>  token manufacturer : piv_II
</span></span><span style=display:flex><span>  token model        : PKCS#15 emulated
</span></span><span style=display:flex><span>  token flags        : login required, rng, token initialized, PIN initialized
</span></span><span style=display:flex><span>  hardware version   : 0.0
</span></span><span style=display:flex><span>  firmware version   : 0.0
</span></span><span style=display:flex><span>  serial num         : xxxxxxxxxxxxxxxx
</span></span><span style=display:flex><span>  pin min/max        : 4/8
</span></span></code></pre></div><p>å¦‚æœæ²¡æœ‰ï¼Œè¯·æ’æŸ¥ä¸Šè¿°æœåŠ¡/è½¯ä»¶åŒ…ï¼Œå¹¶æ£€æŸ¥lsusbå’Œudevé…ç½®ã€‚</p><h1 id=é…ç½®å®¢æˆ·ç«¯openssh-client>é…ç½®å®¢æˆ·ç«¯openssh client</h1><p>é—æ†¾çš„æ˜¯æ”¯æŒPKCS#11å¯†é’¥çš„ssh clientå¹¶ä¸å¤šï¼Œå®æµ‹Termiuså¹¶æ²¡æœ‰æ­¤åŠŸèƒ½ï¼Œä½†æ˜¯çœ‹ä»‹ç»xshellå¥½åƒæ”¯æŒçš„ã€‚ä½†æ˜¯ä¸€èˆ¬æ¥è¯´å’±ä»¬ä¹Ÿå°±ç”¨openssl clientäº†æ‰€ä»¥è¿™é‡Œä»¥å®ƒä¸ºä¾‹ã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯åœ¨æ¯æ¬¡å¼€æœºåç”¨<code>ssh-add</code>ä¸»åŠ¨å°†å¯†é’¥æ·»åŠ åˆ°ssh-agenté‡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh-add -s /usr/lib/opensc-pkcs11.so
</span></span></code></pre></div><p>ä¼˜ç‚¹æ˜¯åªéœ€è¦åœ¨æ·»åŠ çš„æ—¶å€™è¾“å…¥ä¸€æ¬¡PINç ï¼Œä¹‹åï¼ˆæ³¨é”€ä¹‹å‰ï¼‰å†æ’æ‹”yubikeyä¸éœ€è¦å†æ¬¡è¾“å…¥ã€‚ï¼ˆä¸ºå•¥æˆ‘è§‰å¾—è¿™ä¸ç®—æ˜¯ä»€ä¹ˆä¼˜ç‚¹åè€Œæ˜¯ç¼ºç‚¹ï¼‰</p><p>å¦ä¸€ç§åˆ™æ˜¯åœ¨<code>~/.ssh/config</code>é‡Œé…ç½®<code>PKCS11Provider</code>ã€‚æ¯”å¦‚ä¸‹é¢çš„é…ç½®ç»™æ‰€æœ‰çš„Hoståœ¨ç™»é™†æ—¶éƒ½å°è¯•ä½¿ç”¨yubikeyä¸Šçš„å¯†é’¥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Host *
</span></span><span style=display:flex><span>	PKCS11Provider /usr/lib/opensc-pkcs11.so
</span></span></code></pre></div><p>åœ¨è¿™ç§é…ç½®ä¸‹åœ¨æ¯æ¬¡sshç™»é™†çš„æ—¶å€™éƒ½ä¼šè®©ä½ è¾“ä¸€æ¬¡PINç ï¼ˆ<del>æ˜¯ä¸æ˜¯æ„Ÿè§‰å®‰å…¨äº†å¾ˆå¤šï¼Ÿ</del> å…¶å®å¹¶ä¸ï¼Œå¦‚æœè¾“è¿‡ä¸€æ¬¡äº†åªè¦æŒ‰ä¸€ä¸‹å›è½¦å°±å¯ä»¥è¿‡ï¼Œé™¤éæ‹”æ‰yubikeyå†æ’æ‰ä¼šå†é—®ä½ è¦å¯†ç ï¼‰</p><h1 id=å’Œidentitiesonly-yesä¸€èµ·ä½¿ç”¨>å’Œ<code>IdentitiesOnly yes</code>ä¸€èµ·ä½¿ç”¨</h1><p>ä¸€èˆ¬æ¥è¯´å’±ä»¬è¿˜æ˜¯ä¹ æƒ¯ç»™ä¸åŒçš„æœåŠ¡å™¨é…ç½®ä¸åŒçš„å¯†é’¥çš„ï¼Œè¿™ä¹Ÿå¯¼è‡´æˆ‘ä»¬åœ¨<code>~/.ssh/</code>é‡Œä¼šæœ‰ä¸€å¤§å¨å¯†é’¥ã€‚ssh-agentä¹Ÿä¼šæ‚‰æ•°å°†å…¶æ”¶å…¥ï¼Œç„¶ååœ¨è¿æ¥ssh serverçš„æ—¶å€™æŒ¨ä¸ªå°è¯•ï¼Œç»“æœå°±å¯¼è‡´<code>Too many authentication failures</code>å‡ºç°ï¼Œ æ‰€ä»¥opensshæä¾›äº†<code>IdentitiesOnly yes</code>è¿™ä¸ªé…ç½®é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¯¹äº<code>~/.ssh/config</code>é‡Œçš„æ¯ä¸ªHostï¼Œåªä¼šå°è¯•ç”±<code>IdentityFile</code>æŒ‡å®šçš„keyã€‚å¦‚æœè¿™ä¸ªHostæ²¡æœ‰æŒ‡å®šçš„è¯å°±å°è¯•<code>~/.ssh/id_rsa</code>ä¹‹ç±»çš„é»˜è®¤å¯†é’¥è·¯å¾„ã€‚</p><p>ä½†æ˜¯opensslåœ¨å¤„ç†çš„æ—¶å€™ä¼¼ä¹æœ‰ä¸€ç‚¹bugï¼Œå½“<code>IdentitiesOnly yes</code>å’Œ<code>PKCS11Provider</code>åŒæ—¶å­˜åœ¨æ—¶ï¼Œåè€…ä¼šè¢«å¿½ç•¥ã€‚æ ¹æ®<a href=https://groups.google.com/g/opensshunixdev/c/jD1pghvajpo>è¿™é‡Œ</a>çš„è®¨è®ºï¼Œ<code>IdentityFile</code>ç›¸å½“äºä¸€ä¸ªfilterï¼Œåªä¼šå°è¯•<code>IdentityFile</code>æŒ‡å®šçš„é‚£äº›å…¬é’¥ï¼Œ å› æ­¤ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯åŠ ä¸€ä¸ª<code>IdentityFile</code>æŒ‡å‘æˆ‘ä»¬ä¹‹å‰ä»yubikeyé‡Œå¯¼å‡ºçš„å…¬é’¥ï¼Œå®Œæ•´ä¾‹å­å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Host *
</span></span><span style=display:flex><span>	IdentitiesOnly yes
</span></span><span style=display:flex><span>	PKCS11Provider /usr/lib/opensc-pkcs11.so
</span></span><span style=display:flex><span>	IdentityFile ~/.ssh/ybk_piv.pub
</span></span></code></pre></div><h1 id=é—²èŠ>é—²èŠ</h1><h2 id=ssh-serverçš„tofu>ssh serverçš„TOFU</h2><p>å…¶å®ä¸ç®¡æ˜¯æ™®é€šçš„sshå¯†é’¥æ–‡ä»¶è¿˜æ˜¯è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„PIVï¼Œéƒ½æ˜¯å¯¹ssh clientä¾§çš„éªŒè¯ã€‚é‚£ä¹ˆå¯¹ssh serverä¾§çš„éªŒè¯åˆå¦‚ä½•å‘¢ï¼Ÿ</p><p>åœ¨ssh clientç¬¬ä¸€æ¬¡è¿æ¥åˆ°ä¸€ä¸ªæ–°çš„ssh serveræ—¶ï¼Œä¼šæ˜¾ç¤ºserverä¾§å…¬é’¥çš„<code>fingerprint</code>ï¼Œå¹¶ä¸”é—®ä½ ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Are you sure you want to continue connecting (yes/no/[fingerprint])? 
</span></span></code></pre></div><p>è¿™æ—¶å€™å¦‚æœä½ ä¿¡ä»»è¿™ä¸ªç½‘ç»œç¯å¢ƒï¼Œæˆ–è€…ä½ æ¯”å¯¹è¿‡è¿™ä¸ªfingerprintæ˜¯å¯¹çš„ï¼Œä½ å¯ä»¥ç›´æ¥yesï¼Œç„¶åå®ƒä¼šæŠŠserverçš„å…¬é’¥åŠ åˆ°<code>~/.ssh/known_hosts</code>é‡Œé¢ã€‚æˆ–è€…ä½ å¯ä»¥è¾“å…¥ä¸€ä¸ªæŒ‡çº¹æ¯”å¦‚<code>SHA256:CB5smnwKhpcnT1bz6OXHYuFcijlMS3nw2tEJ2HoR++A</code>ä¹‹ç±»çš„ï¼Œæ¥ç€å®ƒä¼šå¸®ä½ æ¯”å¯¹ã€‚å½“ä¹‹åä½ è¿æ¥åˆ°serveræ—¶ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿäº†ä¸­é—´äººæ”»å‡»ï¼Œé‚£ä¹ˆssh clientèƒ½å¤Ÿæ ¹æ®<code>~/.ssh/known_hosts</code>ä¸­çš„å…¬é’¥æ¯”å¯¹å¤±è´¥æ¥æ£€æµ‹åˆ°ã€‚è¿™å°±æ˜¯æ‰€è°“çš„<a href=https://en.wikipedia.org/wiki/Trust_on_first_use>Trust on first use (TOFU)</a>çš„æ–¹å¼ã€‚</p><p>æ‰€ä»¥ï¼ˆåœ¨æœ€å¸¸è§çš„é…ç½®æƒ…å†µä¸‹ï¼‰å¯¹ssh serverçš„éªŒè¯å…³é”®åœ¨ç¬¬ä¸€æ¬¡è¿æ¥æ—¶ã€‚ssh clientæŠŠè´£ä»»äº¤ç»™äº†ç”¨æˆ·ï¼Œå®ƒå‡è®¾ä½ èƒ½å¤Ÿæ ¹æ®é¢å¤–çš„å¯ä¿¡ä¿¡æ¯æºæ¥ç¡®è®¤è¿™ä¸ªfingerprintï¼ˆå› ä¸ºç¬¬ä¸€æ¬¡è¿æ¥çš„æ—¶å€™æ²¡æœ‰ä¿¡ä»»é”šï¼Œä¹‹åçš„ä¿¡ä»»é”šåœ¨<code>~/.ssh/known_hosts</code>é‡Œï¼‰ã€‚</p><p>ä½†æ˜¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿½ç•¥äº†è¿™ä¸€æ­¥ï¼Œç›´æ¥yesæ‰ã€‚</p><h2 id=ä¸æ£€æŸ¥fingerprintæœ‰ä»€ä¹ˆé—®é¢˜>ä¸æ£€æŸ¥fingerprintï¼Œæœ‰ä»€ä¹ˆé—®é¢˜</h2><p>å‡è®¾ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„æ”»å‡»è€…ï¼ˆæ¯”å¦‚æ‰€åœ¨å•ä½çš„ç½‘ç»œç®¡ç†å‘˜ã€è¿è¥å•†çº§ã€<del>ç”šè‡³countryçº§</del>çš„åŠ«æŒï¼‰ï¼Œèƒ½å¤Ÿåœ¨ä½ ç¬¬ä¸€æ¬¡è¿æ¥è¿™ä¸ªæœåŠ¡å™¨æ—¶å°±åŠ«æŒä½ çš„æ•°æ®åŒ…ï¼Œå¹¶ä¸”å¯¹äºä¹‹åçš„è¿æ¥éƒ½èƒ½å¤ŸåŠ«æŒï¼ˆé˜²æ­¢å› ä¸ºfingerprintå˜åŠ¨è€Œè¢«å—å®³è€…å¯Ÿè§‰åˆ°æ”»å‡»çš„å­˜åœ¨ï¼‰ï¼Œé‚£æ”»å‡»è€…å®Œå…¨å¯ä»¥ç”¨ä¸€ä¸ªå‡çš„ssh serverï¼ˆæ¯”å¦‚èœœç½ï¼‰æ¥å“åº”ã€‚å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨å’Œserverä¸Šçš„fingerprintæ¯”å¯¹ï¼Œä½ å¯èƒ½ä¸çŸ¥é“è‡ªå·±å…¶å®æ˜¯åœ¨sshèœœç½é‡Œã€‚</p><p>å½“ç„¶è¿™åªæ˜¯æ”»å‡»è€…ä¼ªè£…æˆssh serverå¯¹clientè¿›è¡Œæ¬ºéª—çš„æƒ…å†µã€‚é‚£å¦‚æœä½ ä¸å·§ä½¿ç”¨çš„æ˜¯åŸºäºå¯†ç çš„sshéªŒè¯æ–¹å¼ï¼Œé‚£å°±æ›´å±é™©äº†ã€‚æ ¹æ®<a href=https://www.rfc-editor.org/rfc/rfc4252#section-8>rfc4252</a> SSH protocolä¸­å¯¹Password Authenticationçš„è¦æ±‚ï¼š</p><pre tabindex=0><code>8.  Password Authentication Method: &#34;password&#34;

   Password authentication uses the following packets.  Note that a
   server MAY request that a user change the password.  All
   implementations SHOULD support password authentication.

      byte      SSH_MSG_USERAUTH_REQUEST
      string    user name
      string    service name
      string    &#34;password&#34;
      boolean   FALSE
      string    plaintext password in ISO-10646 UTF-8 encoding [RFC3629]

   Note that the &#39;plaintext password&#39; value is encoded in ISO-10646
   UTF-8.  It is up to the server how to interpret the password and
   validate it against the password database.  However, if the client
   reads the password in some other encoding (e.g., ISO 8859-1 - ISO
   Latin1), it MUST convert the password to ISO-10646 UTF-8 before
   transmitting, and the server MUST convert the password to the
   encoding used on that system for passwords.
</code></pre><p>å¯†ç ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ°ssh serverï¼Œç„¶åå…·ä½“å¦‚ä½•éªŒè¯è¿™ä¸ªå¯†ç æ˜¯ç”±serveræ¥å®ç°çš„ï¼ˆæˆ‘çŒœæµ‹è®¾è®¡æˆè¿™æ ·æ˜¯å’Œsshéœ€è¦å’ŒPAMå¯¹æ¥æœ‰å…³ï¼‰ã€‚è¿™æ„å‘³ç€å¦‚æœä½ æ—¢æ²¡æ¯”å¯¹fingerprintï¼Œä½ è¿˜æ˜¯ç”¨å¯†ç ç™»é™†çš„ï¼Œé‚£æ”»å‡»è€…å®Œå…¨å¯ä»¥å®æ–½MITMæ”»å‡»ï¼ŒåŒæ—¶æ¬ºéª—clientå’Œserverï¼Œä½ å’Œserverä¹‹é—´çš„é€šä¿¡åœ¨æ”»å‡»è€…é¢å‰ä¸€è§ˆæ— ä½™ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸æ¨èä½¿ç”¨å¯†ç åšsshéªŒè¯ï¼Œè€Œæ˜¯æ¨èä½¿ç”¨å¯†é’¥åšsshéªŒè¯çš„ä¸€ä¸ªåŸå› ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œå…¶å®å¯†ç ç™»é™†ï¼Œæˆ–è€…è¯´æ˜¯ã€ŒåŸºäºå£ä»¤çš„èº«ä»½é‰´åˆ«ã€ï¼Œæ˜¯èƒ½å¤Ÿåœ¨ä¸ä¼ è¾“å¯†ç æ˜æ–‡ï¼ˆæˆ–è€…å…¶ç­‰ä»·ç‰©å¦‚hashå€¼ç­‰ï¼‰ï¼Œç”šè‡³ä¸å‘çªƒå¬è€…æ³„æ¼å’Œå¯†ç æœ‰å…³çš„ä»»ä½•ä¿¡æ¯çš„æƒ…å†µä¸‹å®Œæˆçš„ï¼Œæ¯”å¦‚EKEã€DH-EKEã€SRPï¼ˆThe Secure Remote Password Protocolï¼‰ç­‰åè®®ã€‚ä½†æ˜¯è‡³å°‘sshçš„å¯†ç ç™»å½•æ˜¯ç”¨æ˜æ–‡ä¼ è¾“å¯†ç çš„æ–¹å¼åšçš„ã€‚</p><h2 id=ä¸ªäººå¦‚ä½•é˜²èŒƒ>ä¸ªäººå¦‚ä½•é˜²èŒƒ</h2><p>åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰sshå…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å®‰å…¨ï¼Œæ¯•ç«Ÿä½ å¤§æ¦‚ç‡ä¹Ÿæ²¡æœ‰çœŸæ­£æ¯”å¯¹è¿‡ä½ <del>æµ·å¤–çš„æŸå°VPS</del>æœåŠ¡å™¨ä¸Šçš„fingerprintå¯¹å§ï¼ˆå¯èƒ½æ´»åœ¨èœœç½é‡Œä¹Ÿè¯´ä¸å®šå‘¢ï¼Œç¬‘ï¼‰ã€‚å¦‚æœä½ æƒ³ç°åœ¨åšä¸€ä¸‹éªŒè¯ï¼Œ<a href=https://www.phcomp.co.uk/Tutorials/Unix-And-Linux/ssh-check-server-fingerprint.html>è¿™ç¯‡æ–‡ç« </a>é‡Œæåˆ°äº†åœ¨serverç«¯è®¡ç®—fingerprintçš„å‡ ä¸ªå‘½ä»¤ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å’Œsshè¿æ¥æ—¶çš„æŒ‡çº¹è¿›è¡Œæ¯”å¯¹ã€‚</p><p>ç”ŸæˆæœåŠ¡å™¨ä¸Šçš„sshå…¬é’¥æŒ‡çº¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd /etc/ssh
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> file in *.pub; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  ssh-keygen -lf $file
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>æˆ–è€…ï¼Œä½ å¯ä»¥ç›´æ¥æŸ¥çœ‹sshå…¬é’¥ï¼Œå¹¶ä¸<code>~/.ssh/known_hosts</code>ä¸­çš„å…¬é’¥è¿›è¡Œæ¯”å¯¹ï¼š</p><pre tabindex=0><code>cat /etc/ssh/*.pub
</code></pre><p>æœ€å¥½ç»è¿‡å¯ä¿¡çš„æ–¹å¼ç™»é™†åˆ°æœåŠ¡å™¨å¹¶è¿è¡Œè¿™äº›å‘½ä»¤ï¼Œå¦‚ç»è¿‡äº‘æœåŠ¡å•†çš„VNCæ§åˆ¶å°/æ›´ä¸ºå¯ä¿¡çš„ç½‘ç»œç¯å¢ƒ/éš§é“/<code>ssh -J</code>ç­‰ï¼Œä»¥é˜²å¾¡å¯¹ç»ˆç«¯è¾“å‡ºå†…å®¹è¿›è¡ŒåŒ¹é…æ›¿æ¢çš„æ”»å‡»è€…ï¼ˆä¸è¿‡çœŸçš„æœ‰äººä¼šè¿™ä¹ˆåšå—ï¼‰ã€‚</p><p>å¦‚æœä½ æƒ³åœ¨è¿è¡Œsshå‘½ä»¤æ—¶ï¼ŒæŸ¥çœ‹å½“å‰è¿æ¥çš„ssh serverçš„fingerprintï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh -o VisualHostKey<span style=color:#f92672>=</span>yes -o FingerprintHash<span style=color:#f92672>=</span>sha256 &lt;user-name&gt;@&lt;target-server&gt;
</span></span></code></pre></div><p>å¦‚æœä½ ç›®å‰æ­£åœ¨ç™»é™†ä¸€ä¸ªæ–°çš„serverï¼Œä½†æ˜¯ä½ æ²¡æœ‰å¯ä¿¡çš„æ¥æºæ¥è·å–fingerprintï¼Œä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ³•ä½ å¯ä»¥ä½¿ç”¨å¤šæ¡é“¾è·¯æ¥éªŒè¯ï¼Œæ¯”å¦‚å¦å¤–ä½¿ç”¨<code>ssh -J</code>å¼€ä¸€ä¸ªéš§é“ç»è¿‡ä½ çš„å¦ä¸€ä¸ªæœåŠ¡å™¨å»è¿è¿™ä¸ªæ–°çš„serverï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh -J &lt;a-known-server&gt; &lt;new-server&gt;
</span></span></code></pre></div><p>ä½ å¯ä»¥æ¯”å¯¹è¿™ä¿©è¿æ¥æ—¶æ˜¾ç¤ºçš„æŒ‡çº¹æ˜¯å¦ä¸€æ ·æ¥æ’é™¤æœ¬åœ°ç½‘ç»œç¯å¢ƒä¸­çš„æ”»å‡»è€…ã€‚</p><p>çªç„¶æƒ³åˆ°ï¼Œæ•´ä¸ªä¸–ç•Œå¥½åƒå°±æ˜¯åœ¨â€œå„å¼å„æ ·çš„è‰å°ç­å­â€å’Œâ€œè‡ªæ¬ºæ¬ºäººèˆ¬çš„ä¿¡ä»»â€ä¸­è¿è½¬çš„ã€‚</p><p>å®Œã€‚</p></main><div id=comments><hr><script src=//geoip-js.com/js/apis/geoip2/v2.1/geoip2.js type=text/javascript></script><script>var onSuccess=function(e){var t=e.country.names["zh-CN"],n=e.country.iso_code;if(!n)return;t&&(document.getElementById("comments-blocked-country-code").innerHTML=t),n=="CN"&&(document.getElementById("comments-shown").style.display="none",document.getElementById("comments-blocked").style.display="")},onError=function(){};geoip2.country(onSuccess,onError)</script><div id=comments-blocked style=font-style:italic;color:#777;display:none>è¯„è®ºåŒºå·²å…³é—­ã€‚<span style=float:right>æ¥è‡ª <span id=comments-blocked-country-code>unknown</span> çš„è®¿å®¢
<span>&nbsp; - powered by: geoip-js.com</span></span></div><div id=comments-shown><script src=https://utteranc.es/client.js repo=KB5201314/KB5201314.github.io issue-term=pathname label='ğŸ’¬ comments ğŸ’¬' theme=github-light crossorigin=anonymous async></script></div></div><footer class=footer><hr>Â© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/KB5201314/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>äº¬ICPå¤‡2020042968å·-1</a></footer></body></html>