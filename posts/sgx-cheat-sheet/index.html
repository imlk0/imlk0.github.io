<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SGX EPID & ECDSA Cheat Sheet | imlk's blog</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel=stylesheet></head><body><header class=header><a class=logo href=/>imlk's Blog</a><nav><ul class=menu><li><a href=/>🏠Home</a></li><li><a href=/about/>👋About</a></li><li><a href=/archives/>📜Archives</a></li><li><a href=/friends/>🔗Friends</a></li><li><a href=/dn42/>🕸️DN42</a></li><li><a href=/index.xml>📢Subscribe</a></li></ul></nav></header><hr><div class=article-meta><h1><span class=title>SGX EPID & ECDSA Cheat Sheet</span></h1><span><span class=date>📅 2022-11-01</span>
<span class=date>(更新于2023-08-30)</span>
/
<span class=cats>📚
<a href=https://blog.imlk.top/categories/tee/>TEE</a>
</span>/
<span class=tags>🏷️
<a href=https://blog.imlk.top/tags/sgx/>#SGX</a>
<a href=https://blog.imlk.top/tags/security/>#Security</a>
<a href=https://blog.imlk.top/tags/cheat-sheet/>#Cheat Sheet</a></span></span><br></div><main class=post-content><p>来自王老师的机密计算技术简介：<a href=https://heartever.github.io/files/ConfidentialComputing-Guilin.pdf>https://heartever.github.io/files/ConfidentialComputing-Guilin.pdf</a></p><h1 id=参考阅读文献>参考阅读文献</h1><ul><li><a href=https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html>Intel Software Developer&rsquo;s Manuals</a> chapter 35.4</li><li><a href="https://www.notion.so/SGX-a3196a0f115b43e6b125299a00ef48aa?pvs=21">Intel SGX DCAP Quick Install Guide</a></li><li><a href=https://networkbuilders.intel.com/university/course/introduction-to-intelr-sgx-data-center-attestation-primitives-components-and-flows>Introduction to Intel® SGX Data Center Attestation Primitives: Components and Flows</a></li><li><a href=https://download.01.org/intel-sgx/latest/dcap-latest/linux/docs/DCAP_ECDSA_Orientation.pdf>Intel DCAP ECDSA Orientation</a></li><li><a href=https://www.intel.com/content/dam/develop/external/us/en/documents/intel-sgx-support-for-third-party-attestation-801017.pdf>Supporting Third Party Attestation for Intel® SGX with Intel® Data Center Attestation Primitives</a> (ECDSA主要看这篇文章)</li><li><a href=https://systex.ibr.cs.tu-bs.de/systex19/slides/systex19-keynote-simon.pdf>SGX VC pitch - SysTEX 2019</a></li><li><a href=https://www.intel.com/content/www/us/en/support/articles/000057420/software/intel-security-products.html>Which Platforms Support Intel® Software Guard Extensions (Intel® SGX) Datacenter Attestation Primitives (DCAP)?</a></li><li><a href=https://www.intel.com/content/www/us/en/support/articles/000058764/software/intel-security-products.html>Which Platforms Support Intel® Software Guard Extensions (Intel® SGX) SGX2?</a></li></ul><h1 id=术语>术语</h1><ul><li>TCB(Trusted computing base)
为实现计算机系统安全保护的所有安全保护机制的集合，机制可以硬件、固件和软件的形式出现。现代操作系统努力降低TCB的大小。</li></ul><h2 id=硬件实现>硬件实现</h2><ul><li><p>EPC(Enclave Page Cache)
Enclave被保存在EPC中，而EPC位于DRAM中的处理器保留存储器（PRM）中</p></li><li><p>SECS(SGX Enclave Control Structure)
每个enclave一个</p></li><li><p>TCS(Thread Control Structure)
每个enclave中包含多个TCS，每个TCS又有一个对应的SSA</p></li><li><p>SSA(Save State Area)
每个TCS都有一个SSA，存储了异常和中断处理时处理器的状态。如果正在运行的enclave被停止或者中断，像寄存器这样的上下文信息都会从CPU中清除并移到它们各自的EPC中。</p></li><li><p>SIGSTRUCT and VA Page
每个EPC通常拥有它的SIGSTRUCT和VA Page</p></li><li><p>EPCM(Enclave Page Cache Map)用于管理Enclave Pages的安全属性，EPCM包含了EPC中列出的每一个页面的进一步的信息。
EPCM是CPU中的一个查询表，其中包含了enclave相关的数据</p></li><li><p>MEE(Memory Encryption Engine)
MEE是CPU的一部分，由于EPC在DRAM中，CPU在MEE的协助下加密EPC内容，以保证其安全性，确保CPU是系统中唯一能够正确读取enclave中的数据的地方。</p></li><li><p>度量过程</p><p>SGX在enclave创建之初对所有EADD指令添加到enclave内的内存和其他元数据计算一个<strong>sha256</strong>，而不是在运行时动态measure</p></li></ul><h2 id=软件服务>软件服务</h2><ul><li>AESM(Application Enclave Services Manager)
即SGX应用安全容器的服务管理系统。是一个系统服务，通常位于<code>/opt/intel/sgx-aesm-service/aesm/aesm_service</code>，sgx程序通过unix-sockets与之通信
provides launch support for SGX Enclave, key provisioning, and remote attestation services.</li></ul><h2 id=epid模式的attestation>EPID模式的attestation</h2><ul><li><p>Intel Enhanced Privacy ID (EPID)</p><p>一组机器共同使用一对非对称密钥，以提供匿名性增强</p></li></ul><h3 id=两个密钥>两个密钥</h3><ul><li><p>Root Provisioning Key (RPK)</p><p>随机密钥，在制造时嵌入到cpu中，且intel知道所有设备的RPK。该密钥和远程证明以及Provisioning Enclave有关。</p></li><li><p>Root Sealing Key (RSK)</p><p>随机密钥，出厂时在cpu中产生，intel不知晓该密钥</p><p><code>EGETKEY</code> 借助这两个key派生出之后的所有key</p><p><img src=/images/SGX-a3196a0f115b43e6b125299a00ef48aa/Untitled.png alt=Untitled></p></li></ul><h3 id=两个特殊的enclave>两个特殊的Enclave</h3><ul><li><p>Provisioning Enclave (PvE)，供应Enclave</p><p>负责Platform Provisioning过程：根据RPK与Intel Provisioning Service通信，执行EPID加入流程，获得EPID private key，即<strong>attestation key</strong>。</p></li><li><p>Quoting Enclave (QE)</p><p>负责远程证明过程。它验证请求的enclave的report（相当于一个LA过程），然后用上一步PvE拿到的attestation key对report签名成为quote，然后将quote使用硬编码的IAS公钥进行加密。最后将加密好的quote发给SP，SP拿去找IAS验证。</p><p><img src=/images/SGX-a3196a0f115b43e6b125299a00ef48aa/Untitled1.png alt=Untitled></p></li></ul><h3 id=其他服务组件>其他服务组件</h3><ul><li><p>Intel Provisioning Service</p><p>一个在线服务，与PvE交互，负责EPID组的加入，以及EPID private key（即attestation key ）的供应过程</p></li><li><p>Intel Attestation Service (IAS)</p><p>一个很重要的在线服务，负责验证verifier发来的evidence（即加密的quote）。</p><p>quote只能由IAS解密。解密完成后IAS会向SP返回一个Attestation Verification Report，里面包含了QE生成的QUOTE结构体。</p></li><li><p>Service Provider (SP) 服务供应商</p><p>在实际场景中，一个Service Provider（作为verifier）如果想要使用IAS，必须先找IAS注册，将自己的TLS证书和自己的SPID绑定，才能使用IAS的服务</p></li></ul><h3 id=数据结构>数据结构</h3><ul><li><p>Report (EREPORT)：</p><p>Hardware report generated by the Intel® SGX HW that provides identity and measurement information of the enclave and the platform. It can be MAC’d with a key available to another enclave on the same platform.</p></li><li><p>Quote</p><p>Data structure used to provide proof to an off-platform entity that an application enclave is running with Intel® SGX protections on a trusted Intel® SGX enabled platform.</p><p>通常是由Quoting Enclave产生的，加密后发给IAS</p></li><li><p>Attestation Verification Report</p><p>IAS返回的对quote的验证结果，包含了enclave产生的数据，如MRENCLAVE、MRSIGNER等</p></li><li><p>Attestation Verification Report Signature</p><p>由IAS对Attestation Verification Report做的签名</p></li><li><p>Attestation Report Signing Certificate</p><p>和Attestation Verification Report Signature签名所用私钥对应的公钥证书，由IAS返回</p></li><li><p>Attestation Report Signing CA Certificate</p><p>Attestation Report Signing Certificate的上级CA证书，这是Attestation Verification Report的信任根，因此通常由verifier自己以可信的方式获取。</p></li></ul><h2 id=ecdsa模式的attestation>ECDSA模式的attestation</h2><ul><li>Data Center Attestation Primitives(DCAP)</li></ul><h3 id=服务组件>服务组件</h3><ul><li><p>Intel Provisioning Certification Service (Intel PCS)</p><p>英特尔提供的在线供应认证服务，允许检索必要的材料，包括PCK证书、PCK证书撤销列表(CRLs)。这些材料用以证明支持SGX的飞地</p><p><a href=https://api.portal.trustedservices.intel.com/provisioning-certification>https://api.portal.trustedservices.intel.com/provisioning-certification</a></p></li><li><p>Provisioning Certification Caching Service (PCCS)</p><p>数据中心中对PCS的缓存服务，由服务提供商SP管理，不需要运行在SGX平台之上，SP可以自定义其实现。PCCS在访问PCS时需要使用在intel页面上订阅的api密钥。</p></li><li><p>PCK Certificate ID Retrieval Tool</p><p>一个工具，在Provisioning阶段使用，用于获取provisioning data：包含了该CPU唯一的Platform Provisioning ID (PPID)，以及TCB信息，然后发给PCCS。</p></li></ul><h3 id=一些quote-libraryql>一些Quote Library（ql）</h3><ul><li><p>ECDSA Quote Provider Library (qpl库)</p><p>SP可以自定义其实现，负责从PCCS获取PCK证书，嵌入到Quote里面</p><ul><li>这个库被后面的Quote Generation Library和Quote Verification Library所依赖</li></ul></li><li><p>ECDSA Quote Generation Library</p><p>负责生成Quote并且使用平台密钥签名</p><p>SP可以自定义其实现。包含了PCE和QE</p></li><li><p>ECDSA Quote Verification Library</p><p>由Intel提供，包含了QVE。</p><p>在SGX平台和非SGX平台上都可以运行</p><blockquote><p>When the platform supports SGX, the library can return an SGX REPORT authenticating the verification result was produced by the Intel® SGX Quote Verification Enclave (QVE).</p></blockquote></li></ul><h3 id=特殊的enclave>特殊的Enclave</h3><p><img src=/images/SGX-a3196a0f115b43e6b125299a00ef48aa/Untitled2.png alt=Untitled></p><ul><li><p>Provisioning Certification Enclave (PCE)</p><p>为本地运行的QE扮演了一个本地CA的角色，持有平台特定的Provisioning Certification Key（PCK）（通过<code>EGETKEY</code>获得）。</p><p>QE可以自己产生一对attestation key，然后把公钥给PCE签名形成一个类似于证书的结构，包含了公钥和QE的身份信息。这个结构会用PCK签名。</p></li><li><p>Quoting Enclave (QE)</p><p>与EPID里的QE不同。</p><p>Intel提供了其源码，但需要注意的是如果SP自己编译这个enclave，那么相当于把SP包括在了TCB中。因此Intel还提供了自己签名好的的enclave二进制文件。</p></li><li><p>Quote Verification Enclave QVE</p><p>在Verify环节用到，是可选的。由DCAP 1.3引入，目的是「Keeps 3rd party verifiers out of the SGX Attestation TCB」</p></li></ul><h3 id=key和certificate>Key和Certificate</h3><ul><li><p>Provisioning Certification Key (PCK)</p><p>PCE持有的一对和TCB关联的签名密钥，用于对attestation key签名。</p></li><li><p>PCK Certificate</p><p>Intel颁发的证书，由PCS提供</p></li><li><p>Attestation Key</p><p>QE产生的一对非对称密钥</p></li></ul><h3 id=数据结构-1>数据结构</h3><ul><li><p>Collateral</p><p>材料，指的是Intel PCS提供的远程证明相关的材料，也可以从PCCS那里获得</p></li><li><p>Quote</p><p>Quote中至少包含了：attester enclave的元数据、QE的身份标识、PCK证书、</p></li></ul><h3 id=其它术语>其它术语</h3><ul><li><p>Platform Provisioning ID (PPID)</p><p>Is unique to the platform and PCE identity, but not to the specific TCB. This values and
corresponding TCB SVNs are used to identify the platform when requesting the corresponding PCK certificate from Intel.</p></li></ul><h3 id=三个过程>三个过程</h3><p><img src=/images/SGX-a3196a0f115b43e6b125299a00ef48aa/Untitled3.png alt=Untitled></p><ul><li><p>Provisioning过程</p><p>在设备初始化时，或者TCB更新时需要重新进行该过程</p><p>流程是：</p><ul><li>运行PCK Certificate ID Retrieval Tool，将PPID和TCB信息发给PCCS进行注册。</li><li>PCCS向PCS获取certificates，以及对应该TCB level的其余endorsements数据，PCCS会将其存储起来。</li></ul></li><li><p>Evidence(Quote) Generation过程</p><ul><li>attester应用调用Quote Generation Library生成quote，后者调用Quote Provider Library去向PCCS获取PCK证书，以嵌入到quote中</li></ul></li><li><p>Quote & TCB Verify 过程</p><ul><li><p>步骤</p><blockquote><p>To verify an Intel® SGX attestation, the verifier should take the following steps.</p><ol><li>Verify the integrity of the signature chain from the Quote to the Intel-issued PCK certificate.</li><li>Verify no keys in the chain have been revoked.</li><li><strong>Verify the Quoting Enclave is from a suitable source and is up to date.</strong></li><li>Verify the status of the Intel® SGX TCB described in the chain.</li><li>Verify the enclave measurements in the Quote reflect an enclave identity expected.</li></ol></blockquote></li><li><p>需要的信息，除了quote之外还要：</p><blockquote><ol><li>Intel-issued Certificate for the PCK that certified the attestation key,</li><li>Revocation list that applies to the PCK certificate and any intermediate CA used to certify it.</li><li>Up-to-date SVNs for the CPU & PCE.</li><li>Identity of Quoting Enclave trusted to generate attestation key and issue Quotes.</li></ol></blockquote></li></ul></li></ul><h1 id=开发相关>开发相关</h1><h2 id=软件组成>软件组成</h2><ul><li>SGX driver<ul><li>SGX driver存在三个版本（具体区别可以看上面的pdf文档）<ul><li>Out-of-tree Driver (/dev/isgx): <a href=https://github.com/intel/linux-sgx-driver>https://github.com/intel/linux-sgx-driver</a><ul><li>2021年底停止更新，适用于没有Flexible Launch Control (FLC)功能的CPU</li><li>对于archlinux用户，可以选择安装aur中的linux-sgx-driver-dkms-git包</li><li>i5-7200U支持SGX但是是Legacy Launch Control</li></ul></li><li>DCAP Driver (/dev/{sgx_enclave, sgx_provision}，新的是/dev/sgx/enclave和/dev/sgx/provision): <a href=https://github.com/intel/SGXDataCenterAttestationPrimitives/>https://github.com/intel/SGXDataCenterAttestationPrimitives/</a><ul><li>较新的驱动，支持DCAP模式，需要Flexible Launch Control.</li></ul></li><li>DCAP Driver（In-kernel Driver） (/dev/{sgx_enclave, sgx_provision}): Mainline kernel release 5.11 or higher<ul><li>需要Flexible Launch Control.</li></ul></li></ul></li></ul></li><li>SGX PSW<ul><li>对于ubuntu和Red Hat Enterprise Linux用户，Intel 提供了repository，可以直接用包管理器安装，参考https://download.01.org/intel-sgx/sgx-linux/2.14/docs/Intel_SGX_SW_Installation_Guide_for_Linux.pdf</li></ul></li><li>SGX PSW(SGX Platform SoftWare)
该部分主要包含aesm服务</li><li>SGX SDK
主要分为三部分：<ul><li>Untrusted RunTime System (URTS)：被链接到基于sgx的应用程序中（通常是libsgx_urts.so），通过socket与aesm通信</li><li>Trusted RunTime System (TRTS)：与enclave代码链接在一起构建成ELF共享库文件</li><li>enclave standard library code：intel提供的一部分标准库文件，与enclave代码链接在一起</li></ul></li></ul><h2 id=安装方式>安装方式</h2><ul><li>建议阅读文档
<a href=https://download.01.org/intel-sgx/sgx-linux/2.14/docs/Intel_SGX_SW_Installation_Guide_for_Linux.pdf>https://download.01.org/intel-sgx/sgx-linux/2.14/docs/Intel_SGX_SW_Installation_Guide_for_Linux.pdf</a></li><li>从docker中启动sgx开发环境<ul><li><p>使用github的intel/linux-sgx仓库中<code>linux/installer/docker</code>目录下的的文件来构建。</p></li><li><p>这里我做了一些修改来创建一个专门用来开发sgx程序的镜像</p></li><li><p>运行aesm服务所在的docker容器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>build_and_run_aesm_docker.sh
</span></span></code></pre></div></li><li><p>创建并启动一个sgx开发环境的docker容器
进入该容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build --target sgx_sdk --build-arg https_proxy<span style=color:#f92672>=</span>$https_proxy --build-arg http_proxy<span style=color:#f92672>=</span>$http_proxy -t sgx_sdk -f ./Dockerfile ./
</span></span><span style=display:flex><span>docker create --device<span style=color:#f92672>=</span>/dev/isgx -v aesmd-socket:/var/run/aesmd --network<span style=color:#f92672>=</span>host -v /run/media/imlk/Data/workspace/sgx:/code --name<span style=color:#f92672>=</span>sgx_sdk_container -t -i sgx_sdk
</span></span><span style=display:flex><span>docker start sgx_sdk_container
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it sgx_sdk_container /bin/bash
</span></span></code></pre></div></li></ul></li></ul></main><div id=comments><hr><script src=//geoip-js.com/js/apis/geoip2/v2.1/geoip2.js type=text/javascript></script><script>var onSuccess=function(e){var t=e.country.names["zh-CN"],n=e.country.iso_code;if(!n)return;t&&(document.getElementById("comments-blocked-country-code").innerHTML=t),n=="CN"&&(document.getElementById("comments-shown").style.display="none",document.getElementById("comments-blocked").style.display="")},onError=function(){};geoip2.country(onSuccess,onError)</script><div id=comments-blocked style=font-style:italic;color:#777;display:none>评论区已关闭。<span style=float:right>来自 <span id=comments-blocked-country-code>unknown</span> 的访客
<span>&nbsp; - powered by: geoip-js.com</span></span></div><div id=comments-shown><script src=https://utteranc.es/client.js repo=imlk0/imlk0.github.io issue-term=pathname label='💬 comments 💬' theme=github-light crossorigin=anonymous async></script></div></div><footer class=footer><hr>© imlk 2017 &ndash; 2023 | <a href=https://blog.imlk.top>imlk's blog</a> | <a href=https://github.com/imlk0/>Github</a> | <a href=mailto:me@imlk.top>Email</a> | <a href=https://beian.miit.gov.cn/>京ICP备2020042968号-1</a></footer></body></html>