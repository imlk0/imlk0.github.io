<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ä¸ºZjDroidé€‚é…ARTè™šæ‹Ÿæœºçš„å°è¯• | imlk&#39;s blog</title>
  <link rel="stylesheet" href='/css/style.css' />
  <link rel="stylesheet" href='/css/fonts.css' />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="header">
    <a class="logo" href='/'> imlk's Blog </a>
    <nav>
      <ul class="menu">
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/archives/">Archives</a></li>
        
        <li><a href="/friends/">Friends</a></li>
        
        <li><a href="/index.xml">Subscribe</a></li>
        
      </ul>
    </nav>
  </header>
  <hr />



<div class="article-meta">
    <h1><span class="title">ä¸ºZjDroidé€‚é…ARTè™šæ‹Ÿæœºçš„å°è¯•</span></h1>
    
    <span>
        <span class="date">2018-05-05</span> |
        
        <span class="cats">
            
            
            <a href='https://blog.imlk.top/categories/reverse/'>Reverse</a>
            
        </span>
        <span class="tags">
            
             | 
            <a href='https://blog.imlk.top/tags/android/'>#Android</a>
            
            
            <a href='https://blog.imlk.top/tags/art/'>#ART</a>
            
            
            <a href='https://blog.imlk.top/tags/zjdroid/'>#ZjDroid</a>
            
            
            <a href='https://blog.imlk.top/tags/%E7%9E%8E%E6%90%9E/'>#çæ</a>
            
        </span>
    </span>
    <br>
    <br>
    
</div>


<main>
    <p>ä¸Šæ˜ŸæœŸè¶ç€æ”¾å‡ç©äº†ç©ZjDroidï¼Œè‡ªå·±ç¼–è¯‘äº†ä¸€ä¸ªæ¥ç©ï¼Œæœ€ç»ˆå…‹æœä¸‡éš¾æ€»ç®—æ‰¾é½äº†æºç ï¼Œç»™ç¼–è¯‘å‡ºæ¥äº†ã€‚
ä¸Šä¸€ç¯‡æ–‡ç« :</p>
<p>ç¬”è®°-ç¬¬ä¸€æ¬¡ZjDroidè„±å£³å®æˆ˜
<a href="https://blog.imlk.top/blog/40/">https://blog.imlk.top/blog/40/</a></p>
<p>è™½ç„¶ï¼Œæœ€ç»ˆæ‹¿å‡ºæ¥çš„å¤§æ•°å­—åŠ å›ºçš„dexæ²¡èƒ½æ¢å¤onCreateè¿™ä¸ªnativeæ–¹æ³•ï¼ˆæœ¬äººå®åœ¨å¤ªèœï¼‰ï¼Œä½†æ˜¯å…¶ä»–éƒ¨åˆ†è¿˜æ˜¯èƒ½çœ‹æºç çš„ã€‚</p>
<h3 id="èµ·å› ">èµ·å› </h3>
<p>æœ€è¿‘ä¸€ä¸ªæœ‹å‹ç»™æˆ‘çœ‹äº†ä¸€ä¸ªçˆ±åŠ å¯†çš„åŒ…ï¼Œæˆ‘æ”¾åˆ°æ¨¡æ‹Ÿå™¨é‡Œé¢ç”¨æˆ‘çš„ZjDroidè„±ï¼Œæ²¡æƒ³åˆ°è¿™ä¸ªåŒ…å´ä¸»åŠ¨é€€å‡ºäº†ï¼
æˆ‘ä»¥ä¸ºæ˜¯æ£€æµ‹åˆ°äº†ZjDroidï¼Œå°±å¸è½½äº†ZjDroidï¼Œç»“æœè¿˜æ˜¯å´©ï¼Œåæ¥ä¸Šç½‘æŸ¥æ‰å‘ç°ï¼Œçˆ±åŠ å¯†æ£€æµ‹åˆ°æ˜¯æ¨¡æ‹Ÿå™¨ç¯å¢ƒå°±ä¼šä¸»åŠ¨é€€å‡ºã€‚</p>
<p>è¿™å¯è®©æˆ‘è´¹è„‘ç­‹å•Šï¼</p>
<p>æˆ‘æ‰‹ä¸Šåªæœ‰Android7.1.2çš„è®¾å¤‡ï¼Œè€Œç›®å‰çš„ZjDroidåªæ”¯æŒdalvikè™šæ‹Ÿæœºä¸Šè·‘ï¼Œè¿™å¯å’‹åŠå‘¢ï¼Œè¦æˆ‘åˆ·æœºï¼Ÿæ‡’å¾—å¤‡ä»½ã€‚ã€‚ã€‚</p>
<p>æˆ‘è®°å¾—ZjDroidçš„æºç æœ€åæ˜¯4å¹´å‰æ›´æ–°çš„ï¼Œç„¶åä½œè€…å°±ä¸ç»´æŠ¤äº†ï¼Œäºæ˜¯æˆ‘æƒ³èƒ½ä¸èƒ½å­¦ä¹ ZjDroidçš„åŸç†å»é€‚é…artå‘¢ï¼Ÿ</p>
<p>æ‰“å¼€aså°±å¼€å§‹æ£é¼“äº†ï¼</p>
<h3 id="ç¨å¾®å°è¯•">ç¨å¾®å°è¯•</h3>
<p>å°è¯•åœ¨Android7.1.2ä¸Šé¢å®‰è£…ZjDroidï¼Œé‡å¯ï¼Œæ‰“å¼€ä¸Šæ¬¡æˆ‘æ‹†çš„åº”ç”¨ï¼ˆå°±æ˜¯é‚£ä¸ªæˆ‘è‡ªå·±çš„åº”ç”¨å•¦ï¼‰ã€‚</p>
<p>çœ‹logï¼Œé™¤äº†å‡ ä¸ªç¢çœ¼çš„å¼‚å¸¸ä»¥å¤–ï¼Œæ²¡ä»€ä¹ˆå¤§çŠ¶å†µå‡ºç°ï¼Œ</p>
<p>å—¯ï¼Œ</p>
<p>å‘é€å¹¿æ’­æ‰§è¡Œ<code>dump_dexinfo</code>å‘½ä»¤ï¼Œç„¶åä¸€ä¸‹å­å°±å´©äº†ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åœ¨ä¸Šä¸€ç¯‡æ–‡ç« é‡Œé¢å°±æåˆ°è¿‡äº†ã€‚
ZjDroidåœ¨æ‰§è¡Œ<code>dump_dexinfo</code>å‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰ç”¨åˆ°nativeå±‚çš„å‡½æ•°ï¼Œåªæ˜¯é€šè¿‡åå°„è·å–<code>dalvik.system.DexFile</code>ä¸­çš„<code>mCookie</code>å˜é‡æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯å‘ç”Ÿäº†ç±»å‹å¼ºåˆ¶è½¬æ¢çš„é”™è¯¯ï¼Œé”™è¯¯åœ°æŠŠ<code>long[]</code>ç±»å‹è½¬æ¢ä¸ºäº†<code>int</code>ç±»å‹ã€‚</p>
<p>è§£å†³çš„åŠæ³•æ˜¯ï¼š
æŸ¥é˜…<code>Android</code>æºç ï¼Œå¯¹è¿™ä¸ª<code>openDexFileNative</code>åˆ†sdkç‰ˆæœ¬é€‚é…</p>
<ul>
<li>
<p>dalvikï¼ˆAndroid4.4åŠä»¥å‰ sdk &lt;= 19ï¼‰ä¸­çš„openDexFileNative
<a href="http://androidxref.com/4.4.4_r1/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#301">http://androidxref.com/4.4.4_r1/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#301</a></p>
</li>
<li>
<p>art ï¼ˆAndroid5.1.1åŠä»¥å‰ 19 &lt; sdk &lt;= 22ï¼‰ä¸­çš„openDexFileNative
<a href="http://androidxref.com/5.1.1_r6/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#308">http://androidxref.com/5.1.1_r6/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#308</a></p>
</li>
<li>
<p>art ï¼ˆAndroid6.0è‡³ä»Š(å·²æµ‹è¯•7.1.2) 22 &lt; sdkï¼‰ä¸­çš„openDexFileNative
<a href="http://androidxref.com/7.1.2_r36/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#396">http://androidxref.com/7.1.2_r36/xref/libcore/dalvik/src/main/java/dalvik/system/DexFile.java#396</a></p>
</li>
</ul>
<h3 id="artè™šæ‹Ÿæœºçš„mcookie">artè™šæ‹Ÿæœºçš„mCookie</h3>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œ
æˆ‘ä»¬è¦çš„<code>mCookie</code>ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢?</p>
<p>é€šè¿‡å¯¹ZjDroidçš„æ—§ç‰ˆæœ¬ä»£ç è¿›è¡Œåˆ†æå‘ç°ï¼Œåœ¨dalvikè™šæ‹Ÿæœºä¸­ï¼Œ<code>mCookie</code>å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç»“æ„ä½“çš„å†…å­˜åœ°å€ï¼Œé€šè¿‡è¿™ä¸ªç»“æ„ä½“å¯ä»¥è·å¾—å†…å­˜ä¸­dexæ–‡ä»¶çš„åœ°å€ï¼Œç„¶åå°±èƒ½dumpå‡ºæ¥äº†ã€‚
æ—¢ç„¶å¦‚æ­¤ï¼Œåœ¨arté‡Œé¢çš„<code>mCookie</code>æ—¶ä¸€ä¸ª<code>long[]</code>ç±»å‹çš„ï¼Œæˆ‘ä»¬å°±å¾ˆæœ‰å¿…è¦å»äº†è§£è¿™ä¸ªä¸œè¥¿æ˜¯æ€ä¹ˆå½¢æˆçš„äº†ã€‚</p>
<p>æŸ¥çœ‹Android7.1.2çš„æºç ï¼Œæ‰¾åˆ°<code>openDexFileNative</code>æ–¹æ³•çš„nativeå±‚å®ç°ï¼š
<a href="http://androidxref.com/7.1.2_r36/xref/art/runtime/native/dalvik_system_DexFile.cc#156">http://androidxref.com/7.1.2_r36/xref/art/runtime/native/dalvik_system_DexFile.cc#156</a></p>
<p>æœ‰ä¸€äº›æƒ…å†µä¸‹æ˜¯è¿”å›ç©ºæŒ‡é’ˆçš„ï¼Œæˆ‘ä»¬å°±åªçœ‹è¿”å›æ­£å¸¸å€¼çš„æƒ…å†µï¼Œåœ¨ç¬¬184-194è¡Œï¼Œ</p>
<pre tabindex="0"><code>Â·Â·Â·
184  if (!dex_files.empty()) {
185    jlongArray array = ConvertDexFilesToJavaArray(env, oat_file, dex_files);
186    if (array == nullptr) {
187      ScopedObjectAccess soa(env);
188      for (auto&amp; dex_file : dex_files) {
189        if (linker-&gt;FindDexCache(soa.Self(), *dex_file, true) != nullptr) {
190          dex_file.release();
191        }
192      }
193    }
194    return array;
Â·Â·Â·
</code></pre><p>è¿™ä¸ª<code>ConvertDexFilesToJavaArray</code>å‡½æ•°åº”è¯¥æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªå‡½æ•°
çœ‹çœ‹å®ƒçš„å®ç°</p>
<pre tabindex="0"><code>
77static jlongArray ConvertDexFilesToJavaArray(JNIEnv* env,
78                                             const OatFile* oat_file,
79                                             std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;&amp; vec) {
80  // Add one for the oat file.
81  jlongArray long_array = env-&gt;NewLongArray(static_cast&lt;jsize&gt;(kDexFileIndexStart + vec.size())); //åˆå§‹åŒ–ä¸€ä¸ªlongç±»å‹çš„Javaæ•°ç»„
82  if (env-&gt;ExceptionCheck() == JNI_TRUE) {//æ£€æŸ¥æ˜¯å¦å‡ºç°å¼‚å¸¸
83    return nullptr;
84  }
85
86  jboolean is_long_data_copied;
87  jlong* long_data = env-&gt;GetLongArrayElements(long_array, &amp;is_long_data_copied);//è¿™é‡Œåº”è¯¥æ˜¯è·å–åˆšåˆšç”Ÿæˆçš„Javaçš„longç±»å‹æ•°ç»„ä¸­å…ƒç´ çš„åŸå§‹çš„æŒ‡é’ˆï¼Œç†Ÿæ‚‰cè¯­è¨€çš„å°±çŸ¥é“ï¼Œcä¸­çš„æ•°ç»„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç»“æ„ï¼Œé€šè¿‡æŒ‡é’ˆå¯ä»¥è¯»å–æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªä½ç½®çš„å…ƒç´ 
88  if (env-&gt;ExceptionCheck() == JNI_TRUE) {//æ£€æŸ¥æ˜¯å¦å‡ºç°å¼‚å¸¸
89    return nullptr;
90  }
91	// è¿™é‡Œçš„kOatFileIndexå®šä¹‰åœ¨äº†dalvik_system_DexFile.hæ–‡ä»¶ä¸­ï¼šå€¼æ˜¯0ï¼›
	// http://androidxref.com/7.1.2_r36/xref/art/runtime/native/dalvik_system_DexFile.h#25
92  long_data[kOatFileIndex] = reinterpret_cast&lt;uintptr_t&gt;(oat_file);//è¿™é‡Œæ˜¯c++çš„ä¸€ç§ç±»å‹è½¬æ¢çš„æ–¹å¼ï¼ŒæŠŠå‚æ•°è½¬åŒ–ä¸ºäº†uintptr_tç±»å‹ï¼Œè€Œuintptr_tç±»å‹æ˜¯ä¸€ç§æŒ‡é’ˆç±»å‹ï¼Œå°±æŠŠå®ƒçœ‹ä½œä¸€ä¸ªæŒ‡é’ˆå§ã€‚
93  for (size_t i = 0; i &lt; vec.size(); ++i) {//å¯ä»¥çœ‹åˆ°ï¼Œä¹‹å‰åœ¨æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½ç½®æ”¾äº†oat_fileçš„åœ°å€ï¼Œç„¶åæ¥ä¸‹æ¥ä»kDexFileIndexStartï¼ˆè¿™ä¸ªå€¼æ˜¯1ï¼Œä¹Ÿåœ¨ä¸Šé¢é‚£ä¸ªæ–‡ä»¶é‡Œå®šä¹‰äº†ï¼‰å¼€å§‹ï¼ŒæŠŠvecæ•°ç»„é‡Œé¢çš„ä¸œè¥¿å¡«ä¹‹å‰ç”Ÿæˆçš„æ•°ç»„é‡Œã€‚
94    long_data[kDexFileIndexStart + i] = reinterpret_cast&lt;uintptr_t&gt;(vec[i].get());
95  }
96
97  env-&gt;ReleaseLongArrayElements(long_array, long_data, 0);//åˆ·æ–°æ•°ç»„ä¿¡æ¯ï¼ˆæ¯”å¦‚é•¿åº¦ç­‰ï¼‰
98  if (env-&gt;ExceptionCheck() == JNI_TRUE) {//æ£€æŸ¥æ˜¯å¦å‡ºç°å¼‚å¸¸
99    return nullptr;
100  }
101
102  // Now release all the unique_ptrs.
103  for (auto&amp; dex_file : vec) {
104    dex_file.release();
105  }
106
107  return long_array;
108}
</code></pre><p>å¯ä»¥å¤§æ¦‚äº†è§£åˆ°ï¼Œç¬¬ä¸€ä¸ªä½ç½®è¢«èµ‹å€¼ä¸º<code>oat_file</code>è¿™ä¸ªæŒ‡é’ˆï¼ˆå®é™…ä¸Šå°±æ˜¯æŠŠæŒ‡å‘çš„åœ°å€å­˜åˆ°äº†ç¬¬ä¸€ä¸ªä½ç½®é‡Œï¼‰ï¼Œç„¶åä¾æ¬¡å¡«å……<code>vec</code>è¿™ä¸ªæ•°ç»„é‡Œçš„ä¸œè¥¿åˆ°ä¹‹å‰çš„<code>long</code>æ•°ç»„é‡Œé¢ï¼Œçœ‹çœ‹è¿™ä¸ª<code>vec</code>ï¼š
åœ¨å‚æ•°åˆ—è¡¨é‡Œï¼š</p>
<pre tabindex="0"><code>std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;&amp; vec
</code></pre><p>ä¸è¦æ…Œï¼Œçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†å…¶å®ä¸éš¾ç†è§£ï¼š</p>
<p><code>vec</code>æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„æ˜¯ä¸€ä¸ª<code>vector</code>ï¼ˆå¯å˜é•¿æ•°ç»„ï¼‰å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é‡Œè£…çš„éƒ½æ˜¯<code>unique_ptr</code>ç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æŒ‡é’ˆï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªä¸œè¥¿æŒ‡å‘çš„ç±»å‹æ˜¯<code>DexFile</code>ï¼Œä¸Šé¢çš„é‚£æ®µä»£ç åº”è¯¥å°±æ˜¯æŠŠè¿™äº›æŒ‡é’ˆæŒ‡å‘çš„<strong>åœ°å€</strong>ä¿¡æ¯å¡«åˆ°<code>long</code>æ•°ç»„é‡Œé¢äº†</p>
<p>æœ€ç»ˆè¿”å›çš„<code>long</code>ç±»å‹æ•°ç»„é‡Œé¢ï¼Œåº”è¯¥å…¨éƒ½æ˜¯åœ°å€ã€‚</p>
<h3 id="artä¸­çš„dexfile">artä¸­çš„DexFile</h3>
<p>å†çœ‹çœ‹<code>DexFile</code>è¿™ä¸ªä¸œè¥¿ï¼š</p>
<p>åœ¨</p>
<p><a href="http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h">http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h</a></p>
<pre tabindex="0"><code>class DexFile {
</code></pre><p>æ˜¯ä¸€ä¸ªclassï¼Œé‡Œé¢è¿˜æœ‰ç»“æ„ä½“æ¯”å¦‚</p>
<pre tabindex="0"><code>  struct Header {
</code></pre><p>ä¹‹ç±»çš„ï¼Œè¿™å¥½åƒå’Œdexæ–‡ä»¶çš„ç»“æ„æœ‰ç‚¹å…³è”äº†ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹ç¿»</p>
<p>åœ¨ç¬¬1235è¡Œçš„åœ°æ–¹ï¼š<a href="http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h#1235">http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h#1235</a></p>
<pre tabindex="0"><code>Â·Â·Â·
1234  // The base address of the memory mapping.
1235  const uint8_t* const begin_;
1236
1237  // The size of the underlying memory allocation in bytes.
1238  const size_t size_;
1239
1240  // Typically the dex file name when available, alternatively some identifying string.
1241  //
1242  // The ClassLinker will use this to match DexFiles the boot class
1243  // path to DexCache::GetLocation when loading from an image.
1244  const std::string location_;
1245
1246  const uint32_t location_checksum_;
1247
1248  // Manages the underlying memory allocation.
1249  std::unique_ptr&lt;MemMap&gt; mem_map_;
1250
1251  // Points to the header section.
1252  const Header* const header_;
1253
1254  // Points to the base of the string identifier list.
1255  const StringId* const string_ids_;
1256
1257  // Points to the base of the type identifier list.
1258  const TypeId* const type_ids_;
Â·Â·Â·
</code></pre><p>è¿™ä¸ª<code>begin_</code>çš„æè¿°ï¼Œä¼¼ä¹æ˜¯ä»€ä¹ˆä»€ä¹ˆå†…å­˜æ˜ å°„çš„åŸºåœ°å€ï¼Œä¸‹é¢è¿˜æœ‰è¿™ä¸ªå—åŒºåŸŸçš„å¤§å°<code>size_</code>ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€äº›æŒ‡é’ˆï¼Œ<code>Header</code>ï¼Œ<code>StringId</code>ï¼Œ<code>TypeId</code>å•¥çš„ï¼Œç»“åˆç›¸å…³ä»£ç ï¼Œæˆ‘çŒœæµ‹è¿™å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„dexæ–‡ä»¶çš„ä¿¡æ¯äº†ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>Javaå±‚è·å–åˆ°çš„<code>mCookie</code>æ˜¯ä¸€ä¸ª<code>long</code>ç±»å‹æ•°ç»„ï¼Œé‡Œé¢éƒ½æ˜¯åœ°å€ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªåœ°å€æ˜¯<code>oat_file</code>ä¹Ÿå°±æ˜¯oatè¿‡çš„æ–‡ä»¶çš„åœ°å€ï¼Œå½“ç„¶ç°åœ¨å¤§å¤šæ•°åŠ å›ºéƒ½ä¸ä¼šå…è®¸è™šæ‹Ÿæœºè¿›è¡Œoatæ“ä½œäº†ï¼Œå› ä¸ºoatæ“ä½œä¼šåœ¨å‚¨å­˜ä¸­ç”Ÿæˆä¼˜åŒ–è¿‡çš„oatæ–‡ä»¶ï¼Œå¯¹äºåŠ å›ºæ¥è¯´ï¼Œæ— ç–‘æ˜¯è‡ªå·±æŠŠä»£ç ç»™å‡ºå»äº†ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« é‡Œï¼Œ<code>long</code>æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º0çš„åŸå› ï¼š
<img src="/images/blog/40_0.png" alt="è°ƒè¯•å™¨æŸ¥çœ‹å†…å®¹"></p>
<p>è§£å†³æ–¹æ³•ï¼š
<a href="https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/java/com/android/reverse/collecter/DexFileInfoCollecter.java#L190">https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/java/com/android/reverse/collecter/DexFileInfoCollecter.java#L190</a></p>
<p>æ¥ä¸‹æ¥</p>
<p>æˆ‘ä»¬åªéœ€è¦ç¬¬äºŒä¸ªä½ç½®å¼€å§‹çš„å†…å®¹ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŠŠåœ°å€ä¼ åˆ°<code>native</code>æ–¹æ³•é‡Œï¼Œåœ¨<code>native</code>å±‚é‡Œï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘çš„å°±æ˜¯ä¸€ä¸ª<code>DexFile</code>ç±»ï¼Œè€Œå› ä¸ºç±»ä¹Ÿç±»ä¼¼äºç»“æ„ä½“ï¼Œä¹Ÿæœ‰å®ƒçš„å‚¨å­˜ç»“æ„ï¼Œåªè¦æ‰¾åˆ°<code>begin_</code>å’Œ<code>size_</code>çš„å†…å®¹å°±èƒ½dumpå‡ºå†…å­˜ä¸­çš„dexï¼ˆodexï¼‰æ–‡ä»¶ã€‚</p>
<h3 id="é‡åˆ°çš„å‡ ä¸ªé—®é¢˜">é‡åˆ°çš„å‡ ä¸ªé—®é¢˜</h3>
<p>å…³äºå†…å­˜å¯¹ä¸åˆ°çš„é—®é¢˜ï¼š</p>
<p>æˆ‘ä»¬çŸ¥é“C++å’ŒJavaæ˜¯æœ‰å¾ˆå¤§çš„åŒºåˆ«çš„ï¼Œåœ¨C++é‡Œé¢ï¼Œä¸€ä¸ªå˜é‡ï¼Œç¼–è¯‘äº†ä»¥åï¼Œåœ¨è¿è¡Œæ—¶ä½ æ˜¯ä¸èƒ½é€šè¿‡å˜é‡çš„åç§°æ¥æ‰¾åˆ°è¿™ä¸ªç±»çš„ã€‚å› ä¸ºè¿™äº›å˜é‡éƒ½å˜æˆäº†åœ°å€æˆ–è€…åç§»é‡ã€‚åªä»£è¡¨æŸä¸ªå†…å­˜åŒºåŸŸã€‚ä¸èƒ½åƒJavaé‚£æ ·é€šè¿‡åå°„åŠ¨æ€è·å–ã€‚</p>
<p>æ‰€ä»¥ï¼Œå’Œç»“æ„ä½“ç±»ä¼¼ï¼Œæƒ³è¦è·å–ä¸€ä¸ªC++å¯¹è±¡çš„æŸä¸ªæˆå‘˜å˜é‡ï¼Œä½ åªèƒ½é€šè¿‡è¿™ä¸ª<strong>å¯¹è±¡çš„åœ°å€</strong>+<strong>è¿™ä¸ªæˆå‘˜å˜é‡åœ¨è¿™ä¸ªå¯¹è±¡ä¸­çš„ç›¸å¯¹ä½ç½®</strong>æ¥è·å–åˆ°ï¼Œ</p>
<p>å‰è€…æˆ‘ä»¬å®¹æ˜“å¾—åˆ°ï¼Œè€Œåè€…ï¼Œåˆ™éœ€è¦æ„é€ ä¸€ä¸ªå’Œç”Ÿæˆè¿™ä¸ªå¯¹è±¡çš„<code>class</code>æˆ–è€…<code>struct</code>ä¸€æ¨¡ä¸€æ ·çš„<code>class</code>æˆ–è€…<code>struct</code>ç„¶åé€šè¿‡æŒ‡é’ˆçš„å½¢å¼å–å¾—å…¶ä¸­çš„æˆå‘˜å˜é‡</p>
<p>çœ‹åˆ°è¿™é‡Œå¯èƒ½å°±æœ‰äººæœ‰ç–‘é—®äº†ï¼š</p>
<ul>
<li>ä¸ºä»€ä¹ˆæˆ‘åœ¨åŸå§‹çš„ZjDroidæºç é‡Œé¢çœ‹åˆ°äº†å’ŒAndroidæºç é‡Œé¢ä¸€æ ·çš„ç»“æ„ä½“å®šä¹‰æˆ–è€…classå®šä¹‰ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆæ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Ÿ</li>
</ul>
<p>é‚£æ˜¯å› ä¸ºï¼Œåªæœ‰ä¸€æ¨¡ä¸€æ ·ï¼Œæ‰èƒ½æœ‰ä¸€æ ·çš„åç§»é‡å•Šï¼</p>
<p>å‡è®¾å·²ç»å–å¾—çš„<code>DexFile</code>çš„æŸä¸ªå¯¹è±¡çš„åœ°å€<code>adress</code>(å‡è®¾æ˜¯<code>long</code>ç±»å‹)ï¼Œæƒ³è·å¾—å¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡<code>begin_</code>çš„å€¼ï¼Œåº”è¯¥ç”¨ä»¥ä¸‹çš„æ­¥éª¤</p>
<pre tabindex="0"><code>DexFile *dexFile_ptr = (DexFile *)adress; // castä¸ºDexFileç±»å‹çš„æŒ‡é’ˆ

dexFile_ptr -&gt; begin_; // è¿™æ ·å–å¾—begin_çš„å†…å®¹

</code></pre><p>å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼šè®¾æƒ³å¦‚æœä½ çš„ä»£ç é‡Œé¢æ²¡æœ‰<code>DexFile</code>çš„å®šä¹‰ï¼Œæ€ä¹ˆé€šè¿‡ç¼–è¯‘ï¼Ÿç¼–è¯‘å™¨ä¼šå‘Šè¯‰ä½ æ‰¾ä¸åˆ°ç¬¦å·</p>
<p>å®é™…ä¸Šç¬¬äºŒå¥ï¼š</p>
<pre tabindex="0"><code>dexFile_ptr -&gt; begin_;
</code></pre><p>å¯ä»¥ç†è§£ä¸º:
ï¼ˆ<code>dexFile_ptr</code>çš„åœ°å€ + <code>begin_</code>è¿™ä¸ªæˆå‘˜å˜é‡åœ¨å¯¹è±¡é‡Œçš„ç›¸å¯¹ä½ç½®ï¼‰å°±æ˜¯<code>begin_</code>çš„å†…å®¹åœ¨å†…å­˜ä¸­çš„ä½ç½®</p>
<p>è€Œè¿™ä¸ªç›¸å¯¹ä½ç½®ï¼Œæ˜¯ç¼–è¯‘æ—¶å†³å®šçš„ï¼Œä¸classçš„ç»“æ„æœ‰å…³ï¼Œä¸ç¼–è¯‘å™¨æœ‰å…³ï¼Œä¸å¹³å°æœ‰å…³ã€‚</p>
<h3 id="å…³äºcå¯¹è±¡çš„å†…å­˜ç»“æ„">å…³äºC++å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>
<p>ä»¥ä¸‹æ˜¯æˆ‘ä¸ªäººæ‰€äº†è§£åˆ°çš„</p>
<ul>
<li>C++ä¸­çš„ç±»å¦‚æœæœ‰è™šå‡½æ•°å­˜åœ¨ï¼Œé‚£ä¹ˆå¯¹è±¡çš„å†…å­˜ç»“æ„ä¸­ç¬¬ä¸€ä¸ªä½ç½®åº”è¯¥æ˜¯<strong>è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆ</strong>ã€‚<a href="https://www.linuxidc.com/Linux/2014-12/111047.htm">https://www.linuxidc.com/Linux/2014-12/111047.htm</a></li>
<li>C++ä¸­çš„å‡½æ•°ä¸ç±»ç»‘å®šï¼Œåœ¨å¯¹è±¡ä¸­ä¸å å†…å­˜</li>
<li>C++ä¸­çš„staticæˆå‘˜å˜é‡ä¸ç±»ç»‘å®šï¼Œåœ¨å¯¹è±¡ä¸­ä¸å å†…å­˜</li>
</ul>
<h3 id="æŒ«æŠ˜">æŒ«æŠ˜</h3>
<p>å‘ç°è‡ªå·±ç¼–è¯‘å‡ºçš„soæ–‡ä»¶ä¸­<code>std::string</code>ç±»å‹çš„å¤§å°å’Œartè™šæ‹Ÿæœºä¸­çš„ä¸ä¸€è‡´ï¼Œ
<a href="https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/jni/dvmnative/dexfile_art.h#L454">https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/jni/dvmnative/dexfile_art.h#L454</a></p>
<p>é€šè¿‡dumpå‡ºè¿™ä¸€å—å†…å­˜ç»è¿‡åˆ†æå¯çŸ¥</p>
<p>å†…å­˜ç»“æ„å¯¹åº”å…³ç³»ä¸ºï¼š</p>
<p><img src="/images/blog/42_0.png" alt="DexFileç±»çš„å¯¹è±¡çš„å†…å­˜ç»“æ„"></p>
<p>è¿™é‡Œçš„<code>std::string</code>å äº†3 * 4 = 12ä¸ªå­—èŠ‚ï¼Œè€Œæˆ‘ç¼–è¯‘å‡ºæ¥çš„soé‡Œé¢ï¼Œå®ƒæ˜¯åªå äº†4ä¸ªå­—èŠ‚çš„ã€‚</p>
<p>è¿™å¯¼è‡´ï¼Œåœ¨é‚£ä¸ªstringä¹‹åçš„å†…å®¹éƒ½å‘ç”Ÿé”™ä½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ç¼–è¯‘å‡ºæ¥çš„classï¼Œåç§»é‡å’Œartè™šæ‹Ÿæœºé‡Œé¢çš„soæ–‡ä»¶é‡Œçš„ä¸ä¸€æ ·ï¼Œè¿™å¯¼è‡´å‘ZjDroidå‘é€<code>backsmali</code>å‘½ä»¤æ— æ³•ä½¿ç”¨</p>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>åœ¨ä¸€å®šèŒƒå›´å†…è¿›è¡Œå†…å­˜æœç´¢ï¼š
å› ä¸º<code>begin_</code>å’Œ<code>head_ptr</code>çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘åœ¨ä¹‹åçš„ä¸€å®šçš„å†…å­˜åŒºåŸŸå†…æœç´¢<code>begin_</code>çš„å€¼å°±èƒ½æ‰¾åˆ°<code>head_ptr</code>çš„ä½ç½®äº†
<a href="https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/jni/dvmnative/dvmnative.cpp#L583">https://github.com/KB5201314/ZjDroid/blob/master/app/src/main/jni/dvmnative/dvmnative.cpp#L583</a></p>
<h3 id="å‡ºç‚‰">å‡ºç‚‰</h3>
<p>æºç ï¼š
<a href="https://github.com/KB5201314/ZjDroid">https://github.com/KB5201314/ZjDroid</a>
apkä¸‹è½½ï¼š
<a href="https://github.com/KB5201314/ZjDroid/releases">https://github.com/KB5201314/ZjDroid/releases</a></p>
<h3 id="é—ç•™é—®é¢˜">é—ç•™é—®é¢˜</h3>
<p>ç”±äºåŸå§‹ç‰ˆæœ¬çš„æºç è¿‡äºè€æ—§ï¼Œä¼¼ä¹åªé€‚é…åˆ°Android sdk 17</p>
<p>åœ¨é«˜ç‰ˆæœ¬ä¸Šéƒ¨åˆ†apiå‘ç”Ÿæ”¹å˜ï¼Œä¼šå¼•å‘å¼‚å¸¸</p>
<p>å·²çŸ¥ï¼š</p>
<ul>
<li>åº”ç”¨æ•æ„Ÿè¡Œä¸ºç›‘æ§æœ‰éƒ¨åˆ†åŠŸèƒ½ä¸èƒ½ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯ç½‘ç»œç›¸å…³ï¼Œæ¯”å¦‚æ–°ç‰ˆAndroidåˆ äº†<code>apache</code>çš„<code>http</code>åº“æ”¹ç”¨<code>Okhttp</code>ï¼ŒZjDroidè¿˜æœªè·Ÿè¿›ã€‚</li>
<li>ZjDroidçš„<code>backsmali</code>å‘½ä»¤è™½ç„¶è·å–dexä¿¡æ¯éƒ¨åˆ†ï¼ˆnativeå±‚ï¼‰å·²ç»æå®šï¼Œä½†æ˜¯ZjDroidæ‰€ä½¿ç”¨çš„<code>org.jf.dexlib2</code>ç­‰åº“æ˜¯å››å¹´å‰çš„ç‰ˆæœ¬ï¼Œä¸æ”¯æŒartï¼Œè¦æ”¹ä¸ºæ–°ç‰ˆçš„è¯ï¼Œè¦åšå¾ˆå¤šä¿®æ”¹ã€‚</li>
</ul>
<p>æ¬¢è¿æäº¤æ”¹è¿›</p>
<h3 id="æŸ¥çœ‹androidæºç çš„ç½‘ç«™">æŸ¥çœ‹Androidæºç çš„ç½‘ç«™</h3>
<ul>
<li>grepcode:æ”¯æŒæŸ¥çœ‹Android5.1.1åŠä»¥å‰çš„æºç ï¼Œæ”¯æŒæ–‡ä»¶æ¯”è¾ƒ
<a href="http://www.grepcode.com/">http://www.grepcode.com/</a></li>
<li>androidxref:èµ„æºå…¨ï¼Œä½†æ–‡ä»¶æ¯”è¾ƒåŠŸèƒ½æ²¡ä¸Šé¢çš„é‚£ä¸ªå¥½ç”¨
<a href="http://androidxref.com/">http://androidxref.com/</a></li>
</ul>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>è§£å†³çˆ±åŠ å¯†åŠ å›ºä¹‹åä½¿ç”¨xposed hookçš„æ—¶å€™logæ‰“å°ä¸å‡ºæ¥çš„é—®é¢˜:
<a href="https://bbs.pediy.com/thread-216965.htm">https://bbs.pediy.com/thread-216965.htm</a></li>
<li>C++ç±»å¯¹è±¡çš„å†…å­˜æ¨¡å‹:
<a href="https://www.linuxidc.com/Linux/2014-12/111047.htm">https://www.linuxidc.com/Linux/2014-12/111047.htm</a></li>
<li>std::stringæºç æ¢ç§˜å’Œæ€§èƒ½åˆ†æï¼š
<a href="https://blog.csdn.net/ybxuwei/article/details/51326830">https://blog.csdn.net/ybxuwei/article/details/51326830</a></li>
<li>ä¿®æ”¹å®‰å“æºç ï¼šArtæ¨¡å¼ä¸‹çš„é€šç”¨è„±å£³æ–¹æ³•:
<a href="http://www.freebuf.com/articles/terminal/166307.html">http://www.freebuf.com/articles/terminal/166307.html</a></li>
<li>GDBä¸­æ‰“å°ARTåŸºç¡€ç±»:
<a href="http://www.cnblogs.com/YYPapa/p/6858787.html">http://www.cnblogs.com/YYPapa/p/6858787.html</a></li>
<li>é˜¿é‡Œæ—©æœŸAndroidåŠ å›ºä»£ç çš„å®ç°åˆ†æ:
<a href="http://www.voidcn.com/article/p-ntseiwvg-bqs.html">http://www.voidcn.com/article/p-ntseiwvg-bqs.html</a></li>
<li>[åŸåˆ›]é˜¿é‡Œæ—©æœŸåŠ å›ºä»£ç è¿˜åŸ4.4-6.0:
<a href="https://bbs.pediy.com/thread-215078.htm">https://bbs.pediy.com/thread-215078.htm</a></li>
<li>dex_file.hå¤´æ–‡ä»¶
<a href="http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h">http://androidxref.com/7.1.2_r36/xref/art/runtime/dex_file.h</a></li>
<li>dex_file.hå¤´æ–‡ä»¶ï¼ˆAndroid Pï¼‰
<a href="https://android.googlesource.com/platform/art/+/android-p-preview-2/libdexfile/dex/dex_file.h">https://android.googlesource.com/platform/art/+/android-p-preview-2/libdexfile/dex/dex_file.h</a></li>
<li>dalvik_system_DexFile.hå¤´æ–‡ä»¶
<a href="http://androidxref.com/7.1.2_r36/xref/art/runtime/native/dalvik_system_DexFile.h">http://androidxref.com/7.1.2_r36/xref/art/runtime/native/dalvik_system_DexFile.h</a></li>
</ul>

</main>



<div id="comments">
    <hr>
    <script src="https://utteranc.es/client.js" repo='KB5201314/KB5201314.github.io' issue-term="pathname" label='ğŸ’¬ comments ğŸ’¬'
        theme='github-light' crossorigin="anonymous" async>
        </script>
</div>


  <footer>
  
  <hr/>
  Â© <a href="https://blog.imlk.top">imlk</a> 2017 &ndash; 2021 | imlk's blog | <a href="https://github.com/KB5201314/">Github</a> | <a href="mailto:me@imlk.top">Email</a> | <a href="http://www.miitbeian.gov.cn/">äº¬ICPå¤‡ - 2020042968å·</a>
  
  </footer>
  </body>
</html>
